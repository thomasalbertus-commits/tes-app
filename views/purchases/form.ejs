<div class="max-w-3xl mx-auto">
  <form method="POST" action="/purchases" id="purchaseForm">
    <div class="space-y-6">
      <!-- Supplier -->
      <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="truck" class="w-5 h-5 text-blue-600"></i> Supplier</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Supplier</label>
            <select name="supplier_id" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm" onchange="this.form.supplier_name.value = this.selectedOptions[0].text">
              <option value="">-- Pilih --</option>
              <% suppliers.forEach(s => { %><option value="<%= s.id %>"><%= s.name %></option><% }) %>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Nama Supplier</label>
            <input type="text" name="supplier_name" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm" placeholder="Atau ketik manual">
          </div>
        </div>
      </div>

      <!-- Items -->
      <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="package" class="w-5 h-5 text-orange-600"></i> Item Pembelian</h3>
          <button type="button" onclick="addItem()" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700">+ Tambah Item</button>
        </div>
        <div id="itemsContainer" class="space-y-3"></div>
      </div>

      <!-- Payment -->
      <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="credit-card" class="w-5 h-5 text-green-600"></i> Pembayaran</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Metode Bayar</label>
            <select name="payment_method" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm">
              <option value="cash">Cash</option>
              <option value="transfer">Transfer</option>
              <option value="credit">Kredit (Utang)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Akun Kas</label>
            <select name="cash_account_id" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm">
              <option value="">-- Tidak Ada --</option>
              <% cashAccounts.forEach(a => { %><option value="<%= a.id %>"><%= a.name %></option><% }) %>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Catatan</label>
            <input type="text" name="notes" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl text-sm">
          </div>
        </div>
      </div>

      <div class="flex gap-3">
        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors">
          <i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Simpan Pembelian
        </button>
        <a href="/purchases" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-colors">Batal</a>
      </div>
    </div>
  </form>
</div>

<script>
let itemIndex = 0;
const inventoryData = <%- JSON.stringify(inventoryItems.map(i => ({ id: i.id, name: i.name, buy_price: i.buy_price }))) %>;

function addItem() {
  const container = document.getElementById('itemsContainer');
  const html = `
    <div class="item-row border border-slate-200 rounded-xl p-3 bg-slate-50 animate-fade-in">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <select name="items[${itemIndex}][inventory_id]" class="px-3 py-2 border border-slate-300 rounded-lg text-sm" onchange="fillItemData(this, ${itemIndex})">
          <option value="">Manual</option>
          ${inventoryData.map(i => `<option value="${i.id}" data-name="${i.name}" data-buy="${i.buy_price}">${i.name}</option>`).join('')}
        </select>
        <input type="text" name="items[${itemIndex}][name]" placeholder="Nama Item" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
        <input type="number" name="items[${itemIndex}][qty]" value="1" placeholder="Qty" min="1" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
        <div class="flex gap-2">
          <input type="number" name="items[${itemIndex}][buy_price]" placeholder="Harga Beli" class="px-3 py-2 border border-slate-300 rounded-lg text-sm flex-1">
          <button type="button" onclick="this.closest('.item-row').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
      </div>
    </div>`;
  container.insertAdjacentHTML('beforeend', html);
  itemIndex++;
  if (typeof lucide !== 'undefined') lucide.createIcons();
}

function fillItemData(select, idx) {
  const opt = select.selectedOptions[0];
  if (opt.value) {
    const row = select.closest('.item-row');
    row.querySelector('[name="items['+idx+'][name]"]').value = opt.dataset.name;
    row.querySelector('[name="items['+idx+'][buy_price]"]').value = opt.dataset.buy;
  }
}

addItem();
</script>
