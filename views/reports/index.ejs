<!-- Tabs -->
<div class="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6">
  <div class="flex overflow-x-auto border-b border-slate-200">
    <a href="/reports?tab=summary" class="px-4 py-3 text-sm font-bold whitespace-nowrap border-b-2 transition-colors <%= tab === 'summary' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700' %>">Ringkasan</a>
    <a href="/reports?tab=sales" class="px-4 py-3 text-sm font-bold whitespace-nowrap border-b-2 transition-colors <%= tab === 'sales' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700' %>">Penjualan</a>
    <a href="/reports?tab=services" class="px-4 py-3 text-sm font-bold whitespace-nowrap border-b-2 transition-colors <%= tab === 'services' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700' %>">Servis</a>
    <a href="/reports?tab=inventory" class="px-4 py-3 text-sm font-bold whitespace-nowrap border-b-2 transition-colors <%= tab === 'inventory' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700' %>">Inventaris</a>
    <a href="/reports?tab=profitloss" class="px-4 py-3 text-sm font-bold whitespace-nowrap border-b-2 transition-colors <%= tab === 'profitloss' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700' %>">Laba Rugi</a>
  </div>
</div>

<% if (tab === 'summary') { %>
<!-- Summary -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
    <p class="text-xs text-slate-500 mb-1">Pendapatan (Bulan Ini)</p>
    <p class="text-xl font-extrabold text-green-600">Rp <%= (txSummary.totalIncome || 0).toLocaleString('id-ID') %></p>
  </div>
  <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
    <p class="text-xs text-slate-500 mb-1">Pengeluaran (Bulan Ini)</p>
    <p class="text-xl font-extrabold text-red-600">Rp <%= (txSummary.totalExpense || 0).toLocaleString('id-ID') %></p>
  </div>
  <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
    <p class="text-xs text-slate-500 mb-1">Laba Bersih</p>
    <p class="text-xl font-extrabold <%= (txSummary.totalIncome - txSummary.totalExpense) >= 0 ? 'text-green-600' : 'text-red-600' %>">Rp <%= ((txSummary.totalIncome || 0) - (txSummary.totalExpense || 0)).toLocaleString('id-ID') %></p>
  </div>
  <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
    <p class="text-xs text-slate-500 mb-1">Total Transaksi</p>
    <p class="text-xl font-extrabold text-blue-600"><%= txSummary.count || 0 %></p>
  </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
    <h3 class="font-bold text-slate-800 mb-3">Pendapatan per Kategori</h3>
    <canvas id="incomeChart" height="200"></canvas>
  </div>
  <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
    <h3 class="font-bold text-slate-800 mb-3">Pengeluaran per Kategori</h3>
    <canvas id="expenseChart" height="200"></canvas>
  </div>
</div>

<!-- Top Products -->
<div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
  <h3 class="font-bold text-slate-800 mb-3"><i data-lucide="trending-up" class="w-5 h-5 inline text-orange-600"></i> Top 10 Produk Terlaris</h3>
  <% if (topProducts.length > 0) { %>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead><tr class="bg-slate-50"><th class="text-left p-3 font-bold">#</th><th class="text-left p-3 font-bold">Nama Produk</th><th class="text-right p-3 font-bold">Qty</th><th class="text-right p-3 font-bold">Revenue</th></tr></thead>
      <tbody>
        <% topProducts.forEach((p, i) => { %>
          <tr class="border-b border-slate-100">
            <td class="p-3"><%= i + 1 %></td>
            <td class="p-3 font-semibold"><%= p.name %></td>
            <td class="p-3 text-right"><%= p.total_qty %></td>
            <td class="p-3 text-right font-bold text-green-600">Rp <%= (p.total_revenue || 0).toLocaleString('id-ID') %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
    <p class="text-slate-400 text-sm text-center py-4">Belum ada data penjualan</p>
  <% } %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const incomeData = <%- JSON.stringify(incomeByCategory) %>;
  const expenseData = <%- JSON.stringify(expenseByCategory) %>;
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16'];

  if (Object.keys(incomeData).length > 0) {
    new Chart(document.getElementById('incomeChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(incomeData),
        datasets: [{ data: Object.values(incomeData), backgroundColor: colors }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  if (Object.keys(expenseData).length > 0) {
    new Chart(document.getElementById('expenseChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(expenseData),
        datasets: [{ data: Object.values(expenseData), backgroundColor: colors }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }
});
</script>

<% } else if (tab === 'sales') { %>
<!-- Sales Report -->
<div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
  <h3 class="font-bold text-slate-800 mb-4"><i data-lucide="shopping-cart" class="w-5 h-5 inline text-blue-600"></i> Laporan Penjualan</h3>
  <p class="text-sm text-slate-500 mb-4">Total: <span class="font-bold"><%= sales.length %></span> transaksi</p>
  <% if (sales.length > 0) { %>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead><tr class="bg-slate-50">
        <th class="text-left p-3 font-bold">No</th>
        <th class="text-left p-3 font-bold">Tanggal</th>
        <th class="text-left p-3 font-bold">Customer</th>
        <th class="text-right p-3 font-bold">Items</th>
        <th class="text-right p-3 font-bold">Diskon</th>
        <th class="text-right p-3 font-bold">Total</th>
        <th class="text-left p-3 font-bold">Metode</th>
      </tr></thead>
      <tbody>
        <% sales.forEach((s, i) => { %>
          <tr class="border-b border-slate-100 hover:bg-slate-50">
            <td class="p-3"><%= i + 1 %></td>
            <td class="p-3 text-xs"><%= new Date(s.created_at).toLocaleDateString('id-ID', {day:'2-digit',month:'short',year:'numeric'}) %></td>
            <td class="p-3"><%= s.customer_name || '-' %></td>
            <td class="p-3 text-right"><%= s.items ? s.items.length : 0 %></td>
            <td class="p-3 text-right text-red-500"><%= s.discount > 0 ? 'Rp ' + s.discount.toLocaleString('id-ID') : '-' %></td>
            <td class="p-3 text-right font-bold">Rp <%= (s.total || 0).toLocaleString('id-ID') %></td>
            <td class="p-3"><span class="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-700"><%= s.payment_method || 'cash' %></span></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
    <p class="text-slate-400 text-sm text-center py-8">Belum ada penjualan</p>
  <% } %>
</div>

<% } else if (tab === 'services') { %>
<!-- Services Report -->
<div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
  <h3 class="font-bold text-slate-800 mb-4"><i data-lucide="wrench" class="w-5 h-5 inline text-teal-600"></i> Laporan Servis</h3>

  <!-- Stats -->
  <% 
    const statusCounts = {};
    services.forEach(s => { statusCounts[s.status] = (statusCounts[s.status] || 0) + 1; });
  %>
  <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
    <div class="bg-slate-50 p-3 rounded-xl text-center"><p class="text-xs text-slate-500">Total</p><p class="font-extrabold text-lg"><%= services.length %></p></div>
    <div class="bg-yellow-50 p-3 rounded-xl text-center"><p class="text-xs text-yellow-600">Antrian</p><p class="font-extrabold text-lg text-yellow-600"><%= statusCounts['antrian'] || 0 %></p></div>
    <div class="bg-blue-50 p-3 rounded-xl text-center"><p class="text-xs text-blue-600">Proses</p><p class="font-extrabold text-lg text-blue-600"><%= statusCounts['proses'] || 0 %></p></div>
    <div class="bg-green-50 p-3 rounded-xl text-center"><p class="text-xs text-green-600">Selesai</p><p class="font-extrabold text-lg text-green-600"><%= statusCounts['selesai'] || 0 %></p></div>
    <div class="bg-teal-50 p-3 rounded-xl text-center"><p class="text-xs text-teal-600">Diambil</p><p class="font-extrabold text-lg text-teal-600"><%= statusCounts['diambil'] || 0 %></p></div>
  </div>

  <% if (services.length > 0) { %>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead><tr class="bg-slate-50">
        <th class="text-left p-3 font-bold">Token</th>
        <th class="text-left p-3 font-bold">Customer</th>
        <th class="text-left p-3 font-bold">Unit</th>
        <th class="text-left p-3 font-bold">Status</th>
        <th class="text-right p-3 font-bold">Biaya</th>
        <th class="text-right p-3 font-bold">Bayar</th>
      </tr></thead>
      <tbody>
        <% services.forEach(s => { %>
          <tr class="border-b border-slate-100">
            <td class="p-3 font-bold text-blue-600"><%= s.token || '-' %></td>
            <td class="p-3"><%= s.customer_name || '-' %></td>
            <td class="p-3"><%= s.brand || '' %> <%= s.unit_type || '' %></td>
            <td class="p-3">
              <% const sColors = {antrian:'bg-yellow-100 text-yellow-700', proses:'bg-blue-100 text-blue-700', selesai:'bg-green-100 text-green-700', diambil:'bg-teal-100 text-teal-700', batal:'bg-red-100 text-red-700'}; %>
              <span class="px-2 py-0.5 rounded-full text-xs <%= sColors[s.status] || 'bg-slate-100 text-slate-700' %>"><%= s.status %></span>
            </td>
            <td class="p-3 text-right">Rp <%= (s.estimated_cost || 0).toLocaleString('id-ID') %></td>
            <td class="p-3 text-right font-bold">Rp <%= (s.total_paid || 0).toLocaleString('id-ID') %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
    <p class="text-slate-400 text-sm text-center py-8">Belum ada data servis</p>
  <% } %>
</div>

<% } else if (tab === 'inventory') { %>
<!-- Inventory Report -->
<div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
  <h3 class="font-bold text-slate-800 mb-4"><i data-lucide="package" class="w-5 h-5 inline text-purple-600"></i> Laporan Inventaris</h3>

  <%
    let totalValue = 0, lowStockCount = 0;
    inventory.forEach(item => {
      totalValue += (item.buy_price || 0) * (item.stock || 0);
      if (item.stock <= (item.min_stock || 0)) lowStockCount++;
    });
  %>
  <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
    <div class="bg-purple-50 p-3 rounded-xl text-center"><p class="text-xs text-purple-600">Total Item</p><p class="font-extrabold text-lg text-purple-600"><%= inventory.length %></p></div>
    <div class="bg-blue-50 p-3 rounded-xl text-center"><p class="text-xs text-blue-600">Nilai Stok</p><p class="font-extrabold text-lg text-blue-600">Rp <%= totalValue.toLocaleString('id-ID') %></p></div>
    <div class="bg-red-50 p-3 rounded-xl text-center"><p class="text-xs text-red-600">Stok Rendah</p><p class="font-extrabold text-lg text-red-600"><%= lowStockCount %></p></div>
  </div>

  <% if (inventory.length > 0) { %>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead><tr class="bg-slate-50">
        <th class="text-left p-3 font-bold">Nama</th>
        <th class="text-left p-3 font-bold">Kategori</th>
        <th class="text-right p-3 font-bold">Stok</th>
        <th class="text-right p-3 font-bold">Harga Beli</th>
        <th class="text-right p-3 font-bold">Harga Jual</th>
        <th class="text-right p-3 font-bold">Nilai</th>
      </tr></thead>
      <tbody>
        <% inventory.forEach(item => { %>
          <tr class="border-b border-slate-100 <%= item.stock <= (item.min_stock || 0) ? 'bg-red-50' : '' %>">
            <td class="p-3 font-semibold"><%= item.name %></td>
            <td class="p-3 text-xs text-slate-500"><%= item.category || '-' %></td>
            <td class="p-3 text-right font-bold <%= item.stock <= (item.min_stock || 0) ? 'text-red-600' : '' %>"><%= item.stock %></td>
            <td class="p-3 text-right">Rp <%= (item.buy_price || 0).toLocaleString('id-ID') %></td>
            <td class="p-3 text-right">Rp <%= (item.sell_price || 0).toLocaleString('id-ID') %></td>
            <td class="p-3 text-right font-bold">Rp <%= ((item.buy_price || 0) * (item.stock || 0)).toLocaleString('id-ID') %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
    <p class="text-slate-400 text-sm text-center py-8">Belum ada data inventaris</p>
  <% } %>
</div>

<% } else if (tab === 'profitloss') { %>
<!-- Profit / Loss Report -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
  <div class="bg-white rounded-2xl p-5 border border-green-200 shadow-sm text-center">
    <p class="text-xs text-slate-500 mb-1">Total Pemasukan</p>
    <p class="text-2xl font-extrabold text-green-600">Rp <%= (txSummary.totalIncome || 0).toLocaleString('id-ID') %></p>
  </div>
  <div class="bg-white rounded-2xl p-5 border border-red-200 shadow-sm text-center">
    <p class="text-xs text-slate-500 mb-1">Total Pengeluaran</p>
    <p class="text-2xl font-extrabold text-red-600">Rp <%= (txSummary.totalExpense || 0).toLocaleString('id-ID') %></p>
  </div>
  <div class="bg-white rounded-2xl p-5 border shadow-sm text-center <%= ((txSummary.totalIncome || 0) - (txSummary.totalExpense || 0)) >= 0 ? 'border-green-200' : 'border-red-200' %>">
    <p class="text-xs text-slate-500 mb-1">Laba / Rugi Bersih</p>
    <p class="text-2xl font-extrabold <%= ((txSummary.totalIncome || 0) - (txSummary.totalExpense || 0)) >= 0 ? 'text-green-600' : 'text-red-600' %>">
      Rp <%= ((txSummary.totalIncome || 0) - (txSummary.totalExpense || 0)).toLocaleString('id-ID') %>
    </p>
  </div>
</div>

<!-- Detail Transactions -->
<div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
  <h3 class="font-bold text-slate-800 mb-4">Detail Transaksi Bulan Ini</h3>
  <% if (transactions.length > 0) { %>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead><tr class="bg-slate-50">
        <th class="text-left p-3 font-bold">Tanggal</th>
        <th class="text-left p-3 font-bold">Kategori</th>
        <th class="text-left p-3 font-bold">Deskripsi</th>
        <th class="text-left p-3 font-bold">Tipe</th>
        <th class="text-right p-3 font-bold">Jumlah</th>
      </tr></thead>
      <tbody>
        <% transactions.forEach(t => { %>
          <tr class="border-b border-slate-100">
            <td class="p-3 text-xs"><%= new Date(t.created_at).toLocaleDateString('id-ID', {day:'2-digit',month:'short'}) %></td>
            <td class="p-3 font-semibold"><%= t.category %></td>
            <td class="p-3 text-slate-600 text-xs"><%= t.description || '-' %></td>
            <td class="p-3">
              <span class="px-2 py-0.5 rounded-full text-xs <%= t.type === 'income' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' %>"><%= t.type %></span>
            </td>
            <td class="p-3 text-right font-bold <%= t.type === 'income' ? 'text-green-600' : 'text-red-600' %>">
              <%= t.type === 'income' ? '+' : '-' %> Rp <%= (t.amount || 0).toLocaleString('id-ID') %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } else { %>
    <p class="text-slate-400 text-sm text-center py-8">Belum ada transaksi bulan ini</p>
  <% } %>
</div>
<% } %>
