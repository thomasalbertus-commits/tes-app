u<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>iFix Pro Enterprise - Cloud SaaS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Aplikasi POS untuk Service HP & Penjualan - iFix Pro Enterprise">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="iFix Pro">
    
    <!-- Inline PWA Manifest -->
    <link id="manifest-placeholder" rel="manifest">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grad)' rx='20'/%3E%3Ctext x='50' y='70' font-family='Arial' font-size='50' font-weight='bold' fill='white' text-anchor='middle'%3EiF%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' fill='url(%23grad)' rx='40'/%3E%3Ctext x='90' y='120' font-family='Arial' font-size='80' font-weight='bold' fill='white' text-anchor='middle'%3EiF%3C/text%3E%3C/svg%3E">
    
    <script>
        // Generate inline manifest
        const manifestData = {
            name: "iFix Pro - Phone Repair POS",
            short_name: "iFix Pro",
            description: "Sistem POS untuk servis HP dengan fitur multi-branch, inventory, HR & Payroll",
            start_url: window.location.pathname,
            display: "standalone",
            background_color: "#0f172a",
            theme_color: "#2563eb",
            orientation: "any",
            icons: [{
                src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' fill='url(%23grad)' rx='40'/%3E%3Ctext x='96' y='130' font-family='Arial, sans-serif' font-size='90' font-weight='bold' fill='white' text-anchor='middle'%3EiF%3C/text%3E%3C/svg%3E",
                sizes: "192x192",
                type: "image/svg+xml",
                purpose: "any maskable"
            }, {
                src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%231d4ed8;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' fill='url(%23grad)' rx='100'/%3E%3Ctext x='256' y='340' font-family='Arial, sans-serif' font-size='240' font-weight='bold' fill='white' text-anchor='middle'%3EiF%3C/text%3E%3C/svg%3E",
                sizes: "512x512",
                type: "image/svg+xml"
            }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>
    <!-- 
    üî• FIREBASE QUOTA OPTIMIZATION AKTIF üî•
    ========================================
    ‚úÖ enableIndexedDbPersistence dengan synchronizeTabs
    ‚úÖ Cache-first strategy dengan metadata tracking
    ‚úÖ Limit 25 items per collection (turun dari 50)
    ‚úÖ Skip update jika data dari cache dan tidak ada perubahan
    ‚úÖ Pagination client-side untuk hemat reads
    
    Estimasi Penggunaan:
    - 10 user aktif/hari: ~3,000 reads/hari (6% quota)
    - Reload halaman: 0 reads (data dari cache)
    - Multi-tab support: shared cache antar tab
    -->
    
    <!-- 
    ‚ö†Ô∏è  DEPENDENCY VERSIONS LOCKED - DO NOT AUTO-UPDATE ‚ö†Ô∏è
    ================================================================
    Status: PRODUCTION STABLE (Tested & Working - Feb 2026)
    
    CORE LIBRARIES (LOCKED):
    - React: 18.2.0 (Stable - No breaking changes expected)
    - Firebase: 10.7.1 (Tested with persistence & offline)
    - Lucide Icons: 0.263.1 (Icon library)
    - Recharts: 2.12.0 (Charts)
    - HTML2Canvas: 1.4.1 (Export PDF)
    - Babel Standalone: 7.23.6 (JSX compiler)
    - Tailwind CSS: Latest (via CDN - safe to update)
    
    BREAKING CHANGE PROTECTION:
    ‚úÖ All versions pinned to exact numbers
    ‚úÖ Firebase API wrapped with error handling
    ‚úÖ Fallback mechanisms for offline/errors
    ‚úÖ Tested compatibility: React 18.2 + Firebase 10.7
    
    BEFORE UPDATING ANY VERSION:
    1. Test in development environment first
    2. Check changelog for breaking changes
    3. Update ONE library at a time
    4. Verify all features still work
    5. Update this documentation
    
    Last Verified: February 3, 2026
    Risk Level: LOW (All versions locked)
    ================================================================
    -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Libraries (VERSIONS LOCKED) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom-client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1",
        "jspdf": "https://esm.sh/jspdf@2.5.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      body { background-color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .saas-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
      
      /* Animasi Timeline */
      .timeline-line { position: absolute; left: 15px; top: 30px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
      .timeline-item:last-child .timeline-line { display: none; }
      
      /* Animasi Loading */
      .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      @media print {
        .no-print { display: none !important; }
        body { background: white; }
        .print-only { display: block !important; }
        @page { margin: 0; }
      }

      /* Animasi Fade In */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
      
      /* Animasi Scale Up untuk popup */
      @keyframes scaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
      .animate-scale-up { animation: scaleUp 0.3s ease-out forwards; }
      
      /* Sidebar Scrollbar - Custom untuk sidebar agar tidak mengecil */
      .sidebar-scroll::-webkit-scrollbar { width: 4px; }
      .sidebar-scroll::-webkit-scrollbar-track { background: #0f172a; }
      .sidebar-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
      .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }
      .sidebar-scroll { scrollbar-width: thin; scrollbar-color: #334155 #0f172a; }
      
      /* ========================================
         üì± MOBILE RESPONSIVE OPTIMIZATIONS
         ======================================== */
      
      /* Mobile touch targets - min 44px */
      @media (max-width: 767px) {
        /* Sembunyikan scrollbar horizontal di tabel mobile */
        .overflow-x-auto::-webkit-scrollbar { height: 3px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        /* Padding tabel lebih compact di mobile */
        table th, table td { padding: 8px 10px !important; font-size: 12px !important; }
        
        /* Card value text responsive */
        .mobile-value { font-size: 1.25rem !important; }
        
        /* Input & button touch-friendly */
        input, select, textarea { font-size: 16px !important; min-height: 44px; }
        button { min-height: 40px; }
        
        /* Bottom padding untuk bottom nav */
        .mobile-bottom-padding { padding-bottom: 80px !important; }
        
        /* Sidebar mobile overlay */
        .mobile-sidebar { max-width: 85vw !important; }
        
        /* Responsive card grid */
        .mobile-stat-value { font-size: 1.1rem !important; word-break: break-all; }
        
        /* Fix tabel agar tidak terlalu wide */
        .mobile-table-compact th:nth-child(n+4), .mobile-table-compact td:nth-child(n+4) {
          display: none;
        }
        
        /* Floating debug button lebih kecil di mobile */
        #debug-btn { width: 36px !important; height: 36px !important; font-size: 14px !important; bottom: 90px !important; right: 12px !important; opacity: 0.6 !important; }
        #debug-btn:hover { opacity: 1 !important; }
      }
      
      /* Small phone (iPhone SE, Galaxy S8 etc) */
      @media (max-width: 375px) {
        table th, table td { padding: 6px 8px !important; font-size: 11px !important; }
        .text-3xl { font-size: 1.25rem !important; }
        .text-2xl { font-size: 1.1rem !important; }
      }
      
      /* Bottom Navigation Bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: white;
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        padding: 4px 8px;
        padding-bottom: max(4px, env(safe-area-inset-bottom));
        display: none;
      }
      @media (max-width: 767px) {
        .bottom-nav { display: flex; justify-content: space-around; align-items: center; }
      }
      .bottom-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 6px 4px;
        border-radius: 8px;
        transition: all 0.2s;
        min-width: 56px;
        cursor: pointer;
        border: none;
        background: transparent;
        color: #64748b;
        font-size: 9px;
        font-weight: 600;
      }
      .bottom-nav-item.active {
        color: #2563eb;
        background: #eff6ff;
      }
      .bottom-nav-item svg { width: 20px; height: 20px; margin-bottom: 2px; }
      
      /* ========================================
         üíº MOBILE TABLE TO CARD VIEW
         ======================================== */
      @media (max-width: 767px) {
        /* Sembunyikan table normal, tampilkan mobile card stack */
        .mobile-card-wrapper table { display: none; }
        .mobile-card-stack { display: block !important; }
        
        /* Mobile card styles */
        .mobile-card {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .mobile-card-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #f1f5f9;
        }
        .mobile-card-row:last-child { border-bottom: none; }
        .mobile-card-label {
          font-size: 11px;
          font-weight: 700;
          color: #64748b;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }
        .mobile-card-value {
          font-size: 13px;
          font-weight: 600;
          color: #1e293b;
          text-align: right;
          max-width: 60%;
        }
        .mobile-card-actions {
          display: flex;
          gap: 8px;
          margin-top: 12px;
          padding-top: 12px;
          border-top: 1px solid #e2e8f0;
        }
      }
      @media (min-width: 768px) {
        /* Desktop: hide mobile cards, show table */
        .mobile-card-stack { display: none !important; }
      }
      
      /* Safe area untuk notch / gesture area */
      @supports (padding: max(0px)) {
        body { padding-bottom: env(safe-area-inset-bottom); }
      }
      
      /* Swipe hint animation */
      @keyframes swipeHint {
        0%, 100% { transform: translateX(0); opacity: 0.5; }
        50% { transform: translateX(-8px); opacity: 1; }
      }
      .swipe-hint { animation: swipeHint 2s ease-in-out 1; }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-blue-100 selection:text-blue-900">
    <!-- Error Display Container -->
    <div id="error-display" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 999999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: #dc2626;">
                <svg style="width: 32px; height: 32px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #dc2626;">Error Terdeteksi</h2>
            </div>
            <div id="error-content" style="font-family: monospace; font-size: 14px; line-height: 1.6; color: #1f2937; white-space: pre-wrap; word-wrap: break-word; background: #f3f4f6; padding: 15px; border-radius: 4px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
            
            <!-- Diagnostic Info -->
            <details style="margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px;">
                <summary style="cursor: pointer; font-weight: bold; color: #3b82f6; margin-bottom: 10px;">üìä Info Diagnostik (klik untuk lihat)</summary>
                <div id="diagnostic-info" style="font-family: monospace; font-size: 12px; line-height: 1.6; color: #1f2937; white-space: pre-wrap; background: #f9fafb; padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
            </details>
            
            <button onclick="document.getElementById('error-display').style.display='none'" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%;">Tutup</button>
            <button onclick="location.reload()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">Reload Halaman</button>
            <button onclick="navigator.clipboard.writeText(document.getElementById('error-content').textContent + '\\n\\n' + document.getElementById('diagnostic-info').textContent).then(() => alert('‚úÖ Error & diagnostic info berhasil disalin ke clipboard!'))" style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">üìã Copy Error Info</button>
        </div>
    </div>
    
    <!-- Debug Button (Floating) -->
    <button id="debug-btn" style="position: fixed; bottom: 80px; right: 20px; background: #8b5cf6; color: white; border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); z-index: 999998; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
        üêû
    </button>
    
    <div id="root"></div>

    <script>
        // Debug button handler
        document.getElementById('debug-btn').addEventListener('click', function() {
            window.showError('System Info', 'Tidak ada error.\nIni adalah informasi sistem Anda.', null);
        });
        
        document.getElementById('debug-btn').addEventListener('mouseover', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        document.getElementById('debug-btn').addEventListener('mouseout', function() {
            this.style.transform = 'scale(1)';
        });
        
        // ==========================================
        // üîç DIAGNOSTIC INFO (tampil di console)
        // ==========================================
        console.log('==========================================');
        console.log('üöÄ iFix Pro Enterprise - Starting...');
        console.log('==========================================');
        console.log('üì± User Agent:', navigator.userAgent);
        console.log('üåê Browser:', navigator.appName + ' ' + navigator.appVersion);
        console.log('üì∫ Screen:', window.screen.width + 'x' + window.screen.height);
        console.log('ü™ü Viewport:', window.innerWidth + 'x' + window.innerHeight);
        console.log('üåç Online:', navigator.onLine);
        console.log('üíæ LocalStorage:', typeof localStorage !== 'undefined' ? 'Supported' : 'Not Supported');
        console.log('üîß ServiceWorker:', 'serviceWorker' in navigator ? 'Supported' : 'Not Supported');
        console.log('üìÖ Date:', new Date().toLocaleString('id-ID'));
        console.log('==========================================');
        
        // Global Error Handler untuk menampilkan error di halaman
        window.showError = function(title, message, error) {
            const errorDisplay = document.getElementById('error-display');
            const errorContent = document.getElementById('error-content');
            const diagnosticInfo = document.getElementById('diagnostic-info');
            
            let errorText = `üî¥ ${title}\n\n`;
            errorText += `${message}\n\n`;
            
            if (error) {
                errorText += `Error Details:\n`;
                errorText += `${error.toString()}\n\n`;
                
                if (error.stack) {
                    errorText += `Stack Trace:\n${error.stack}`;
                }
            }
            
            errorContent.textContent = errorText;
            
            // Populate diagnostic info
            let diagText = '';
            diagText += `User Agent: ${navigator.userAgent}\n`;
            diagText += `Browser: ${navigator.appName} ${navigator.appVersion}\n`;
            diagText += `Screen: ${window.screen.width}x${window.screen.height}\n`;
            diagText += `Viewport: ${window.innerWidth}x${window.innerHeight}\n`;
            diagText += `Online: ${navigator.onLine}\n`;
            diagText += `LocalStorage: ${typeof localStorage !== 'undefined' ? 'Supported' : 'Not Supported'}\n`;
            diagText += `ServiceWorker: ${'serviceWorker' in navigator ? 'Supported' : 'Not Supported'}\n`;
            diagText += `Cookies: ${navigator.cookieEnabled ? 'Enabled' : 'Disabled'}\n`;
            diagText += `Language: ${navigator.language}\n`;
            diagText += `Platform: ${navigator.platform}\n`;
            diagText += `Date: ${new Date().toLocaleString('id-ID')}\n`;
            diagText += `URL: ${window.location.href}\n`;
            
            diagnosticInfo.textContent = diagText;
            errorDisplay.style.display = 'block';
            
            // Juga log ke console untuk reference
            console.error('‚ùå Error:', title, message, error);
        };
        
        // Catch all unhandled errors
        window.addEventListener('error', function(event) {
            showError(
                'JavaScript Error',
                `File: ${event.filename}\nLine: ${event.lineno}:${event.colno}`,
                event.error
            );
        });
        
        // Catch all unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            showError(
                'Unhandled Promise Rejection',
                'Promise ditolak tanpa error handler',
                event.reason
            );
        });
        
        // Loading indicator
        window.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM loaded');
            
            // Check if React loaded
            setTimeout(function() {
                const root = document.getElementById('root');
                if (!root.hasChildNodes()) {
                    showError(
                        'React Tidak Load',
                        'React tidak berhasil merender aplikasi.\nPeriksa koneksi internet atau kompabilitas browser.',
                        new Error('Root div kosong setelah 5 detik')
                    );
                }
            }, 5000);
            
            // Monitor network status
            if (!navigator.onLine) {
                showError(
                    'Tidak Ada Koneksi Internet',
                    'Perangkat Anda sedang offline.\nPastikan koneksi internet aktif.',
                    new Error('navigator.onLine = false')
                );
            }
            
            window.addEventListener('online', function() {
                console.log('‚úÖ Kembali online');
                const errorDisplay = document.getElementById('error-display');
                if (errorDisplay.style.display === 'block') {
                    if (confirm('Koneksi internet kembali. Reload halaman?')) {
                        location.reload();
                    }
                }
            });
            
            window.addEventListener('offline', function() {
                console.log('‚ö†Ô∏è Offline');
                showError(
                    'Koneksi Internet Terputus',
                    'Perangkat kehilangan koneksi internet.\nBeberapa fitur mungkin tidak tersedia.',
                    new Error('Connection lost')
                );
            });
        });
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useContext, createContext, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom-client';
        import { 
          LayoutDashboard, Smartphone, Box, Wallet, FileText, Users, Settings, 
          LogOut, Plus, Search, Store, ChevronDown, Check, Lock, ShieldCheck, MapPin,
          Printer, Share2, X, Save, Menu, CheckCircle, AlertTriangle, Trash2, 
          Upload, Download, RefreshCw, Copy, Wrench, PackagePlus, PenTool, 
          MessageCircle, Calendar, Clock, DollarSign, CreditCard, Image as ImageIcon, 
          ArrowUpRight, ArrowDownRight, Activity, TrendingUp, TrendingDown, ToggleLeft, Globe, Eye, UserX, Key,
          ShieldAlert, Shield, Building, Database, HardDriveDownload, HardDriveUpload, Layers,
          Loader2, LogIn, UserPlus, RefreshCcw, SearchX, Truck, CheckCheck, Pencil,
          Hash, Edit3, Filter, MinusCircle, Crown, Minus, History, Tag,
          Zap, BarChart3, Info, ShoppingCart, Banknote, Phone, Mail, RotateCcw, RotateCw, Package
        } from 'lucide-react';
        import { 
          BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, 
          AreaChart, Area, PieChart, Pie
        } from 'recharts';
        import html2canvas from 'html2canvas';
        import { jsPDF } from 'jspdf';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp, deleteApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            signInAnonymously,
            setPersistence,
            browserLocalPersistence,
            browserSessionPersistence
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            deleteDoc, 
            getDocs,
            query, 
            where, 
            onSnapshot, 
            orderBy, 
            serverTimestamp, 
            writeBatch, 
            runTransaction, 
            increment, 
            limit,
            enableIndexedDbPersistence, 
            Timestamp
        } from 'firebase/firestore';

        // Tambahkan debug untuk check imports Firebase
        console.log('üîß Firebase imports check:', {
            query: typeof query,
            where: typeof where,
            collection: typeof collection,
            onSnapshot: typeof onSnapshot
        });
        
        // Pastikan semua Firebase functions tersedia
        if (typeof query !== 'function') {
            console.error('‚ùå Firebase query function not available!');
            throw new Error('Firebase query import failed');
        }
        
        // Global error handler for any remaining Firebase issues
        const originalConsoleError = console.error;
        console.error = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('query is not a function')) {
                console.warn('üîç Caught query function error - checking imports...');
                originalConsoleError.apply(this, ['üîç Firebase function availability:', {
                    query: typeof query,
                    where: typeof where, 
                    collection: typeof collection
                }]);
            }
            originalConsoleError.apply(this, args);
        };
        // ==========================================
        // Wrapper untuk protect dari breaking changes di Firebase API
        // Jika Firebase update dan API berubah, kita bisa handle di sini
        const FirebaseAPI = {
            // Firestore operations dengan error handling
            async safeGetDoc(ref) {
                try {
                    return await getDoc(ref);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase getDoc error:', error);
                    if (error.code === 'unavailable') {
                        throw new Error('Koneksi Firebase tidak tersedia. Cek internet Anda.');
                    }
                    throw error;
                }
            },
            
            async safeSetDoc(ref, data, options) {
                try {
                    return await setDoc(ref, data, options);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase setDoc error:', error);
                    if (error.code === 'permission-denied') {
                        throw new Error('Akses ditolak. Periksa permission Firestore.');
                    }
                    throw error;
                }
            },
            
            async safeAddDoc(collectionRef, data) {
                try {
                    return await addDoc(collectionRef, data);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase addDoc error:', error);
                    throw error;
                }
            },
            
            async safeGetDocs(queryRef) {
                try {
                    return await getDocs(queryRef);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase getDocs error:', error);
                    throw error;
                }
            },
            
            async safeUpdateDoc(ref, data) {
                try {
                    return await updateDoc(ref, data);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase updateDoc error:', error);
                    throw error;
                }
            },
            
            async safeDeleteDoc(ref) {
                try {
                    return await deleteDoc(ref);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase deleteDoc error:', error);
                    throw error;
                }
            },
            
            // Auth operations
            async safeSignIn(email, password) {
                try {
                    return await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase signIn error:', error);
                    if (error.code === 'auth/wrong-password') {
                        throw new Error('Password salah');
                    } else if (error.code === 'auth/user-not-found') {
                        throw new Error('User tidak ditemukan');
                    } else if (error.code === 'auth/too-many-requests') {
                        throw new Error('Terlalu banyak percobaan. Coba lagi nanti.');
                    }
                    throw error;
                }
            },
            
            // Version info untuk tracking
            getVersionInfo() {
                return {
                    firebase: '10.7.1',
                    react: '18.2.0',
                    status: 'locked',
                    lastVerified: '2026-02-03'
                };
            }
        };
        
        // Export untuk logging
        console.log('üõ°Ô∏è Firebase Protection Layer Active:', FirebaseAPI.getVersionInfo());

        // ==========================================
        // ÔøΩüî• FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDSUuxkMkNru9ShYapB9qDdcM1Zq_A1jZo",
            authDomain: "ifix-enterprise.firebaseapp.com",
            projectId: "ifix-enterprise",
            storageBucket: "ifix-enterprise.firebasestorage.app",
            messagingSenderId: "954001235629",
            appId: "1:954001235629:web:0cf28c5eeff9041e3ff024",
            measurementId: "G-RL6W0BGZDM"
        };

        // Initialize Firebase dengan error handling
        let app, auth, db;
        try {
            console.log('üîÑ Initializing Firebase...');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            window.showError(
                'Firebase Initialization Error',
                'Gagal menginisialisasi Firebase.\nPeriksa koneksi internet atau konfigurasi.',
                error
            );
            throw error;
        }
        
        // Enable offline persistence dengan error recovery
        // Cache ini akan menyimpan data di browser, sehingga reload halaman tidak mengambil dari server
        (async () => {
            try {
                // Try with synchronizeTabs first (best for multi-tab)
                await enableIndexedDbPersistence(db, {
                    synchronizeTabs: true
                });
                console.log('‚úÖ Firebase Offline Persistence AKTIF - Multi-tab sync enabled');
            } catch (err) {
                if (err.code === 'failed-precondition') {
                    console.warn('‚ö†Ô∏è Multi-tab persistence already active in another tab');
                    // This is OK - another tab has persistence enabled
                } else if (err.code === 'unimplemented') {
                    console.warn('‚ö†Ô∏è Persistence tidak didukung di browser ini');
                } else {
                    // Try fallback without synchronizeTabs
                    console.warn('‚ö†Ô∏è Falling back to single-tab persistence due to:', err.message);
                    try {
                        await enableIndexedDbPersistence(db, {
                            forceOwnership: true
                        });
                        console.log('‚úÖ Firebase Offline Persistence AKTIF - Single-tab mode');
                    } catch (fallbackErr) {
                        console.error('‚ùå Persistence completely failed:', fallbackErr);
                        // App will still work without persistence, just no offline cache
                        console.log('‚ÑπÔ∏è Aplikasi tetap berjalan tanpa offline cache');
                    }
                }
            }
        })();

        // ==========================================
        // üßπ CLEANUP & ERROR RECOVERY
        // ==========================================
        // Track active listeners for cleanup
        window.firestoreListeners = new Set();
        
        // Global error handler for Firestore internal assertions
        window.addEventListener('error', (event) => {
            if (event.error && event.error.message && event.error.message.includes('FIRESTORE') && event.error.message.includes('INTERNAL ASSERTION FAILED')) {
                console.warn('üî¥ Firestore internal error suppressed:', event.error.message);
                event.preventDefault(); // Prevent error from crashing app
                return false;
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            if (event.reason && event.reason.message && event.reason.message.includes('FIRESTORE') && event.reason.message.includes('INTERNAL ASSERTION FAILED')) {
                console.warn('üî¥ Firestore internal rejection suppressed:', event.reason.message);
                event.preventDefault(); // Prevent unhandled rejection
            }
        });
        
        // Cleanup on page unload to prevent "Unexpected state" errors
        window.addEventListener('beforeunload', () => {
            // Cleanup all active Firestore listeners
            if (window.firestoreListeners) {
                window.firestoreListeners.forEach(unsubscribe => {
                    try {
                        if (typeof unsubscribe === 'function') unsubscribe();
                    } catch (e) {
                        // Ignore cleanup errors
                    }
                });
                window.firestoreListeners.clear();
            }
        });

        // Handle visibility change to prevent issues when tab is inactive
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                console.log('üì± Tab hidden - Firestore listeners paused');
            } else {
                console.log('üì± Tab visible - Firestore listeners active');
            }
        });

        // ==========================================
        // üöÄ PWA SERVICE WORKER REGISTRATION
        // ==========================================
        window.deferredPrompt = null;

        // Check PWA install state
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('PWA: Already installed');
        } else {
            console.log('PWA: Running in browser, installable');
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            window.dispatchEvent(new Event('pwa-installable'));
            console.log('PWA: Install prompt available');
        });

        // Hide button when app is installed
        window.addEventListener('appinstalled', () => {
            window.deferredPrompt = null;
            window.dispatchEvent(new Event('pwa-installed'));
            console.log('PWA: Successfully installed');
        });

        // ==========================================
        // üîß SERVICE WORKER
        // ==========================================
        // Inline Service Worker (no external file needed)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'ifix-pro-v1';
                    self.addEventListener('install', e => {
                        console.log('SW: Installed');
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', e => {
                        console.log('SW: Activated');
                        self.clients.claim();
                    });
                    self.addEventListener('fetch', e => {
                        e.respondWith(
                            fetch(e.request).catch(() => caches.match(e.request))
                        );
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                
                navigator.serviceWorker.register(swUrl).then(reg => {
                    console.log('PWA: Service Worker registered');
                }).catch(err => {
                    console.log('PWA: SW registration skipped (OK for development)');
                });
            });
        } else {
            console.log('PWA: Service Worker not supported');
        }

        // Constants
        const SUPERADMIN_EMAIL = "agis.cpcd@gmail.com";
        const APP_COLLECTION_PREFIX = "ifix_enterprise_data"; 
        
        // ==========================================
        // üõ†Ô∏è UTILS
        // ==========================================
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        
        // Number formatter untuk input dengan separator ribuan
        const formatNumberWithSeparator = (value) => {
            if (!value) return '';
            const num = value.toString().replace(/\D/g, '');
            if (!num) return '';
            return new Intl.NumberFormat('id-ID').format(num);
        };
        
        const parseNumberFromInput = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\D/g, '')) || 0;
        };

        // ==========================================
        // üìÑ PAGINATION COMPONENT (Reusable)
        // ==========================================
        const Pagination = ({ currentPage, totalPages, totalItems, startIndex, endIndex, onPageChange, itemsPerPage, onItemsPerPageChange }) => {
            if (totalPages <= 1) return null;
            
            return (
                <div className="space-y-4">
                    {/* Items per page controls */}
                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => onItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => onItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                                <button onClick={() => onItemsPerPageChange(50)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 50 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>50</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                    </div>
                    
                    {/* Navigation */}
                    <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <button 
                            onClick={() => onPageChange(currentPage - 1)} 
                            disabled={currentPage === 1}
                            className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                        >
                            ‚Üê Sebelumnya
                        </button>
                        <div className="text-sm text-slate-600 font-medium">
                            Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                        </div>
                        <button 
                            onClick={() => onPageChange(currentPage + 1)} 
                            disabled={currentPage === totalPages}
                            className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                        >
                            Selanjutnya ‚Üí
                        </button>
                    </div>
                </div>
            );
        };
        
        // Custom number input component
        const NumberInput = ({ value, onChange, placeholder, className, name, ...props }) => {
            const [displayValue, setDisplayValue] = React.useState('');
            const [numericValue, setNumericValue] = React.useState(0);
            
            React.useEffect(() => {
                if (value || value === 0) {
                    setDisplayValue(formatNumberWithSeparator(value));
                    setNumericValue(value);
                } else {
                    setDisplayValue('');
                    setNumericValue(0);
                }
            }, [value]);
            
            const handleChange = (e) => {
                const input = e.target.value;
                const parsed = parseNumberFromInput(input);
                
                // Update display value dengan separator
                setDisplayValue(formatNumberWithSeparator(parsed));
                setNumericValue(parsed);
                
                // Call onChange dengan angka asli
                if (onChange) {
                    onChange(parsed);
                }
            };
            
            return (
                <>
                    <input
                        type="text"
                        inputMode="numeric"
                        value={displayValue}
                        onChange={handleChange}
                        placeholder={placeholder || '0'}
                        className={className}
                        {...props}
                    />
                    {name && <input type="hidden" name={name} value={numericValue} />}
                </>
            );
        };
        
        const formatDate = (timestamp) => {
          if (!timestamp) return '-';
          let date;
          if (timestamp?.seconds) {
             date = new Date(timestamp.seconds * 1000);
          } else {
             date = new Date(timestamp);
          }
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const generateToken = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const STATUS_FLOW = ['Diterima', 'Diagnosa', 'Menunggu Sparepart', 'Selesai', 'Dibatalkan'];

        const formatWhatsAppNumber = (phone) => {
            if (!phone) return '';
            let p = phone.toString().replace(/\D/g, ''); 
            if (p.startsWith('0')) {
                p = '62' + p.substring(1);
            } else if (p.startsWith('8')) {
                p = '62' + p;
            }
            return p;
        };

        const handleShareProgress = (service) => {
            const formattedPhone = formatWhatsAppNumber(service.phone);
            
            if (!formattedPhone) {
                alert("‚ö†Ô∏è Nomor WA pelanggan kosong atau tidak valid!");
                return;
            }

            // Build detailed progress message
            const publicLink = `${window.location.origin}${window.location.pathname}?track=${service.id}`;
            
            let progressMessage = `Halo Kak ${service.customerName}! üëã\n\n`;
            progressMessage += `üì± *Update Progress Servis HP*\n`;
            progressMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            progressMessage += `üÜî *Token:* ${service.token}\n`;
            progressMessage += `üì± *HP:* ${service.unitType || service.deviceType || '-'}\n`;
            progressMessage += `üîß *Keluhan:* ${service.complaint || service.problem || '-'}\n`;
            progressMessage += `‚öôÔ∏è *Status:* ${service.status}\n\n`;
            progressMessage += `üí∞ *Biaya Servis:* ${formatCurrency(service.costEstimate)}\n`;
            
            // Add payment status
            const paid = parseFloat(service.dp) || 0;
            const total = parseFloat(service.costEstimate) || 0;
            const remaining = total - paid;
            
            if (service.paymentStatus === 'Lunas') {
                progressMessage += `‚úÖ *Status Bayar:* LUNAS\n\n`;
            } else if (service.paymentStatus === 'DP') {
                progressMessage += `‚è≥ *Status Bayar:* DP ${formatCurrency(paid)}\n`;
                progressMessage += `üí≥ *Sisa Bayar:* ${formatCurrency(remaining)}\n\n`;
            } else {
                progressMessage += `‚è≥ *Status Bayar:* Belum Dibayar\n\n`;
            }
            
            progressMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            progressMessage += `üîó *Cek Progress Realtime:*\n${publicLink}\n\n`;
            progressMessage += `‚ú® Terimakasih telah mempercayakan servis HP kepada kami. Kami berkomitmen memberikan yang terbaik! üôè`;
            
            const encodedMessage = encodeURIComponent(progressMessage);
            const waLink = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(waLink, '_blank');
        };

        const handleShareInvoiceToWA = async (service) => {
            const formattedPhone = formatWhatsAppNumber(service.phone);
            
            if (!formattedPhone) {
                alert("‚ö†Ô∏è Nomor WA pelanggan kosong atau tidak valid!");
                return;
            }

            // Generate invoice image FIRST
            setCaptureData(service);
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            try {
                const element = document.getElementById('invoice-capture');
                if (!element) {
                    alert("Gagal membuat invoice");
                    setCaptureData(null);
                    return;
                }

                const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff' });
                canvas.toBlob(async (blob) => {
                    setCaptureData(null);
                    
                    try {
                        const file = new File([blob], `Invoice-${service.token}.jpg`, { type: 'image/jpeg' });
                        
                        // Use native share API (mobile) - file will be attached, user just tap send
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: `Invoice ${service.customerName}`,
                                text: `Invoice servis untuk ${service.customerName}\nToken: ${service.token}`
                            });
                            return;
                        }
                        
                        // Desktop fallback: copy to clipboard then open WhatsApp
                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                const item = new ClipboardItem({ 'image/jpeg': blob });
                                await navigator.clipboard.write([item]);
                                
                                // Open WhatsApp after copying
                                const waLink = `https://wa.me/${formattedPhone}`;
                                window.open(waLink, '_blank');
                                
                                alert('‚úÖ Invoice sudah di-copy!\n\nPaste ke chat WA dengan Ctrl+V atau klik kanan > Paste');
                            } catch (err) {
                                // Fallback: download file
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = `Invoice-${service.token}.jpg`;
                                link.click();
                                
                                const waLink = `https://wa.me/${formattedPhone}`;
                                window.open(waLink, '_blank');
                                
                                alert('üì• Invoice sudah di-download!\n\nKirim file dari folder download ke chat WA');
                            }
                        }
                        
                    } catch (err) {
                        console.error('Share error:', err);
                    }
                }, 'image/jpeg', 0.95);
                
            } catch (err) {
                setCaptureData(null);
                console.error('Canvas error:', err);
            }
        };

        const showAccessDenied = (msg = "Akses Ditolak") => {
            alert(`üîí ${msg}`);
        };

        const normalizeFirestoreData = (data) => {
            if (!data) return data;
            if (typeof data === 'object') {
                if (data.seconds !== undefined && data.nanoseconds !== undefined) {
                    return new Date(data.seconds * 1000);
                }
                if (Array.isArray(data)) {
                    return data.map(normalizeFirestoreData);
                }
                const newItem = {};
                Object.keys(data).forEach(key => {
                    newItem[key] = normalizeFirestoreData(data[key]);
                });
                return newItem;
            }
            if (typeof data === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(data)) {
                const d = new Date(data);
                if (!isNaN(d.getTime())) return d;
            }
            return data;
        };

        const recalculateServicePayment = async (serviceId, ownerId) => {
            if (!serviceId) return;
            try {
                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                const serviceSnap = await getDoc(serviceRef);
                if (!serviceSnap.exists()) return;
                const serviceData = serviceSnap.data();

                const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                const q = query(transRef, where('serviceId', '==', serviceId));
                const transSnap = await getDocs(q);
                
                let totalPaid = 0;
                transSnap.docs.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'income') totalPaid += (parseFloat(t.amount) || 0);
                });

                let paymentStatus = 'Belum Lunas';
                if (totalPaid >= (serviceData.costEstimate || 0) && (serviceData.costEstimate || 0) > 0) paymentStatus = 'Lunas';
                else if (totalPaid > 0) paymentStatus = 'DP';

                await updateDoc(serviceRef, {
                    dp: totalPaid,
                    paymentStatus: paymentStatus
                });
                console.log(`Service ${serviceId} synced. Total Paid: ${totalPaid}`);
            } catch (err) {
                console.error("Error syncing payment:", err);
            }
        };

        // ==========================================
        // ‚öõÔ∏è CONTEXT & HOOKS
        // ==========================================
        const SessionContext = createContext(null);
        const ToastContext = createContext(null);

        // ==========================================
        // üí∞ GLOBAL CASH ACCOUNTS HOOK & COMPONENT
        // ==========================================
        const useCashAccounts = (ownerId, storeId) => {
            const [cashAccounts, setCashAccounts] = useState([]);
            useEffect(() => {
                if (!ownerId) return;
                const accountsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts');
                let q = query(accountsRef, where('ownerId', '==', ownerId));
                if (storeId && storeId !== 'all') {
                    q = query(accountsRef, where('ownerId', '==', ownerId), where('storeId', '==', storeId));
                }
                const unsub = onSnapshot(q, (snap) => {
                    setCashAccounts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
                    unsub();
                };
            }, [ownerId, storeId]);
            return ['Kas Tunai', ...cashAccounts.map(a => a.name)];
        };

        const CashAccountSelect = ({ value, onChange, label, className = '' }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const accounts = useCashAccounts(activeOwner?.id, activeStore?.id);
            return (
                <div className={className}>
                    <label className="text-xs font-bold text-slate-500 block mb-1">{label || 'Masuk/Keluar dari Kas'}</label>
                    <select value={value || 'Kas Tunai'} onChange={e => onChange(e.target.value)} className="w-full border border-slate-300 p-2 rounded-lg text-sm">
                        {accounts.map(a => <option key={a} value={a}>{a === 'Kas Tunai' ? 'üíµ ' + a : 'üè¶ ' + a}</option>)}
                    </select>
                </div>
            );
        };

        // Toast Notification System
        const Toast = ({ message, type = 'info', duration = 3000, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, duration);
                return () => clearTimeout(timer);
            }, [duration, onClose]);

            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
                sync: 'bg-purple-500'
            }[type] || 'bg-blue-500';

            return (
                <div className={`${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in`}>
                    {type === 'success' && <Check className="w-4 h-4"/>}
                    {type === 'error' && <X className="w-4 h-4"/>}
                    {type === 'warning' && <AlertTriangle className="w-4 h-4"/>}
                    {type === 'sync' && <RefreshCw className="w-4 h-4 animate-spin"/>}
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            
            const showToast = (message, type = 'info', duration = 3000) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type, duration }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="fixed bottom-6 right-6 space-y-2 z-[999]">
                        {toasts.map(toast => (
                            <Toast 
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                duration={toast.duration}
                                onClose={() => removeToast(toast.id)}
                            />
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => {
            const context = useContext(ToastContext);
            if (!context) throw new Error('useToast must be used within ToastProvider');
            return context;
        };

        // Hook untuk monitor perubahan akses real-time
        const useAccessNotification = (userProfile) => {
            const { showToast } = useToast();
            const lastNotificationRef = useRef(null);

            useEffect(() => {
                if (!userProfile?.id || userProfile?.role === 'superadmin') return;

                const userRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'users', userProfile.id);
                
                const unsubscribe = onSnapshot(userRef, (docSnap) => {
                    if (!docSnap.exists()) return;
                    
                    const userData = docSnap.data();
                    const notification = userData?.notification;
                    
                    // Jika ada notifikasi baru tentang akses yang berubah
                    if (notification?.type === 'access_updated' && 
                        !notification?.acknowledged &&
                        lastNotificationRef.current !== notification?.timestamp) {
                        
                        lastNotificationRef.current = notification?.timestamp;
                        showToast(
                            'üîÑ Hak akses Anda telah diperbarui oleh Superadmin. Beberapa fitur mungkin terkunci.',
                            'sync',
                            4000
                        );
                        
                        // Mark notification as acknowledged
                        updateDoc(userRef, {
                            'notification.acknowledged': true
                        }).catch(e => console.error('Failed to acknowledge notification:', e));
                    }
                }, (error) => {
                    console.error('Error monitoring access notifications:', error);
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);

                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
                    unsubscribe();
                };
            }, [userProfile?.id, userProfile?.role, showToast]);
        };

        // ==========================================
        // üìä FIREBASE QUOTA TRACKING SYSTEM
        // ==========================================
        const QuotaTrackingContext = createContext();
        
        const QuotaTrackingProvider = ({children}) => {
            const [quotaStats, setQuotaStats] = useState(() => {
                const saved = localStorage.getItem('firebase_quota_stats');
                return saved ? JSON.parse(saved) : {
                    totalReads: 0,
                    cacheHits: 0,
                    serverReads: 0,
                    totalWrites: 0,
                    totalUpdates: 0,
                    totalDeletes: 0,
                    byCollection: {},
                    byCollectionWrites: {},
                    dailyStats: {},
                    lastReset: new Date().toISOString().split('T')[0]
                };
            });
            
            const trackRead = useCallback((collectionName, fromCache, count = 1) => {
                setQuotaStats(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Reset jika hari berbeda
                    if (prev.lastReset !== today) {
                        return {
                            totalReads: fromCache ? 0 : count,
                            cacheHits: fromCache ? count : 0,
                            serverReads: fromCache ? 0 : count,
                            totalWrites: 0,
                            totalUpdates: 0,
                            totalDeletes: 0,
                            byCollection: { [collectionName]: fromCache ? 0 : count },
                            byCollectionWrites: {},
                            dailyStats: {
                                ...prev.dailyStats,
                                [prev.lastReset]: {
                                    totalReads: prev.totalReads,
                                    serverReads: prev.serverReads,
                                    cacheHits: prev.cacheHits,
                                    totalWrites: prev.totalWrites,
                                    totalUpdates: prev.totalUpdates,
                                    totalDeletes: prev.totalDeletes
                                }
                            },
                            lastReset: today
                        };
                    }
                    
                    const updated = {
                        ...prev,
                        totalReads: prev.totalReads + count,
                        cacheHits: fromCache ? prev.cacheHits + count : prev.cacheHits,
                        serverReads: fromCache ? prev.serverReads : prev.serverReads + count,
                        byCollection: {
                            ...prev.byCollection,
                            [collectionName]: (prev.byCollection[collectionName] || 0) + (fromCache ? 0 : count)
                        }
                    };
                    
                    localStorage.setItem('firebase_quota_stats', JSON.stringify(updated));
                    return updated;
                });
            }, []);
            
            const trackWrite = useCallback((collectionName, operation = 'write', count = 1) => {
                setQuotaStats(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Reset jika hari berbeda
                    if (prev.lastReset !== today) {
                        return {
                            ...prev,
                            totalReads: prev.totalReads || 0,
                            cacheHits: prev.cacheHits || 0,
                            serverReads: prev.serverReads || 0,
                            totalWrites: operation === 'write' ? count : 0,
                            totalUpdates: operation === 'update' ? count : 0,
                            totalDeletes: operation === 'delete' ? count : 0,
                            byCollectionWrites: { [collectionName]: count },
                            dailyStats: {
                                ...prev.dailyStats,
                                [prev.lastReset]: {
                                    totalReads: prev.totalReads,
                                    serverReads: prev.serverReads,
                                    cacheHits: prev.cacheHits,
                                    totalWrites: prev.totalWrites,
                                    totalUpdates: prev.totalUpdates,
                                    totalDeletes: prev.totalDeletes
                                }
                            },
                            lastReset: today
                        };
                    }
                    
                    const updated = {
                        ...prev,
                        totalWrites: operation === 'write' ? (prev.totalWrites || 0) + count : (prev.totalWrites || 0),
                        totalUpdates: operation === 'update' ? (prev.totalUpdates || 0) + count : (prev.totalUpdates || 0),
                        totalDeletes: operation === 'delete' ? (prev.totalDeletes || 0) + count : (prev.totalDeletes || 0),
                        byCollectionWrites: {
                            ...prev.byCollectionWrites,
                            [collectionName]: ((prev.byCollectionWrites || {})[collectionName] || 0) + count
                        }
                    };
                    
                    localStorage.setItem('firebase_quota_stats', JSON.stringify(updated));
                    return updated;
                });
            }, []);
            
            const resetStats = useCallback(() => {
                const reset = {
                    totalReads: 0,
                    cacheHits: 0,
                    serverReads: 0,
                    totalWrites: 0,
                    totalUpdates: 0,
                    totalDeletes: 0,
                    byCollection: {},
                    byCollectionWrites: {},
                    dailyStats: {},
                    lastReset: new Date().toISOString().split('T')[0]
                };
                setQuotaStats(reset);
                localStorage.setItem('firebase_quota_stats', JSON.stringify(reset));
            }, []);
            
            return (
                <QuotaTrackingContext.Provider value={{ quotaStats, trackRead, trackWrite, resetStats }}>
                    {children}
                </QuotaTrackingContext.Provider>
            );
        };
        
        const useQuotaTracking = () => useContext(QuotaTrackingContext);
        
        // Helper functions untuk track writes otomatis
        const trackedAddDoc = async (collectionRef, data, quotaContext) => {
            const result = await addDoc(collectionRef, data);
            if (quotaContext) {
                const collectionName = collectionRef.path.split('/').pop();
                quotaContext.trackWrite(collectionName, 'write', 1);
            }
            return result;
        };
        
        const trackedUpdateDoc = async (docRef, data, quotaContext) => {
            const result = await updateDoc(docRef, data);
            if (quotaContext) {
                const collectionName = docRef.path.split('/')[docRef.path.split('/').length - 2];
                quotaContext.trackWrite(collectionName, 'update', 1);
            }
            return result;
        };
        
        const trackedDeleteDoc = async (docRef, quotaContext) => {
            const result = await deleteDoc(docRef);
            if (quotaContext) {
                const collectionName = docRef.path.split('/')[docRef.path.split('/').length - 2];
                quotaContext.trackWrite(collectionName, 'delete', 1);
            }
            return result;
        };

        const useFirestoreCollection = (collectionName, ownerId, storeId) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fromCache, setFromCache] = useState(false);
            const quotaContext = useContext(QuotaTrackingContext);

            useEffect(() => {
                if (!collectionName) {
                    setLoading(false);
                    return;
                }
                
                // Safety check for Firebase functions
                if (typeof query !== 'function' || typeof collection !== 'function') {
                    console.error('‚ùå Firebase functions not available:', {query: typeof query, collection: typeof collection});
                    setLoading(false);
                    setData([]);
                    return;
                }
                
                let unsubscribeRef = null;
                let isMounted = true;
                
                const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', collectionName);
                
                // Untuk transactions, ambil semua data (no limit) agar keuntungan bisa ditampilkan
                // Untuk collection lain, gunakan limit 25 untuk lebih hemat
                const hasLimit = collectionName !== 'transactions';
                const limitCount = 25;
                
                // Query builder dengan fallback jika orderBy butuh index yang belum ada
                let q;
                if (ownerId) { 
                    try {
                        const constraints = [where('ownerId', '==', ownerId), orderBy('createdAt', 'desc')];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    } catch (e) {
                        console.warn(`OrderBy failed untuk ${collectionName}, fallback...`);
                        const constraints = [where('ownerId', '==', ownerId)];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    }
                } else {
                    try {
                        const constraints = [orderBy('createdAt', 'desc')];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    } catch (e) {
                        console.warn(`OrderBy failed untuk ${collectionName}, fallback...`);
                        const constraints = [];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    }
                }
                
                const setupListener = (queryObj, isFallback = false) => {
                    const unsub = onSnapshot(queryObj, { 
                        includeMetadataChanges: false,
                        // Optimize for less network usage
                        source: 'default'
                    }, (snapshot) => {
                        if (!isMounted) return;
                        
                        // Deteksi apakah data dari cache (offline) atau server
                        const source = snapshot.metadata.fromCache ? 'cache' : 'server';
                        setFromCache(snapshot.metadata.fromCache);
                        
                        // Track quota usage
                        if (quotaContext && !snapshot.metadata.hasPendingWrites) {
                            quotaContext.trackRead(collectionName, snapshot.metadata.fromCache, snapshot.docs.length);
                        }
                        
                        let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        let filtered = items;
                        // Only filter by storeId if storeId is provided AND not null (null means "Semua"/all stores)
                        if (storeId !== undefined && storeId !== null) { 
                            filtered = filtered.filter(item => item.storeId === storeId); 
                        }
                        
                        // Client-side sort sebagai fallback
                        filtered.sort((a, b) => {
                            const tA = a.createdAt?.seconds || a.date?.seconds || 0;
                            const tB = b.createdAt?.seconds || b.date?.seconds || 0;
                            return tB - tA;
                        });
                        
                        setData(filtered);
                        setLoading(false);
                    }, (error) => {
                        if (!isMounted) return;
                        console.error(`Error fetching ${collectionName}:`, error);
                        
                        if (!isFallback) {
                            // Try fallback query without orderBy
                            const fallbackQ = ownerId 
                                ? query(colRef, where('ownerId', '==', ownerId))
                                : query(colRef);
                            
                            // Clean up current listener
                            if (unsubscribeRef) {
                                unsubscribeRef();
                            }
                            
                            // Setup fallback listener
                            unsubscribeRef = setupListener(fallbackQ, true);
                        } else {
                            console.error(`Fallback query failed untuk ${collectionName}:`, error);
                            setData([]);
                            setLoading(false);
                        }
                    });
                    
                    // Track listener for cleanup
                    if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                    
                    return unsub;
                };
                
                // Setup main listener
                unsubscribeRef = setupListener(q);
                
                return () => {
                    isMounted = false;
                    if (unsubscribeRef) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribeRef);
                        unsubscribeRef();
                    }
                };
            }, [collectionName, ownerId, storeId]);
            return { data, loading, fromCache };
        };

        
// ==========================================
// üîÑ REALTIME SYNC PLAN -> OWNER (OPTIONAL)
// ==========================================
// Jika owner.autoSyncPlan === true,
// maka perubahan plan_configs akan langsung update accessRights owner
const useRealtimePlanSync = (activeOwner) => {
  React.useEffect(() => {
    if (!activeOwner?.autoSyncPlan) return;
    if (!activeOwner?.plan || !activeOwner?.id) return;

    const unsub = onSnapshot(
      doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', activeOwner.plan),
      async (snap) => {
        if (!snap.exists()) return;
        try {
          await updateDoc(
            doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', activeOwner.id),
            { accessRights: snap.data() }
          );
          console.log('Owner accessRights synced with plan:', activeOwner.plan);
        } catch (e) {
          console.error('Sync plan error', e);
        }
      },
      (error) => {
        console.error('Plan sync listener error:', error);
      }
    );
    
    if (window.firestoreListeners) window.firestoreListeners.add(unsub);
    return () => {
      if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
      unsub();
    };
  }, [activeOwner?.id, activeOwner?.plan, activeOwner?.autoSyncPlan]);
};


const SessionProvider = ({ children }) => {
            const [authUser, setAuthUser] = useState(null); 
            const [userProfile, setUserProfile] = useState(null); 
            const [activeOwner, setActiveOwner] = useState(null); 
            const [activeStore, setActiveStore] = useState(null); 
            const [availableStores, setAvailableStores] = useState([]);
            const [ownerAccess, setOwnerAccess] = useState({});
            const [storeConfig, setStoreConfig] = useState({});
            const [adminWhatsApp, setAdminWhatsApp] = useState('');
            const [loading, setLoading] = useState(true);
            const ownerUnsubRef = useRef(null);
            const storesUnsubRef = useRef(null);
            const storeConfigUnsubRef = useRef(null);

            // Load admin WA number from subscription config
            useEffect(() => {
                const unsub = onSnapshot(
                    doc(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config', 'settings'),
                    (snap) => { 
                        if (snap.exists()) {
                            const data = snap.data();
                            const wa = data.whatsapp || '';
                            console.log('üìû Admin WhatsApp loaded:', wa);
                            setAdminWhatsApp(wa);
                        } else {
                            console.log('‚ö†Ô∏è Subscription config document not found');
                        }
                    }
                );
                if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                return () => { if (window.firestoreListeners) window.firestoreListeners.delete(unsub); unsub(); };
            }, []);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setAuthUser(currentUser);
                    if (currentUser && !currentUser.isAnonymous) {
                        await fetchUserProfile(currentUser.email);
                    } else {
                        setUserProfile(null);
                        setActiveOwner(null);
                        setActiveStore(null);
                        if(ownerUnsubRef.current) ownerUnsubRef.current();
                        if(storesUnsubRef.current) storesUnsubRef.current();
                        if(storeConfigUnsubRef.current) storeConfigUnsubRef.current();
                        setLoading(false);
                    }
                });
                
                return () => {
                    unsubscribe();
                    if(ownerUnsubRef.current) ownerUnsubRef.current();
                    if(storesUnsubRef.current) storesUnsubRef.current();
                    if(storeConfigUnsubRef.current) storeConfigUnsubRef.current();
                };
            }, []);

            const fetchUserProfile = async (email) => {
                try {
                    if (email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()) {
                        const adminProfile = { uid: 'superadmin_master', email: email, name: 'Super Administrator', role: 'superadmin', ownerId: null };
                        setUserProfile(adminProfile);
                        setLoading(false);
                        return;
                    }
                    const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                    const q = query(usersRef, where('email', '==', email));
                    const snapshot = await getDocs(q); 

                    if (!snapshot.empty) {
                        const profile = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                        setUserProfile(profile);
                        if (profile.role !== 'superadmin' && profile.ownerId) {
                            enterTenantContext(profile.ownerId, profile);
                        }
                    } else {
                        setUserProfile({ email: email, role: 'guest', name: 'Guest User' });
                    }
                } catch (err) {
                    console.error("Error fetching profile:", err);
                } finally {
                    setLoading(false);
                }
            };

            const enterTenantContext = (ownerId, specificUser = null) => {
                try {
                    const ownerRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', ownerId);
                    if (ownerUnsubRef.current) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(ownerUnsubRef.current);
                        ownerUnsubRef.current();
                    }
                    
                    // Listener untuk owner doc - includes real-time accessRights update
                    ownerUnsubRef.current = onSnapshot(ownerRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const ownerData = { id: docSnap.id, ...docSnap.data() };
                            setActiveOwner(ownerData);
                            setOwnerAccess(ownerData.accessRights || {});
                            
                            // Notifikasi jika ada perubahan akses
                            if (ownerData.updatedAt) {
                                console.log('‚úÖ Hak akses owner diperbarui secara real-time:', ownerData.accessRights);
                            }
                        } else {
                            handleLogout();
                        }
                    }, (error) => {
                        console.error('Error listening to owner:', error);
                    });
                    if (window.firestoreListeners) window.firestoreListeners.add(ownerUnsubRef.current);

                    const storesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'stores');
                    const q = query(storesRef, where('ownerId', '==', ownerId));
                    if (storesUnsubRef.current) {
                        if (window.firestoreListeners) window.firestoreListeners.delete(storesUnsubRef.current);
                        storesUnsubRef.current();
                    }

                    storesUnsubRef.current = onSnapshot(q, (snapshot) => {
                        const stores = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        let targetStore = null;
                        if (specificUser && specificUser.role !== 'owner' && specificUser.storeId) {
                            targetStore = stores.find(s => s.id === specificUser.storeId);
                            setAvailableStores(targetStore ? [targetStore] : []);
                        } else {
                            setAvailableStores(stores);
                            targetStore = stores[0];
                        }
                        
                        setActiveStore(prev => {
                            if (!prev) return targetStore;
                            const stillExists = stores.find(s => s.id === prev.id);
                            return stillExists ? prev : targetStore;
                        });
                        
                        const storeToLoad = activeStore || targetStore;
                        if (storeToLoad) fetchStoreConfig(storeToLoad.id);
                    });
                    if (window.firestoreListeners) window.firestoreListeners.add(storesUnsubRef.current);
                } catch (err) { console.error("Context Error:", err); }
            };

            const fetchStoreConfig = (storeId) => {
                // Clean up previous listener
                if (storeConfigUnsubRef.current) {
                    if (window.firestoreListeners) window.firestoreListeners.delete(storeConfigUnsubRef.current);
                    storeConfigUnsubRef.current();
                    storeConfigUnsubRef.current = null;
                }
                
                // Real-time listener dengan query spesifik
                const configsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs');
                const q = query(configsRef, where('storeId', '==', storeId));
                
                storeConfigUnsubRef.current = onSnapshot(q, (snap) => {
                    if (!snap.empty) {
                        const conf = snap.docs[0].data();
                        setStoreConfig(conf);
                        console.log('‚úÖ Real-time update: Store config untuk', storeId, conf);
                    } else {
                        // Default config jika belum ada di Firestore
                        const defaultConfig = {
                            storeId: storeId,
                            feature_share: true, 
                            feature_print: true, 
                            feature_delete: true, 
                            feature_stock_add: true
                        };
                        setStoreConfig(defaultConfig);
                        console.log('üìã Menggunakan default config untuk', storeId);
                    }
                }, (error) => {
                    console.error('‚ùå Error listening to store config:', error);
                });
                if (window.firestoreListeners) window.firestoreListeners.add(storeConfigUnsubRef.current);
            };

            const switchStore = (storeId) => {
                if (storeId === null) {
                    // "Semua" - All stores mode
                    setActiveStore(null);
                    return;
                }
                const target = availableStores.find(s => s.id === storeId);
                if (target) {
                    setActiveStore(target);
                    fetchStoreConfig(target.id);
                }
            };

            const handleLogout = async () => {
                await signOut(auth);
                window.location.href = window.location.origin + window.location.pathname; 
            };

            const checkPermission = (featureKey) => {
                if (userProfile?.role === 'superadmin') return true;
                
                // Essential features that should work by default
                const essentialFeatures = ['feature_delete', 'feature_print', 'feature_share'];
                
                // For essential features, only block if explicitly disabled
                if (essentialFeatures.includes(featureKey)) {
                    // Owner level restriction
                    if (ownerAccess && ownerAccess[featureKey] === false) return false;
                    // Store level restriction  
                    if (storeConfig && storeConfig[featureKey] === false) return false;
                    // Default to enabled for essential features
                    return true;
                }
                
                // Priority: Owner Access (Platform level) -> Store Config (Store level)
                if (ownerAccess && ownerAccess[featureKey] === false) return false;
                if (userProfile?.role === 'owner') return true;
                if (storeConfig && storeConfig[featureKey] === false) return false;
                return true;
            };

            // Subscription status calculation
            const subscriptionStatus = useMemo(() => {
                if (!activeOwner) return null;
                const sub = activeOwner.subscription;
                if (!sub || !sub.expiresAt) return { status: 'none', remainingDays: 0, expired: true };
                
                const now = new Date();
                const expiresAt = sub.expiresAt?.toDate ? sub.expiresAt.toDate() : new Date(sub.expiresAt);
                const activatedAt = sub.activatedAt?.toDate ? sub.activatedAt.toDate() : (sub.activatedAt ? new Date(sub.activatedAt) : null);
                const diffMs = expiresAt.getTime() - now.getTime();
                const remainingDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                
                return {
                    status: remainingDays > 0 ? 'active' : 'expired',
                    remainingDays: Math.max(0, remainingDays),
                    expiresAt,
                    activatedAt,
                    expired: remainingDays <= 0,
                    amount: sub.amount || 0
                };
            }, [activeOwner]);

            return (
                <SessionContext.Provider value={{ 
                    user: userProfile, authUser, activeOwner, activeStore, availableStores, ownerAccess, storeConfig, 
                    switchStore, enterTenantContext, logout: handleLogout,
                    checkPermission, loading, subscriptionStatus, adminWhatsApp
                }}>
                    {children}
                </SessionContext.Provider>
            );
        };

        const PublicTrackingView = ({ token, onBack }) => {
            const [service, setService] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [store, setStore] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) { console.error("Anon auth failed", e); } }
                    const servicesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'services');
                    try {
                        const q1 = query(servicesRef, where('token', '==', token));
                        const snap1 = await getDocs(q1);
                        let foundService = null;
                        if (!snap1.empty) foundService = { id: snap1.docs[0].id, ...snap1.docs[0].data() };
                        else {
                            const q2 = query(servicesRef, where('publicToken', '==', token));
                            const snap2 = await getDocs(q2);
                            if(!snap2.empty) foundService = { id: snap2.docs[0].id, ...snap2.docs[0].data() };
                        }
                        if (foundService) {
                            setService(foundService);
                            if(foundService.storeId) {
                                const storeSnap = await getDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', foundService.storeId));
                                if(storeSnap.exists()) setStore(storeSnap.data());
                            }
                        } else { setError('Data servis tidak ditemukan. Periksa kembali token Anda.'); }
                    } catch (err) { setError('Gagal memuat data. ' + err.message); } finally { setLoading(false); }
                };
                fetchData();
            }, [token]);

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="text-center"><Loader2 className="w-10 h-10 animate-spin text-blue-600 mx-auto mb-4"/><p className="text-slate-500">Mencari Data Servis...</p></div></div>;
            if(error) return <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full"><div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><SearchX className="w-8 h-8"/></div><h2 className="text-xl font-bold text-slate-800 mb-2">Maaf!</h2><p className="text-slate-500 mb-6">{error}</p><button onClick={onBack} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold w-full">Kembali</button></div></div>;
            const isDone = ['Selesai', 'Diambil'].includes(service.status);
            const statusColor = isDone ? 'bg-green-500' : service.status === 'Dibatalkan' ? 'bg-red-500' : 'bg-blue-500';
            return (
                <div className="min-h-screen bg-slate-100 py-10 px-4">
                    <div className="max-w-lg mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
                        <div className="bg-slate-900 p-6 text-white text-center relative">{store?.logo ? <img src={store.logo} className="w-16 h-16 object-contain mx-auto mb-3 bg-white rounded-lg p-1"/> : <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center font-bold text-2xl mx-auto mb-3">iF</div>}<h1 className="font-bold text-xl">{store?.name || 'iFix Service Tracker'}</h1><p className="text-slate-400 text-xs mt-1">{store?.address}</p><div className="absolute top-4 right-4"><button onClick={onBack} className="text-slate-400 hover:text-white text-xs font-bold bg-slate-800 px-3 py-1 rounded-full">Login</button></div></div>
                        <div className="p-6"><div className="bg-slate-50 border border-slate-100 rounded-2xl p-5 mb-6 text-center shadow-inner"><p className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Status Pengerjaan</p><div className={`inline-block px-6 py-2 rounded-full text-white font-bold text-lg shadow-lg ${statusColor} mb-2`}>{service.status}</div><p className="text-xs text-slate-500">Update Terakhir: {formatDate(service.updatedAt)}</p></div><div className="space-y-4 mb-8"><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-blue-100 p-2 rounded-lg text-blue-600"><UserPlus className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Pelanggan</p><p className="font-bold text-slate-800">{service.customerName}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-purple-100 p-2 rounded-lg text-purple-600"><Smartphone className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Perangkat</p><p className="font-bold text-slate-800">{service.unitType || service.deviceType}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Wrench className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Keluhan</p><p className="font-bold text-slate-800">{service.complaint || service.problem}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-green-100 p-2 rounded-lg text-green-600"><Wallet className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Biaya Estimasi</p><p className="font-bold text-green-600 text-lg">{formatCurrency(service.costEstimate)}</p></div></div></div></div><div><h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Activity className="w-5 h-5 text-blue-500"/> Riwayat Status</h3><div className="space-y-0 pl-2"><div className="relative pl-8 pb-6 timeline-item"><div className="timeline-line"></div><div className="absolute left-0 top-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm"><CheckCheck className="w-4 h-4"/></div><p className="font-bold text-sm text-slate-800">Diterima</p><p className="text-xs text-slate-500">{formatDate(service.createdAt)}</p></div>{service.status !== 'Diterima' && (<div className="relative pl-8 pb-0 timeline-item"><div className="absolute left-0 top-0 w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm"><Activity className="w-4 h-4"/></div><p className="font-bold text-sm text-slate-800">{service.status}</p><p className="text-xs text-slate-500">{formatDate(service.updatedAt)}</p></div>)}</div></div></div><div className="bg-slate-50 p-4 text-center text-xs text-slate-400 border-t border-slate-200">&copy; 2026 iFix Enterprise Cloud</div></div></div>
            );
        };

        
// ================================
// PLAN CONFIG (SUPERADMIN)
// ================================
const PLAN_FEATURES = [
  { id: 'feature_delete', label: 'Hapus Data Servis' },
  { id: 'feature_print', label: 'Cetak Invoice' },
  { id: 'feature_share', label: 'Share WhatsApp' },
  { id: 'feature_stock_add', label: 'Tambah Stok Barang' },
  { id: 'menu_finance', label: 'Akses Menu Keuangan' },
  { id: 'feature_backup', label: 'Backup & Restore Data' },
  { id: 'feature_finance_edit', label: 'Edit & Hapus Keuangan' },
  { id: 'feature_employee_edit', label: 'Edit Data Pegawai' }
];

const PlanConfigModal = ({ close }) => {
  const [activePlan, setActivePlan] = React.useState('basic');
  const [config, setConfig] = React.useState({});
  const [loading, setLoading] = React.useState(false);

  React.useEffect(() => {
    const unsub = onSnapshot(
      doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', activePlan),
      (snap) => setConfig(snap.exists() ? snap.data() : {})
    );
    if (window.firestoreListeners) window.firestoreListeners.add(unsub);
    return () => {
      if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
      unsub();
    };
  }, [activePlan]);

  const toggle = (k) => setConfig(p => ({ ...p, [k]: !p[k] }));

  const save = async () => {
    setLoading(true);
    try {
      await setDoc(
        doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', activePlan),
        config,
        { merge: true }
      );
      alert(`Paket ${activePlan.toUpperCase()} disimpan`);
      close();
    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
      <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <Crown className="w-5 h-5 text-yellow-400" />
          Pengaturan Paket
        </h3>
        <div className="flex gap-2 mb-4">
          {['basic','pro'].map(p => (
            <button key={p} onClick={() => setActivePlan(p)}
              className={`flex-1 py-2 rounded-lg font-bold uppercase text-xs ${activePlan===p?'bg-purple-600 text-white':'bg-slate-700 text-slate-400'}`}>
              {p}
            </button>
          ))}
        </div>
        <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
          {PLAN_FEATURES.map(f => (
            <label key={f.id} className="flex items-center justify-between bg-slate-900 p-3 rounded-lg border border-slate-700">
              <span className="text-slate-300 text-sm">{f.label}</span>
              <input type="checkbox" checked={!!config[f.id]} onChange={() => toggle(f.id)} className="accent-purple-600 w-5 h-5"/>
            </label>
          ))}
        </div>
        <div className="flex gap-3 mt-6">
          <button onClick={close} className="flex-1 py-2 border border-slate-600 rounded-lg text-slate-400 font-bold">Batal</button>
          <button onClick={save} disabled={loading} className="flex-1 py-2 bg-purple-600 text-white rounded-lg font-bold">
            {loading?'Menyimpan...':'Simpan'}
          </button>
        </div>
      </div>
    </div>
  );
};

const CategoryItemsModal = ({ close, ownerId, storeId }) => {
    const [categories, setCategories] = useState(['Sparepart', 'Aksesori', 'Tools', 'Lainnya']);
    const [customCategories, setCustomCategories] = useState([]);
    const [subCategories, setSubCategories] = useState({});
    const [newCategory, setNewCategory] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('');
    const [newSubCategory, setNewSubCategory] = useState('');
    const [loading, setLoading] = useState(false);
    const [deleting, setDeleting] = useState(null);

    useEffect(() => {
        if (!ownerId) return;
        // Load custom categories and subcategories from Firestore
        let q;
        if (storeId) {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
        } else {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
        }
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const configs = snapshot.docs.map(doc => doc.data());
            const allCats = new Set([...categories]);
            const allSubs = {};
            configs.forEach(config => {
                if (config.customCategories && Array.isArray(config.customCategories)) {
                    config.customCategories.forEach(cat => allCats.add(cat));
                }
                if (config.subCategories && typeof config.subCategories === 'object') {
                    Object.assign(allSubs, config.subCategories);
                }
            });
            setCustomCategories(Array.from(allCats).filter(c => !categories.includes(c)));
            setSubCategories(allSubs);
        });
        if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
            unsubscribe();
        };
    }, [ownerId, storeId]);

    const addCategory = async (e) => {
        e.preventDefault();
        if (!newCategory.trim()) return;
        if ([...categories, ...customCategories].includes(newCategory)) {
            alert('Kategori sudah ada!');
            return;
        }

        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    customCategories: [newCategory],
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                const docRef = snapshot.docs[0].ref;
                const existing = snapshot.docs[0].data().customCategories || [];
                if (!existing.includes(newCategory)) {
                    await updateDoc(docRef, {
                        customCategories: [...existing, newCategory]
                    });
                }
            }
            setNewCategory('');
            alert('Kategori berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const addSubCategory = async (e) => {
        e.preventDefault();
        if (!selectedCategory || !newSubCategory.trim()) return;
        
        const existingSubs = subCategories[selectedCategory] || [];
        if (existingSubs.includes(newSubCategory)) {
            alert('Sub-kategori sudah ada!');
            return;
        }

        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            const updatedSubs = {
                ...subCategories,
                [selectedCategory]: [...existingSubs, newSubCategory]
            };
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    subCategories: updatedSubs,
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                await updateDoc(snapshot.docs[0].ref, {
                    subCategories: updatedSubs
                });
            }
            setNewSubCategory('');
            alert('Sub-kategori berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const deleteCategory = async (category) => {
        if (!confirm(`Hapus kategori "${category}"?`)) return;
        
        setDeleting(category);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
            }
            const snapshot = await getDocs(q);
            
            for (const docSnap of snapshot.docs) {
                const existing = docSnap.data().customCategories || [];
                const updated = existing.filter(c => c !== category);
                await updateDoc(docSnap.ref, { customCategories: updated });
            }
            alert('Kategori berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    const deleteSubCategory = async (category, subCat) => {
        if (!confirm(`Hapus sub-kategori "${subCat}"?`)) return;
        
        setDeleting(`${category}_${subCat}`);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                const existingSubs = subCategories[category] || [];
                const updatedSubs = {
                    ...subCategories,
                    [category]: existingSubs.filter(s => s !== subCat)
                };
                await updateDoc(snapshot.docs[0].ref, {
                    subCategories: updatedSubs
                });
            }
            alert('Sub-kategori berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    const allCategories = [...categories, ...customCategories];

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-gradient-to-r from-orange-600 to-orange-500 p-6 text-white flex items-center justify-between">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Tag className="w-6 h-6"/> Kelola Kategori & Sub-Kategori</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-6">
                    {/* Add Category */}
                    <div className="bg-orange-50 p-4 rounded-xl border border-orange-200">
                        <h3 className="font-bold text-orange-900 mb-3">Tambah Kategori Baru</h3>
                        <form onSubmit={addCategory} className="flex gap-2">
                            <input 
                                type="text" 
                                placeholder="Contoh: LCD, Baterai, IC..."
                                value={newCategory}
                                onChange={e => setNewCategory(e.target.value)}
                                className="flex-1 px-4 py-2 border border-orange-300 rounded-lg focus:outline-none focus:border-orange-500"
                            />
                            <button 
                                type="submit"
                                disabled={loading || !newCategory.trim()}
                                className="px-6 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 disabled:opacity-50"
                            >
                                {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+ Kategori'}
                            </button>
                        </form>
                    </div>

                    {/* Add Sub-Category */}
                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <h3 className="font-bold text-blue-900 mb-3">Tambah Sub-Kategori</h3>
                        <form onSubmit={addSubCategory} className="flex gap-2">
                            <select 
                                value={selectedCategory}
                                onChange={e => setSelectedCategory(e.target.value)}
                                className="px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:border-blue-500"
                            >
                                <option value="">Pilih Kategori...</option>
                                {allCategories.map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                ))}
                            </select>
                            <input 
                                type="text" 
                                placeholder="Contoh: OLED, IPS, LCD..."
                                value={newSubCategory}
                                onChange={e => setNewSubCategory(e.target.value)}
                                disabled={!selectedCategory}
                                className="flex-1 px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:border-blue-500 disabled:bg-slate-100"
                            />
                            <button 
                                type="submit"
                                disabled={loading || !selectedCategory || !newSubCategory.trim()}
                                className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+ Sub'}
                            </button>
                        </form>
                    </div>

                    {/* Categories List */}
                    <div className="space-y-4">
                        <h3 className="font-bold text-slate-700">Kategori & Sub-Kategori ({allCategories.length})</h3>
                        <div className="space-y-3">
                            {allCategories.map((cat) => (
                                <div key={cat} className="bg-slate-50 rounded-lg border border-slate-200 p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                            <Tag className="w-4 h-4 text-orange-600" />
                                            {cat}
                                        </span>
                                        {!categories.includes(cat) && (
                                            <button
                                                onClick={() => deleteCategory(cat)}
                                                disabled={deleting === cat}
                                                className="p-1 hover:bg-red-100 rounded text-red-600 disabled:opacity-50"
                                                title="Hapus kategori"
                                            >
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        )}
                                    </div>
                                    {subCategories[cat] && subCategories[cat].length > 0 && (
                                        <div className="ml-6 mt-2 flex flex-wrap gap-2">
                                            {subCategories[cat].map(sub => (
                                                <div key={sub} className="inline-flex items-center gap-2 bg-white px-3 py-1 rounded-full border border-blue-200 text-xs">
                                                    <span className="text-blue-700 font-medium">{sub}</span>
                                                    <button
                                                        onClick={() => deleteSubCategory(cat, sub)}
                                                        disabled={deleting === `${cat}_${sub}`}
                                                        className="text-red-500 hover:text-red-700 disabled:opacity-50"
                                                    >
                                                        <X className="w-3 h-3" />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <p className="text-xs text-slate-500 italic">* Kategori default (Sparepart, Aksesori, Tools, Lainnya) tidak dapat dihapus</p>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end sticky bottom-0">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const BrandItemsModal = ({ close, ownerId }) => {
    const [brands, setBrands] = useState([]);
    const [newBrand, setNewBrand] = useState('');
    const [loading, setLoading] = useState(false);
    const [deleting, setDeleting] = useState(null);

    useEffect(() => {
        if (!ownerId) return;
        const unsubscribe = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), where('ownerId', '==', ownerId)),
            (snapshot) => setBrands(snapshot.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
            unsubscribe();
        };
    }, [ownerId]);

    const addBrand = async (e) => {
        e.preventDefault();
        if (!newBrand.trim()) return;
        if (brands.some(b => b.name.toLowerCase() === newBrand.toLowerCase())) {
            alert('Brand sudah ada!');
            return;
        }

        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), {
                ownerId: ownerId,
                name: newBrand.trim(),
                createdAt: serverTimestamp()
            });
            setNewBrand('');
            alert('Brand berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const deleteBrand = async (brandId, brandName) => {
        if (!confirm(`Hapus brand "${brandName}"?`)) return;
        
        setDeleting(brandId);
        try {
            await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'brands', brandId));
            alert('Brand berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-500 p-6 text-white flex items-center justify-between">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Tag className="w-6 h-6"/> Kelola Brand Produk</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-4">
                    <form onSubmit={addBrand} className="flex gap-2 mb-6">
                        <input 
                            type="text" 
                            placeholder="Tambah brand baru... (contoh: Samsung, Apple, Xiaomi)"
                            value={newBrand}
                            onChange={e => setNewBrand(e.target.value)}
                            className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-purple-500"
                        />
                        <button 
                            type="submit"
                            disabled={loading || !newBrand.trim()}
                            className="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50"
                        >
                            {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+'}
                        </button>
                    </form>

                    <div className="space-y-2">
                        <h3 className="font-bold text-slate-700 mb-3">Brand Tersedia ({brands.length})</h3>
                        {brands.length === 0 ? (
                            <div className="text-center py-8 text-slate-400">
                                <Tag className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                <p>Belum ada brand. Tambahkan brand pertama Anda!</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                {brands.map((brand) => (
                                    <div 
                                        key={brand.id}
                                        className="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200"
                                    >
                                        <span className="text-sm font-bold text-purple-700">{brand.name}</span>
                                        <button
                                            onClick={() => deleteBrand(brand.id, brand.name)}
                                            disabled={deleting === brand.id}
                                            className="p-1 hover:bg-red-100 rounded text-red-600 disabled:opacity-50"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end sticky bottom-0">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const InventorySettingsModal = ({ close, ownerId, storeId }) => {
    const [settings, setSettings] = useState({
        preventDuplicateNames: false,
        preventDuplicatePrices: false
    });
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        let q;
        if (storeId) {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
        } else {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
        }
        const unsubscribe = onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                const config = snapshot.docs[0].data();
                setSettings(config.inventorySettings || {
                    preventDuplicateNames: false,
                    preventDuplicatePrices: false
                });
            }
        });
        if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
            unsubscribe();
        };
    }, [ownerId, storeId]);

    const saveSettings = async () => {
        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    inventorySettings: settings,
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                await updateDoc(snapshot.docs[0].ref, {
                    inventorySettings: settings
                });
            }
            alert('‚úÖ Pengaturan berhasil disimpan!');
            close();
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full">
                <div className="sticky top-0 bg-gradient-to-r from-slate-700 to-slate-600 p-6 text-white flex items-center justify-between rounded-t-2xl">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Settings className="w-6 h-6"/> Pengaturan Stok</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-6">
                    <div className="space-y-4">
                        <label className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                            <input 
                                type="checkbox"
                                checked={settings.preventDuplicateNames}
                                onChange={e => setSettings({...settings, preventDuplicateNames: e.target.checked})}
                                className="mt-1 w-5 h-5 text-blue-600 rounded"
                            />
                            <div className="flex-1">
                                <div className="font-bold text-slate-700 mb-1">Cegah Duplikasi Nama Produk</div>
                                <div className="text-sm text-slate-500">Sistem akan menolak jika Anda menambahkan produk dengan nama, kategori, dan brand yang sama</div>
                            </div>
                        </label>

                        <label className="flex items-start gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100 opacity-50">
                            <input 
                                type="checkbox"
                                checked={settings.preventDuplicatePrices}
                                onChange={e => setSettings({...settings, preventDuplicatePrices: e.target.checked})}
                                className="mt-1 w-5 h-5 text-blue-600 rounded"
                                disabled
                            />
                            <div className="flex-1">
                                <div className="font-bold text-slate-700 mb-1">Cegah Duplikasi Harga <span className="text-xs bg-slate-200 px-2 py-0.5 rounded">Coming Soon</span></div>
                                <div className="text-sm text-slate-500">Sistem akan memberi peringatan jika harga produk sama persis dengan produk lain</div>
                            </div>
                        </label>
                    </div>

                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <div className="flex gap-2 items-start">
                            <AlertTriangle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                            <div className="text-sm text-amber-700">
                                <strong>Info:</strong> Pengaturan ini hanya berlaku untuk penambahan produk baru. Produk yang sudah ada tidak akan terpengaruh.
                            </div>
                        </div>
                    </div>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end rounded-b-2xl">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Batal</button>
                    <button 
                        onClick={saveSettings}
                        disabled={loading}
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                    >
                        {loading && <Loader2 className="w-4 h-4 animate-spin" />}
                        Simpan Pengaturan
                    </button>
                </div>
            </div>
        </div>
    );
};

const QCFunctionalItemsModal = ({ close, ownerId }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), where('ownerId', '==', ownerId)),
            (snap) => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        if (window.firestoreListeners) window.firestoreListeners.add(unsub);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
            unsub();
        };
    }, [ownerId]);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), {
                name: newItem, ownerId, createdAt: serverTimestamp()
            });
            setNewItem('');
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-4 text-slate-800">Kelola QC Cek Fungsional</h3>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nama item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.map(item => (
                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
                            <span className="font-medium text-slate-800">{item.name}</span>
                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const MasterKelengkapanModal = ({ close }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items'), orderBy('createdAt', 'desc')),
            (snap) => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        if (window.firestoreListeners) window.firestoreListeners.add(unsub);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
            unsub();
        };
    }, []);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items'), {
                name: newItem, createdAt: serverTimestamp()
            });
            setNewItem('');
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-2 text-slate-800">Master Data Kelengkapan</h3>
                <p className="text-sm text-slate-600 mb-4">Kelola item kelengkapan default untuk semua owner</p>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Tambah item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-teal-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.length === 0 ? (
                        <p className="text-center text-slate-400 py-8">Belum ada item master</p>
                    ) : (
                        items.map(item => (
                            <div key={item.id} className="flex justify-between items-center p-3 bg-teal-50 border border-teal-200 rounded-lg">
                                <span className="font-medium text-slate-800">{item.name}</span>
                                <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                            </div>
                        ))
                    )}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const KelengkapanItemsModal = ({ close, ownerId }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), where('ownerId', '==', ownerId)),
            (snap) => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        if (window.firestoreListeners) window.firestoreListeners.add(unsub);
        return () => {
            if (window.firestoreListeners) window.firestoreListeners.delete(unsub);
            unsub();
        };
    }, [ownerId]);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), {
                name: newItem, ownerId, createdAt: serverTimestamp()
            });
            setNewItem('');
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-4 text-slate-800">Kelola Cek Kelengkapan</h3>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nama item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.map(item => (
                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
                            <span className="font-medium text-slate-800">{item.name}</span>
                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const SuperAdminDashboard = () => {
             const { logout, enterTenantContext } = useContext(SessionContext);
             const { data: owners } = useFirestoreCollection('owners');
             const quotaTracking = useQuotaTracking();
             const [subConfig, setSubConfig] = useState({ price: 500000, duration: 365, currency: 'IDR', whatsapp: '' });
             const [subModal, setSubModal] = useState(null); // null | 'settings' | {type: 'activate', owner}
             const quotaStats = quotaTracking?.quotaStats || {
                 totalReads: 0,
                 cacheHits: 0,
                 serverReads: 0,
                 totalWrites: 0,
                 totalUpdates: 0,
                 totalDeletes: 0,
                 byCollection: {},
                 byCollectionWrites: {},
                 dailyStats: {}
             };
             const resetStats = quotaTracking?.resetStats || (() => {});
             const [modal, setModal] = useState(null); 
             const [selectedOwner, setSelectedOwner] = useState(null);
             const [selectedOwnerUser, setSelectedOwnerUser] = useState(null);
             const [loading, setLoading] = useState(false);
             
             // Load subscription config from Firestore
             useEffect(() => {
                 const unsub = onSnapshot(
                     doc(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config', 'settings'),
                     (snap) => {
                         if (snap.exists()) setSubConfig(snap.data());
                     }
                 );
                 if (window.firestoreListeners) window.firestoreListeners.add(unsub);
                 return () => { if (window.firestoreListeners) window.firestoreListeners.delete(unsub); unsub(); };
             }, []);

             // Subscription helper functions
             const getOwnerSubStatus = (owner) => {
                 const sub = owner.subscription;
                 if (!sub || !sub.expiresAt) return { status: 'none', remainingDays: 0, expired: true, label: 'Belum Aktif' };
                 const now = new Date();
                 const expiresAt = sub.expiresAt?.toDate ? sub.expiresAt.toDate() : new Date(sub.expiresAt);
                 const diffMs = expiresAt.getTime() - now.getTime();
                 const remainingDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                 if (remainingDays <= 0) return { status: 'expired', remainingDays: 0, expired: true, label: 'Kedaluwarsa', expiresAt };
                 return { status: 'active', remainingDays, expired: false, label: `${remainingDays} hari lagi`, expiresAt };
             };

             const activateSubscription = async (owner, customPrice, customDuration, adminMessage) => {
                 setLoading(true);
                 try {
                     const price = customPrice || subConfig.price;
                     const duration = customDuration || subConfig.duration;
                     const now = new Date();
                     const expiresAt = new Date(now.getTime() + duration * 24 * 60 * 60 * 1000);
                     
                     const historyEntry = {
                         activatedAt: now.toISOString(),
                         expiresAt: expiresAt.toISOString(),
                         amount: price,
                         duration: duration,
                         activatedBy: 'superadmin'
                     };

                     const ownerRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', owner.id);
                     const ownerSnap = await getDoc(ownerRef);
                     const existingHistory = ownerSnap.data()?.subscription?.history || [];

                     const updateData = {
                         'subscription.status': 'active',
                         'subscription.activatedAt': serverTimestamp(),
                         'subscription.expiresAt': expiresAt,
                         'subscription.amount': price,
                         'subscription.duration': duration,
                         'subscription.history': [...existingHistory, historyEntry]
                     };
                     
                     // Add admin message if provided
                     if (adminMessage && adminMessage.trim()) {
                         updateData['adminMessage'] = adminMessage.trim();
                         updateData['adminMessageAt'] = serverTimestamp();
                     }

                     await updateDoc(ownerRef, updateData);
                     alert(`‚úÖ Langganan ${owner.name} berhasil diaktifkan!\nBerlaku hingga: ${expiresAt.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}\nDurasi: ${duration} hari`);
                     setSubModal(null);
                 } catch (err) {
                     alert('Gagal mengaktifkan langganan: ' + err.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const revokeSubscription = async (owner, adminMessage) => {
                 if (!confirm(`‚ö†Ô∏è Anda yakin ingin menonaktifkan langganan ${owner.name}?\n\nAplikasi akan terkunci untuk owner ini.`)) return;
                 setLoading(true);
                 try {
                     const updateData = {
                         'subscription.status': 'expired',
                         'subscription.expiresAt': new Date(2000, 0, 1) // Force expired
                     };
                     
                     // Add admin message if provided
                     if (adminMessage && adminMessage.trim()) {
                         updateData['adminMessage'] = adminMessage.trim();
                         updateData['adminMessageAt'] = serverTimestamp();
                     }
                     
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', owner.id), updateData);
                     alert(`Langganan ${owner.name} dinonaktifkan.`);
                 } catch (err) {
                     alert('Gagal: ' + err.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const saveSubConfig = async (newConfig) => {
                 setLoading(true);
                 try {
                     console.log('üíæ Saving subscription config:', newConfig);
                     await setDoc(
                         doc(db, APP_COLLECTION_PREFIX, 'public', 'subscription_config', 'settings'),
                         newConfig,
                         { merge: true }
                     );
                     console.log('‚úÖ Subscription config saved successfully');
                     alert('‚úÖ Pengaturan langganan disimpan!');
                     setSubModal(null);
                 } catch (err) {
                     alert('Gagal: ' + err.message);
                 } finally {
                     setLoading(false);
                 }
             };

             // Calculate quota metrics
             const FREE_TIER_READS_LIMIT = 50000;
             const FREE_TIER_WRITES_LIMIT = 20000;
             const totalWrites = (quotaStats.totalWrites || 0) + (quotaStats.totalUpdates || 0) + (quotaStats.totalDeletes || 0);
             const readsPercentage = ((quotaStats.serverReads / FREE_TIER_READS_LIMIT) * 100).toFixed(2);
             const writesPercentage = ((totalWrites / FREE_TIER_WRITES_LIMIT) * 100).toFixed(2);
             const cacheEfficiency = quotaStats.totalReads > 0 
                 ? ((quotaStats.cacheHits / quotaStats.totalReads) * 100).toFixed(1)
                 : 0;
             
             // Daily stats for chart
             const dailyChartData = Object.entries(quotaStats.dailyStats || {})
                 .slice(-7)
                 .map(([date, stats]) => ({
                     date: new Date(date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }),
                     reads: stats.serverReads || 0,
                     writes: (stats.totalWrites || 0) + (stats.totalUpdates || 0) + (stats.totalDeletes || 0)
                 }));
             
             // Add today's data
             if (quotaStats.serverReads > 0 || quotaStats.cacheHits > 0 || totalWrites > 0) {
                 dailyChartData.push({
                     date: 'Hari Ini',
                     reads: quotaStats.serverReads,
                     writes: totalWrites
                 });
             }
             
             // Collection breakdown for reads
             const collectionReadsData = Object.entries(quotaStats.byCollection || {})
                 .filter(([_, count]) => count > 0)
                 .map(([name, value]) => ({ name, value }))
                 .sort((a, b) => b.value - a.value);
             
             // Collection breakdown for writes
             const collectionWritesData = Object.entries(quotaStats.byCollectionWrites || {})
                 .filter(([_, count]) => count > 0)
                 .map(([name, value]) => ({ name, value }))
                 .sort((a, b) => b.value - a.value);

             const createOwner = async (e) => { 
                 e.preventDefault(); 
                 setLoading(true); 
                 const formData = new FormData(e.target); 
                 const ownerName = formData.get('name'); 
                 const ownerEmail = formData.get('email'); 
                 const password = formData.get('password'); 
                 const personalName = formData.get('ownerName'); 
                 const plan = formData.get('plan'); 
                 
                 // üî• DEFINISI HAK AKSES DARI PLAN_CONFIGS (DINAMIS)
                 const planSnap = await getDoc(
                     doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', plan)
                 );
                 if (!planSnap.exists()) {
                     alert(`‚ùå Paket "${plan.toUpperCase()}" belum dikonfigurasi. Silakan atur Pengaturan Paket terlebih dahulu.`);
                     setLoading(false);
                     return;
                 }
                 const defaultAccessRights = planSnap.data();

                 try { 
                     let newUid = null; 
                     const secondaryApp = initializeApp(firebaseConfig, "Secondary"); 
                     const secondaryAuth = getAuth(secondaryApp); 
                     try { 
                         const userCred = await createUserWithEmailAndPassword(secondaryAuth, ownerEmail, password); 
                         newUid = userCred.user.uid; 
                         await signOut(secondaryAuth); 
                     } catch(authErr) { 
                         if(authErr.code === 'auth/email-already-in-use') { throw new Error("Email ini sudah terdaftar di sistem Authentication."); } 
                         throw authErr; 
                     } finally { 
                         await deleteApp(secondaryApp); 
                     } 
                     
                     const ownerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'owners'), { 
                         name: ownerName, 
                         email: ownerEmail, 
                         plan: plan, 
                         status: 'active', 
                         createdAt: serverTimestamp(), 
                         accessRights: defaultAccessRights 
                     }); 
                     
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), { 
                         ownerId: ownerRef.id, 
                         name: `${ownerName} - Pusat`, 
                         address: 'Alamat Default', 
                         phone: '-', 
                         createdAt: serverTimestamp() 
                     }); 
                     
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), { 
                         uid: newUid, 
                         email: ownerEmail, 
                         name: personalName, 
                         role: 'owner', 
                         ownerId: ownerRef.id, 
                         storeId: null, 
                         createdAt: serverTimestamp() 
                     }); 
                     
                     alert(`‚úÖ SUKSES!\n\nTenant: ${ownerName}\nPlan: ${plan.toUpperCase()}\n\nUser telah dibuat. Default Access Rights disesuaikan dengan Plan.`); 
                     setModal(null); 
                 } catch (err) { 
                     alert("Gagal: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
             };
             
             const handleEditClick = async (owner) => {
                 setLoading(true);
                 try {
                     const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                     const q = query(usersRef, where('ownerId', '==', owner.id), where('role', '==', 'owner'));
                     const snap = await getDocs(q);
                     if (!snap.empty) {
                         setSelectedOwnerUser({ id: snap.docs[0].id, ...snap.docs[0].data() });
                     } else {
                         setSelectedOwnerUser(null);
                     }
                     setSelectedOwner(owner);
                     setModal('edit');
                 } catch (e) {
                     alert("Error mengambil data user owner: " + e.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const updateOwner = async (e) => { 
                 e.preventDefault(); 
                 setLoading(true); 
                 const formData = new FormData(e.target); 
                 try { 
                     
                 // üîÑ AUTO SYNC ACCESS RIGHTS DENGAN PLAN
                 const plan = formData.get('plan');
                 const planSnap = await getDoc(
                     doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', plan)
                 );
                 if (!planSnap.exists()) {
                     alert(`‚ùå Paket "${plan.toUpperCase()}" belum dikonfigurasi.`);
                     setLoading(false);
                     return;
                 }
                 const accessRights = planSnap.data();

                 await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', selectedOwner.id), {
                         accessRights: accessRights, 
                         name: formData.get('name'), 
                         email: formData.get('email'),
                         plan: formData.get('plan'), 
                     }); 
                     if (selectedOwnerUser) {
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', selectedOwnerUser.id), {
                             name: formData.get('ownerName'), 
                             email: formData.get('email')
                         });
                     }
                     alert("Data Owner & Profil Berhasil Diperbarui!"); 
                     setModal(null); 
                 } catch(err) { 
                     alert("Gagal update: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
        };
             
             const deleteTenant = async (ownerId, ownerName) => { if (!confirm(`‚ö†Ô∏è BAHAYA!\n\nAnda yakin ingin menghapus Tenant: ${ownerName}?\n\nTindakan ini akan menghapus:\n- Data Owner\n- Data Toko (Cabang)\n- Data User (Pegawai)\n\nData tidak dapat dikembalikan!`)) return; setLoading(true); try { const usersQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), where('ownerId', '==', ownerId)); const usersSnap = await getDocs(usersQ); const userDeletions = usersSnap.docs.map(d => deleteDoc(d.ref)); await Promise.all(userDeletions); const storesQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), where('ownerId', '==', ownerId)); const storesSnap = await getDocs(storesQ); const storeDeletions = storesSnap.docs.map(d => deleteDoc(d.ref)); await Promise.all(storeDeletions); await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', ownerId)); alert(`Tenant ${ownerName} berhasil dihapus permanen.`); } catch(err) { alert("Gagal menghapus tenant: " + err.message); } finally { setLoading(false); } };
             const updateAccess = async (e) => { 
                 e.preventDefault(); 
                 if (!selectedOwner) return; 
                 
                 const newRights = { 
                     feature_delete: e.target.feature_delete.checked, 
                     feature_print: e.target.feature_print.checked, 
                     feature_share: e.target.feature_share.checked, 
                     feature_stock_add: e.target.feature_stock_add.checked, 
                     menu_finance: e.target.menu_finance.checked, 
                     feature_backup: e.target.feature_backup.checked, 
                     feature_finance_edit: e.target.feature_finance_edit.checked, 
                     feature_employee_edit: e.target.feature_employee_edit.checked, 
                     menu_dashboard: e.target.menu_dashboard.checked, 
                     menu_report: e.target.menu_report.checked,
                     menu_service: e.target.menu_service.checked,
                     menu_sales: e.target.menu_sales.checked,
                     menu_purchase: e.target.menu_purchase.checked,
                     menu_return_sales: e.target.menu_return_sales.checked,
                     menu_return_purchase: e.target.menu_return_purchase.checked,
                     menu_payable: e.target.menu_payable.checked,
                     menu_receivable: e.target.menu_receivable.checked,
                     menu_cash: e.target.menu_cash.checked,
                     menu_inventory: e.target.menu_inventory.checked,
                     menu_supplier: e.target.menu_supplier.checked,
                     menu_customers: e.target.menu_customers.checked,
                     menu_hr: e.target.menu_hr.checked,
                     menu_users: e.target.menu_users.checked,
                     menu_settings: e.target.menu_settings.checked,
                     menu_finance: e.target.menu_finance.checked,
                     feature_service_edit: e.target.feature_service_edit.checked, 
                     feature_sales_edit: e.target.feature_sales_edit.checked, 
                     feature_inventory_edit: e.target.feature_inventory_edit.checked, 
                     feature_customer_edit: e.target.feature_customer_edit.checked,
                     feature_import_export: e.target.feature_import_export.checked,
                     feature_multi_branch: e.target.feature_multi_branch.checked,
                     feature_qc_checklist: e.target.feature_qc_checklist.checked,
                     feature_kelengkapan: e.target.feature_kelengkapan.checked,
                     feature_accounting: e.target.feature_accounting.checked
                 }; 
                 
                 try { 
                     setLoading(true);
                     
                     // Update accessRights di owner doc
                     await updateDoc(
                         doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', selectedOwner.id), 
                         { accessRights: newRights, updatedAt: serverTimestamp() }
                     );
                     
                     // Broadcast notification ke semua user di tenant ini
                     const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                     const usersQ = query(usersRef, where('ownerId', '==', selectedOwner.id));
                     const usersSnap = await getDocs(usersQ);
                     
                     const now = new Date();
                     const batch = writeBatch(db);
                     
                     usersSnap.docs.forEach(userDoc => {
                         batch.update(userDoc.ref, {
                             'notification.type': 'access_updated',
                             'notification.message': 'Hak akses Anda telah diperbarui oleh Superadmin',
                             'notification.timestamp': serverTimestamp(),
                             'notification.acknowledged': false
                         });
                     });
                     
                     await batch.commit();
                     
                     alert("‚úÖ Hak akses Tenant diperbarui dan semua user sedang menerima notifikasi real-time!");
                     setModal(null);
                 } catch (err) { 
                     alert("Gagal update: " + err.message); 
                 } finally {
                     setLoading(false);
                 }
             };
             return (
                 <div className="min-h-screen bg-slate-900 text-white">
                     {loading && <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center"><Loader2 className="w-10 h-10 animate-spin text-purple-500"/></div>}
                     <header className="bg-slate-800 border-b border-slate-700 p-4 md:p-6 sticky top-0 z-50 shadow-lg">
                         <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                             <div className="flex items-center gap-3 md:gap-4">
                                 <div className="w-10 h-10 md:w-12 md:h-12 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20"><Globe className="w-6 h-6 md:w-7 md:h-7 text-white"/></div>
                                 <div>
                                     <h1 className="text-base md:text-xl font-black tracking-tight">iFix Platform Manager</h1>
                                     <p className="text-[10px] md:text-xs text-purple-400 font-medium uppercase tracking-wider">Superadmin Control Panel</p>
                                 </div>
                             </div>
                             <div className="flex items-center justify-between md:justify-end gap-2 md:gap-4">
                                 <div className="text-right hidden sm:block">
                                     <p className="text-xs md:text-sm font-bold">Administrator</p>
                                     <p className="text-[10px] md:text-xs text-slate-400">{SUPERADMIN_EMAIL}</p>
                                 </div>
                                 <button onClick={()=>setSubModal('settings')} className="bg-amber-600 hover:bg-amber-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold flex items-center gap-1 md:gap-2 text-xs md:text-sm">
                                     <Banknote className="w-3 h-3 md:w-4 md:h-4"/> <span className="hidden sm:inline">Langganan</span><span className="sm:hidden">Sub</span>
                                 </button>
                                 <button onClick={()=>setModal('masterKelengkapan')} className="bg-teal-600 hover:bg-teal-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold flex items-center gap-1 md:gap-2 text-xs md:text-sm">
                                     <Settings className="w-3 h-3 md:w-4 md:h-4"/> <span className="hidden lg:inline">Master Lengkap</span><span className="lg:hidden">Master</span>
                                 </button>
                                 <button onClick={logout} className="bg-red-600 hover:bg-red-700 px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold flex items-center gap-1 md:gap-2 text-xs md:text-sm">
                                     <LogOut className="w-3 h-3 md:w-4 md:h-4"/> <span className="hidden md:inline">Logout</span>
                                 </button>
                             </div>
                         </div>
                     </header>
                     
                     {/* Firebase Quota Monitoring Dashboard */}
                     <div className="px-3 md:px-8 pt-4 md:pt-6 max-w-7xl mx-auto">
                         <div className="bg-gradient-to-br from-purple-900 to-slate-800 rounded-2xl p-4 md:p-6 border border-purple-500/30 shadow-2xl mb-4 md:mb-6">
                             <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 md:gap-0 mb-4 md:mb-6">
                                 <div>
                                     <h2 className="text-xl md:text-2xl font-bold text-white mb-1 flex items-center gap-2">
                                         <Activity className="w-5 h-5 md:w-6 md:h-6 text-purple-400"/>
                                         Firebase Quota Monitor
                                     </h2>
                                     <p className="text-purple-200 text-xs md:text-sm">Real-time tracking penggunaan Firebase Reads & Writes ‚Ä¢ Hari ini: {new Date().toLocaleDateString('id-ID')}</p>
                                 </div>
                                 <div className="flex gap-2">
                                     <button 
                                         onClick={() => {
                                             if (confirm('Reset semua statistik quota hari ini?')) resetStats();
                                         }}
                                         className="bg-red-600/50 hover:bg-red-600 px-3 md:px-4 py-2 rounded-lg text-white font-bold text-xs md:text-sm flex items-center gap-2 border border-red-400/30 transition-all">
                                         <RefreshCw className="w-3 h-3 md:w-4 md:h-4"/> Reset
                                     </button>
                                 </div>
                             </div>
                             
                             {/* Metrics Cards */}
                             <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 md:gap-4 mb-4 md:mb-6">
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Reads</span>
                                         <Database className="w-4 h-4 text-blue-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">{quotaStats.serverReads.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">dari {FREE_TIER_READS_LIMIT.toLocaleString()} limit</div>
                                     <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                                         <div 
                                             className={`h-full transition-all ${readsPercentage > 80 ? 'bg-red-500' : readsPercentage > 50 ? 'bg-yellow-500' : 'bg-blue-500'}`}
                                             style={{width: `${Math.min(readsPercentage, 100)}%`}}
                                         ></div>
                                     </div>
                                     <div className="text-xs text-white font-bold mt-1">{readsPercentage}% terpakai</div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Writes</span>
                                         <Edit3 className="w-4 h-4 text-orange-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">{totalWrites.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">dari {FREE_TIER_WRITES_LIMIT.toLocaleString()} limit</div>
                                     <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                                         <div 
                                             className={`h-full transition-all ${writesPercentage > 80 ? 'bg-red-500' : writesPercentage > 50 ? 'bg-yellow-500' : 'bg-orange-500'}`}
                                             style={{width: `${Math.min(writesPercentage, 100)}%`}}
                                         ></div>
                                     </div>
                                     <div className="text-xs text-white font-bold mt-1">{writesPercentage}% terpakai</div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Write Detail</span>
                                         <TrendingUp className="w-4 h-4 text-pink-400"/>
                                     </div>
                                     <div className="text-xl font-black text-white mb-1">{totalWrites.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">total write operations</div>
                                     <div className="mt-2 space-y-1 text-xs">
                                         <div className="flex justify-between">
                                             <span className="text-green-400">‚ûï Creates:</span>
                                             <span className="text-white font-bold">{(quotaStats.totalWrites || 0).toLocaleString()}</span>
                                         </div>
                                         <div className="flex justify-between">
                                             <span className="text-blue-400">‚úèÔ∏è Updates:</span>
                                             <span className="text-white font-bold">{(quotaStats.totalUpdates || 0).toLocaleString()}</span>
                                         </div>
                                         <div className="flex justify-between">
                                             <span className="text-red-400">üóëÔ∏è Deletes:</span>
                                             <span className="text-white font-bold">{(quotaStats.totalDeletes || 0).toLocaleString()}</span>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Cache Hits</span>
                                         <Zap className="w-4 h-4 text-green-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">{quotaStats.cacheHits.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">data dari offline cache</div>
                                     <div className="mt-2 px-3 py-1 bg-green-500/20 border border-green-400/30 rounded-full text-xs font-bold text-green-300 inline-block">
                                         üíæ {cacheEfficiency}% Efficiency
                                     </div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Estimasi Biaya</span>
                                         <DollarSign className="w-4 h-4 text-yellow-400"/>
                                     </div>
                                     <div className="text-2xl font-black text-white mb-1">
                                         {(() => {
                                             let cost = 0;
                                             if (quotaStats.serverReads > FREE_TIER_READS_LIMIT) {
                                                 cost += ((quotaStats.serverReads - FREE_TIER_READS_LIMIT) / 100000) * 0.36;
                                             }
                                             if (totalWrites > FREE_TIER_WRITES_LIMIT) {
                                                 cost += ((totalWrites - FREE_TIER_WRITES_LIMIT) / 100000) * 1.08;
                                             }
                                             return cost > 0 ? `$${cost.toFixed(2)}` : '$0.00';
                                         })()}
                                     </div>
                                     <div className="text-xs text-purple-300">
                                         {(() => {
                                             const overageReads = quotaStats.serverReads > FREE_TIER_READS_LIMIT ? quotaStats.serverReads - FREE_TIER_READS_LIMIT : 0;
                                             const overageWrites = totalWrites > FREE_TIER_WRITES_LIMIT ? totalWrites - FREE_TIER_WRITES_LIMIT : 0;
                                             if (overageReads > 0 || overageWrites > 0) {
                                                 return `overage: ${overageReads > 0 ? overageReads.toLocaleString() + ' reads' : ''} ${overageReads > 0 && overageWrites > 0 ? '+ ' : ''}${overageWrites > 0 ? overageWrites.toLocaleString() + ' writes' : ''}`;
                                             }
                                             return '‚úÖ Masih dalam free tier';
                                         })()}
                                     </div>
                                     <div className="mt-2 px-2 py-1 bg-purple-500/20 border border-purple-400/30 rounded text-xs text-purple-200">
                                         Reset: {new Date().toLocaleDateString('id-ID')}
                                     </div>
                                 </div>
                             </div>
                             
                             {/* Mini Charts */}
                             <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                 {/* Trend Chart */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                         <TrendingUp className="w-4 h-4 text-blue-400"/>
                                         Trend 7 Hari Terakhir (Reads vs Writes)
                                     </h3>
                                     {dailyChartData.length > 0 ? (
                                         <ResponsiveContainer width="100%" height={180}>
                                             <BarChart data={dailyChartData}>
                                                 <CartesianGrid strokeDasharray="3 3" stroke="#475569" />
                                                 <XAxis dataKey="date" tick={{fill: '#cbd5e1', fontSize: 11}} />
                                                 <YAxis tick={{fill: '#cbd5e1', fontSize: 11}} />
                                                 <Tooltip 
                                                     contentStyle={{
                                                         backgroundColor: '#1e293b',
                                                         border: '1px solid #475569',
                                                         borderRadius: '8px',
                                                         color: '#fff'
                                                     }}
                                                 />
                                                 <Bar dataKey="reads" fill="#3b82f6" name="Reads" />
                                                 <Bar dataKey="writes" fill="#f97316" name="Writes" />
                                             </BarChart>
                                         </ResponsiveContainer>
                                     ) : (
                                         <div className="h-180 flex items-center justify-center text-purple-300 text-sm">
                                             Belum ada data tracking
                                         </div>
                                     )}
                                 </div>
                                 
                                 {/* Collection Breakdown - Reads */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                         <Database className="w-4 h-4 text-blue-400"/>
                                         Breakdown Reads per Collection
                                     </h3>
                                     {collectionReadsData.length > 0 ? (
                                         <div className="space-y-2">
                                             {collectionReadsData.map((item, idx) => {
                                                 const percentage = ((item.value / quotaStats.serverReads) * 100).toFixed(1);
                                                 const colors = ['bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-cyan-500', 'bg-green-500'];
                                                 return (
                                                     <div key={idx} className="flex items-center gap-3">
                                                         <div className="flex-1">
                                                             <div className="flex justify-between mb-1">
                                                                 <span className="text-xs font-bold text-white capitalize">{item.name}</span>
                                                                 <span className="text-xs text-purple-300">{item.value.toLocaleString()} ({percentage}%)</span>
                                                             </div>
                                                             <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                                                 <div 
                                                                     className={`h-full ${colors[idx % colors.length]} transition-all`}
                                                                     style={{width: `${percentage}%`}}
                                                                 ></div>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 );
                                             })}
                                         </div>
                                     ) : (
                                         <div className="h-40 flex items-center justify-center text-purple-300 text-sm">
                                             Belum ada server reads
                                         </div>
                                     )}
                                 </div>
                             </div>
                             
                             {/* Collection Breakdown - Writes */}
                             <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 mt-4">
                                 <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                     <Edit3 className="w-4 h-4 text-orange-400"/>
                                     Breakdown Writes per Collection
                                 </h3>
                                 {collectionWritesData.length > 0 ? (
                                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                         {collectionWritesData.map((item, idx) => {
                                                 const percentage = ((item.value / totalWrites) * 100).toFixed(1);
                                                 const colors = ['bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-red-500', 'bg-pink-500'];
                                                 return (
                                                     <div key={idx} className="bg-slate-900/50 rounded-lg p-3 border border-slate-700">
                                                         <div className="flex justify-between items-center mb-2">
                                                             <span className="text-sm font-bold text-white capitalize">{item.name}</span>
                                                             <span className={`px-2 py-0.5 rounded text-xs font-bold ${colors[idx % colors.length]} text-white`}>
                                                                 {percentage}%
                                                             </span>
                                                         </div>
                                                         <div className="text-2xl font-black text-orange-400">{item.value.toLocaleString()}</div>
                                                         <div className="text-xs text-slate-400 mt-1">write operations</div>
                                                     </div>
                                                 );
                                             })}
                                     </div>
                                 ) : (
                                     <div className="h-32 flex items-center justify-center text-purple-300 text-sm">
                                         Belum ada write operations
                                     </div>
                                 )}
                             </div>
                             
                             {/* Tips */}
                             <div className="mt-4 bg-blue-500/10 border border-blue-400/30 rounded-lg p-3">
                                 <div className="flex items-start gap-2">
                                     <Info className="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0"/>
                                     <div className="text-xs text-blue-200">
                                         <strong>üí° Tips:</strong> Free Tier: 50k reads + 20k writes/hari. 
                                         Cache Hits (hijau) tidak mengurangi quota. Overage: Reads $0.36/100k, Writes $1.08/100k.
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <main className="p-8 max-w-7xl mx-auto"> <div className="flex justify-between items-end mb-8"><div><h2 className="text-3xl font-bold mb-2">Daftar Tenant (Owner)</h2><p className="text-slate-400">Kelola bisnis dan hak akses setiap owner.</p></div><button onClick={()=>{setModal('create')}} className="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all hover:scale-105 shadow-lg shadow-purple-900/50"><Plus className="w-5 h-5"/> Buat Owner Baru</button></div> <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {owners.map(owner => { const subStatus = getOwnerSubStatus(owner); return ( <div key={owner.id} className="bg-slate-800 border border-slate-700 rounded-2xl p-6 hover:border-purple-500 transition-all group relative overflow-hidden flex flex-col"> <div className="flex justify-between items-start mb-4 relative z-10"> <div className="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center font-bold text-xl text-purple-400 border border-slate-600">{owner.name?.charAt(0)}</div> <div className="flex gap-2"> <button onClick={()=>{handleEditClick(owner)}} className="bg-blue-900/50 hover:bg-blue-800 text-blue-300 p-2 rounded-lg transition-colors"><Pencil className="w-3 h-3"/></button> <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase pt-1.5 border ${owner.plan === 'pro' ? 'bg-purple-900/50 text-purple-300 border-purple-500/30' : 'bg-slate-700 text-slate-400 border-slate-600'}`}>{owner.plan}</span> </div> </div> <h3 className="text-xl font-bold mb-1">{owner.name}</h3><p className="text-slate-400 text-sm mb-3 flex items-center gap-2"><MessageCircle className="w-3 h-3"/> {owner.email}</p> <div className={`flex items-center justify-between p-3 rounded-lg mb-4 border ${subStatus.status === 'active' ? 'bg-green-900/30 border-green-500/30' : subStatus.status === 'expired' ? 'bg-red-900/30 border-red-500/30' : 'bg-yellow-900/30 border-yellow-500/30'}`}><div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${subStatus.status === 'active' ? 'bg-green-400 animate-pulse' : subStatus.status === 'expired' ? 'bg-red-400' : 'bg-yellow-400'}`}></div><span className={`text-xs font-bold ${subStatus.status === 'active' ? 'text-green-300' : subStatus.status === 'expired' ? 'text-red-300' : 'text-yellow-300'}`}>{subStatus.status === 'active' ? `Aktif - ${subStatus.remainingDays} hari lagi` : subStatus.status === 'expired' ? 'Kedaluwarsa' : 'Belum Diaktifkan'}</span></div><div className="flex gap-1">{subStatus.status === 'active' && <button onClick={() => revokeSubscription(owner)} className="px-2 py-1 rounded text-[10px] font-bold bg-red-600 hover:bg-red-700 text-white" title="Nonaktifkan"><Lock className="w-3 h-3 inline mr-1"/>Nonaktifkan</button>}{subStatus.status === 'active' && <button onClick={() => setSubModal({type: 'activate', owner})} className="px-2 py-1 rounded text-[10px] font-bold bg-blue-600 hover:bg-blue-700 text-white">Perpanjang</button>}{subStatus.status !== 'active' && <button onClick={() => setSubModal({type: 'activate', owner})} className="px-2 py-1 rounded text-[10px] font-bold bg-green-600 hover:bg-green-700 text-white animate-pulse">Aktifkan</button>}</div></div><div className="grid grid-cols-4 gap-2 mb-4"><button onClick={() => { setSelectedOwner(owner); setModal('access'); }} className="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors border border-slate-600"><Key className="w-3 h-3"/> Akses</button><button onClick={() => { setSelectedOwner(owner); setModal('qcItems'); }} className="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors"><ShieldCheck className="w-3 h-3"/> QC</button><button onClick={() => { setSelectedOwner(owner); setModal('kelengkapanItems'); }} className="bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors"><CheckCircle className="w-3 h-3"/> Lengkap</button><button onClick={() => setSubModal({type: 'message', owner})} className="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors" title="Kirim Pesan ke Owner"><MessageCircle className="w-3 h-3"/> Pesan</button></div><button onClick={() => enterTenantContext(owner.id)} className="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-colors mb-2"><Eye className="w-3 h-3"/> Masuk (Spy)</button> <button onClick={() => deleteTenant(owner.id, owner.name)} className="mt-auto w-full py-2 bg-red-900/30 text-red-400 border border-red-900/50 hover:bg-red-900/50 rounded-lg text-xs font-bold flex items-center justify-center gap-2"><Trash2 className="w-3 h-3"/> Hapus Tenant</button> </div> ); })} </div> </main> { (modal === 'create' || modal === 'edit') && ( <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"> <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl"> <h3 className="font-bold text-xl mb-6 text-white">{modal === 'create' ? 'Registrasi Owner Baru' : 'Edit Data Owner'}</h3> <form onSubmit={modal === 'create' ? createOwner : updateOwner} className="space-y-4"> <input name="name" defaultValue={selectedOwner?.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Nama Bisnis / Toko" required/> <input name="ownerName" defaultValue={selectedOwnerUser?.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Nama Pemilik" required/> <input name="email" type="email" defaultValue={selectedOwner?.email} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Email Login Owner" required/> {modal === 'create' && <input name="password" type="password" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Password Login (Min 6 Karakter)" required minLength="6"/>} <div className="grid grid-cols-1 gap-2"> <label className="text-xs text-slate-400 font-bold uppercase">Pilih Paket Langganan</label> <select name="plan" defaultValue={selectedOwner?.plan || 'basic'} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none"> <option value="basic">Basic Plan (Max 1 Cabang, No Backup)</option> <option value="pro">Pro Plan (Unlimited, Full Akses)</option> </select> </div> <div className="flex gap-3 mt-6"> <button type="button" onClick={()=>{setModal(null); setSelectedOwner(null); setSelectedOwnerUser(null);}} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button> <button disabled={loading} className="flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 shadow-lg shadow-purple-900/50 flex items-center justify-center gap-2"> {loading && <Loader2 className="w-4 h-4 animate-spin"/>} {modal === 'create' ? 'Buat Tenant' : 'Simpan Perubahan'} </button> </div> </form> </div> </div> ) } {modal === 'access' && selectedOwner && ( <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-2"><div className="bg-slate-800 border border-slate-700 w-full max-w-[98vw] rounded-2xl shadow-2xl h-[96vh] overflow-hidden flex flex-col"><div className="flex items-center justify-between gap-3 p-6 border-b border-slate-700 bg-slate-750"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white text-lg">{selectedOwner.name.charAt(0)}</div><div><h3 className="font-bold text-lg text-white">{selectedOwner.name}</h3><p className="text-xs text-purple-300">Pengaturan Hak Akses Tenant - Kontrol Fitur & Menu</p></div></div><button type="button" onClick={()=>setModal(null)} className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700 rounded-lg"><X className="w-5 h-5"/></button></div><div className="px-6 pt-4"><p className="text-slate-400 text-sm bg-slate-900/50 p-3 rounded-lg border border-slate-700"><span className="text-yellow-400 font-bold">‚ö†Ô∏è PERHATIAN:</span> Fitur yang Anda matikan akan <strong>terkunci permanen</strong> untuk Owner dan seluruh karyawannya.</p></div><form onSubmit={updateAccess} className="flex-1 overflow-y-auto p-6 space-y-6"><div className="space-y-4"><div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4"><h4 className="font-bold text-blue-300 mb-3 flex items-center gap-2"><LayoutDashboard className="w-4 h-4"/> MENU UTAMA</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_dashboard', label: 'üìä Dashboard'},{id: 'menu_report', label: 'üìà Laporan'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div></div></label>))}</div></div><div className="bg-green-900/20 border border-green-500/30 rounded-lg p-4"><h4 className="font-bold text-green-300 mb-3 flex items-center gap-2"><Smartphone className="w-4 h-4"/> MENU TRANSAKSI</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_service', label: 'üì± Servis HP'},{id: 'menu_sales', label: 'üõí Penjualan'},{id: 'menu_purchase', label: 'üõçÔ∏è Pembelian'},{id: 'menu_return_sales', label: '‚Ü©Ô∏è Retur Penjualan'},{id: 'menu_return_purchase', label: '‚Ü™Ô∏è Retur Pembelian'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div></div></label>))}</div></div><div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4"><h4 className="font-bold text-yellow-300 mb-3 flex items-center gap-2"><Wallet className="w-4 h-4"/> MENU KEUANGAN</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_payable', label: 'üì§ Utang'},{id: 'menu_receivable', label: 'üì• Piutang'},{id: 'menu_cash', label: 'üíµ Kas'},{id: 'menu_finance', label: 'üí≥ Laporan Keuangan'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600"></div></div></label>))}</div></div><div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4"><h4 className="font-bold text-purple-300 mb-3 flex items-center gap-2"><Box className="w-4 h-4"/> MENU INVENTORY & DATA</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_inventory', label: 'üì¶ Stok Barang'},{id: 'menu_supplier', label: 'üöö Supplier'},{id: 'menu_customers', label: 'üë• Pelanggan'},{id: 'menu_hr', label: 'üëî HR & Payroll'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div></div></label>))}</div></div><div className="bg-red-900/20 border border-red-500/30 rounded-lg p-4"><h4 className="font-bold text-red-300 mb-3 flex items-center gap-2"><Settings className="w-4 h-4"/> MENU ADMIN</h4><div className="grid grid-cols-1 gap-3">{[{id: 'menu_users', label: 'üë® Pegawai'},{id: 'menu_settings', label: '‚öôÔ∏è Pengaturan'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div></div></label>))}</div></div><div className="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-4"><h4 className="font-bold text-cyan-300 mb-3 flex items-center gap-2"><ShieldCheck className="w-4 h-4"/> FITUR & AKSI</h4><div className="grid grid-cols-1 gap-3">{[{id: 'feature_service_edit', label: '‚úèÔ∏è Edit Servis'},{id: 'feature_sales_edit', label: '‚úèÔ∏è Edit Penjualan'},{id: 'feature_inventory_edit', label: '‚úèÔ∏è Edit Inventory'},{id: 'feature_customer_edit', label: '‚úèÔ∏è Edit Pelanggan'},{id: 'feature_employee_edit', label: '‚úèÔ∏è Edit Pegawai'},{id: 'feature_finance_edit', label: '‚úèÔ∏è Edit Keuangan'},{id: 'feature_print', label: 'üñ®Ô∏è Cetak Invoice'},{id: 'feature_share', label: 'üí¨ Share WhatsApp'},{id: 'feature_delete', label: 'üóëÔ∏è Hapus Data'},{id: 'feature_stock_add', label: '‚ûï Tambah Stok'},{id: 'feature_backup', label: 'üíæ Backup Data'},{id: 'feature_import_export', label: 'üì§ Import/Export'},{id: 'feature_multi_branch', label: 'üè¢ Multi Cabang'},{id: 'feature_qc_checklist', label: '‚úÖ QC Checklist'},{id: 'feature_kelengkapan', label: 'üìã Kelengkapan Item'},{id: 'feature_accounting', label: 'üìä Akuntansi'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"></div></div></label>))}</div></div></div><div className="flex gap-3 pt-4 border-t border-slate-700"><button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700 text-sm">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 text-sm flex items-center justify-center gap-2"><Save className="w-4 h-4"/>Simpan Hak Akses</button></div></form></div></div> )} {modal === 'plan' && <PlanConfigModal close={()=>setModal(null)} />} {modal === 'masterKelengkapan' && <MasterKelengkapanModal close={()=>setModal(null)} />} {modal === 'qcItems' && <QCFunctionalItemsModal close={()=>setModal(null)} ownerId={selectedOwner?.id} />} {modal === 'kelengkapanItems' && <KelengkapanItemsModal close={()=>setModal(null)} ownerId={selectedOwner?.id} />}

                    {/* Subscription Settings Modal */}
                    {subModal === 'settings' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-xl text-white flex items-center gap-2"><Banknote className="w-5 h-5 text-amber-400"/> Pengaturan Langganan</h3>
                                    <button onClick={() => setSubModal(null)} className="text-slate-400 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                </div>
                                <form onSubmit={(e) => { e.preventDefault(); const fd = new FormData(e.target); saveSubConfig({ price: parseInt(fd.get('price')), duration: parseInt(fd.get('duration')), whatsapp: fd.get('whatsapp'), currency: 'IDR' }); }} className="space-y-4">
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">No. WhatsApp Admin</label>
                                        <input name="whatsapp" type="tel" defaultValue={subConfig.whatsapp} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-amber-500 outline-none font-bold" placeholder="6281234567890" required/>
                                        <p className="text-xs text-slate-500 mt-1">Nomor WA yang tampil di halaman lock (format: 628xxx tanpa + atau spasi)</p>
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Harga Langganan (Rp)</label>
                                        <input name="price" type="number" defaultValue={subConfig.price} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-amber-500 outline-none text-lg font-bold" placeholder="500000" required/>
                                        <p className="text-xs text-slate-500 mt-1">Harga yang harus dibayar owner untuk mengaktifkan aplikasi</p>
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Durasi Aktif (Hari)</label>
                                        <input name="duration" type="number" defaultValue={subConfig.duration} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-amber-500 outline-none text-lg font-bold" placeholder="365" required min="1"/>
                                        <p className="text-xs text-slate-500 mt-1">Berapa hari aplikasi aktif setelah pembayaran (default: 365 = 1 tahun)</p>
                                    </div>
                                    <div className="bg-amber-900/30 border border-amber-500/30 p-4 rounded-lg">
                                        <p className="text-amber-200 text-sm font-bold mb-1">Preview:</p>
                                        <p className="text-white text-sm">Rp {(subConfig.price || 0).toLocaleString('id-ID')} / {subConfig.duration || 365} hari</p>
                                        <p className="text-xs text-amber-300 mt-1">= Rp {Math.round((subConfig.price || 0) / (subConfig.duration || 365) * 30).toLocaleString('id-ID')} / bulan</p>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setSubModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button>
                                        <button disabled={loading} className="flex-1 py-3 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 flex items-center justify-center gap-2">
                                            {loading && <Loader2 className="w-4 h-4 animate-spin"/>} Simpan Setting
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Activate/Extend Subscription Modal */}
                    {subModal?.type === 'activate' && subModal.owner && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-xl text-white flex items-center gap-2"><CheckCircle className="w-5 h-5 text-green-400"/> Aktifkan Langganan</h3>
                                    <button onClick={() => setSubModal(null)} className="text-slate-400 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                </div>
                                <div className="bg-slate-900 p-4 rounded-lg mb-4 border border-slate-700">
                                    <p className="text-white font-bold text-lg">{subModal.owner.name}</p>
                                    <p className="text-slate-400 text-sm">{subModal.owner.email}</p>
                                    {(() => {
                                        const st = getOwnerSubStatus(subModal.owner);
                                        return st.status === 'active' ? (
                                            <p className="text-green-400 text-xs mt-2 font-bold">Status: Aktif - {st.remainingDays} hari tersisa (s/d {st.expiresAt?.toLocaleDateString('id-ID', {day:'numeric',month:'long',year:'numeric'})})</p>
                                        ) : st.status === 'expired' ? (
                                            <p className="text-red-400 text-xs mt-2 font-bold">Status: Kedaluwarsa sejak {st.expiresAt?.toLocaleDateString('id-ID')}</p>
                                        ) : (
                                            <p className="text-yellow-400 text-xs mt-2 font-bold">Status: Belum pernah diaktifkan</p>
                                        );
                                    })()}
                                    {subModal.owner.adminMessage && (
                                        <div className="mt-2 p-2 bg-blue-900/30 border border-blue-500/30 rounded">
                                            <p className="text-blue-300 text-xs font-bold flex items-center gap-1"><MessageCircle className="w-3 h-3"/> Pesan Admin:</p>
                                            <p className="text-blue-200 text-xs mt-1">{subModal.owner.adminMessage}</p>
                                            {subModal.owner.adminMessageAt && subModal.owner.adminMessageAt.seconds && (
                                                <p className="text-blue-400 text-[10px] mt-1 opacity-70">
                                                    {new Date(subModal.owner.adminMessageAt.seconds * 1000).toLocaleString('id-ID')}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <form onSubmit={(e) => { e.preventDefault(); const fd = new FormData(e.target); activateSubscription(subModal.owner, parseInt(fd.get('price')), parseInt(fd.get('duration')), fd.get('adminMessage')); }} className="space-y-4">
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Harga (Rp)</label>
                                        <input name="price" type="number" defaultValue={subConfig.price} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-green-500 outline-none font-bold" required/>
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Durasi (Hari)</label>
                                        <input name="duration" type="number" defaultValue={subConfig.duration} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-green-500 outline-none font-bold" required min="1"/>
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 flex items-center gap-2">
                                            <MessageCircle className="w-3 h-3"/> Pesan untuk Owner (Opsional)
                                        </label>
                                        <textarea 
                                            name="adminMessage" 
                                            rows="3" 
                                            defaultValue={subModal.owner.adminMessage || ''}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-green-500 outline-none text-sm" 
                                            placeholder="Contoh: Terima kasih telah memperpanjang langganan. Jika ada pertanyaan, hubungi kami via WhatsApp."
                                        ></textarea>
                                        <p className="text-xs text-slate-500 mt-1">üí° Pesan ini akan tampil di layar owner, termasuk saat aplikasi terkunci</p>
                                    </div>
                                    {subModal.owner.subscription?.history?.length > 0 && (
                                        <div>
                                            <label className="text-xs text-slate-400 font-bold uppercase mb-2 block">Riwayat Pembayaran</label>
                                            <div className="space-y-2 max-h-32 overflow-y-auto">
                                                {subModal.owner.subscription.history.slice().reverse().map((h, idx) => (
                                                    <div key={idx} className="bg-slate-900/80 p-2 rounded border border-slate-700 text-xs flex justify-between">
                                                        <span className="text-slate-300">{new Date(h.activatedAt).toLocaleDateString('id-ID')}</span>
                                                        <span className="text-green-400 font-bold">Rp {(h.amount || 0).toLocaleString('id-ID')}</span>
                                                        <span className="text-slate-500">{h.duration} hari</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setSubModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button>
                                        <button disabled={loading} className="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2">
                                            {loading && <Loader2 className="w-4 h-4 animate-spin"/>} Aktifkan Sekarang
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Send Message to Owner Modal */}
                    {subModal?.type === 'message' && subModal.owner && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-xl text-white flex items-center gap-2"><MessageCircle className="w-5 h-5 text-purple-400"/> Kirim Pesan ke Owner</h3>
                                    <button onClick={() => setSubModal(null)} className="text-slate-400 hover:text-white p-1"><X className="w-5 h-5"/></button>
                                </div>
                                <div className="bg-slate-900 p-4 rounded-lg mb-4 border border-slate-700">
                                    <p className="text-white font-bold text-lg">{subModal.owner.name}</p>
                                    <p className="text-slate-400 text-sm">{subModal.owner.email}</p>
                                </div>
                                <form onSubmit={async (e) => { 
                                    e.preventDefault(); 
                                    const fd = new FormData(e.target);
                                    const message = fd.get('adminMessage');
                                    if (!message || !message.trim()) {
                                        alert('Pesan tidak boleh kosong!');
                                        return;
                                    }
                                    setLoading(true);
                                    try {
                                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', subModal.owner.id), {
                                            adminMessage: message.trim(),
                                            adminMessageAt: serverTimestamp()
                                        });
                                        alert('‚úÖ Pesan berhasil terkirim ke ' + subModal.owner.name);
                                        setSubModal(null);
                                    } catch (err) {
                                        alert('Gagal mengirim pesan: ' + err.message);
                                    } finally {
                                        setLoading(false);
                                    }
                                }} className="space-y-4">
                                    {subModal.owner.adminMessage && (
                                        <div className="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3">
                                            <p className="text-blue-300 text-xs font-bold mb-2">Pesan Saat Ini:</p>
                                            <p className="text-blue-200 text-sm">{subModal.owner.adminMessage}</p>
                                            {subModal.owner.adminMessageAt && subModal.owner.adminMessageAt.seconds && (
                                                <p className="text-blue-400 text-[10px] mt-1 opacity-70">
                                                    {new Date(subModal.owner.adminMessageAt.seconds * 1000).toLocaleString('id-ID', { 
                                                        dateStyle: 'medium', 
                                                        timeStyle: 'short' 
                                                    })}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                    <div>
                                        <label className="text-xs text-slate-400 font-bold uppercase mb-1 block">Pesan Baru</label>
                                        <textarea 
                                            name="adminMessage" 
                                            rows="5" 
                                            defaultValue={subModal.owner.adminMessage || ''}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none text-sm" 
                                            placeholder="Ketik pesan untuk owner di sini... Pesan akan tampil di layar mereka termasuk saat aplikasi terkunci."
                                            required
                                        ></textarea>
                                        <p className="text-xs text-slate-500 mt-1">üí° Pesan ini akan tampil di layar owner, termasuk saat aplikasi nonaktif/terkunci</p>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setSubModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button>
                                        <button disabled={loading} className="flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 flex items-center justify-center gap-2">
                                            {loading && <Loader2 className="w-4 h-4 animate-spin"/>} Kirim Pesan
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                 </div> );
        };

        const Dashboard = ({setView}) => {
          const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
          
          // Permission check
          if (!checkPermission('menu_dashboard')) {
              return (
                  <div className="p-10 text-center">
                      <div className="bg-red-50 border border-red-200 rounded-lg p-6 inline-block">
                          <Lock className="w-10 h-10 text-red-600 mx-auto mb-3"/>
                          <h2 className="text-lg font-bold text-red-600 mb-2">‚ùå Akses Ditolak</h2>
                          <p className="text-slate-600">Menu Dashboard telah dikunci oleh Superadmin/Owner. Hubungi mereka untuk mendapatkan akses.</p>
                      </div>
                  </div>
              );
          }
          
          useRealtimePlanSync(activeOwner);
          const { data: services, fromCache: servicesFromCache } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
          const { data: transactions, fromCache: transactionsFromCache } = useFirestoreCollection('transactions', activeOwner?.id, activeStore?.id); // ‚úÖ FIXED: Filter by storeId untuk isolasi data per cabang
          const { data: sales, fromCache: salesFromCache } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
          const { data: users } = useFirestoreCollection('users', activeOwner?.id, activeStore?.id);
          const { data: inventory = [] } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
          const [filter, setFilter] = useState('today');
          const [customDateRange, setCustomDateRange] = useState({start: '', end: ''});
          const [detailModal, setDetailModal] = useState(null);
          const [technicianModal, setTechnicianModal] = useState(null);
          const [inventorySettings, setInventorySettings] = useState({});
          
          // Load inventory settings with debounce
          useEffect(() => {
              if (!activeOwner?.id) return;
              let unsubscribeRef = null;
              let timeoutRef = null;
              
              let q;
              if (activeStore?.id && activeStore.id !== 'all') {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
              } else {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', activeOwner.id));
              }
              
              unsubscribeRef = onSnapshot(q, (snapshot) => {
                  // Debounce settings update
                  if (timeoutRef) clearTimeout(timeoutRef);
                  timeoutRef = setTimeout(() => {
                      let settings = { minStockThreshold: 5 }; // default
                      snapshot.docs.forEach(doc => {
                          const data = doc.data();
                          if (data.inventorySettings) {
                              settings = { ...settings, ...data.inventorySettings };
                          }
                      });
                      setInventorySettings(settings);
                  }, 100); // 100ms debounce
              }, (error) => {
                  console.error('Error loading inventory settings:', error);
                  setInventorySettings({ minStockThreshold: 5 }); // fallback
              });
              
              return () => {
                  if (timeoutRef) clearTimeout(timeoutRef);
                  if (unsubscribeRef) {
                      unsubscribeRef();
                  }
              };
          }, [activeOwner?.id, activeStore?.id]);
          
          const getFilteredData = (items, isTransaction = false) => {
              if (filter === 'custom' && customDateRange.start && customDateRange.end) {
                  const startDate = new Date(customDateRange.start);
                  const endDate = new Date(customDateRange.end);
                  endDate.setHours(23, 59, 59, 999);
                  return items.filter(i => {
                      // Untuk transactions, prioritaskan field 'date'
                      const d = isTransaction ? 
                          (i.date?.seconds ? new Date(i.date.seconds * 1000) : (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : null)) :
                          (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : (i.date?.seconds ? new Date(i.date.seconds * 1000) : null));
                      if(!d) return false;
                      return d >= startDate && d <= endDate;
                  });
              }
              if (filter === 'all') return items;
              const now = new Date();
              return items.filter(i => {
                  // Untuk transactions, prioritaskan field 'date'
                  const d = isTransaction ? 
                      (i.date?.seconds ? new Date(i.date.seconds * 1000) : (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : null)) :
                      (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : (i.date?.seconds ? new Date(i.date.seconds * 1000) : null));
                  if(!d) return false;
                  if (filter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                  if (filter === 'today') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                  if (filter === 'year') return d.getFullYear() === now.getFullYear();
                  return true;
              });
          };

          const filteredServices = getFilteredData(services, false);
          const filteredTrans = getFilteredData(transactions, true);
          const filteredSales = getFilteredData(sales || [], false);
          
          // Debug log untuk troubleshooting
          React.useEffect(() => {
              if (filter === 'today') {
                  const profitTransactions = filteredTrans.filter(t => t.type === 'profit');
                  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  console.log('üîç DASHBOARD DEBUG - Filter: HARI INI');
                  console.log('Total transactions:', transactions.length);
                  console.log('Filtered transactions:', filteredTrans.length);
                  console.log('Profit transactions di hari ini:', profitTransactions.length);
                  
                  if (profitTransactions.length > 0) {
                      console.log('\n‚ö†Ô∏è DETAIL PROFIT TRANSACTIONS:');
                      profitTransactions.forEach((t, idx) => {
                          const dateField = t.date?.seconds ? new Date(t.date.seconds * 1000) : null;
                          const createdAtField = t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : null;
                          console.log(`  ${idx + 1}. ${t.category}:`);
                          console.log(`     Amount: Rp ${t.amount?.toLocaleString('id-ID')}`);
                          console.log(`     date field: ${dateField ? dateField.toLocaleString('id-ID') : 'N/A'}`);
                          console.log(`     createdAt field: ${createdAtField ? createdAtField.toLocaleString('id-ID') : 'N/A'}`);
                          console.log(`     serviceId: ${t.serviceId}`);
                      });
                  } else {
                      console.log('‚úÖ Tidak ada profit transactions di hari ini - CORRECT!');
                  }
                  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              }
          }, [filter, filteredTrans]);

          const assignTechnician = async (serviceId, technicianName) => {
              if (!technicianName?.trim()) {
                  alert('Nama tekhnisi tidak boleh kosong');
                  return;
              }
              try {
                  const serviceDoc = filteredServices.find(s => s.id === serviceId);
                  const currentTechs = serviceDoc?.technicians || [];
                  
                  // Check if already assigned
                  if (currentTechs.includes(technicianName.trim())) {
                      alert('Tekhnisi ini sudah ditugaskan');
                      return;
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId), {
                      technicians: [...currentTechs, technicianName.trim()]
                  });
                  setTechnicianModal(null);
                  alert('Tekhnisi berhasil ditambahkan');
              } catch (err) {
                  alert('Gagal tambah tekhnisi: ' + err.message);
              }
          };

          const queueCount = filteredServices.filter(s => ['Diterima', 'Diagnosa'].includes(s.status)).length;
          const activeCount = filteredServices.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status)).length;
          const readyCount = filteredServices.filter(s => s.status === 'Selesai').length;
          const completedServices = filteredServices.filter(s => s.status === 'Selesai');
          const sales_total = filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0);
          const income_trans = filteredTrans.filter(t => t.type === 'income');
          const service_income = income_trans.reduce((a,b)=>a+b.amount,0);
          const expense_trans = filteredTrans.filter(t => t.type === 'expense');
          const expense = expense_trans.reduce((a,b)=>a+b.amount,0);
          const profit_trans = filteredTrans.filter(t => t.type === 'profit').reduce((a,b)=>a+b.amount,0);
          const profit_jasa = filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0);
          const profit_penjualan = profit_trans - profit_jasa;
          const loss_trans = filteredTrans.filter(t => t.type === 'loss').reduce((a,b)=>a+b.amount,0);
          const kerugian = loss_trans;
          const netProfit = service_income - expense;
          const totalProfit = netProfit + profit_trans - loss_trans;
          const service_income_only = filteredTrans.filter(t => t.type === 'income' && t.category?.includes('Servis')).reduce((a,b)=>a+b.amount,0);
          
          // Kompensasi Retur
          const kompensasi_retur_penjualan = filteredTrans.filter(t => t.type === 'income' && t.category === 'Kompensasi Retur Penjualan').reduce((a,b)=>a+b.amount,0);
          const kompensasi_retur_pembelian = filteredTrans.filter(t => t.type === 'expense' && t.category === 'Kompensasi Retur Pembelian').reduce((a,b)=>a+b.amount,0);

          const keuntungan = profit_jasa + profit_penjualan - kompensasi_retur_penjualan - kompensasi_retur_pembelian;
          
          // Calculate urgent stock and inventory metrics
          const minThreshold = inventorySettings.minStockThreshold || 5;
          const urgentStock = inventory.filter(i => (i.stock || 0) <= minThreshold && (i.stock || 0) > 0);
          const outOfStock = inventory.filter(i => (i.stock || 0) === 0);
          const totalStockValue = inventory.reduce((sum, item) => sum + ((item.sellPrice || 0) * (item.stock || 0)), 0);
          
          const statusCounts = filteredServices.reduce((acc, curr) => { acc[curr.status] = (acc[curr.status] || 0) + 1; return acc; }, {});
          const pieData = Object.keys(statusCounts).map(key => ({ name: key, value: statusCounts[key] }));
          const flowData = [{name:'Servis', val:service_income_only}, {name:'Penjualan', val:sales_total}, {name:'Pengeluaran', val:expense}];
          
          const StatCard = ({ title, value, icon: Icon, color, sub, clickable, onClick }) => ( 
            <button onClick={onClick} disabled={!clickable} className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group transition-all duration-300 text-left ${clickable ? 'hover:shadow-md hover:border-blue-200 cursor-pointer' : ''}`}> 
              <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity ${color}`}><Icon className="w-24 h-24" /></div> 
              <div className="relative z-10">
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center mb-2 ${color} text-white shadow-lg shadow-blue-500/20`}><Icon className="w-5 h-5"/></div>
                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">{title}</p>
                <h3 className="font-bold text-slate-800 line-clamp-2 break-words max-w-full" style={{fontSize: '0.875rem', lineHeight: '1.25'}}>{value}</h3>
                {sub && <p className="text-xs text-slate-400 mt-1">{sub}</p>}
              </div> 
            </button> 
          );
          
          return ( 
            <div className="space-y-6"> 
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onClick={() => { sessionStorage.setItem('autoOpenServiceForm', 'true'); setView('service'); }} className="bg-blue-600 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-600/20 hover:bg-blue-700 hover:scale-105 transition-all whitespace-nowrap"><Plus className="w-5 h-5"/> Servis Baru</button>
                        <button onClick={() => setView('sales')} className="bg-white text-slate-600 border border-slate-200 px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50 transition-colors whitespace-nowrap"><Store className="w-5 h-5"/> Penjualan</button>
                        {/* Cache Indicator Badge */}
                        {(servicesFromCache || transactionsFromCache || salesFromCache) && (
                            <div className="flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-xl text-xs">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="font-bold text-green-700">üì± Offline Mode - Hemat Quota</span>
                            </div>
                        )}
                    </div> 
                    <div className="flex flex-col gap-3 w-full md:w-auto">
                        <div className="bg-white border border-slate-200 rounded-lg p-1 flex flex-wrap gap-1">
                            {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'},{id:'custom',l:'Custom'}].map(f => (
                                <button key={f.id} onClick={()=>{setFilter(f.id); if(f.id!=='custom') setCustomDateRange({start:'',end:''})}} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filter === f.id ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}>{f.l}</button>
                            ))}
                        </div>
                        {filter === 'custom' && (
                            <div className="flex gap-2 bg-white border border-slate-200 rounded-lg p-2">
                                <input type="date" value={customDateRange.start} onChange={(e)=>setCustomDateRange({...customDateRange, start:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Dari"/>
                                <span className="text-slate-400">-</span>
                                <input type="date" value={customDateRange.end} onChange={(e)=>setCustomDateRange({...customDateRange, end:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Ke"/>
                            </div>
                        )}
                    </div>
                </div>

                {/* Baris 1: Servis & Jasa */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Antrian" value={queueCount} icon={RotateCw} color="bg-orange-500" sub="Menunggu proses" clickable={queueCount > 0} onClick={() => queueCount > 0 && setDetailModal({type:'queue', title:'Antrian'})} />
                  <StatCard title="Servis Aktif" value={activeCount} icon={Activity} color="bg-blue-500" sub="Sedang dikerjakan" clickable={activeCount > 0} onClick={() => activeCount > 0 && setDetailModal({type:'active_service', title:'Servis Aktif'})} />
                  <StatCard title="Status Selesai" value={readyCount} icon={CheckCircle} color="bg-emerald-500" sub="Servis Selesai" clickable={readyCount > 0} onClick={() => readyCount > 0 && setDetailModal({type:'ready_service', title:'Status Selesai'})} />
                  <StatCard title="Untung Jasa" value={formatCurrency(profit_jasa)} icon={TrendingUp} color="bg-indigo-500" sub="Profit Servis" clickable={profit_jasa > 0} onClick={() => profit_jasa > 0 && setDetailModal({type:'profit', subType:'jasa', title:'Keuntungan Jasa'})} />
                </div>

                {/* Baris 2: Keuangan & Kompensasi */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Pemasukan" value={formatCurrency(service_income)} icon={TrendingUp} color="bg-green-500" sub="Total Penjualan" clickable={income_trans.length > 0} onClick={() => income_trans.length > 0 && setDetailModal({type:'income', title:'Pemasukan'})} />
                  <StatCard title="Pengeluaran" value={formatCurrency(expense)} icon={ArrowDownRight} color="bg-red-500" sub="Total Modal" clickable={expense_trans.length > 0} onClick={() => expense_trans.length > 0 && setDetailModal({type:'expense', title:'Pengeluaran'})} />
                  <StatCard title="Untung Jual" value={formatCurrency(profit_penjualan)} icon={TrendingUp} color="bg-cyan-500" sub="Profit Penjualan" clickable={profit_penjualan > 0} onClick={() => profit_penjualan > 0 && setDetailModal({type:'profit', subType:'penjualan', title:'Keuntungan Penjualan'})} />
                  <StatCard title="Komp. Retur Jual" value={formatCurrency(kompensasi_retur_penjualan)} icon={RotateCcw} color="bg-teal-500" sub="Fee dari Customer" clickable={kompensasi_retur_penjualan > 0} onClick={() => kompensasi_retur_penjualan > 0 && setDetailModal({type:'kompensasi_retur_penjualan', title:'Kompensasi Retur Penjualan'})} />
                </div>

                {/* Baris 3: Kompensasi Retur Pembelian + Total Keuntungan */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Komp. Retur Beli" value={formatCurrency(kompensasi_retur_pembelian)} icon={RotateCw} color="bg-rose-500" sub="Fee ke Supplier" clickable={kompensasi_retur_pembelian > 0} onClick={() => kompensasi_retur_pembelian > 0 && setDetailModal({type:'kompensasi_retur_pembelian', title:'Kompensasi Retur Pembelian'})} />
                  <StatCard title="Nilai Stok" value={formatCurrency(totalStockValue)} icon={Box} color="bg-indigo-500" sub={`${inventory.length} items`} clickable={true} onClick={() => setDetailModal({type:'stock_value', title:'Nilai Total Stok'})} />
                  <div className={`col-span-2 p-5 rounded-2xl shadow-sm border relative overflow-hidden transition-all duration-300 text-left ${keuntungan >= 0 ? 'bg-blue-50 border-blue-200' : 'bg-amber-50 border-amber-200'}`}>
                    <p className={`text-xs font-bold uppercase tracking-wider mb-1 ${keuntungan >= 0 ? 'text-blue-400' : 'text-amber-400'}`}>Total Keuntungan</p>
                    <h3 className={`font-bold text-2xl ${keuntungan >= 0 ? 'text-blue-600' : 'text-amber-600'}`}>{formatCurrency(keuntungan)}</h3>
                  </div>
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6"> 
                  <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80">
                    <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Wallet className="w-4 h-4 text-slate-400"/> Arus Kas</h3>
                    <ResponsiveContainer width="100%" height="85%">
                      <AreaChart data={flowData}>
                        <defs><linearGradient id="colorInc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.8}/><stop offset="95%" stopColor="#8b5cf6" stopOpacity={0}/></linearGradient></defs>
                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill:'#94a3b8', fontSize:12}} />
                        <YAxis axisLine={false} tickLine={false} tick={{fill:'#94a3b8', fontSize:12}} />
                        <CartesianGrid vertical={false} stroke="#f1f5f9" />
                        <Tooltip contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                        <Area type="monotone" dataKey="val" stroke="#8b5cf6" fillOpacity={1} fill="url(#colorInc)" />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div> 
                  <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80 flex flex-col">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Smartphone className="w-4 h-4 text-slate-400"/> Status Servis</h3>
                    <div className="flex-1 w-full flex items-center justify-center">
                      {pieData.length > 0 ? (
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={pieData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5}>
                              {pieData.map((entry, index) => (<Cell key={`cell-${index}`} fill={['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'][index % 6]} />))}
                            </Pie>
                            <Tooltip />
                          </PieChart>
                        </ResponsiveContainer>
                      ) : (
                        <p className="text-slate-400 text-sm text-center">Tidak ada data servis</p>
                      )}
                    </div>
                  </div> 
                </div>
                
                {/* Urgent Stock Warning */}
                {urgentStock.length > 0 && (
                <div className="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-lg mb-6">
                    <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-amber-500 mt-0.5" />
                        <div className="flex-1">
                            <h4 className="font-bold text-amber-800 mb-2">‚ö†Ô∏è Stok Menipis ({urgentStock.length} item)</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-3">
                                {urgentStock.slice(0, 6).map(item => (
                                    <div key={item.id} className="bg-white p-2 rounded border border-amber-200 text-sm flex justify-between">
                                        <span className="font-medium text-slate-700">{item.name}</span>
                                        <span className="text-amber-700 font-bold">{item.stock} unit</span>
                                    </div>
                                ))}
                            </div>
                            {urgentStock.length > 6 && (
                                <p className="text-xs text-amber-600">dan {urgentStock.length - 6} item lainnya...</p>
                            )}
                            <button 
                                onClick={() => setDetailModal({type:'urgent_stock', title:'Stok Menipis', data: urgentStock})}
                                className="mt-2 text-xs font-bold text-amber-700 hover:text-amber-900 hover:underline"
                            >
                                Lihat Semua ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                )}
                
                {/* Out of Stock Alert */}
                {outOfStock.length > 0 && (
                <div className="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg mb-6">
                    <div className="flex items-start gap-3">
                        <X className="w-5 h-5 text-red-500 mt-0.5" />
                        <div className="flex-1">
                            <h4 className="font-bold text-red-800 mb-2">üî¥ Stok Habis ({outOfStock.length} item)</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-3">
                                {outOfStock.slice(0, 6).map(item => (
                                    <div key={item.id} className="bg-white p-2 rounded border border-red-200 text-sm">
                                        <span className="font-medium text-slate-700">{item.name}</span>
                                    </div>
                                ))}
                            </div>
                            {outOfStock.length > 6 && (
                                <p className="text-xs text-red-600">dan {outOfStock.length - 6} item lainnya...</p>
                            )}
                            <button 
                                onClick={() => setDetailModal({type:'out_of_stock', title:'Stok Habis', data: outOfStock})}
                                className="mt-2 text-xs font-bold text-red-700 hover:text-red-900 hover:underline"
                            >
                                Lihat Semua ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                )}
                
                {/* Modal Detail */}
                {detailModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden shadow-2xl flex flex-col">
                            {/* Header */}
                            <div className="flex justify-between items-center border-b border-slate-200 p-6 bg-gradient-to-r from-slate-50 to-slate-100">
                                <div>
                                    <h3 className="font-bold text-2xl text-slate-800">{detailModal.title}</h3>
                                    <p className="text-xs text-slate-500 mt-1">
                                        {detailModal.type === 'queue' && '‚è±Ô∏è Daftar servis yang menunggu proses'}
                                        {detailModal.type === 'active_service' && 'üìã Daftar servis yang sedang dikerjakan'}
                                        {detailModal.type === 'ready_service' && '‚úÖ Daftar servis yang sudah selesai'}
                                        {detailModal.type === 'income' && 'üí∞ Semua transaksi pemasukan'}
                                        {detailModal.type === 'expense' && 'üí∏ Semua transaksi pengeluaran'}
                                        {detailModal.type === 'profit' && detailModal.subType === 'jasa' && 'üíµ Keuntungan dari jasa servis'}
                                        {detailModal.type === 'profit' && detailModal.subType === 'penjualan' && 'üõçÔ∏è Keuntungan dari penjualan sparepart'}
                                        {detailModal.type === 'kompensasi_retur_penjualan' && 'üí∞ Fee kompensasi dari pelanggan untuk retur penjualan'}
                                        {detailModal.type === 'kompensasi_retur_pembelian' && 'üí∏ Fee kompensasi ke supplier untuk retur pembelian'}
                                        {detailModal.type === 'urgent_stock' && '‚ö†Ô∏è Daftar item dengan stok menipis'}
                                        {detailModal.type === 'out_of_stock' && 'üî¥ Daftar item dengan stok habis'}
                                        {detailModal.type === 'stock_value' && 'üíé Detail nilai total stok inventory'}
                                    </p>
                                </div>
                                <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-lg transition-all"><X className="w-6 h-6 text-slate-600" /></button>
                            </div>

                            {/* Content */}
                            <div className="overflow-y-auto flex-1 p-6">
                                {detailModal.type === 'queue' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {filteredServices.filter(s => ['Diterima', 'Diagnosa'].includes(s.status)).length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            filteredServices.filter(s => ['Diterima', 'Diagnosa'].includes(s.status)).map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-orange-50 to-orange-100/50 p-4 rounded-xl border border-orange-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.device || s.unitType}</p>
                                                        </div>
                                                        <span className={`text-xs font-bold px-3 py-1 rounded-full ${
                                                            s.status === 'Diterima' ? 'bg-amber-100 text-amber-700' :
                                                            'bg-orange-100 text-orange-700'
                                                        }`}>{s.status}</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700 bg-white/60 p-2 rounded mb-3">üîß {s.complaint || s.problem}</p>
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-orange-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-slate-500 mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Technician section */}
                                                    <div className="mb-3 pb-3 border-b border-orange-200">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <p className="text-xs font-bold text-slate-600 uppercase">üë®‚Äçüîß Tekhnisi ({(s.technicians || []).length})</p>
                                                            <button 
                                                                onClick={() => setTechnicianModal({serviceId: s.id, customerName: s.customerName})}
                                                                className="text-orange-600 hover:text-orange-800 text-xs font-bold hover:bg-orange-50 px-2 py-1 rounded transition"
                                                            >
                                                                + Tambah
                                                            </button>
                                                        </div>
                                                        {(s.technicians || []).length > 0 ? (
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.technicians.map((tech, idx) => (
                                                                    <span key={idx} className="bg-orange-600 text-white text-xs px-2.5 py-1 rounded-full font-medium flex items-center gap-1">
                                                                        {tech}
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    const newTechs = s.technicians.filter((t, i) => i !== idx);
                                                                                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', s.id), {
                                                                                        technicians: newTechs
                                                                                    });
                                                                                } catch (err) {
                                                                                    alert('Gagal hapus tekhnisi');
                                                                                }
                                                                            }}
                                                                            className="hover:text-red-300 ml-1"
                                                                            title="Hapus"
                                                                        >
                                                                            √ó
                                                                        </button>
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-xs text-slate-500 italic">Belum ada tekhnisi yang ditugaskan</p>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ {formatDate(s.createdAt)}</span>
                                                        {s.estimatedDate && <span>‚è∞ Est: {formatDate(s.estimatedDate)}</span>}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'active_service' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {filteredServices.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status)).length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            filteredServices.filter(s => ['Dikerjakan', 'Menunggu Sparepart'].includes(s.status)).map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-blue-50 to-blue-100/50 p-4 rounded-xl border border-blue-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.device || s.unitType}</p>
                                                        </div>
                                                        <span className={`text-xs font-bold px-3 py-1 rounded-full ${
                                                            s.status === 'Antri' ? 'bg-amber-100 text-amber-700' :
                                                            s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                            'bg-purple-100 text-purple-700'
                                                        }`}>{s.status}</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700 bg-white/60 p-2 rounded mb-3">üîß {s.complaint || s.problem}</p>
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-blue-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-slate-500 mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Technician section */}
                                                    <div className="mb-3 pb-3 border-b border-blue-200">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <p className="text-xs font-bold text-slate-600 uppercase">üë®‚Äçüîß Tekhnisi ({(s.technicians || []).length})</p>
                                                            <button 
                                                                onClick={() => setTechnicianModal({serviceId: s.id, customerName: s.customerName})}
                                                                className="text-blue-600 hover:text-blue-800 text-xs font-bold hover:bg-blue-50 px-2 py-1 rounded transition"
                                                            >
                                                                + Tambah
                                                            </button>
                                                        </div>
                                                        {(s.technicians || []).length > 0 ? (
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.technicians.map((tech, idx) => (
                                                                    <span key={idx} className="bg-blue-600 text-white text-xs px-2.5 py-1 rounded-full font-medium flex items-center gap-1">
                                                                        {tech}
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    const newTechs = s.technicians.filter((t, i) => i !== idx);
                                                                                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', s.id), {
                                                                                        technicians: newTechs
                                                                                    });
                                                                                } catch (err) {
                                                                                    alert('Gagal hapus tekhnisi');
                                                                                }
                                                                            }}
                                                                            className="hover:text-red-300 ml-1"
                                                                            title="Hapus"
                                                                        >
                                                                            √ó
                                                                        </button>
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-xs text-slate-500 italic">Belum ada tekhnisi yang ditugaskan</p>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ {formatDate(s.createdAt)}</span>
                                                        {s.estimatedDate && <span>‚è∞ Est: {formatDate(s.estimatedDate)}</span>}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'ready_service' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {completedServices.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            completedServices.map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-emerald-50 to-emerald-100/50 p-4 rounded-xl border border-emerald-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.device}</p>
                                                        </div>
                                                        <span className="text-xs font-bold px-3 py-1 rounded-full bg-emerald-100 text-emerald-700">‚úÖ Siap</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700 bg-white/60 p-2 rounded mb-3">üîß {s.problem}</p>
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-emerald-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart Terpasang ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-emerald-600 font-semibold mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ Selesai: {formatDate(s.updatedAt)}</span>
                                                        <span>üíµ {s.totalPrice ? formatCurrency(s.totalPrice) : 'Belum ditentukan'}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'income' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {income_trans.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            income_trans.map(t => {
                                                const relatedService = services.find(s => s.id === t.serviceId);
                                                return (
                                                <div key={t.id} className="bg-gradient-to-r from-emerald-50 to-emerald-100/50 p-4 rounded-xl border border-emerald-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                        </div>
                                                        <span className="text-lg font-bold text-emerald-600">+{formatCurrency(t.amount)}</span>
                                                    </div>
                                                    {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                        <div className="bg-white/80 p-3 rounded-lg mb-2 border border-emerald-100">
                                                            <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Digunakan:</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {relatedService.usedParts.map((part, idx) => (
                                                                    <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                        {part.name} x{part.qty} - {formatCurrency(part.sellPrice || 0)}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                    <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'expense' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {expense_trans.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            expense_trans.map(t => {
                                                const relatedService = services.find(s => s.id === t.serviceId);
                                                return (
                                                <div key={t.id} className="bg-gradient-to-r from-rose-50 to-rose-100/50 p-4 rounded-xl border border-rose-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                        </div>
                                                        <span className="text-lg font-bold text-rose-600">-{formatCurrency(t.amount)}</span>
                                                    </div>
                                                    {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                        <div className="bg-white/80 p-3 rounded-lg mb-2 border border-rose-100">
                                                            <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart Modal:</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {relatedService.usedParts.map((part, idx) => (
                                                                    <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                        {part.name} x{part.qty} - Modal: {formatCurrency(part.buyPrice || 0)}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                    <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'profit' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {detailModal.subType === 'jasa' ? (
                                            filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).length === 0 ? (
                                                <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                            ) : (
                                                filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).map(t => {
                                                    const relatedService = services.find(s => s.id === t.serviceId);
                                                    return (
                                                    <div key={t.id} className="bg-gradient-to-r from-indigo-50 to-indigo-100/50 p-4 rounded-xl border border-indigo-200 hover:shadow-md transition-all">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                                <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                            </div>
                                                            <span className="text-lg font-bold text-indigo-600">+{formatCurrency(t.amount)}</span>
                                                        </div>
                                                        {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                            <div className="bg-white/80 p-3 rounded-lg mb-2 border border-indigo-100">
                                                                <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart Terpasang:</p>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {relatedService.usedParts.map((part, idx) => (
                                                                        <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                            {part.name} x{part.qty}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                        <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                    </div>
                                                    );
                                                })
                                            )
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).length === 0 ? (
                                                <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                            ) : (
                                                filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).map(t => {
                                                    const relatedSale = sales.find(s => s.id === t.originalSaleId);
                                                    return (
                                                    <div key={t.id} className="bg-gradient-to-r from-cyan-50 to-cyan-100/50 p-4 rounded-xl border border-cyan-200 hover:shadow-md transition-all">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                                <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                            </div>
                                                            <span className="text-lg font-bold text-cyan-600">+{formatCurrency(t.amount)}</span>
                                                        </div>
                                                        {relatedSale && relatedSale.items && relatedSale.items.length > 0 && (
                                                            <div className="bg-white/80 p-3 rounded-lg mb-3 border border-cyan-100">
                                                                <p className="text-xs font-bold text-cyan-700 mb-3">üì¶ Detail Barang & Keuntungan:</p>
                                                                <div className="space-y-2">
                                                                    {relatedSale.items.map((item, idx) => {
                                                                        const itemProfit = (item.sellPrice - (item.buyPrice || 0)) * item.qty;
                                                                        return (
                                                                            <div key={idx} className="bg-gradient-to-r from-cyan-50 to-blue-50 p-2.5 rounded-lg border border-cyan-200 text-xs">
                                                                                <div className="flex justify-between items-start gap-2">
                                                                                    <div className="flex-1">
                                                                                        <p className="font-bold text-slate-800">{item.name}</p>
                                                                                        <p className="text-slate-600 mt-0.5">Qty: {item.qty} ‚Ä¢ Modal: {formatCurrency(item.buyPrice || 0)}/unit ‚Ä¢ Jual: {formatCurrency(item.sellPrice)}/unit</p>
                                                                                        {item.category && <p className="text-slate-500 mt-1">üìÇ {item.category}</p>}
                                                                                    </div>
                                                                                    <span className="font-bold text-cyan-600 whitespace-nowrap">+{formatCurrency(itemProfit)}</span>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                        <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                    </div>
                                                    );
                                                })
                                            )
                                        )}
                                    </div>
                                )}
                                
                                {/* Kompensasi Retur Penjualan */}
                                {detailModal.type === 'kompensasi_retur_penjualan' && (
                                    <div className="space-y-3">
                                        {filteredTrans.filter(t => t.type === 'income' && t.category === 'Kompensasi Retur Penjualan').length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data kompensasi retur penjualan</div>
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'income' && t.category === 'Kompensasi Retur Penjualan').map(t => (
                                                <div key={t.id} className="bg-gradient-to-r from-teal-50 to-teal-100/50 p-4 rounded-xl border border-teal-200">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{t.description}</p>
                                                            <p className="text-xs text-slate-500 mt-1">{formatDate(t.date || t.createdAt)}</p>
                                                        </div>
                                                        <span className="text-xl font-bold text-teal-600">+{formatCurrency(t.amount)}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {/* Kompensasi Retur Pembelian */}
                                {detailModal.type === 'kompensasi_retur_pembelian' && (
                                    <div className="space-y-3">
                                        {filteredTrans.filter(t => t.type === 'expense' && t.category === 'Kompensasi Retur Pembelian').length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data kompensasi retur pembelian</div>
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'expense' && t.category === 'Kompensasi Retur Pembelian').map(t => (
                                                <div key={t.id} className="bg-gradient-to-r from-rose-50 to-rose-100/50 p-4 rounded-xl border border-rose-200">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{t.description}</p>
                                                            <p className="text-xs text-slate-500 mt-1">{formatDate(t.date || t.createdAt)}</p>
                                                        </div>
                                                        <span className="text-xl font-bold text-rose-600">-{formatCurrency(t.amount)}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {/* Summary Footer */}
                                {(detailModal.type === 'income' || detailModal.type === 'expense' || detailModal.type === 'profit' || detailModal.type === 'kompensasi_retur_penjualan' || detailModal.type === 'kompensasi_retur_pembelian') && (
                                    <div className="mt-6 pt-6 border-t border-slate-200">
                                        {detailModal.type === 'income' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Pemasukan:</p>
                                                <p className="text-2xl font-bold text-emerald-600">{formatCurrency(income_trans.reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'expense' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Pengeluaran:</p>
                                                <p className="text-2xl font-bold text-rose-600">-{formatCurrency(expense_trans.reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'profit' && detailModal.subType === 'jasa' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Keuntungan Jasa:</p>
                                                <p className="text-2xl font-bold text-indigo-600">+{formatCurrency(filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'profit' && detailModal.subType === 'penjualan' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Keuntungan Penjualan:</p>
                                                <p className="text-2xl font-bold text-cyan-600">+{formatCurrency(filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'kompensasi_retur_penjualan' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Kompensasi Retur Penjualan:</p>
                                                <p className="text-2xl font-bold text-teal-600">+{formatCurrency(kompensasi_retur_penjualan)}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'kompensasi_retur_pembelian' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Kompensasi Retur Pembelian:</p>
                                                <p className="text-2xl font-bold text-rose-600">-{formatCurrency(kompensasi_retur_pembelian)}</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Stock Modal - Urgent Stock, Out of Stock, Stock Value */}
                {detailModal && (detailModal.type === 'urgent_stock' || detailModal.type === 'out_of_stock' || detailModal.type === 'stock_value') && (
                    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                            <div className="p-6 border-b border-slate-200 bg-slate-50">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-xl text-slate-800">{detailModal.title}</h3>
                                        <p className="text-xs text-slate-500">Daftar item inventory</p>
                                    </div>
                                    <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                                        <X className="w-6 h-6 text-slate-400" />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-6 max-h-[60vh] overflow-y-auto">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {(detailModal.data || []).map(item => (
                                        <div key={item.id} className={`p-4 border rounded-xl ${
                                            detailModal.type === 'urgent_stock' ? 'border-amber-200 bg-amber-50' :
                                            detailModal.type === 'out_of_stock' ? 'border-red-200 bg-red-50' :
                                            'border-indigo-200 bg-indigo-50'
                                        }`}>
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex-1">
                                                    <h4 className="font-bold text-slate-800 text-sm">{item.name}</h4>
                                                    {item.brand && <p className="text-xs text-slate-500">{item.brand}</p>}
                                                    {item.category && <p className="text-xs text-slate-500">{item.category}</p>}
                                                </div>
                                                <div className="text-right">
                                                    <p className={`font-bold text-lg ${
                                                        detailModal.type === 'urgent_stock' ? 'text-amber-600' :
                                                        detailModal.type === 'out_of_stock' ? 'text-red-600' :
                                                        'text-indigo-600'
                                                    }`}>
                                                        {detailModal.type === 'stock_value' ? formatCurrency(item.stock * item.sellPrice) : item.stock + ' unit'}
                                                    </p>
                                                    {detailModal.type === 'stock_value' && (
                                                        <p className="text-xs text-slate-500">{item.stock} x {formatCurrency(item.sellPrice)}</p>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {detailModal.type === 'stock_value' && (
                                                <div className="grid grid-cols-2 gap-2 text-xs">
                                                    <div>
                                                        <p className="text-slate-500">Beli:</p>
                                                        <p className="font-bold text-slate-700">{formatCurrency(item.buyPrice || 0)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-500">Jual:</p>
                                                        <p className="font-bold text-slate-700">{formatCurrency(item.sellPrice || 0)}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                
                                {detailModal.data && detailModal.data.length === 0 && (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
                                            <Box className="w-8 h-8 text-slate-400" />
                                        </div>
                                        <p className="text-slate-500">Tidak ada item yang ditemukan</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* Summary Footer */}
                            {detailModal.type === 'stock_value' && detailModal.data && (
                                <div className="p-6 border-t border-slate-200 bg-slate-50">
                                    <div className="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <p className="text-sm text-slate-600">Total Item</p>
                                            <p className="font-bold text-lg text-indigo-600">{detailModal.data.length}</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-slate-600">Total Stock</p>
                                            <p className="font-bold text-lg text-indigo-600">{detailModal.data.reduce((a,b) => a + (b.stock || 0), 0)}</p>
                                        </div>
                                        <div>
                                            <p className="text-sm text-slate-600">Total Nilai</p>
                                            <p className="font-bold text-lg text-indigo-600">{formatCurrency(detailModal.data.reduce((a,b) => a + (b.stock * b.sellPrice), 0))}</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                {technicianModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[71] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="font-bold text-xl text-slate-800">Assign Tekhnisi</h3>
                                <button onClick={() => setTechnicianModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                            </div>
                            
                            <div className="mb-4">
                                <p className="text-sm font-bold text-slate-700 mb-2">Service: <span className="text-blue-600">{technicianModal.customerName}</span></p>
                                <p className="text-xs text-slate-500">Pilih tekhnisi untuk menugaskan ke service ini:</p>
                            </div>
                            
                            <div className="space-y-2 max-h-64 overflow-y-auto mb-6 border rounded-lg p-3 bg-slate-50">
                                {users?.filter(u => u.role !== 'owner')?.length > 0 ? (
                                    users.filter(u => u.role !== 'owner').map(user => (
                                        <button
                                            key={user.id}
                                            onClick={() => assignTechnician(technicianModal.serviceId, user.name)}
                                            className="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-100 transition-colors border border-slate-200 hover:border-blue-300"
                                        >
                                            <p className="font-bold text-slate-800 text-sm">{user.name}</p>
                                            <p className="text-xs text-slate-500">{user.role} ‚Ä¢ {user.email}</p>
                                        </button>
                                    ))
                                ) : (
                                    <div className="text-center py-6 text-slate-500">
                                        <Lock className="w-8 h-8 mx-auto mb-2 opacity-50"/>
                                        <p className="text-sm">Tidak ada tekhnisi tersedia</p>
                                    </div>
                                )}
                            </div>
                            
                            <div className="flex gap-3">
                                <button onClick={() => setTechnicianModal(null)} className="flex-1 py-2.5 border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Technician Assignment Modal */}
                {technicianModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="font-bold text-xl text-slate-800">Tambah Tekhnisi</h3>
                                <button onClick={() => setTechnicianModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                            </div>
                            
                            <p className="text-sm text-slate-600 mb-4">Servis: <strong>{technicianModal.customerName}</strong></p>
                            
                            <div className="space-y-3 mb-6">
                                <p className="text-xs font-bold text-slate-500 uppercase">Pilih dari daftar pegawai:</p>
                                {users && users.length > 0 ? (
                                    <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">
                                        {users.map(user => (
                                            <button
                                                key={user.id}
                                                onClick={() => {
                                                    assignTechnician(technicianModal.serviceId, user.name);
                                                }}
                                                className="p-3 text-left border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-blue-400 transition"
                                            >
                                                <p className="text-sm font-bold text-slate-800">{user.name}</p>
                                                <p className="text-xs text-slate-500">{user.role}</p>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-500 text-center py-4">Tidak ada pegawai terdaftar</p>
                                )}
                            </div>
                            
                            <div className="border-t pt-4">
                                <p className="text-xs font-bold text-slate-500 uppercase mb-2">Atau ketik nama manual:</p>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const name = e.target.techName.value;
                                    assignTechnician(technicianModal.serviceId, name);
                                    e.target.techName.value = '';
                                }} className="flex gap-2">
                                    <input
                                        name="techName"
                                        placeholder="Nama tekhnisi..."
                                        className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700">
                                        Tambah
                                    </button>
                                </form>
                            </div>
                            
                            <button onClick={() => setTechnicianModal(null)} className="w-full mt-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-bold hover:bg-slate-50">
                                Tutup
                            </button>
                        </div>
                    </div>
                )}
            </div> 
          );
        };

        const ReportManager = () => {
            const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            
            // Permission check
            if (!checkPermission('menu_report')) {
                return (
                    <div className="p-10 text-center">
                        <div className="bg-red-50 border border-red-200 rounded-lg p-6 inline-block">
                            <Lock className="w-10 h-10 text-red-600 mx-auto mb-3"/>
                            <h2 className="text-lg font-bold text-red-600 mb-2">‚ùå Akses Ditolak</h2>
                            <p className="text-slate-600">Menu Laporan telah dikunci oleh Superadmin/Owner. Hubungi mereka untuk mendapatkan akses.</p>
                        </div>
                    </div>
                );
            }
            
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            const { data: transactions } = useFirestoreCollection('transactions', activeOwner?.id, activeStore?.id); // ‚úÖ FIXED: Filter by storeId untuk isolasi data per cabang
            const { data: sales } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
            const [tab, setTab] = useState('summary');
            const [dateRange, setDateRange] = useState('today');
            const [detailModal, setDetailModal] = useState(null); // { title, data[], type }
            
            // Pagination states for inventory tab
            const [inventoryCurrentPage, setInventoryCurrentPage] = useState(1);
            const [inventoryItemsPerPage, setInventoryItemsPerPage] = useState(10);
            
            // Pagination states for sales tab
            const [salesCurrentPage, setSalesCurrentPage] = useState(1);
            const [salesItemsPerPage, setSalesItemsPerPage] = useState(10);
            
            // Pagination states for service tab
            const [serviceCurrentPage, setServiceCurrentPage] = useState(1);
            const [serviceItemsPerPage, setServiceItemsPerPage] = useState(10);

            const getFilteredByDateRange = (items) => {
                const now = new Date();
                return items.filter(i => {
                    const d = i.createdAt ? (i.createdAt.seconds ? new Date(i.createdAt.seconds * 1000) : new Date(i.createdAt)) : (i.date ? (i.date.seconds ? new Date(i.date.seconds * 1000) : new Date(i.date)) : null);
                    if (!d) return false;
                    if (dateRange === 'today') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (dateRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (dateRange === 'year') return d.getFullYear() === now.getFullYear();
                    return true;
                });
            };

            const filteredServices = getFilteredByDateRange(services);
            const filteredSales = getFilteredByDateRange(sales || []);
            const filteredTrans = getFilteredByDateRange(transactions);

            const totalServices = filteredServices.length;
            const completedServices = filteredServices.filter(s => s.status === 'Selesai').length;
            const serviceIncome = filteredTrans.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
            const serviceExpense = filteredTrans.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const serviceProfitLoss = serviceIncome - serviceExpense;

            const totalSales = filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0);
            const totalReturns = filteredSales.filter(s => s.type === 'return').reduce((a, b) => a + (parseFloat(b.total) || 0), 0);

            const topItems = inventory.filter(i => i.stock > 0).sort((a, b) => (parseFloat(b.sellPrice) * b.stock) - (parseFloat(a.sellPrice) * a.stock)).slice(0, 5);
            const inventoryValue = inventory.reduce((a, b) => a + (parseFloat(b.sellPrice) * b.stock), 0);

            // Pagination calculations for inventory tab
            const inventoryStartIndex = (inventoryCurrentPage - 1) * inventoryItemsPerPage;
            const inventoryEndIndex = inventoryStartIndex + inventoryItemsPerPage;
            const paginatedInventory = inventory.slice(inventoryStartIndex, inventoryEndIndex);
            const inventoryTotalPages = Math.ceil(inventory.length / inventoryItemsPerPage);
            
            // Pagination calculations for sales tab
            const salesStartIndex = (salesCurrentPage - 1) * salesItemsPerPage;
            const salesEndIndex = salesStartIndex + salesItemsPerPage;
            const paginatedSales = filteredSales.slice(salesStartIndex, salesEndIndex);
            const salesTotalPages = Math.ceil(filteredSales.length / salesItemsPerPage);
            
            // Pagination calculations for service tab
            const serviceStartIndex = (serviceCurrentPage - 1) * serviceItemsPerPage;
            const serviceEndIndex = serviceStartIndex + serviceItemsPerPage;
            const paginatedServices = filteredServices.slice(serviceStartIndex, serviceEndIndex);
            const serviceTotalPages = Math.ceil(filteredServices.length / serviceItemsPerPage);

            // Reset to page 1 when tab changes to inventory
            useEffect(() => {
                if (tab === 'inventory') {
                    setInventoryCurrentPage(1);
                } else if (tab === 'sales') {
                    setSalesCurrentPage(1);
                } else if (tab === 'service') {
                    setServiceCurrentPage(1);
                }
            }, [tab]);

            const handleInventoryPageChange = (newPage) => {
                if (newPage >= 1 && newPage <= inventoryTotalPages) {
                    setInventoryCurrentPage(newPage);
                    // Smooth scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleInventoryItemsPerPageChange = (value) => {
                setInventoryItemsPerPage(value);
                setInventoryCurrentPage(1);
            };
            
            const handleSalesPageChange = (newPage) => {
                if (newPage >= 1 && newPage <= salesTotalPages) {
                    setSalesCurrentPage(newPage);
                    // Smooth scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleSalesItemsPerPageChange = (value) => {
                setSalesItemsPerPage(value);
                setSalesCurrentPage(1);
            };
            
            const handleServicePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= serviceTotalPages) {
                    setServiceCurrentPage(newPage);
                    // Smooth scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleServiceItemsPerPageChange = (value) => {
                setServiceItemsPerPage(value);
                setServiceCurrentPage(1);
            };

            const handleExportPDF = () => {
                const content = `
LAPORAN ${tab.toUpperCase()} - iFix Pro
Periode: ${dateRange === 'today' ? 'Hari Ini' : dateRange === 'month' ? 'Bulan Ini' : 'Tahun Ini'}
Tanggal: ${new Date().toLocaleDateString('id-ID')}

${tab === 'summary' && `
RINGKASAN KPI:
- Total Servis: ${totalServices}
- Servis Selesai: ${completedServices}
- Pemasukan: ${formatCurrency(serviceIncome)}
- Pengeluaran: ${formatCurrency(serviceExpense)}
- Profit/Loss: ${formatCurrency(serviceProfitLoss)}
- Total Penjualan: ${formatCurrency(totalSales)}
- Total Retur: ${formatCurrency(totalReturns)}
- Nilai Inventaris: ${formatCurrency(inventoryValue)}
`}

`;
                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `laporan-${tab}-${new Date().toISOString().slice(0, 10)}.txt`;
                link.click();
            };

            const handleExportExcel = () => {
                alert('Export Excel akan segera tersedia. Untuk saat ini, gunakan Download PDF dan convert ke Excel.');
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">Laporan</h2>
                        <div className="flex gap-2">
                            <select value={dateRange} onChange={e => setDateRange(e.target.value)} className="border p-2 rounded-lg text-sm font-bold bg-white">
                                <option value="today">Hari Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                            </select>
                            <button onClick={handleExportPDF} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700 flex items-center gap-2"><Download className="w-4 h-4"/> PDF</button>
                            <button onClick={handleExportExcel} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-green-700 flex items-center gap-2"><FileText className="w-4 h-4"/> Excel</button>
                        </div>
                    </div>

                    <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 w-full overflow-x-auto">
                        {[
                            { id: 'summary', label: 'Ringkasan' },
                            { id: 'sales', label: 'Penjualan' },
                            { id: 'service', label: 'Servis' },
                            { id: 'inventory', label: 'Stok' },
                            { id: 'profitloss', label: 'Profit/Loss' }
                        ].map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>{t.label}</button>
                        ))}
                    </div>

                    {tab === 'summary' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üì± Total Servis', type: 'service-list', data: filteredServices })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Servis</p>
                                    <h3 className="text-lg md:text-xl font-black text-blue-600 truncate">{totalServices}</h3>
                                    <p className="text-[10px] text-blue-600 mt-1 truncate">‚úÖ {completedServices} selesai</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üõí Total Penjualan', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-green-700 font-bold uppercase mb-1 truncate">Total Penjualan</p>
                                    <h3 className="text-lg md:text-xl font-black text-green-600 truncate">{formatCurrency(totalSales)}</h3>
                                    <p className="text-[10px] text-red-600 mt-1 truncate">‚Ü©Ô∏è {formatCurrency(totalReturns)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üìä Transaksi Penjualan', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-purple-700 font-bold uppercase mb-1 truncate">Total Transaksi</p>
                                    <h3 className="text-lg md:text-xl font-black text-purple-600 truncate">{filteredSales.length}</h3>
                                    <p className="text-[10px] text-purple-600 mt-1 truncate">Avg: {formatCurrency(filteredSales.length > 0 ? totalSales / filteredSales.length : 0)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Profit Penjualan', type: 'profit-list', data: filteredSales })} className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border-2 border-emerald-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-emerald-700 font-bold uppercase mb-1 truncate">Profit Penjualan</p>
                                    <h3 className="text-lg md:text-xl font-black text-emerald-600 truncate">
                                        {formatCurrency(filteredSales.reduce((a, b) => {
                                            const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                            return a + profit;
                                        }, 0))}
                                    </h3>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì• Pemasukan', type: 'income-list', data: filteredTrans.filter(t => t.type === 'income') })} className="bg-gradient-to-br from-violet-50 to-violet-100 p-4 rounded-xl border-2 border-violet-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-violet-700 font-bold uppercase mb-1 truncate">Pemasukan</p>
                                    <h3 className="text-lg md:text-xl font-black text-violet-600 truncate">{formatCurrency(serviceIncome)}</h3>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì§ Pengeluaran', type: 'expense-list', data: filteredTrans.filter(t => t.type === 'expense') })} className="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border-2 border-red-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-red-700 font-bold uppercase mb-1 truncate">Pengeluaran</p>
                                    <h3 className="text-lg md:text-xl font-black text-red-600 truncate">{formatCurrency(serviceExpense)}</h3>
                                </button>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <button onClick={() => setDetailModal({ title: 'üìä Profit/Loss', type: 'profitloss-detail', data: { income: serviceIncome, expense: serviceExpense, profit: serviceProfitLoss, incomeData: filteredTrans.filter(t => t.type === 'income'), expenseData: filteredTrans.filter(t => t.type === 'expense') } })} className={`${serviceProfitLoss >= 0 ? 'bg-gradient-to-br from-green-50 to-green-100 border-green-200' : 'bg-gradient-to-br from-red-50 to-red-100 border-red-200'} p-6 rounded-xl border-2 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer`}>
                                    <h3 className={`font-bold mb-2 text-sm ${serviceProfitLoss >= 0 ? 'text-green-700' : 'text-red-700'}`}>üìä Profit/Loss Periode Ini</h3>
                                    <div className={`text-2xl md:text-3xl font-black truncate ${serviceProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(serviceProfitLoss)}</div>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì¶ Nilai Stok Barang', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border-2 border-orange-200 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer">
                                    <h3 className="font-bold text-orange-700 mb-2 text-sm">üì¶ Nilai Stok Barang</h3>
                                    <div className="text-2xl md:text-3xl font-black text-orange-600 truncate">{formatCurrency(inventoryValue)}</div>
                                    <p className="text-xs text-orange-600 mt-2">{inventory.reduce((a, b) => a + b.stock, 0)} pcs ({inventory.length} item)</p>
                                </button>
                            </div>

                            <div className="bg-white p-6 rounded-xl border border-slate-200">
                                <h3 className="font-bold text-slate-800 mb-4">üèÜ Top 5 Produk (Nilai Stok Terbesar)</h3>
                                <div className="space-y-2">
                                    {topItems.map((item, idx) => {
                                        const totalValue = parseFloat(item.sellPrice) * item.stock;
                                        const profitValue = ((parseFloat(item.sellPrice) - parseFloat(item.buyPrice || 0)) * item.stock);
                                        return (
                                            <div key={item.id} className="p-3 bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                                                <div className="flex justify-between items-start mb-1">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-slate-800">{idx + 1}. {item.name}</p>
                                                        <p className="text-xs text-slate-500">üì¶ {item.category || 'No Category'} ‚Ä¢ Stok: {item.stock} pcs</p>
                                                    </div>
                                                    <div className="text-right ml-3">
                                                        <p className="font-bold text-green-600 text-lg">{formatCurrency(totalValue)}</p>
                                                        <p className="text-xs text-emerald-600">Profit: {formatCurrency(profitValue)}</p>
                                                    </div>
                                                </div>
                                                <div className="w-full bg-slate-300 rounded-full h-2">
                                                    <div 
                                                        className="bg-gradient-to-r from-green-400 to-emerald-600 h-2 rounded-full transition-all"
                                                        style={{width: `${Math.min(100, (totalValue / ((parseFloat(topItems[0]?.sellPrice || 0) * (topItems[0]?.stock || 1)) || 1)) * 100)}%`}}
                                                    ></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'sales' && (
                        <div className="space-y-4">
                            <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead className="bg-gradient-to-r from-slate-100 to-slate-50 border-b-2 border-slate-300">
                                            <tr>
                                                <th className="p-3 text-left text-slate-700 font-bold">Tanggal</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Pelanggan</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Items</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Barang Terjual</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Kategori</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Metode</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Subtotal</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Diskon</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Total</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200">
                                            {paginatedSales.map((s, i) => {
                                                const profit = s.items?.reduce((acc, item) => {
                                                    return acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty);
                                                }, 0) || 0;
                                                const itemsList = s.items?.map(it => it.name).join(', ') || '-';
                                                const categoriesList = s.items?.map(it => it.category).filter(Boolean).join(', ') || '-';
                                                
                                                return (
                                                    <tr key={i} className={`hover:bg-blue-50 transition-colors ${s.type === 'return' ? 'bg-red-50' : ''}`}>
                                                        <td className="p-3 text-slate-700 font-semibold">{formatDate(s.createdAt)}</td>
                                                        <td className="p-3 text-slate-700 font-semibold">{s.customerName}</td>
                                                        <td className="p-3 text-center">
                                                            <span className="inline-block bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">{s.items?.length || 0}</span>
                                                        </td>
                                                        <td className="p-3 text-slate-600 max-w-xs">
                                                            <div className="space-y-1">
                                                                {s.items?.map((item, idx) => (
                                                                    <div key={idx} className="flex justify-between items-start gap-2">
                                                                        <span>{item.name}</span>
                                                                        <span className="text-slate-500 ml-auto">(x{item.qty})</span>
                                                                    </div>
                                                                )) || <span className="text-slate-400">-</span>}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-slate-600 max-w-xs">
                                                            <div className="space-y-1">
                                                                {s.items?.map((item, idx) => (
                                                                    <div key={idx}>
                                                                        <span className="inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-semibold">
                                                                            üì¶ {item.category || 'No Category'}
                                                                        </span>
                                                                        {item.subCategory && (
                                                                            <span className="inline-block bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded font-semibold ml-1">
                                                                                ‚Üí {item.subCategory}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                )) || <span className="text-slate-400">-</span>}
                                                            </div>
                                                        </td>
                                                        <td className="p-3">
                                                            <span className={`text-xs font-bold px-2 py-1 rounded ${s.paymentMethod === 'credit' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                                {s.paymentMethod === 'credit' ? 'Piutang' : s.paymentMethod === 'transfer' ? 'Transfer' : s.paymentMethod === 'card' ? 'Kartu' : 'Kas'}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-center text-slate-700 font-semibold">{formatCurrency(s.subtotal || (s.items?.reduce((a, b) => a + (b.sellPrice * b.qty), 0)) || s.total)}</td>
                                                        <td className="p-3 text-center font-semibold">
                                                            {s.discount > 0 ? (
                                                                <div className="flex flex-col items-center">
                                                                    <span className="text-slate-500 text-[10px]">Disc: {s.discount}%</span>
                                                                    <span className="text-red-600 font-bold">-{formatCurrency(s.discountAmount || 0)}</span>
                                                                </div>
                                                            ) : (
                                                                <span className="text-slate-400">-</span>
                                                            )}
                                                        </td>
                                                        <td className="p-3 text-center font-bold text-lg">
                                                            <span className={s.type === 'return' ? 'text-red-600' : 'text-green-600'}>
                                                                {s.type === 'return' ? '-' : ''}{formatCurrency(s.total)}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-center font-bold">
                                                            <span className={profit > 0 ? 'text-emerald-600' : profit < 0 ? 'text-red-600' : 'text-slate-500'}>
                                                                {profit > 0 ? '+' : ''}{formatCurrency(profit)}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot className="bg-slate-100 border-t-2 border-slate-300 font-bold">
                                            <tr>
                                                <td colSpan="6" className="p-3 text-right">TOTAL:</td>
                                                <td className="p-3 text-center text-slate-800">{formatCurrency(filteredSales.reduce((a, b) => a + (parseFloat(b.subtotal) || parseFloat(b.total) || 0), 0))}</td>
                                                <td className="p-3 text-center text-red-600">{formatCurrency(filteredSales.reduce((a, b) => a + (parseFloat(b.discountAmount) || 0), 0))}</td>
                                                <td className="p-3 text-center text-green-700">{formatCurrency(filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0))}</td>
                                                <td className="p-3 text-center text-emerald-700">
                                                    {formatCurrency(filteredSales.reduce((a, b) => {
                                                        const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                                        return a + profit;
                                                    }, 0))}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Pagination Controls for Sales */}
                            <div className="pt-4 border-t border-slate-200">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    {/* Items Per Page Selector */}
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-slate-600">Tampilkan:</span>
                                        <select 
                                            value={salesItemsPerPage} 
                                            onChange={(e) => handleSalesItemsPerPageChange(parseInt(e.target.value))}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                        >
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span className="text-sm text-slate-600">transaksi per halaman</span>
                                    </div>

                                    {/* Page Info */}
                                    <div className="text-sm text-slate-600">
                                        Menampilkan {Math.min(salesItemsPerPage * (salesCurrentPage - 1) + 1, filteredSales.length)} - {Math.min(salesItemsPerPage * salesCurrentPage, filteredSales.length)} dari {filteredSales.length} transaksi
                                    </div>

                                    {/* Page Navigation */}
                                    <div className="flex items-center space-x-2">
                                        <button 
                                            onClick={() => handleSalesPageChange(salesCurrentPage - 1)}
                                            disabled={salesCurrentPage === 1}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            ‚Üê Sebelumnya
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        <div className="flex space-x-1">
                                            {Array.from({ length: salesTotalPages }, (_, i) => {
                                                const pageNumber = i + 1;
                                                if (
                                                    pageNumber === 1 || 
                                                    pageNumber === salesTotalPages ||
                                                    (pageNumber >= salesCurrentPage - 2 && pageNumber <= salesCurrentPage + 2)
                                                ) {
                                                    return (
                                                        <button
                                                            key={pageNumber}
                                                            onClick={() => handleSalesPageChange(pageNumber)}
                                                            className={`px-3 py-1 text-sm rounded ${
                                                                pageNumber === salesCurrentPage
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNumber}
                                                        </button>
                                                    );
                                                } else if (
                                                    pageNumber === salesCurrentPage - 3 || 
                                                    pageNumber === salesCurrentPage + 3
                                                ) {
                                                    return <span key={pageNumber} className="px-2 py-1 text-slate-400">...</span>;
                                                }
                                                return null;
                                            })}
                                        </div>

                                        <button 
                                            onClick={() => handleSalesPageChange(salesCurrentPage + 1)}
                                            disabled={salesCurrentPage === salesTotalPages}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            Selanjutnya ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üõí Transaksi Penjualan', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Transaksi</p>
                                    <p className="text-lg md:text-xl font-black text-blue-600 truncate">{filteredSales.length}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üíµ Total Penjualan', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-green-700 font-bold uppercase mb-1 truncate">Total Penjualan</p>
                                    <p className="text-lg md:text-xl font-black text-green-600 truncate">{formatCurrency(filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üìä Avg Per Transaksi', type: 'sales-list', data: filteredSales })} className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-purple-700 font-bold uppercase mb-1 truncate">Avg Per Transaksi</p>
                                    <p className="text-lg md:text-xl font-black text-purple-600 truncate">{formatCurrency(filteredSales.length > 0 ? filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0) / filteredSales.length : 0)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Profit Penjualan', type: 'profit-list', data: filteredSales })} className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border-2 border-emerald-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-emerald-700 font-bold uppercase mb-1 truncate">Total Profit</p>
                                    <p className="text-lg md:text-xl font-black text-emerald-600 truncate">{formatCurrency(filteredSales.reduce((a, b) => {
                                        const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                        return a + profit;
                                    }, 0))}</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {tab === 'service' && (
                        <div className="space-y-4">
                            <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead className="bg-gradient-to-r from-slate-100 to-slate-50 border-b-2 border-slate-300">
                                            <tr>
                                                <th className="p-3 text-left text-slate-700 font-bold">Tanggal</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Pelanggan</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Unit</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Keluhan</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">Tekhnisi</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Status</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Estimasi</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Bayar Awal</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Sisa</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200">
                                            {paginatedServices.map(s => {
                                                const dpAmount = s.downPayment || 0;
                                                const estimateCost = parseFloat(s.costEstimate) || 0;
                                                const remaining = estimateCost - dpAmount;
                                                return (
                                                    <tr key={s.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-3 text-slate-700 font-semibold">{formatDate(s.createdAt)}</td>
                                                        <td className="p-3 font-bold text-slate-700">{s.customerName}</td>
                                                        <td className="p-3 text-slate-600">{s.unitType}</td>
                                                        <td className="p-3 text-slate-600 max-w-xs">
                                                            <span className="line-clamp-2">{s.problemDescription || s.problem || '-'}</span>
                                                        </td>
                                                        <td className="p-3 text-slate-600">{s.assignedTechnician || '-'}</td>
                                                        <td className="p-3 text-center">
                                                            <span className={`text-xs font-bold px-2 py-1 rounded whitespace-nowrap inline-block ${
                                                                s.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700' :
                                                                s.status === 'Menunggu Sparepart' ? 'bg-orange-100 text-orange-700' :
                                                                'bg-slate-100 text-slate-700'
                                                            }`}>
                                                                {s.status}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-right font-bold text-slate-700">{formatCurrency(estimateCost)}</td>
                                                        <td className="p-3 text-right font-semibold">
                                                            <span className="text-blue-600">{formatCurrency(dpAmount)}</span>
                                                        </td>
                                                        <td className="p-3 text-right font-bold">
                                                            <span className={remaining > 0 ? 'text-orange-600' : remaining === 0 ? 'text-green-600' : 'text-red-600'}>
                                                                {formatCurrency(Math.max(0, remaining))}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot className="bg-slate-100 border-t-2 border-slate-300 font-bold">
                                            <tr>
                                                <td colSpan="4" className="p-3 text-right">TOTAL:</td>
                                                <td colSpan="2" className="p-3"></td>
                                                <td className="p-3 text-right text-slate-800">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.costEstimate) || 0), 0))}</td>
                                                <td className="p-3 text-right text-blue-700">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.downPayment) || 0), 0))}</td>
                                                <td className="p-3 text-right text-orange-700">{formatCurrency(filteredServices.reduce((a, b) => a + Math.max(0, (parseFloat(b.costEstimate) || 0) - (parseFloat(b.downPayment) || 0)), 0))}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Pagination Controls for Services */}
                            <div className="pt-4 border-t border-slate-200">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    {/* Items Per Page Selector */}
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-slate-600">Tampilkan:</span>
                                        <select 
                                            value={serviceItemsPerPage} 
                                            onChange={(e) => handleServiceItemsPerPageChange(parseInt(e.target.value))}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                        >
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span className="text-sm text-slate-600">service per halaman</span>
                                    </div>

                                    {/* Page Info */}
                                    <div className="text-sm text-slate-600">
                                        Menampilkan {Math.min(serviceItemsPerPage * (serviceCurrentPage - 1) + 1, filteredServices.length)} - {Math.min(serviceItemsPerPage * serviceCurrentPage, filteredServices.length)} dari {filteredServices.length} service
                                    </div>

                                    {/* Page Navigation */}
                                    <div className="flex items-center space-x-2">
                                        <button 
                                            onClick={() => handleServicePageChange(serviceCurrentPage - 1)}
                                            disabled={serviceCurrentPage === 1}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            ‚Üê Sebelumnya
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        <div className="flex space-x-1">
                                            {Array.from({ length: serviceTotalPages }, (_, i) => {
                                                const pageNumber = i + 1;
                                                if (
                                                    pageNumber === 1 || 
                                                    pageNumber === serviceTotalPages ||
                                                    (pageNumber >= serviceCurrentPage - 2 && pageNumber <= serviceCurrentPage + 2)
                                                ) {
                                                    return (
                                                        <button
                                                            key={pageNumber}
                                                            onClick={() => handleServicePageChange(pageNumber)}
                                                            className={`px-3 py-1 text-sm rounded ${
                                                                pageNumber === serviceCurrentPage
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNumber}
                                                        </button>
                                                    );
                                                } else if (
                                                    pageNumber === serviceCurrentPage - 3 || 
                                                    pageNumber === serviceCurrentPage + 3
                                                ) {
                                                    return <span key={pageNumber} className="px-2 py-1 text-slate-400">...</span>;
                                                }
                                                return null;
                                            })}
                                        </div>

                                        <button 
                                            onClick={() => handleServicePageChange(serviceCurrentPage + 1)}
                                            disabled={serviceCurrentPage === serviceTotalPages}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            Selanjutnya ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards for Services */}
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üì± Total Servis', type: 'service-list', data: filteredServices })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Servis</p>
                                    <p className="text-lg md:text-xl font-black text-blue-600 truncate">{totalServices}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: '‚úÖ Servis Selesai', type: 'service-list', data: filteredServices.filter(s => s.status === 'Selesai') })} className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border-2 border-green-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-green-700 font-bold uppercase mb-1 truncate">Selesai</p>
                                    <p className="text-lg md:text-xl font-black text-green-600 truncate">{completedServices}</p>
                                    <p className="text-[10px] text-green-600 mt-1 truncate">{totalServices > 0 ? ((completedServices / totalServices * 100).toFixed(1)) : 0}%</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Estimasi Total', type: 'service-list', data: filteredServices })} className="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl border-2 border-yellow-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-yellow-700 font-bold uppercase mb-1 truncate">Estimasi Total</p>
                                    <p className="text-lg md:text-xl font-black text-yellow-600 truncate">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.costEstimate) || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üíµ DP Terkumpul', type: 'service-list', data: filteredServices.filter(s => (parseFloat(s.downPayment) || 0) > 0) })} className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-purple-700 font-bold uppercase mb-1 truncate">DP Terkumpul</p>
                                    <p className="text-lg md:text-xl font-black text-purple-600 truncate">{formatCurrency(filteredServices.reduce((a, b) => a + (parseFloat(b.downPayment) || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: '‚è≥ Sisa Tagihan', type: 'service-list', data: filteredServices.filter(s => ((parseFloat(s.costEstimate) || 0) - (parseFloat(s.downPayment) || 0)) > 0) })} className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-orange-700 font-bold uppercase mb-1 truncate">Sisa Tagihan</p>
                                    <p className="text-lg md:text-xl font-black text-orange-600 truncate">{formatCurrency(filteredServices.reduce((a, b) => a + Math.max(0, (parseFloat(b.costEstimate) || 0) - (parseFloat(b.downPayment) || 0)), 0))}</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {tab === 'inventory' && (
                        <div className="space-y-4">
                            <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gradient-to-r from-slate-100 to-slate-50 border-b-2 border-slate-300">
                                            <tr>
                                                <th className="p-3 text-left text-slate-700 font-bold">Barang</th>
                                                <th className="p-3 text-left text-slate-700 font-bold">üì¶ Kategori</th>
                                                <th className="p-3 text-center text-slate-700 font-bold">Stok</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Modal</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Harga Jual</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Keuntungan/Unit</th>
                                                <th className="p-3 text-right text-slate-700 font-bold">Nilai Stok</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200">
                                            {paginatedInventory.map((i, idx) => {
                                                const profitPerUnit = (parseFloat(i.sellPrice) || 0) - (parseFloat(i.buyPrice) || 0);
                                                const totalValue = parseFloat(i.sellPrice) * i.stock;
                                                return (
                                                    <tr key={i.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-3 font-bold text-slate-700">{i.name}</td>
                                                        <td className="p-3">
                                                            <span className="inline-block bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-semibold">
                                                                {i.category || 'No Category'}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-center">
                                                            <span className="inline-block bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">
                                                                {i.stock} pcs
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-right text-slate-600">{formatCurrency(parseFloat(i.buyPrice) || 0)}</td>
                                                        <td className="p-3 text-right font-semibold text-slate-700">{formatCurrency(parseFloat(i.sellPrice) || 0)}</td>
                                                        <td className="p-3 text-right font-bold">
                                                            <span className={profitPerUnit > 0 ? 'text-green-600' : profitPerUnit < 0 ? 'text-red-600' : 'text-slate-500'}>
                                                                {profitPerUnit > 0 ? '+' : ''}{formatCurrency(profitPerUnit)}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-right font-bold text-emerald-600">{formatCurrency(totalValue)}</td>
                                                    </tr>
                                                );
                                            })}
                                            {paginatedInventory.length === 0 && (
                                                <tr>
                                                    <td colSpan="7" className="p-8 text-center text-slate-500">
                                                        üì¶ Tidak ada data inventori untuk ditampilkan
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                        <tfoot className="bg-slate-100 border-t-2 border-slate-300 font-bold">
                                            <tr>
                                                <td colSpan="2" className="p-3 text-right">TOTAL NILAI STOK:</td>
                                                <td className="p-3 text-center text-slate-800">{inventory.reduce((a, b) => a + b.stock, 0)} pcs</td>
                                                <td className="p-3 text-right text-slate-800">{formatCurrency(inventory.reduce((a, b) => a + (parseFloat(b.buyPrice) * b.stock || 0), 0))}</td>
                                                <td colSpan="2"></td>
                                                <td className="p-3 text-right text-emerald-700">{formatCurrency(inventory.reduce((a, b) => a + (parseFloat(b.sellPrice) * b.stock || 0), 0))}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Pagination Controls for Inventory */}
                            <div className="pt-4 border-t border-slate-200">
                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    {/* Items Per Page Selector */}
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-slate-600">Tampilkan:</span>
                                        <select 
                                            value={inventoryItemsPerPage} 
                                            onChange={(e) => setInventoryItemsPerPage(parseInt(e.target.value))}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                        >
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                        <span className="text-sm text-slate-600">item per halaman</span>
                                    </div>

                                    {/* Page Info */}
                                    <div className="text-sm text-slate-600">
                                        Menampilkan {Math.min(inventoryItemsPerPage * (inventoryCurrentPage - 1) + 1, inventory.length)} - {Math.min(inventoryItemsPerPage * inventoryCurrentPage, inventory.length)} dari {inventory.length} item
                                    </div>

                                    {/* Page Navigation */}
                                    <div className="flex items-center space-x-2">
                                        <button 
                                            onClick={() => handleInventoryPageChange(inventoryCurrentPage - 1)}
                                            disabled={inventoryCurrentPage === 1}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            ‚Üê Sebelumnya
                                        </button>
                                        
                                        {/* Page Numbers */}
                                        <div className="flex space-x-1">
                                            {Array.from({ length: Math.ceil(inventory.length / inventoryItemsPerPage) }, (_, i) => {
                                                const pageNumber = i + 1;
                                                if (
                                                    pageNumber === 1 || 
                                                    pageNumber === Math.ceil(inventory.length / inventoryItemsPerPage) ||
                                                    (pageNumber >= inventoryCurrentPage - 2 && pageNumber <= inventoryCurrentPage + 2)
                                                ) {
                                                    return (
                                                        <button
                                                            key={pageNumber}
                                                            onClick={() => handleInventoryPageChange(pageNumber)}
                                                            className={`px-3 py-1 text-sm rounded ${
                                                                pageNumber === inventoryCurrentPage
                                                                    ? 'bg-blue-600 text-white'
                                                                    : 'border border-slate-300 hover:bg-slate-50'
                                                            }`}
                                                        >
                                                            {pageNumber}
                                                        </button>
                                                    );
                                                } else if (
                                                    pageNumber === inventoryCurrentPage - 3 || 
                                                    pageNumber === inventoryCurrentPage + 3
                                                ) {
                                                    return <span key={pageNumber} className="px-2 py-1 text-slate-400">...</span>;
                                                }
                                                return null;
                                            })}
                                        </div>

                                        <button 
                                            onClick={() => handleInventoryPageChange(inventoryCurrentPage + 1)}
                                            disabled={inventoryCurrentPage === Math.ceil(inventory.length / inventoryItemsPerPage)}
                                            className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50"
                                        >
                                            Selanjutnya ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards for Inventory */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onClick={() => setDetailModal({ title: 'üì¶ Total Item', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-blue-700 font-bold uppercase mb-1 truncate">Total Item</p>
                                    <p className="text-lg md:text-xl font-black text-blue-600 truncate">{inventory.length}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì¶ Total Stok', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-cyan-50 to-cyan-100 p-4 rounded-xl border-2 border-cyan-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-cyan-700 font-bold uppercase mb-1 truncate">Total Stok</p>
                                    <p className="text-lg md:text-xl font-black text-cyan-600 truncate">{inventory.reduce((a, b) => a + b.stock, 0)} pcs</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üí∞ Modal Total', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-orange-700 font-bold uppercase mb-1 truncate">Modal Total</p>
                                    <p className="text-lg md:text-xl font-black text-orange-600 truncate">{formatCurrency(inventory.reduce((a, b) => a + (parseFloat(b.buyPrice) * b.stock || 0), 0))}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üíé Nilai Stok', type: 'inventory-detail', data: inventory })} className="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border-2 border-emerald-200 text-left hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer">
                                    <p className="text-[10px] text-emerald-700 font-bold uppercase mb-1 truncate">Nilai Stok</p>
                                    <p className="text-lg md:text-xl font-black text-emerald-600 truncate">{formatCurrency(inventoryValue)}</p>
                                </button>
                            </div>
                        </div>
                    )}

                    {tab === 'profitloss' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onClick={() => setDetailModal({ title: 'üì• Detail Pemasukan', type: 'income-list', data: filteredTrans.filter(t => t.type === 'income') })} className="bg-green-50 p-6 rounded-xl border border-green-200 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer">
                                    <h3 className="font-bold text-green-900 mb-2 text-sm">Total Pemasukan</h3>
                                    <p className="text-2xl md:text-3xl font-black text-green-600 truncate">{formatCurrency(serviceIncome)}</p>
                                </button>
                                <button onClick={() => setDetailModal({ title: 'üì§ Detail Pengeluaran', type: 'expense-list', data: filteredTrans.filter(t => t.type === 'expense') })} className="bg-red-50 p-6 rounded-xl border border-red-200 text-left hover:shadow-lg hover:scale-[1.01] transition-all cursor-pointer">
                                    <h3 className="font-bold text-red-900 mb-2 text-sm">Total Pengeluaran</h3>
                                    <p className="text-2xl md:text-3xl font-black text-red-600 truncate">{formatCurrency(serviceExpense)}</p>
                                </button>
                            </div>
                            <div className={`${serviceProfitLoss >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-orange-50 border-orange-200'} p-6 rounded-xl border`}>
                                <h3 className={`font-bold mb-2 text-sm ${serviceProfitLoss >= 0 ? 'text-emerald-900' : 'text-orange-900'}`}>Profit/Loss Bersih</h3>
                                <p className={`text-3xl md:text-4xl font-black truncate ${serviceProfitLoss >= 0 ? 'text-emerald-600' : 'text-orange-600'}`}>{formatCurrency(serviceProfitLoss)}</p>
                            </div>
                        </div>
                    )}

                    {/* Detail Modal */}
                    {detailModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setDetailModal(null)}>
                            <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center p-5 border-b bg-slate-50">
                                    <h3 className="font-bold text-lg text-slate-800">{detailModal.title}</h3>
                                    <button onClick={() => setDetailModal(null)} className="text-slate-400 hover:text-slate-700 p-1 hover:bg-slate-200 rounded-lg transition-colors">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="overflow-y-auto max-h-[calc(85vh-80px)] p-5">
                                    {/* Income List */}
                                    {detailModal.type === 'income-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-green-700 font-bold">Total Pemasukan: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => a + (b.amount || 0), 0))}</span></p>
                                                <p className="text-xs text-green-600 mt-1">{detailModal.data.length} transaksi pemasukan</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data pemasukan</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Keterangan</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Jumlah</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((t, idx) => (
                                                                <tr key={idx} className="hover:bg-green-50">
                                                                    <td className="p-3 text-slate-600 text-xs">{formatDate(t.date || t.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{t.description || t.note || '-'}</td>
                                                                    <td className="p-3 text-right font-bold text-green-600">+{formatCurrency(t.amount || 0)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Expense List */}
                                    {detailModal.type === 'expense-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-red-700 font-bold">Total Pengeluaran: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => a + (b.amount || 0), 0))}</span></p>
                                                <p className="text-xs text-red-600 mt-1">{detailModal.data.length} transaksi pengeluaran</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data pengeluaran</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Keterangan</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Jumlah</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((t, idx) => (
                                                                <tr key={idx} className="hover:bg-red-50">
                                                                    <td className="p-3 text-slate-600 text-xs">{formatDate(t.date || t.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{t.description || t.note || '-'}</td>
                                                                    <td className="p-3 text-right font-bold text-red-600">-{formatCurrency(t.amount || 0)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Sales List */}
                                    {detailModal.type === 'sales-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-green-700 font-bold">Total Penjualan: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.total) || 0), 0))}</span></p>
                                                <p className="text-xs text-green-600 mt-1">{detailModal.data.length} transaksi</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data penjualan</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Pelanggan</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Barang</th>
                                                                <th className="p-3 text-center font-bold text-slate-700">Metode</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((s, idx) => (
                                                                <tr key={idx} className="hover:bg-slate-50">
                                                                    <td className="p-3 text-slate-600 text-xs whitespace-nowrap">{formatDate(s.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{s.customerName || '-'}</td>
                                                                    <td className="p-3 text-xs text-slate-600">
                                                                        {s.items?.map(it => `${it.name} x${it.qty}`).join(', ') || '-'}
                                                                    </td>
                                                                    <td className="p-3 text-center">
                                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${s.paymentMethod === 'credit' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                                            {s.paymentMethod === 'credit' ? 'Piutang' : s.paymentMethod === 'transfer' ? 'Transfer' : 'Kas'}
                                                                        </span>
                                                                    </td>
                                                                    <td className="p-3 text-right font-bold text-green-600 whitespace-nowrap">{formatCurrency(s.total)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Profit List */}
                                    {detailModal.type === 'profit-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-emerald-700 font-bold">Total Profit: <span className="text-xl">{formatCurrency(detailModal.data.reduce((a, b) => {
                                                    const profit = b.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                                    return a + profit;
                                                }, 0))}</span></p>
                                                <p className="text-xs text-emerald-600 mt-1">{detailModal.data.length} transaksi</p>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-slate-100">
                                                        <tr>
                                                            <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                            <th className="p-3 text-left font-bold text-slate-700">Pelanggan</th>
                                                            <th className="p-3 text-left font-bold text-slate-700">Barang</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Total</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Profit</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {detailModal.data.map((s, idx) => {
                                                            const profit = s.items?.reduce((acc, item) => acc + ((item.sellPrice - (item.buyPrice || 0)) * item.qty), 0) || 0;
                                                            return (
                                                                <tr key={idx} className="hover:bg-slate-50">
                                                                    <td className="p-3 text-slate-600 text-xs whitespace-nowrap">{formatDate(s.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{s.customerName || '-'}</td>
                                                                    <td className="p-3 text-xs text-slate-600">
                                                                        {s.items?.map(it => `${it.name} x${it.qty}`).join(', ') || '-'}
                                                                    </td>
                                                                    <td className="p-3 text-right text-slate-700 whitespace-nowrap">{formatCurrency(s.total)}</td>
                                                                    <td className="p-3 text-right font-bold whitespace-nowrap">
                                                                        <span className={profit > 0 ? 'text-emerald-600' : profit < 0 ? 'text-red-600' : 'text-slate-500'}>
                                                                            {profit > 0 ? '+' : ''}{formatCurrency(profit)}
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* Service List */}
                                    {detailModal.type === 'service-list' && (
                                        <div className="space-y-3">
                                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                                                <p className="text-sm text-blue-700 font-bold">Total: {detailModal.data.length} servis</p>
                                                <p className="text-xs text-blue-600 mt-1">Estimasi: {formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.costEstimate) || 0), 0))}</p>
                                            </div>
                                            {detailModal.data.length === 0 ? (
                                                <div className="text-center text-slate-400 py-8">Tidak ada data servis</div>
                                            ) : (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-slate-100">
                                                            <tr>
                                                                <th className="p-3 text-left font-bold text-slate-700">Tanggal</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Pelanggan</th>
                                                                <th className="p-3 text-left font-bold text-slate-700">Unit</th>
                                                                <th className="p-3 text-center font-bold text-slate-700">Status</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">Estimasi</th>
                                                                <th className="p-3 text-right font-bold text-slate-700">DP</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {detailModal.data.map((s, idx) => (
                                                                <tr key={idx} className="hover:bg-slate-50">
                                                                    <td className="p-3 text-slate-600 text-xs whitespace-nowrap">{formatDate(s.createdAt)}</td>
                                                                    <td className="p-3 text-slate-700 font-medium">{s.customerName || '-'}</td>
                                                                    <td className="p-3 text-slate-600 text-xs">{s.unitType || '-'}</td>
                                                                    <td className="p-3 text-center">
                                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded whitespace-nowrap ${
                                                                            s.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                            s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                            'bg-yellow-100 text-yellow-700'
                                                                        }`}>{s.status}</span>
                                                                    </td>
                                                                    <td className="p-3 text-right font-bold text-slate-700 whitespace-nowrap">{formatCurrency(parseFloat(s.costEstimate) || 0)}</td>
                                                                    <td className="p-3 text-right font-bold text-blue-600 whitespace-nowrap">{formatCurrency(parseFloat(s.downPayment) || 0)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Inventory Detail */}
                                    {detailModal.type === 'inventory-detail' && (
                                        <div className="space-y-3">
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-blue-700 font-bold uppercase">Total Item</p>
                                                    <p className="text-lg font-black text-blue-600">{detailModal.data.length}</p>
                                                </div>
                                                <div className="bg-cyan-50 border border-cyan-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-cyan-700 font-bold uppercase">Total Stok</p>
                                                    <p className="text-lg font-black text-cyan-600">{detailModal.data.reduce((a, b) => a + b.stock, 0)} pcs</p>
                                                </div>
                                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-orange-700 font-bold uppercase">Modal</p>
                                                    <p className="text-lg font-black text-orange-600">{formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.buyPrice) * b.stock || 0), 0))}</p>
                                                </div>
                                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                                    <p className="text-[10px] text-emerald-700 font-bold uppercase">Nilai Jual</p>
                                                    <p className="text-lg font-black text-emerald-600">{formatCurrency(detailModal.data.reduce((a, b) => a + (parseFloat(b.sellPrice) * b.stock || 0), 0))}</p>
                                                </div>
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-slate-100">
                                                        <tr>
                                                            <th className="p-3 text-left font-bold text-slate-700">Nama</th>
                                                            <th className="p-3 text-left font-bold text-slate-700">Kategori</th>
                                                            <th className="p-3 text-center font-bold text-slate-700">Stok</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Modal</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Harga Jual</th>
                                                            <th className="p-3 text-right font-bold text-slate-700">Nilai Stok</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {detailModal.data.sort((a, b) => (parseFloat(b.sellPrice) * b.stock) - (parseFloat(a.sellPrice) * a.stock)).map((i, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="p-3 font-medium text-slate-700">{i.name}</td>
                                                                <td className="p-3">
                                                                    <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded font-semibold">{i.category || '-'}</span>
                                                                </td>
                                                                <td className="p-3 text-center font-bold text-blue-600">{i.stock}</td>
                                                                <td className="p-3 text-right text-slate-600 whitespace-nowrap">{formatCurrency(parseFloat(i.buyPrice) || 0)}</td>
                                                                <td className="p-3 text-right text-slate-700 whitespace-nowrap">{formatCurrency(parseFloat(i.sellPrice) || 0)}</td>
                                                                <td className="p-3 text-right font-bold text-emerald-600 whitespace-nowrap">{formatCurrency(parseFloat(i.sellPrice) * i.stock)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}

                                    {/* Profit/Loss Detail */}
                                    {detailModal.type === 'profitloss-detail' && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                                    <p className="text-xs text-green-700 font-bold uppercase">Total Pemasukan</p>
                                                    <p className="text-xl font-black text-green-600">{formatCurrency(detailModal.data.income)}</p>
                                                </div>
                                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                                    <p className="text-xs text-red-700 font-bold uppercase">Total Pengeluaran</p>
                                                    <p className="text-xl font-black text-red-600">{formatCurrency(detailModal.data.expense)}</p>
                                                </div>
                                                <div className={`${detailModal.data.profit >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-orange-50 border-orange-200'} border rounded-lg p-4`}>
                                                    <p className={`text-xs font-bold uppercase ${detailModal.data.profit >= 0 ? 'text-emerald-700' : 'text-orange-700'}`}>Profit/Loss</p>
                                                    <p className={`text-xl font-black ${detailModal.data.profit >= 0 ? 'text-emerald-600' : 'text-orange-600'}`}>{formatCurrency(detailModal.data.profit)}</p>
                                                </div>
                                            </div>
                                            
                                            <h4 className="font-bold text-green-700 flex items-center gap-2">üì• Rincian Pemasukan ({detailModal.data.incomeData?.length || 0})</h4>
                                            <div className="overflow-x-auto mb-4">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-green-50"><tr><th className="p-2 text-left text-xs">Tanggal</th><th className="p-2 text-left text-xs">Keterangan</th><th className="p-2 text-right text-xs">Jumlah</th></tr></thead>
                                                    <tbody className="divide-y">
                                                        {(detailModal.data.incomeData || []).map((t, idx) => (
                                                            <tr key={idx} className="hover:bg-green-50">
                                                                <td className="p-2 text-xs text-slate-600">{formatDate(t.date || t.createdAt)}</td>
                                                                <td className="p-2 text-xs font-medium">{t.description || t.note || '-'}</td>
                                                                <td className="p-2 text-right text-xs font-bold text-green-600">+{formatCurrency(t.amount)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>

                                            <h4 className="font-bold text-red-700 flex items-center gap-2">üì§ Rincian Pengeluaran ({detailModal.data.expenseData?.length || 0})</h4>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead className="bg-red-50"><tr><th className="p-2 text-left text-xs">Tanggal</th><th className="p-2 text-left text-xs">Keterangan</th><th className="p-2 text-right text-xs">Jumlah</th></tr></thead>
                                                    <tbody className="divide-y">
                                                        {(detailModal.data.expenseData || []).map((t, idx) => (
                                                            <tr key={idx} className="hover:bg-red-50">
                                                                <td className="p-2 text-xs text-slate-600">{formatDate(t.date || t.createdAt)}</td>
                                                                <td className="p-2 text-xs font-medium">{t.description || t.note || '-'}</td>
                                                                <td className="p-2 text-right text-xs font-bold text-red-600">-{formatCurrency(t.amount)}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ServiceManager = () => {
             const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
             const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
             const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
             const [modal, setModal] = useState(null);
             const [payModal, setPayModal] = useState(null);
             const [addPartModal, setAddPartModal] = useState(null);
             const [printData, setPrint] = useState(null);
             const [store, setStore] = useState(activeStore);
             const [term, setTerm] = useState('');
             const [statusFilter, setStatusFilter] = useState('all');
             const [captureData, setCaptureData] = useState(null);
             const [allKelengkapanItems, setAllKelengkapanItems] = useState([]);
             const [allQCItems, setAllQCItems] = useState([]);
             const [currentPage, setCurrentPage] = useState(1);
             const [itemsPerPage, setItemsPerPage] = useState(10);
             
             useEffect(() => {
                 setStore(activeStore);
             }, [activeStore]);
             
             // Load all Kelengkapan and QC items for invoice display
             useEffect(() => {
                 if (!activeOwner?.id) return;
                 
                 // Load kelengkapan items
                 const masterKelUnsub = onSnapshot(
                     query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items')),
                     (snap) => {
                         const masterItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                         const ownerKelUnsub = onSnapshot(
                             query(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), where('ownerId', '==', activeOwner.id)),
                             (snap) => {
                                 const ownerItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                 const allItems = [...masterItems, ...ownerItems];
                                 const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                 setAllKelengkapanItems(uniqueItems);
                             }
                         );
                         if (window.firestoreListeners) window.firestoreListeners.add(ownerKelUnsub);
                         return () => {
                             if (window.firestoreListeners) window.firestoreListeners.delete(ownerKelUnsub);
                             ownerKelUnsub();
                         };
                     }
                 );
                 if (window.firestoreListeners) window.firestoreListeners.add(masterKelUnsub);
                 
                 // Load QC items
                 const masterQCUnsub = onSnapshot(
                     query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_qc_functional_items')),
                     (snap) => {
                         const masterItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                         const ownerQCUnsub = onSnapshot(
                             query(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), where('ownerId', '==', activeOwner.id)),
                             (snap) => {
                                 const ownerItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                 const allItems = [...masterItems, ...ownerItems];
                                 const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                 setAllQCItems(uniqueItems);
                             }
                         );
                         if (window.firestoreListeners) window.firestoreListeners.add(ownerQCUnsub);
                         return () => {
                             if (window.firestoreListeners) window.firestoreListeners.delete(ownerQCUnsub);
                             ownerQCUnsub();
                         };
                     }
                 );
                 if (window.firestoreListeners) window.firestoreListeners.add(masterQCUnsub);
                 
                 return () => {
                     if (window.firestoreListeners) window.firestoreListeners.delete(masterKelUnsub);
                     if (window.firestoreListeners) window.firestoreListeners.delete(masterQCUnsub);
                     masterKelUnsub();
                     masterQCUnsub();
                 };
             }, [activeOwner?.id]);
             
             // Auto-recalculate profit untuk service yang belum punya profit transactions
             const recalculateRef = useRef(false);
             useEffect(() => {
                 const recalculateAllMissingProfits = async () => {
                     if (recalculateRef.current) return;
                     if (!activeOwner?.id || !activeStore?.id || services.length === 0) return;
                     
                     const recalcFlag = localStorage.getItem('profit_recalculated_date_fix');
                     if (recalcFlag === 'true') {
                         console.log('‚úÖ Profit already recalculated with service dates, skipping...');
                         return;
                     }
                     
                     recalculateRef.current = true;
                     console.log('üîç Recalculating ALL profit transactions with correct service dates...');
                     
                     try {
                         // Recalculate SEMUA service (untuk fix tanggal)
                         const servicesToRecalc = services.filter(s => {
                             const hasParts = (s.usedParts || []).length > 0;
                             const hasFee = parseFloat(s.serviceFee || 0) > 0;
                             return hasParts || hasFee;
                         });
                         
                         if (servicesToRecalc.length === 0) {
                             console.log('‚úÖ No services to recalculate');
                             localStorage.setItem('profit_recalculated_date_fix', 'true');
                             return;
                         }
                         
                         console.log(`üîß Recalculating ${servicesToRecalc.length} services with correct dates...`);
                         
                         for (const service of servicesToRecalc) {
                             await recalculateServiceProfit(
                                 service.id,
                                 service,
                                 service.customerName,
                                 false // Hapus profit lama, buat yang baru dengan tanggal benar
                             );
                         }
                         
                         console.log('‚úÖ All profits recalculated with correct dates!');
                         localStorage.setItem('profit_recalculated_date_fix', 'true');
                         localStorage.removeItem('profit_recalculated_v1');
                         alert(`‚úÖ ${servicesToRecalc.length} profit transactions telah diupdate dengan tanggal yang benar!`);
                         
                     } catch (error) {
                         console.error('‚ùå Error during auto-recalculate:', error);
                         recalculateRef.current = false;
                     }
                 };
                 
                 if (services.length > 0 && !recalculateRef.current) {
                     const timer = setTimeout(() => {
                         recalculateAllMissingProfits();
                     }, 1000);
                     return () => clearTimeout(timer);
                 }
             }, [services.length, activeOwner?.id, activeStore?.id]);
             
             // Check for customer data from CustomerManager
             useEffect(() => {
                 // Small delay to ensure sessionStorage is written
                 const timer = setTimeout(() => {
                     const newServiceData = sessionStorage.getItem('newServiceData');
                     if (newServiceData) {
                         try {
                             const data = JSON.parse(newServiceData);
                             console.log('‚úÖ Loading service data from customer:', data);
                             setModal(data);
                             sessionStorage.removeItem('newServiceData');
                         } catch (e) {
                             console.error('‚ùå Error parsing service data:', e);
                         }
                     }
                     
                     // Check for auto-open from Dashboard
                     const autoOpen = sessionStorage.getItem('autoOpenServiceForm');
                     if (autoOpen === 'true') {
                         console.log('‚úÖ Auto-opening service form from Dashboard');
                         setModal({ownerId: activeOwner?.id});
                         sessionStorage.removeItem('autoOpenServiceForm');
                     }
                 }, 100);
                 return () => clearTimeout(timer);
             }, []);
             const canDelete = checkPermission('feature_delete');
             const canPrint = checkPermission('feature_print');
             const canShare = checkPermission('feature_share');
             
             // Fungsi untuk recalculate profit saat service diupdate
             const recalculateServiceProfit = async (serviceId, serviceData, customerName, skipDelete = false) => {
                 try {
                     console.log('üîÑ Recalculating profit for service:', serviceId);
                     
                     const batch = writeBatch(db);
                     
                     // 1. Delete existing profit/loss transactions for this service (jika bukan batch recalculate)
                     if (!skipDelete) {
                         const transactionsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                         const q = query(
                             transactionsRef, 
                             where('serviceId', '==', serviceId),
                             where('type', 'in', ['profit', 'loss'])
                         );
                         const existingSnapshot = await getDocs(q);
                         
                         let deletedCount = 0;
                         existingSnapshot.forEach((doc) => {
                             batch.delete(doc.ref);
                             deletedCount++;
                         });
                         
                         console.log(`üóëÔ∏è Deleting ${deletedCount} old profit/loss transactions`);
                     }
                     
                     // 2. Calculate new profits
                     const usedParts = serviceData.usedParts || [];
                     const serviceFee = parseFloat(serviceData.serviceFee) || 0;
                     
                     // Profit from spareparts - hitung per part
                     let totalProfitParts = 0;
                     usedParts.forEach(part => {
                         if (!part.isManual) {
                             const buyPrice = parseFloat(part.buyPrice) || 0;
                             const sellPrice = parseFloat(part.sellPrice) || 0;
                             const qty = parseInt(part.qty) || 0;
                             const profitPerUnit = sellPrice - buyPrice;
                             const itemProfit = profitPerUnit * qty;
                             totalProfitParts += itemProfit;
                         }
                     });
                     
                     // Buat transaction untuk profit/loss sparepart (gabungan)
                     if (totalProfitParts !== 0) {
                         const transactionRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'));
                         batch.set(transactionRef, {
                             ownerId: activeOwner.id,
                             storeId: activeStore.id,
                             type: totalProfitParts > 0 ? 'profit' : 'loss',
                             category: totalProfitParts > 0 ? 'Keuntungan Sparepart' : 'Rugi Sparepart',
                             description: `${totalProfitParts > 0 ? 'Profit' : 'Loss'} sparepart untuk ${customerName || 'Customer'}`,
                             amount: Math.abs(totalProfitParts),
                             date: serviceData.createdAt || serverTimestamp(),
                             createdAt: serviceData.createdAt || serverTimestamp(),
                             serviceId: serviceId
                         });
                         console.log(`üí∞ Creating ${totalProfitParts > 0 ? 'profit' : 'loss'} transaction for parts: Rp ${Math.abs(totalProfitParts).toLocaleString('id-ID')}`);
                     }
                     
                     // Profit from service fee
                     // Untung Jasa = Total Biaya - Harga Jual Sparepart
                     const partsJual = usedParts.reduce((acc, part) => acc + (parseFloat(part.sellPrice || 0) * part.qty), 0);
                     const jasaProfit = serviceFee - partsJual;
                     if (jasaProfit > 0) {
                         const transactionRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'));
                         batch.set(transactionRef, {
                             ownerId: activeOwner.id,
                             storeId: activeStore.id,
                             type: 'profit',
                             category: 'Keuntungan Jasa Servis',
                             description: `Profit jasa servis untuk ${customerName || 'Customer'}`,
                             amount: jasaProfit,
                             date: serviceData.createdAt || serverTimestamp(),
                             createdAt: serviceData.createdAt || serverTimestamp(),
                             serviceId: serviceId
                         });
                         console.log(`üí∞ Creating profit transaction for service fee: Rp ${jasaProfit.toLocaleString('id-ID')}`);
                     }
                     
                     // 3. Commit batch
                     await batch.commit();
                     console.log('‚úÖ Profit recalculation completed successfully');
                     
                 } catch (error) {
                     console.error('‚ùå Error recalculating profit:', error);
                     throw error;
                 }
             };
             
             const saveService = async (data) => { 
                const totalBiaya = parseFloat(data.serviceFee) || 0; // Total Biaya sudah termasuk harga jual sparepart
                const partsTotal = (data.usedParts || []).reduce((acc, p) => acc + (parseFloat(p.sellPrice) * p.qty), 0); 
                const paid = parseFloat(data.dp) || 0; 
                let paymentStatus = 'Belum Lunas'; 
                if (paid >= totalBiaya && totalBiaya > 0) paymentStatus = 'Lunas'; 
                else if (paid > 0) paymentStatus = 'DP'; 
                
                const payload = { ...data, costEstimate: totalBiaya, ownerId: activeOwner.id, storeId: activeStore.id, paymentStatus, updatedAt: serverTimestamp(), token: data.token || generateToken() };
                 try { 
                     if (modal.id) { 
                         // UPDATE existing service - compare old vs new parts for stock adjustment
                         const oldService = services.find(s => s.id === modal.id);
                         const oldParts = oldService?.usedParts || [];
                         const newParts = data.usedParts || [];
                         
                         // Batch write for stock adjustments
                         const batch = writeBatch(db);
                         
                         // Restore stock for parts removed in this edit
                         oldParts.forEach(oldPart => {
                             if (!oldPart.isManual && !newParts.some(np => np.id === oldPart.id && np.qty === oldPart.qty)) {
                                 const removedQty = oldPart.qty - (newParts.find(np => np.id === oldPart.id)?.qty || 0);
                                 if (removedQty > 0) {
                                     const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', oldPart.id);
                                     batch.update(ref, { stock: increment(removedQty) });
                                 }
                             }
                         });
                         
                         // Decrease stock for parts added or increased in this edit
                         newParts.forEach(newPart => {
                             if (!newPart.isManual) {
                                 const oldQty = oldParts.find(op => op.id === newPart.id)?.qty || 0;
                                 const decreaseQty = newPart.qty - oldQty;
                                 if (decreaseQty > 0) {
                                     const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', newPart.id);
                                     batch.update(ref, { stock: increment(-decreaseQty) });
                                 }
                             }
                         });
                         
                         await batch.commit();
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', modal.id), payload);
                         
                         // Recalculate and update profit transactions saat EDIT
                         await recalculateServiceProfit(modal.id, data, payload.customerName);
                     } else { 
                         // CREATE new service - DECREASE stock for all used parts
                         const batch = writeBatch(db);
                         
                         // Decrease stock for each part from inventory
                         (data.usedParts || []).forEach(part => {
                             if (!part.isManual) {
                                 const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                 batch.update(ref, { stock: increment(-part.qty) });
                             }
                         });
                         
                         payload.createdAt = serverTimestamp(); 
                         await batch.commit(); // Commit stock updates first
                         
                         const serviceRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'services'), payload);
                         
                         // CREATE TRANSACTIONS: income for service + expense for modal parts + profit
                         const transactionBatch = writeBatch(db);
                         
                         // 1. INCOME transaction (jasa service)
                         if (paid > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), { 
                                 ownerId: activeOwner.id, 
                                 storeId: activeStore.id, 
                                 type: 'income', 
                                 amount: paid, 
                                 category: 'DP Servis', 
                                 description: `DP ${payload.customerName}`, 
                                 date: serverTimestamp(), 
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai'
                             }); 
                         }
                         
                         // 2. EXPENSE transaction (modal dari sparepart yang dijual)
                         const modalSparepart = (data.usedParts || []).reduce((acc, p) => {
                             if (!p.isManual) {
                                 acc += (parseFloat(p.buyPrice || 0) * p.qty);
                             }
                             return acc;
                         }, 0);
                         
                         if (modalSparepart > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'expense',
                                 category: 'Modal Sparepart Dijual',
                                 description: `Modal sparepart untuk ${payload.customerName}`,
                                 amount: modalSparepart,
                                 date: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai',
                                 items: (data.usedParts || []).filter(p => !p.isManual).map(p => ({
                                     name: p.name,
                                     qty: p.qty,
                                     buyPrice: p.buyPrice,
                                     subtotal: (parseFloat(p.buyPrice || 0) * p.qty)
                                 }))
                             });
                         }
                         
                         // 3. PROFIT/LOSS transaction (keuntungan dari sparepart)
                         let profitSparepart = 0;
                         (data.usedParts || []).forEach(p => {
                             if (!p.isManual) {
                                 const itemProfit = ((parseFloat(p.sellPrice) || 0) - (parseFloat(p.buyPrice) || 0)) * p.qty;
                                 profitSparepart += itemProfit;
                             }
                         });
                         
                         if (profitSparepart !== 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: profitSparepart > 0 ? 'profit' : 'loss',
                                 category: profitSparepart > 0 ? 'Keuntungan Sparepart' : 'Rugi Sparepart',
                                 description: `${profitSparepart > 0 ? 'Profit' : 'Loss'} sparepart untuk ${payload.customerName}`,
                                 amount: Math.abs(profitSparepart),
                                 date: serverTimestamp(),
                                 createdAt: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai'
                             });
                         }
                         
                         // 4. PROFIT transaction (keuntungan dari jasa service)
                         // Untung Jasa = Total Biaya - Harga Jual Sparepart
                         const partsJualTotal = (data.usedParts || []).reduce((acc, p) => acc + (parseFloat(p.sellPrice || 0) * p.qty), 0);
                         const jasaProfit = (parseFloat(data.serviceFee) || 0) - partsJualTotal;
                         if (jasaProfit > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'profit',
                                 category: 'Keuntungan Jasa Servis',
                                 description: `Profit jasa servis untuk ${payload.customerName}`,
                                 amount: jasaProfit,
                                 date: serverTimestamp(),
                                 createdAt: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 cashAccount: data.cashAccount || 'Kas Tunai'
                             });
                         }
                         
                         await transactionBatch.commit();
                     } 
                     setModal(null); 
                 } catch(err) { alert("Gagal simpan: " + err.message); } 
             };
             const handlePay = async (service, amount, method, cashAccount) => { try { const newPaid = (parseFloat(service.dp) || 0) + parseFloat(amount); const isPaidOff = newPaid >= service.costEstimate; await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id), { dp: newPaid, paymentStatus: isPaidOff ? 'Lunas' : 'DP' }); await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), { ownerId: activeOwner.id, storeId: activeStore.id, type: 'income', amount: parseFloat(amount), category: 'Pelunasan Servis', description: `Bayar ${service.customerName} (${method})`, date: serverTimestamp(), serviceId: service.id, cashAccount: cashAccount || 'Kas Tunai' }); setPayModal(null); } catch(err) { alert("Gagal bayar: " + err.message); } };
             const deleteService = async (id) => { 
                 if(confirm("Hapus data servis ini?")) { 
                     try { 
                         console.log('üóëÔ∏è Starting service deletion for ID:', id);
                         
                         // Check if service exists first
                         const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', id);
                         const serviceDoc = await getDoc(serviceRef);
                         
                         if (!serviceDoc.exists()) {
                             alert("‚ùå Data servis tidak ditemukan di database!");
                             return;
                         }
                         
                         const serviceData = serviceDoc.data();
                         console.log('üìÑ Service data found:', serviceData);
                         
                         // Restore stock if service has used parts
                         if (serviceData.usedParts && serviceData.usedParts.length > 0) { 
                             console.log('üîÑ Restoring stock for used parts...');
                             for (const part of serviceData.usedParts) { 
                                 try {
                                     const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id); 
                                     const invDoc = await getDoc(invRef);
                                     if (invDoc.exists()) {
                                         const currentStock = invDoc.data().stock || 0;
                                         await updateDoc(invRef, {stock: currentStock + (part.qty || 0)}); 
                                         console.log(`‚úÖ Stock restored for ${part.name}: +${part.qty}`);
                                     }
                                 } catch (partError) {
                                     console.warn(`‚ö†Ô∏è Failed to restore stock for part ${part.id}:`, partError);
                                 }
                             } 
                         }
                         
                         // Delete related transactions
                         console.log('üóëÔ∏è Deleting related transactions...');
                         const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'); 
                         const tq = query(transRef, where('serviceId', '==', id)); 
                         const tSnap = await getDocs(tq); 
                         
                         if (tSnap.docs.length > 0) {
                             const tbatch = writeBatch(db); 
                             tSnap.docs.forEach(d => tbatch.delete(d.ref)); 
                             await tbatch.commit(); 
                             console.log(`‚úÖ Deleted ${tSnap.docs.length} related transactions`);
                         }
                         
                         // Finally delete the service document
                         console.log('üóëÔ∏è Deleting service document...');
                         await deleteDoc(serviceRef); 
                         console.log('‚úÖ Service deleted successfully');
                         
                         alert("‚úÖ Servis berhasil dihapus. Stok & transaksi sudah dikembalikan."); 
                         
                     } catch(err) { 
                         console.error('‚ùå Error deleting service:', err);
                         
                         // More specific error messages
                         let errorMessage = "‚ùå Gagal hapus servis: ";
                         if (err.code === 'not-found') {
                             errorMessage += "Data tidak ditemukan";
                         } else if (err.code === 'permission-denied') {
                             errorMessage += "Tidak ada izin";
                         } else {
                             errorMessage += err.message;
                         }
                         
                         alert(errorMessage); 
                     } 
                 } 
             };

             // NEW: Delete All Services Function
             const deleteAllServices = async () => {
                 const confirmText = prompt(
                     "‚ö†Ô∏è PERINGATAN: Ini akan menghapus SEMUA data servis!\n\nKetik 'HAPUS SEMUA' untuk konfirmasi:"
                 );
                 
                 if (confirmText !== 'HAPUS SEMUA') {
                     alert('‚ùå Konfirmasi dibatalkan');
                     return;
                 }
                 
                 if (!confirm(`üö® KONFIRMASI TERAKHIR\n\nAnda akan menghapus ${services.length} data servis.\nStok spare part akan dikembalikan.\nTransaksi terkait akan dihapus.\n\nLanjutkan?`)) {
                     return;
                 }
                 
                 try {
                     console.log('üóëÔ∏è Starting bulk service deletion...');
                     
                     let restoredParts = 0;
                     let deletedTransactions = 0;
                     
                     // Process each service
                     for (const service of services) {
                         console.log(`Processing service ${service.id}...`);
                         
                         // Restore stock if service has used parts
                         if (service.usedParts && service.usedParts.length > 0) {
                             for (const part of service.usedParts) {
                                 try {
                                     const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                     const invDoc = await getDoc(invRef);
                                     if (invDoc.exists()) {
                                         const currentStock = invDoc.data().stock || 0;
                                         await updateDoc(invRef, {stock: currentStock + (part.qty || 0)});
                                         restoredParts++;
                                     }
                                 } catch (partError) {
                                     console.warn(`‚ö†Ô∏è Failed to restore part ${part.id}:`, partError);
                                 }
                             }
                         }
                         
                         // Delete related transactions
                         const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                         const tq = query(transRef, where('serviceId', '==', service.id));
                         const tSnap = await getDocs(tq);
                         
                         if (tSnap.docs.length > 0) {
                             const tbatch = writeBatch(db);
                             tSnap.docs.forEach(d => tbatch.delete(d.ref));
                             await tbatch.commit();
                             deletedTransactions += tSnap.docs.length;
                         }
                     }
                     
                     // Delete all services in batches
                     const serviceRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'services');
                     const serviceQuery = query(serviceRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                     const serviceSnap = await getDocs(serviceQuery);
                     
                     const batchArray = [];
                     let currentBatch = writeBatch(db);
                     let count = 0;
                     
                     serviceSnap.docs.forEach(doc => {
                         currentBatch.delete(doc.ref);
                         count++;
                         if (count >= 450) {
                             batchArray.push(currentBatch);
                             currentBatch = writeBatch(db);
                             count = 0;
                         }
                     });
                     
                     if (count > 0) {
                         batchArray.push(currentBatch);
                     }
                     
                     // Commit all batches
                     for (const batch of batchArray) {
                         await batch.commit();
                     }
                     
                     console.log('‚úÖ Bulk deletion completed');
                     alert(`‚úÖ BERHASIL!\n\nüìã ${serviceSnap.docs.length} servis dihapus\nüì¶ ${restoredParts} stok dikembalikan\nüí∞ ${deletedTransactions} transaksi dihapus`);
                     
                 } catch (err) {
                     console.error('‚ùå Error in bulk deletion:', err);
                     alert(`‚ùå Gagal hapus semua: ${err.message}`);
                 }
             };
             const updateStatus = async (id, newStatus) => { 
                 try { 
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', id), { status: newStatus });
                     
                     // Auto show payment modal when status changes to Selesai
                     if (newStatus === 'Selesai') {
                         const service = services.find(s => s.id === id);
                         if (service && service.paymentStatus !== 'Lunas') {
                             const remainingAmount = (parseFloat(service.costEstimate) || 0) - (parseFloat(service.dp) || 0);
                             if (remainingAmount > 0) {
                                 setPayModal(service);
                             }
                         }
                     }
                 } catch(err) {
                     console.error('Error updating status:', err);
                 } 
             };
             const print = (s) => { setPrint(s); setTimeout(() => { window.print(); setPrint(null); }, 500); };
             const shareInvoiceAsImage = async (service) => { 
                const formattedPhone = formatWhatsAppNumber(service.phone);
                if (!formattedPhone) { alert('‚ö†Ô∏è Nomor WA pelanggan kosong!'); return; }
                
                // Generate invoice FIRST
                setCaptureData(service); 
                await new Promise(r => setTimeout(r, 800));
                const element = document.getElementById('invoice-capture'); 
                if (!element) { alert('Gagal membuat invoice'); setCaptureData(null); return; } 
                try { 
                    const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff' }); 
                    canvas.toBlob(async (blob) => { 
                        setCaptureData(null);
                        
                        // 1. Download File
                        const link = document.createElement('a'); 
                        link.href = URL.createObjectURL(blob); 
                        link.download = `Invoice-${service.token}.jpg`; 
                        document.body.appendChild(link);
                        link.click(); 
                        document.body.removeChild(link);
                        
                        // Wait for download to register
                        await new Promise(r => setTimeout(r, 1500));
                        
                        // 2. Open WhatsApp Direct to Customer Number using wa.me (more compatible)
                        const message = `Halo Kak ${service.customerName}! üëã\n\nBerikut adalah invoice detail servis untuk Kak:\n\nüí∞ *Invoice Servis*\nüÜî Token: ${service.token}\nüìÑ Silakan download file invoice yang telah kami siapkan.\n\nJika ada pertanyaan, silakan hubungi kami. Terimakasih! üôè`
                        const encodedMessage = encodeURIComponent(message);
                        
                        // Use wa.me which works on both mobile apps and desktop
                        window.open(`https://wa.me/${formattedPhone}?text=${encodedMessage}`, '_blank');
                        
                    }, 'image/jpeg', 0.95); 
                } catch (err) { setCaptureData(null); console.error(err); } 
             };
             const filtered = services.filter(s => (s.customerName.toLowerCase().includes(term) || (s.token || s.publicToken || '').includes(term)) && (statusFilter === 'all' || s.status === statusFilter));
             
             // Pagination logic
             const totalItems = filtered.length;
             const totalPages = Math.ceil(totalItems / itemsPerPage);
             const startIndex = (currentPage - 1) * itemsPerPage;
             const endIndex = startIndex + itemsPerPage;
             const paginatedData = filtered.slice(startIndex, endIndex);
             
             // Reset to page 1 when filter changes
             useEffect(() => {
                 setCurrentPage(1);
             }, [statusFilter, term]);
             
             const handlePageChange = (newPage) => {
                 if (newPage >= 1 && newPage <= totalPages) {
                     setCurrentPage(newPage);
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 }
             };
             
             const handleItemsPerPageChange = (value) => {
                 setItemsPerPage(value);
                 setCurrentPage(1);
             };
             
             return (
                 <div className="space-y-6 no-print">
                     {/* Status Filter */}
                     <div className="flex flex-wrap gap-2 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-16 md:top-0 z-10 overflow-x-auto">
                        {['all', ...STATUS_FLOW].map(status => {
                            const statusEmoji = {
                                'all': 'üìã Semua',
                                'Diterima': 'üì• Diterima',
                                'Diagnosa': 'üîç Diagnosa',
                                'Proses': '‚öôÔ∏è Proses',
                                'Menunggu Sparepart': '‚è≥ Menunggu Spare',
                                'Selesai': '‚úÖ Selesai',
                                'Diambil': 'üì¶ Diambil',
                                'Dibatalkan': '‚ùå Batal',
                                'Garansi': 'üîß Garansi'
                            };
                            return (
                                <button
                                    key={status}
                                    onClick={() => setStatusFilter(status)}
                                    className={`px-3 py-2 rounded-lg font-bold text-xs md:text-sm transition-all whitespace-nowrap ${
                                        statusFilter === status
                                            ? 'bg-blue-600 text-white shadow-lg'
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    {statusEmoji[status]}
                                </button>
                            );
                        })}
                     </div>

                     <div className="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-28 md:top-0 z-10">
                        <div className="relative flex-1"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari pelanggan / token..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                        <div className="flex gap-2">
                            <button onClick={deleteAllServices} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-500/30 transition-all hover:scale-105" title="Hapus Semua Data Service"><Trash2 className="w-4 h-4"/> Hapus Semua</button>
                            <button onClick={()=>setModal({ownerId: activeOwner?.id})} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30 transition-all hover:scale-105"><Plus className="w-5 h-5"/> Servis Baru</button>
                        </div>
                     </div>

                     <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto swipe-hint"><table className="w-full text-sm text-left"><thead className="bg-slate-100 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs tracking-wider"><tr><th className="px-3 md:px-6 py-3 md:py-4">Pelanggan / Unit</th><th className="px-3 md:px-6 py-3 md:py-4 bg-purple-50 text-purple-700 hidden md:table-cell">Sparepart</th><th className="px-3 md:px-6 py-3 md:py-4">Status</th><th className="px-3 md:px-6 py-3 md:py-4 hidden lg:table-cell">Pembayaran</th><th className="px-3 md:px-6 py-3 md:py-4">Total</th><th className="px-3 md:px-6 py-3 md:py-4 text-center">Aksi</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {paginatedData.map(s => {
                                        const sisa = (s.costEstimate || 0) - (s.dp || 0);
                                        const statusBgClass = s.status === 'Diterima' ? 'bg-blue-100 hover:bg-blue-200' : 
                                            s.status === 'Diagnosa' ? 'bg-yellow-100 hover:bg-yellow-200' : 
                                            s.status === 'Dikerjakan' ? 'bg-purple-100 hover:bg-purple-200' : 
                                            s.status === 'Menunggu Sparepart' ? 'bg-orange-100 hover:bg-orange-200' : 
                                            s.status === 'Selesai' ? 'bg-green-100 hover:bg-green-200' : 
                                            s.status === 'Diambil' ? 'bg-emerald-100 hover:bg-emerald-200' :
                                            s.status === 'Dibatalkan' ? 'bg-red-100 hover:bg-red-200' : 
                                            'bg-slate-100 hover:bg-slate-200';
                                        return (
                                            <tr key={s.id} className={`transition-colors ${statusBgClass}`}>
                                                <td className="px-3 md:px-6 py-3 md:py-4">
                                                    <div className="font-bold text-slate-800 text-base">{s.customerName}</div>
                                                    <div className="text-xs text-slate-500 font-medium flex items-center gap-1 mt-1"><Smartphone className="w-3 h-3"/> {s.unitType || s.device || s.deviceType}</div>
                                                    <div className="text-[10px] text-slate-400 mt-1">{formatDate(s.createdAt)} ‚Ä¢ {s.token || s.publicToken}</div>
                                                </td>
                                                <td className="px-3 md:px-6 py-3 md:py-4 hidden md:table-cell">
                                                    <div className="flex flex-col gap-2">
                                                        {(s.usedParts || []).map((p, idx) => (
                                                            <div key={idx} className="bg-white border border-purple-100 rounded-lg p-2 shadow-sm">
                                                                <div className="flex items-center gap-1.5 mb-1">
                                                                    <Box className="w-3.5 h-3.5 text-purple-500"/>
                                                                    <span className="text-purple-700 text-xs font-bold">{p.name}</span>
                                                                    <span className="text-slate-400 font-normal text-[10px]">x{p.qty}</span>
                                                                </div>
                                                                <div className="text-[10px] text-slate-600 font-semibold ml-5">
                                                                    {formatCurrency(p.sellPrice || 0)} <span className="text-slate-400 font-normal">/ unit</span>
                                                                    {p.qty > 1 && <span className="text-purple-600 ml-2">= {formatCurrency((p.sellPrice || 0) * p.qty)}</span>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {(!s.usedParts || s.usedParts.length === 0) && <span className="text-slate-400 italic text-xs">-</span>}
                                                    </div>
                                                </td>
                                                <td className="px-3 md:px-6 py-3 md:py-4"><select value={s.status} onChange={(e) => updateStatus(s.id, e.target.value)} className={`text-xs font-bold border rounded-lg px-2 py-1.5 cursor-pointer outline-none transition-colors ${ s.status === 'Diterima' ? 'bg-blue-100 text-blue-700 border-blue-200' : s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Menunggu Sparepart' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Selesai' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200'}`} onClick={(e) => e.stopPropagation()}>{STATUS_FLOW.map(st => <option key={st} value={st}>{st}</option>)}</select></td>
                                                <td className="px-3 md:px-6 py-3 md:py-4 hidden lg:table-cell"><div className="flex flex-col gap-1 items-start"><span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wide border ${s.paymentStatus === 'Lunas' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : s.paymentStatus === 'DP' ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>{s.paymentStatus}</span>{s.paymentStatus !== 'Lunas' && (<button onClick={() => setPayModal(s)} className="flex items-center gap-1 text-xs font-bold text-blue-600 hover:text-blue-800 hover:underline mt-1"><DollarSign className="w-3 h-3"/> Bayar {s.paymentStatus === 'DP' ? 'Sisa' : 'Sekarang'}</button>)}{s.paymentStatus !== 'Lunas' && <span className="text-[10px] text-red-500 font-medium">Sisa: {formatCurrency(sisa)}</span>}</div></td>
                                                <td className="px-3 md:px-6 py-3 md:py-4"><div className="font-bold text-slate-700">{formatCurrency(s.costEstimate)}</div></td>
                                                <td className="px-3 md:px-6 py-3 md:py-4">
                                                    <div className="flex flex-col gap-2">
                                                        {/* Baris 1: Edit, Add Part, Share Progress */}
                                                        <div className="flex justify-center gap-2">
                                                            <button onClick={() => setModal(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-500 transition-all shadow-sm" title="Edit Detail"><Settings className="w-4 h-4"/></button>
                                                            <button onClick={() => setAddPartModal(s)} className="p-2 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 text-purple-600 transition-all shadow-sm" title="Tambah Sparepart"><PackagePlus className="w-4 h-4"/></button>
                                                            {canShare ? <button onClick={() => handleShareProgress(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-green-50 text-green-600 shadow-sm" title="Kirim Progress ke WA"><Share2 className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur SHARE dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                        </div>
                                                        {/* Baris 2: Print, Share Image, Delete */}
                                                        <div className="flex justify-center gap-2">
                                                            {canPrint ? <button onClick={() => print(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-100 text-slate-600 shadow-sm" title="Print"><Printer className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur PRINT dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                            {canShare ? <button onClick={() => shareInvoiceAsImage(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-pink-50 text-pink-600 shadow-sm" title="Kirim Invoice JPEG ke WA"><ImageIcon className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur SHARE IMG dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                            {canDelete ? <button onClick={() => deleteService(s.id)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-red-50 text-red-500 shadow-sm" title="Hapus"><Trash2 className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur HAPUS dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {paginatedData.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada data ditemukan.</div>}
                        </div>
                     </div>
                     
                     {/* Pagination Info & Controls */}
                     <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                     </div>
                     
                     {/* Pagination Navigation */}
                     {totalPages > 1 && (
                         <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <button 
                                onClick={() => handlePageChange(currentPage - 1)} 
                                disabled={currentPage === 1}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                ‚Üê Sebelumnya
                            </button>
                            <div className="flex gap-2 flex-wrap justify-center">
                                {Array.from({ length: Math.min(totalPages, 7) }, (_, i) => {
                                    let pageNum;
                                    if (totalPages <= 7) {
                                        pageNum = i + 1;
                                    } else if (currentPage <= 4) {
                                        pageNum = i + 1;
                                    } else if (currentPage >= totalPages - 3) {
                                        pageNum = totalPages - 6 + i;
                                    } else {
                                        pageNum = currentPage - 3 + i;
                                    }
                                    return (
                                        <button
                                            key={pageNum}
                                            onClick={() => handlePageChange(pageNum)}
                                            className={`w-10 h-10 rounded-lg font-bold text-sm transition-all ${
                                                currentPage === pageNum
                                                    ? 'bg-blue-600 text-white shadow-lg'
                                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                            }`}
                                        >
                                            {pageNum}
                                        </button>
                                    );
                                })}
                            </div>
                            <button 
                                onClick={() => handlePageChange(currentPage + 1)} 
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                Selanjutnya ‚Üí
                            </button>
                         </div>
                     )}
                     
                     {modal && <ServiceForm initial={modal} inventory={inventory} close={()=>setModal(null)} save={saveService} allServices={services} />}
                     {addPartModal && <AddPartModal service={addPartModal} inventory={inventory} close={()=>setAddPartModal(null)} />}
                     {payModal && <PaymentModal service={payModal} close={()=>setPayModal(null)} pay={handlePay} />}
                     {printData && <div className="print-only hidden fixed inset-0 bg-white z-[9999]"><Invoice s={printData} store={store} allKelengkapanItems={allKelengkapanItems} allQCItems={allQCItems} /></div>}
                     {captureData && (<div style={{ position: 'fixed', top: 0, left: '-9999px', width: '80mm', zIndex: -1 }}><div id="invoice-capture" className="bg-white"><Invoice s={captureData} store={store} allKelengkapanItems={allKelengkapanItems} allQCItems={allQCItems} /></div></div>)}
                 </div>
             );
        };

        const AddPartModal = ({ service, inventory, close }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [partMode, setPartMode] = useState('stock');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [selectedPart, setPart] = useState('');
            const [manualPart, setManualPart] = useState({name:'', buyPrice:'', sellPrice:'', qty:1});
            const [loading, setLoading] = useState(false);
            const [customCategories, setCustomCategories] = useState([]);
            
            // Load custom categories from Firestore real-time
            useEffect(() => {
                if (!activeOwner?.id) return;
                let q;
                if (activeStore?.id) {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id), 
                        where('storeId', '==', activeStore.id));
                } else {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allCats = new Set();
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);
            
            // Extract unique categories from inventory
            const invCategories = [...new Set(inventory.map(i => i.category).filter(c => c))];
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const categories = [...new Set([...invCategories, ...defaultCategories, ...customCategories])];
            
            // Filter products by selected category
            const categoryProducts = selectedCategory 
                ? inventory.filter(i => i.category === selectedCategory)
                : [];
            
            const handleSave = async (newPart) => {
                setLoading(true);
                try {
                    const currentParts = service.usedParts || [];
                    const updatedParts = [...currentParts, newPart];
                    
                    // Total Biaya (serviceFee) sudah termasuk harga jual sparepart
                    // Jadi costEstimate = serviceFee (tidak perlu ditambah lagi)
                    const totalBiaya = parseFloat(service.serviceFee || service.costEstimate || 0);

                    // NEW: Atomic Transaction to Update Service & Deduct Stock
                    await runTransaction(db, async (transaction) => {
                         const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id);
                         transaction.update(serviceRef, {
                            usedParts: updatedParts,
                            costEstimate: totalBiaya,
                            updatedAt: serverTimestamp()
                        });

                        // If it's a stock item, decrement inventory by qty
                        if (!newPart.isManual && newPart.id) {
                             const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', newPart.id);
                             transaction.update(invRef, {
                                 stock: increment(-newPart.qty)
                             });
                        }
                    });
                    
                    close();
                } catch(e) {
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const add = () => {
                 if (partMode === 'stock') {
                    const item = inventory.find(i => i.id === selectedPart);
                    if (item) {
                        if (item.stock <= 0) {
                            alert("Stok barang habis!");
                            return;
                        }
                        // Tambahkan qty (default 1, bisa dimodifikasi jika ada input qty)
                        handleSave({ ...item, qty: 1, isManual: false });
                    }
                } else {
                    if(manualPart.name && manualPart.buyPrice && manualPart.sellPrice && manualPart.qty > 0) {
                        handleSave({ 
                           id: 'man_'+Date.now(), 
                           name: manualPart.name + ' (Manual)', 
                           buyPrice: parseFloat(manualPart.buyPrice),
                           sellPrice: parseFloat(manualPart.sellPrice), 
                           qty: parseInt(manualPart.qty) || 1, 
                           isManual: true 
                        });
                        setManualPart({name:'', buyPrice:'', sellPrice:'', qty:1});
                    } else {
                        alert('Semua field harus diisi!');
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[80] animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                             <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><PackagePlus className="w-5 h-5 text-purple-600"/> Tambah Sparepart</h3>
                             <button onClick={close} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="bg-yellow-50 text-yellow-800 p-2 rounded text-xs mb-4 border border-yellow-200">
                           ‚ÑπÔ∏è <b>Info:</b> Stok akan otomatis berkurang jika mengambil dari Inventaris.
                        </div>
                        <div className="flex gap-2 mb-3">
                            <button type="button" onClick={()=>setPartMode('stock')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${partMode==='stock'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>üì¶ Stok Toko</button>
                            <button type="button" onClick={()=>setPartMode('manual')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${partMode==='manual'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>‚úèÔ∏è Input Manual</button>
                        </div>
                        <div className="space-y-3 mb-6">
                            {partMode === 'manual' ? (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Nama Barang *</label>
                                        <input className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: LCD iPhone 12" value={manualPart.name} onChange={e=>setManualPart({...manualPart, name:e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 block mb-1">Harga Beli (Modal) *</label>
                                            <NumberInput value={manualPart.buyPrice} onChange={(val)=>setManualPart({...manualPart, buyPrice:val})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 block mb-1">Harga Jual *</label>
                                            <NumberInput value={manualPart.sellPrice} onChange={(val)=>setManualPart({...manualPart, sellPrice:val})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Jumlah (Qty) *</label>
                                        <NumberInput value={manualPart.qty} onChange={(val)=>setManualPart({...manualPart, qty:val || 1})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="1"/>
                                    </div>
                                    {manualPart.buyPrice && manualPart.sellPrice && (
                                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                            <p className="text-xs text-slate-600 mb-1">Keuntungan per item:</p>
                                            <p className="text-sm font-bold text-blue-600">{formatCurrency((parseFloat(manualPart.sellPrice) - parseFloat(manualPart.buyPrice)) * (manualPart.qty || 1))}</p>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 uppercase mb-2 block">1Ô∏è‚É£ Pilih Kategori</label>
                                        <select 
                                            className="w-full border-2 border-blue-300 rounded-lg p-3 text-sm bg-gradient-to-r from-blue-50 to-purple-50 focus:outline-none focus:border-blue-500 font-bold" 
                                            value={selectedCategory} 
                                            onChange={e => {
                                                setSelectedCategory(e.target.value);
                                                setPart('');
                                            }}
                                        >
                                            <option value="">üì¶ -- Pilih Kategori Dulu --</option>
                                            {categories.map(cat => (
                                                <option key={cat} value={cat}>üìÅ {cat}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    {selectedCategory ? (
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 uppercase mb-2 block">2Ô∏è‚É£ Pilih Barang</label>
                                            <select 
                                                className="w-full border-2 border-green-300 rounded-lg p-3 text-sm bg-white focus:outline-none focus:border-green-500" 
                                                value={selectedPart} 
                                                onChange={e => setPart(e.target.value)}
                                            >
                                                <option value="">-- Pilih Barang --</option>
                                                {categoryProducts.map(i => (
                                                    <option key={i.id} value={i.id} disabled={i.stock <= 0}>
                                                        {i.name} - {formatCurrency(i.sellPrice)} (Stok: {i.stock})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    ) : (
                                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg text-center">
                                            <Info className="w-5 h-5 text-blue-500 mx-auto mb-1" />
                                            <p className="text-xs text-blue-700">Silakan pilih kategori terlebih dahulu</p>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                        <button onClick={add} disabled={loading || (partMode === 'stock' && !selectedPart)} className="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            {loading ? "Menyimpan..." : "‚úÖ Tambahkan & Simpan"}
                        </button>
                    </div>
                </div>
            );
        };

        const ServiceForm = ({ initial, inventory, close, save, allServices = [] }) => {
            // Default form structure
            const defaultForm = { 
                customerName:'', phone:'', unitType:'', address:'', imei:'', complaint:'', serviceFee:0, dp:0, 
                status:'Diterima', paymentMethod:'Cash', warranty:'', usedParts:[], paymentStatus:'Belum Lunas',
                qcFunctional: {
                    microphone: false, speaker_bawah: false, touchscreen: false, proximity: false,
                    volume: false, silent: false, bluetooth: false, nfc: false, speaker_atas: false,
                    lcd: false, face_id: false, vibrator: false, power: false, charging: false,
                    wifi: false, flashlight: false, truetone: false,
                    kamera_belakang: { wide: false, ultrawide: false, tele: false },
                    kamera_depan: { wide: false, ultrawide: false }
                },
                kelengkapan: {
                    sim: false, sim_ejector: false, kabel_charger: false, charger_adapter: false,
                    box_dus: false, manual_buku: false, garansi: false, sticker: false,
                    screen_protector: false, case_casing: false
                }
            };
            
            // If initial has customerName, use it (from customer click). Otherwise check for id (edit mode)
            const [form, setForm] = useState(() => {
                if (initial.id) {
                    // Edit mode - use full initial data
                    return initial;
                } else if (initial.customerName) {
                    // New service from customer click - merge with defaults but keep customer data
                    return { ...defaultForm, ...initial };
                } else {
                    // New service - use defaults but preserve ownerId if provided
                    return { ...defaultForm, ownerId: initial.ownerId };
                }
            });
            const [showParts, setShowParts] = useState(!!(form.usedParts && form.usedParts.length > 0));
            const [showQC, setShowQC] = useState(false);
            const [showKelengkapan, setShowKelengkapan] = useState(false);
            const [partMode, setPartMode] = useState('stock');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [selectedPart, setPart] = useState('');
            const [manualPart, setManualPart] = useState({name:'', price:''});
            const [saving, setSaving] = useState(false);
            const [customCategories, setCustomCategories] = useState([]);
            const [cashAccount, setCashAccount] = useState('Kas Tunai');
            
            // Load custom categories from Firestore real-time
            useEffect(() => {
                if (!initial.ownerId) return;
                let q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                    where('ownerId', '==', initial.ownerId));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allCats = new Set();
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                });
                if (window.firestoreListeners) window.firestoreListeners.add(unsubscribe);
                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(unsubscribe);
                    unsubscribe();
                };
            }, [initial.ownerId]);
            
            // Extract unique categories from inventory for inline category filter
            const invCategories = [...new Set(inventory.map(i => i.category).filter(c => c))];
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const inventoryCategories = [...new Set([...invCategories, ...defaultCategories, ...customCategories])];
            
            // Filter inventory by selected category
            const categorizedInventory = selectedCategory
                ? inventory.filter(i => i.category === selectedCategory)
                : inventory;
            // Master + Owner Kelengkapan Items (Dynamic)
            const [kelengkapanItems, setKelengkapanItems] = useState([]);
            const [customerDropdownOpen, setCustomerDropdownOpen] = useState(false);
            
            // Extract unique customers from allServices for dropdown
            const uniqueCustomers = Array.from(new Map(
                allServices.map(s => [s.customerName?.toLowerCase(), {
                    name: s.customerName,
                    phone: s.phone,
                    address: s.address,
                    phoneType: s.unitType
                }])
            ).values())
            .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            // Riwayat Service Pelanggan
            const serviceHistory = allServices.filter(s => 
                s.customerName?.toLowerCase() === form.customerName.toLowerCase() && 
                s.id !== initial.id
            ).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).slice(0, 5);
            
            const loadFromHistory = (prevService) => {
                setForm(prev => ({
                    ...prev,
                    phone: prevService.phone,
                    unitType: prevService.unitType,
                    address: prevService.address,
                    imei: prevService.imei,
                    complaint: prevService.complaint,
                    warranty: prevService.warranty
                }));
            };

            const partsTotal = (form.usedParts||[]).reduce((a,b) => a + (parseFloat(b.sellPrice) * b.qty), 0);
            const modalSparepart = (form.usedParts||[]).reduce((a,b) => a + ((parseFloat(b.buyPrice)||0) * b.qty), 0);
            const totalBiaya = (parseFloat(form.serviceFee)||0); // Total Biaya sudah termasuk harga jual sparepart
            const total = totalBiaya - modalSparepart; // Laba = Total Biaya - Modal Sparepart
            const untungJual = partsTotal - modalSparepart; // Untung dari jual sparepart
            const untungJasa = totalBiaya - partsTotal; // Untung Jasa = Total Biaya - Harga Jual Sparepart
            const sisa = totalBiaya - (parseFloat(form.dp)||0);

            const addPart = () => {
                if (partMode === 'stock') {
                    const item = inventory.find(i => i.id === selectedPart);
                    if (item) {
                        setForm(p => ({ ...p, usedParts: [...(p.usedParts||[]), { ...item, qty: 1, isManual: false }] }));
                        setPart('');
                    }
                } else {
                    if(manualPart.name && manualPart.price) {
                        setForm(p => ({ ...p, usedParts: [...(p.usedParts||[]), { 
                           id: 'man_'+Date.now(), name: manualPart.name + ' (Manual)', 
                           sellPrice: parseFloat(manualPart.price), qty: 1, isManual: true 
                        }]}));
                        setManualPart({name:'', price:''});
                    }
                }
            };
            
            const handleSave = async () => {
                setSaving(true);
                try {
                     // Just call save - stock adjustment is handled in saveService function
                     await save({...form, cashAccount});
                } catch(e) {
                    alert("Error: " + e.message);
                }
                setSaving(false);
            };

            const removePart = async (idx) => {
                const partToRemove = form.usedParts[idx];
                
                // Jika part bukan manual dan sudah tersimpan di database, kembalikan stok
                if (initial.id && !partToRemove.isManual && partToRemove.id) {
                    if (confirm(`Hapus ${partToRemove.name} dari service? Stok akan dikembalikan.`)) {
                        try {
                            await runTransaction(db, async (transaction) => {
                                // Update service - remove part
                                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', initial.id);
                                const newUsedParts = form.usedParts.filter((_, i) => i !== idx);
                                transaction.update(serviceRef, {
                                    usedParts: newUsedParts,
                                    updatedAt: serverTimestamp()
                                });
                                
                                // Return stock
                                const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', partToRemove.id);
                                transaction.update(invRef, {
                                    stock: increment(partToRemove.qty)
                                });
                            });
                            
                            // Update local state
                            setForm(p => ({ ...p, usedParts: p.usedParts.filter((_, i) => i !== idx) }));
                            alert('‚úÖ Sparepart dihapus dan stok dikembalikan');
                        } catch (err) {
                            alert('Gagal hapus sparepart: ' + err.message);
                        }
                    }
                } else {
                    // Jika belum tersimpan atau manual, langsung hapus dari state
                    setForm(p => ({ ...p, usedParts: p.usedParts.filter((_, i) => i !== idx) }));
                }
            };

            // Load Master + Owner Kelengkapan Items
            useEffect(() => {
                if (!initial.ownerId) return;
                
                // Real-time listener for Kelengkapan items
                const masterUnsub = onSnapshot(
                    query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items')),
                    (masterSnap) => {
                        const masterItems = masterSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'master' }));
                        
                        // Also listen for owner's custom items
                        const ownerUnsub = onSnapshot(
                            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), where('ownerId', '==', initial.ownerId)),
                            (ownerSnap) => {
                                const ownerItems = ownerSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'owner' }));
                                
                                // Combine and deduplicate by name
                                const allItems = [...masterItems, ...ownerItems];
                                const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                setKelengkapanItems(uniqueItems);

                                // Initialize form.kelengkapan state for each item
                                const newKelengkapan = {};
                                uniqueItems.forEach(item => {
                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                    newKelengkapan[itemKey] = form.kelengkapan[itemKey] || false;
                                });
                                setForm(prev => ({ ...prev, kelengkapan: { ...prev.kelengkapan, ...newKelengkapan } }));
                            }
                        );
                        if (window.firestoreListeners) window.firestoreListeners.add(ownerUnsub);
                        
                        return () => {
                            if (window.firestoreListeners) window.firestoreListeners.delete(ownerUnsub);
                            ownerUnsub();
                        };
                    }
                );
                if (window.firestoreListeners) window.firestoreListeners.add(masterUnsub);
                
                return () => {
                    if (window.firestoreListeners) window.firestoreListeners.delete(masterUnsub);
                    masterUnsub();
                };
            }, [initial.ownerId]);
            
            // Load Master + Owner QC Functional Items (Real-time)
            const [qcItems, setQCItems] = useState([]);
            useEffect(() => {
                if (!initial.ownerId) {
                    console.log('No ownerId, skipping QC items load');
                    return;
                }
                
                console.log('Loading QC items for ownerId:', initial.ownerId);
                
                // Real-time listener for Master QC items first
                const masterUnsub = onSnapshot(
                    query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_qc_functional_items')),
                    (masterSnap) => {
                        const masterItems = masterSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'master' }));
                        
                        // Also listen for owner's custom QC items
                        const ownerUnsub = onSnapshot(
                            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), 
                                where('ownerId', '==', initial.ownerId)),
                            (snap) => {
                                const ownerItems = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'owner' }));
                                
                                // Combine and deduplicate by name
                                const allItems = [...masterItems, ...ownerItems];
                                const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                
                                console.log('QC items loaded:', uniqueItems);
                                setQCItems(uniqueItems);
                                
                                // Update form.qcFunctional with all items
                                const newQC = {};
                                uniqueItems.forEach(item => {
                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                    newQC[itemKey] = form.qcFunctional[itemKey] || false;
                                });
                                setForm(prev => ({ ...prev, qcFunctional: { ...prev.qcFunctional, ...newQC } }));
                            },
                            (error) => {
                                console.error('Error loading QC items:', error);
                            }
                        );
                        
                        return () => ownerUnsub();
                    }
                );
                
                return () => masterUnsub();
            }, [initial.ownerId]);

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70] animate-fade-in">
                    <div className="bg-white w-full max-w-4xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                             <div className="flex items-center gap-3">
                                 <h3 className="font-bold text-xl text-slate-800">{initial.id ? 'Edit Servis' : 'Servis Baru'}</h3>
                                 {!initial.id && form.customerName && (
                                     <div className="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-2">
                                         <span>üë§</span>
                                         {form.customerName}
                                     </div>
                                 )}
                             </div>
                             <button onClick={close} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        
                        {/* Riwayat Service Pelanggan */}
                        {!initial.id && serviceHistory.length > 0 && (
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                                <p className="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2">
                                    <History className="w-4 h-4"/> Riwayat Service Pelanggan
                                </p>
                                <div className="space-y-2">
                                    {serviceHistory.map((prev, idx) => (
                                        <button
                                            key={prev.id}
                                            onClick={() => loadFromHistory(prev)}
                                            className="w-full text-left p-3 bg-white border border-blue-100 rounded-lg hover:bg-blue-100 transition-all flex justify-between items-center"
                                        >
                                            <div>
                                                <p className="text-xs font-bold text-slate-600">{formatDate(prev.createdAt)} ‚Ä¢ {prev.unitType}</p>
                                                <p className="text-sm text-slate-700 font-medium">Status: {prev.status}</p>
                                            </div>
                                            <Copy className="w-4 h-4 text-blue-500 flex-shrink-0"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Info: Customer Data Pre-filled */}
                        {!initial.id && form.customerName && (
                            <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start gap-2">
                                <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"/>
                                <div>
                                    <p className="text-xs font-bold text-green-800">Data Pelanggan Ter-isi Otomatis</p>
                                    <p className="text-xs text-green-700 mt-1">
                                        Nama, nomor HP, alamat, dan tipe HP sudah ter-isi dari data pelanggan. 
                                        Atau klik layanan sebelumnya di bawah untuk auto-fill dari riwayat servis.
                                    </p>
                                </div>
                            </div>
                        )}
                        
                        {/* COMPACT LAYOUT START */}
                        <div className="space-y-4">
                            {/* Baris 1: Info Utama - 4 Kolom */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="md:col-span-1 relative">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Nama Pelanggan</label>
                                    <input 
                                        className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" 
                                        value={form.customerName} 
                                        onChange={e=>setForm({...form, customerName:e.target.value})} 
                                        onFocus={() => setCustomerDropdownOpen(true)}
                                        onBlur={() => setTimeout(() => setCustomerDropdownOpen(false), 200)}
                                        required 
                                        placeholder="Ketik nama atau pilih..."
                                    />
                                    
                                    {/* Quick select dropdown untuk customers */}
                                    {customerDropdownOpen && uniqueCustomers.length > 0 && (
                                        <div className="absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-b-md shadow-lg z-20 max-h-60 overflow-y-auto">
                                            {uniqueCustomers
                                                .filter(c => !form.customerName || c.name?.toLowerCase().includes(form.customerName.toLowerCase()))
                                                .slice(0, 5)
                                                .map((c, idx) => (
                                                    <button
                                                        key={idx}
                                                        type="button"
                                                        onClick={() => {
                                                            setForm({
                                                                ...form,
                                                                customerName: c.name,
                                                                phone: c.phone || form.phone,
                                                                address: c.address || form.address,
                                                                unitType: c.phoneType || form.unitType
                                                            });
                                                            setCustomerDropdownOpen(false);
                                                        }}
                                                        className="w-full text-left px-3 py-2 hover:bg-blue-50 border-b last:border-b-0"
                                                    >
                                                        <div className="flex justify-between items-start gap-2">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-sm text-slate-700">{c.name}</div>
                                                                {c.address && (
                                                                    <div className="text-[10px] text-slate-500 mt-0.5 line-clamp-1">
                                                                        üìç {c.address}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <span className="text-slate-600 text-[10px] font-medium whitespace-nowrap">{c.phone}</span>
                                                        </div>
                                                    </button>
                                                ))}
                                        </div>
                                    )}
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">No HP / WA</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} required placeholder="08..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Tipe HP / Unit</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.unitType} onChange={e=>setForm({...form, unitType:e.target.value})} required placeholder="Tipe..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Garansi (Hari)</label>
                                    <NumberInput className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.warranty} onChange={val=>setForm({...form, warranty:val})} placeholder="30"/>
                                </div>
                            </div>

                            {/* Baris 2: Keluhan, Status & Address */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="md:col-span-2">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Keluhan / Kerusakan</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.complaint} onChange={e=>setForm({...form, complaint:e.target.value})} placeholder="Deskripsi kerusakan..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Status Saat Ini</label>
                                    <select className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-blue-600 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.status} onChange={e=>setForm({...form, status:e.target.value})}>{STATUS_FLOW.map(s=><option key={s}>{s}</option>)}</select>
                                </div>
                            </div>

                            {/* Baris 3: Address & IMEI */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Alamat Pelanggan</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.address || ''} onChange={e=>setForm({...form, address:e.target.value})} placeholder="Alamat rumah atau tempat kerja"/>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">IMEI / Serial Number</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.imei || ''} onChange={e=>setForm({...form, imei:e.target.value})} placeholder="IMEI atau Serial..."/>
                                </div>
                            </div>

                            {/* QC Functional Check Section */}
                            <div>
                                <button type="button" onClick={() => setShowQC(!showQC)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showQC ? 'bg-purple-50 text-purple-600 border-purple-200' : 'bg-amber-50 text-amber-600 border-amber-300'}`}>{showQC ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showQC ? "Tutup QC Check" : "QC Cek Fungsional (Klik Disini)"}</button>
                                {showQC && (
                                    <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-4 animate-fade-in shadow-inner">
                                        <h4 className="font-bold text-sm text-amber-900 mb-3">‚úì Cek Fungsional Perangkat ({qcItems.length} items)</h4>
                                        {qcItems.length === 0 ? (
                                            <p className="text-xs text-amber-600 text-center py-4">Belum ada item QC. Tambahkan dari Master Data ‚Üí Cek Fungsional.</p>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                {qcItems.map(item => {
                                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                                    return (
                                                        <label key={item.id} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-100 cursor-pointer hover:bg-amber-50 transition-colors">
                                                            <input type="checkbox" checked={form.qcFunctional[itemKey] || false} onChange={(e) => setForm({...form, qcFunctional: {...form.qcFunctional, [itemKey]: e.target.checked}})} className="w-4 h-4 accent-amber-500"/>
                                                            <span className="text-xs font-medium text-slate-700 flex-1">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400 ml-auto">{item.type === 'master' ? 'üì¶' : 'üë§'}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Kelengkapan / Accessories Section */}
                            <div>
                                <button type="button" onClick={() => setShowKelengkapan(!showKelengkapan)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showKelengkapan ? 'bg-green-50 text-green-600 border-green-200' : 'bg-teal-50 text-teal-600 border-teal-300'}`}>{showKelengkapan ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showKelengkapan ? "Tutup Cek Kelengkapan" : "Cek Kelengkapan / Aksesoris (Klik Disini)"}</button>
                                {showKelengkapan && (
                                    <div className="bg-teal-50 p-4 rounded-xl border border-teal-200 mb-4 animate-fade-in shadow-inner">
                                        <h4 className="font-bold text-sm text-teal-900 mb-3">üì¶ Cek Kelengkapan Paket ({kelengkapanItems.length} items)</h4>
                                        {kelengkapanItems.length === 0 ? (
                                            <p className="text-xs text-teal-600 text-center py-4">Belum ada item master atau custom. Hubungi admin untuk setup.</p>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                {kelengkapanItems.map(item => {
                                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                                    return (
                                                        <label key={item.id} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-teal-100 cursor-pointer hover:bg-teal-50 transition-colors">
                                                            <input type="checkbox" checked={form.kelengkapan[itemKey] || false} onChange={(e) => setForm({...form, kelengkapan: {...form.kelengkapan, [itemKey]: e.target.checked}})} className="w-4 h-4 accent-teal-500"/>
                                                            <span className="text-xs font-medium text-slate-700">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400 ml-auto">{item.type === 'master' ? 'üì¶' : 'üë§'}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Sparepart Section Compact */}
                            <div>
                                <button type="button" onClick={() => setShowParts(!showParts)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showParts ? 'bg-red-50 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-300'}`}>{showParts ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showParts ? "Tutup Input Sparepart" : "Tambah Sparepart / Jasa (Klik Disini)"}</button>
                                {showParts && (
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 animate-fade-in shadow-inner">
                                        <div className="bg-blue-50 text-blue-800 text-[10px] p-2 mb-2 rounded border border-blue-200">
                                            üí° Gunakan tombol <b>+ Sparepart</b> di tabel utama untuk manajemen stok yang lebih akurat.
                                        </div>
                                        <div className="flex gap-2 mb-2 border-b border-slate-200 pb-2">
                                            <button type="button" onClick={()=>setPartMode('stock')} className={`flex-1 py-1 text-[10px] font-bold rounded-lg transition-all ${partMode==='stock'?'bg-white text-blue-600 shadow-sm border border-blue-100':'text-slate-500 hover:bg-gray-200'}`}>üì¶ Dari Stok</button>
                                            <button type="button" onClick={()=>setPartMode('manual')} className={`flex-1 py-1 text-[10px] font-bold rounded-lg transition-all ${partMode==='manual'?'bg-white text-blue-600 shadow-sm border border-blue-100':'text-slate-500 hover:bg-gray-200'}`}>‚úèÔ∏è Manual</button>
                                        </div>
                                        <div className="flex gap-2 mb-2">
                                            {partMode === 'manual' ? (
                                                <>
                                                    <input className="flex-1 border rounded-lg p-2 text-xs focus:outline-blue-500" placeholder="Nama Barang" value={manualPart.name} onChange={e=>setManualPart({...manualPart, name:e.target.value})}/>
                                                    <NumberInput className="w-24 border rounded-lg p-2 text-xs focus:outline-blue-500 font-bold" placeholder="Harga" value={manualPart.price} onChange={val=>setManualPart({...manualPart, price:val})} onFocus={e => e.target.select()}/>
                                                </>
                                            ) : (
                                                <>
                                                    {inventoryCategories.length > 0 && (
                                                        <select 
                                                            className="w-28 border border-blue-300 rounded-lg p-2 text-xs bg-white focus:outline-blue-500 font-bold" 
                                                            value={selectedCategory} 
                                                            onChange={e => {
                                                                setSelectedCategory(e.target.value);
                                                                setPart('');
                                                            }}
                                                        >
                                                            <option value="">üìÅ Kategori</option>
                                                            {inventoryCategories.map(cat => (
                                                                <option key={cat} value={cat}>{cat}</option>
                                                            ))}
                                                        </select>
                                                    )}
                                                    <select className="flex-1 border rounded-lg p-2 text-xs bg-white focus:outline-blue-500" value={selectedPart} onChange={e => setPart(e.target.value)}>
                                                        <option value="">-- Pilih Barang --</option>
                                                        {categorizedInventory.map(i => <option key={i.id} value={i.id}>{i.name} - {formatCurrency(i.sellPrice)}</option>)}
                                                    </select>
                                                    {selectedPart && (
                                                        <div className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold border border-blue-200 whitespace-nowrap flex items-center">
                                                            {formatCurrency(categorizedInventory.find(i => i.id === selectedPart)?.sellPrice || 0)}
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                            <button type="button" onClick={addPart} className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold hover:bg-blue-700 shadow-sm"><Plus className="w-4 h-4"/></button>
                                        </div>
                                        <div className="space-y-3 mb-6 text-sm">
                            {(form.usedParts||[]).map((p,i)=>(<div key={i} className="flex justify-between items-center text-xs bg-white p-1.5 rounded border border-slate-200 shadow-sm"><span className="font-medium text-slate-700">{p.name}</span><div className="flex items-center gap-2"><span className="font-bold text-slate-600">{formatCurrency(p.sellPrice)} x {p.qty} = {formatCurrency(p.sellPrice * p.qty)}</span><button type="button" onClick={()=>removePart(i)} className="text-red-400 hover:text-red-600 bg-red-50 p-0.5 rounded"><X className="w-3 h-3"/></button></div></div>))}</div>
                                    </div>
                                )}
                            </div>

                            {/* Biaya Section Compact Horizontal */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-dashed border-slate-200">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Biaya (Rp)</label>
                                    <NumberInput value={form.serviceFee} onChange={(val)=>setForm({...form, serviceFee:val})} className="w-full bg-slate-50 border border-slate-200 p-2 rounded text-right font-bold text-slate-700 focus:border-blue-500 focus:bg-white focus:outline-none" placeholder="0"/>
                                    <p className="text-[9px] text-slate-500 mt-1">{form.serviceFee ? formatCurrency(parseFloat(form.serviceFee) || 0) : '-'}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Sparepart</label>
                                    <div className="w-full bg-slate-100 border border-slate-200 p-2 rounded text-right font-black text-slate-800">{formatCurrency(partsTotal)}</div>
                                    <p className="text-[9px] text-slate-500 mt-1">Modal: {formatCurrency(modalSparepart)}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Laba</label>
                                    <div className="w-full bg-green-100 border border-green-300 p-2 rounded text-right font-black text-green-800 text-lg">{formatCurrency(total)}</div>
                                    <p className="text-[9px] text-slate-600 mt-1">Jual: {formatCurrency(untungJual)} | Jasa: {formatCurrency(untungJasa)}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Bayar / DP</label>
                                    <NumberInput value={form.dp} onChange={(val)=>setForm({...form, dp:val})} className="w-full bg-green-50 border border-green-200 p-2 rounded text-right font-bold text-green-700 focus:border-green-500 focus:bg-white focus:outline-none" placeholder="0"/>
                                    <p className="text-[9px] text-green-600 mt-1 font-bold">{form.dp ? formatCurrency(parseFloat(form.dp) || 0) : '-'}</p>
                                </div>
                                <div>
                                    <CashAccountSelect value={cashAccount} onChange={setCashAccount} label="Masuk/Keluar dari Kas" />
                                </div>
                            </div>
                        </div>
                        {/* COMPACT LAYOUT END */}

                        <div className="p-5 border-t bg-gray-50 rounded-b-2xl flex gap-3 mt-6 -mx-6 -mb-6">
                            <button onClick={close} className="flex-1 py-3 border border-gray-300 bg-white rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Batal</button>
                            <button onClick={handleSave} disabled={saving} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-600/30 hover:bg-blue-700 transition-colors">{saving ? 'Menyimpan...' : 'Simpan Data'}</button>
                        </div>
                    </div>
                </div>
            )
        };

        const SalesManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const { data: sales } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
            const [tab, setTab] = useState('cart');
            const [modal, setModal] = useState(null);
            const [term, setTerm] = useState('');
            const [searchBarang, setSearchBarang] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [cart, setCart] = useState([]);
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [customerAddress, setCustomerAddress] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('cash');
            const [cashAccount, setCashAccount] = useState('Kas Tunai');
            const [discount, setDiscount] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [productCurrentPage, setProductCurrentPage] = useState(1);
            const [productItemsPerPage, setProductItemsPerPage] = useState(12);
            const [customCategories, setCustomCategories] = useState([]);
            const [subCategories, setSubCategories] = useState({});
            const [selectedSubCategory, setSelectedSubCategory] = useState('');
            const [dateFilter, setDateFilter] = useState('all');
            const [customDateRange, setCustomDateRange] = useState({start:'', end:''});
            const [editModal, setEditModal] = useState(null);
            const [customers, setCustomers] = useState([]);
            const [showCustomerDropdown, setShowCustomerDropdown] = useState(false);
            const [manualItem, setManualItem] = useState({name: '', price: 0, qty: 1});
            const [showManualItemForm, setShowManualItemForm] = useState(false);
            const [editingPrice, setEditingPrice] = useState(null);
            const [newCustomerForm, setNewCustomerForm] = useState({name: '', phone: '', address: ''});
            const [showNewCustomerForm, setShowNewCustomerForm] = useState(false);
            
            // Load custom categories and subcategories from Firestore real-time
            useEffect(() => {
                if (!activeOwner?.id) return;
                let q;
                if (activeStore?.id) {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id), 
                        where('storeId', '==', activeStore.id));
                } else {
                    q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allCats = new Set();
                    const allSubCats = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                        if (data.subCategories && typeof data.subCategories === 'object') {
                            Object.assign(allSubCats, data.subCategories);
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                    setSubCategories(allSubCats);
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);
            
            // Load customers from Firestore
            useEffect(() => {
                if (!activeOwner?.id) return;
                const customersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'customers');
                const q = query(customersRef, where('ownerId', '==', activeOwner.id));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const customersList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setCustomers(customersList);
                });
                return unsubscribe;
            }, [activeOwner?.id]);
            
            // Close customer dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (showCustomerDropdown && !e.target.closest('.customer-dropdown-container')) {
                        setShowCustomerDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showCustomerDropdown]);
            
            // Extract unique categories from inventory
            const invCategories = [...new Set((inventory || []).map(i => i.category).filter(c => c))];
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const productCategories = [...new Set([...invCategories, ...defaultCategories, ...customCategories])];
            
            // Filter products by category + sub-category + search + stock
            const displayedProducts = (inventory || []).filter(i => {
                const matchSearch = i.name?.toLowerCase().includes(searchBarang.toLowerCase());
                const matchCategory = !selectedCategory || i.category === selectedCategory;
                const matchSubCategory = !selectedSubCategory || i.subCategory === selectedSubCategory;
                const hasStock = i.stock > 0;
                return matchSearch && matchCategory && matchSubCategory && hasStock;
            });

            // Pagination untuk produk
            const totalProducts = displayedProducts.length;
            const totalProductPages = Math.ceil(totalProducts / productItemsPerPage);
            const productStartIndex = (productCurrentPage - 1) * productItemsPerPage;
            const productEndIndex = productStartIndex + productItemsPerPage;
            const paginatedProducts = displayedProducts.slice(productStartIndex, productEndIndex);

            const handleProductPageChange = (page) => {
                if (page >= 1 && page <= totalProductPages) {
                    setProductCurrentPage(page);
                }
            };

            const handleProductItemsPerPageChange = (num) => {
                setProductItemsPerPage(num);
                setProductCurrentPage(1);
            };

            // Calculate cart totals
            const subtotal = cart.reduce((a, b) => a + (b.qty * b.sellPrice), 0);
            const discountAmount = (subtotal * discount) / 100;
            const total = subtotal - discountAmount;

            const removeFromCart = (itemId) => {
                setCart(cart.filter(c => c.id !== itemId));
            };

            const addToCart = (item) => {
                const existing = cart.find(c => c.id === item.id);
                if (existing) {
                    if (existing.qty < item.stock) {
                        setCart(cart.map(c => c.id === item.id ? {...c, qty: c.qty + 1} : c));
                    } else {
                        alert(`Stok ${item.name} hanya ${item.stock} unit`);
                    }
                } else {
                    setCart([...cart, {...item, qty: 1, subCategory: item.subCategory || ''}]);
                }
            };

            const updateCartItemPrice = (itemId, newPrice) => {
                setCart(cart.map(c => c.id === itemId ? {...c, sellPrice: newPrice} : c));
                setEditingPrice(null);
            };
            
            const addNewCustomer = async () => {
                if (!newCustomerForm.name.trim()) {
                    alert('Nama pelanggan tidak boleh kosong');
                    return;
                }
                
                try {
                    // Simpan pelanggan baru ke Firestore
                    const newCustomerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                        ownerId: activeOwner.id,
                        name: newCustomerForm.name,
                        phone: newCustomerForm.phone || '',
                        address: newCustomerForm.address || '',
                        createdAt: serverTimestamp()
                    });
                    
                    // Set nama pelanggan ke form checkout
                    setCustomerName(newCustomerForm.name);
                    setNewCustomerForm({name: '', phone: '', address: ''});
                    setShowNewCustomerForm(false);
                    alert('‚úÖ Pelanggan baru berhasil ditambahkan!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            
            const addManualItem = () => {
                if (!manualItem.name.trim()) {
                    alert('Nama barang tidak boleh kosong');
                    return;
                }
                if (manualItem.price <= 0) {
                    alert('Harga harus lebih dari 0');
                    return;
                }
                if (manualItem.qty <= 0) {
                    alert('Jumlah harus lebih dari 0');
                    return;
                }
                
                setCart([...cart, {
                    id: 'manual_' + Date.now(),
                    name: manualItem.name + ' (Manual)',
                    category: 'Manual',
                    sellPrice: manualItem.price,
                    buyPrice: 0,
                    qty: manualItem.qty,
                    isManual: true
                }]);
                
                setManualItem({name: '', price: 0, qty: 1});
                setShowManualItemForm(false);
                alert('‚úÖ Barang manual ditambahkan ke keranjang');
            };

            const updateCartQty = (itemId, newQty) => {
                if (newQty <= 0) {
                    removeFromCart(itemId);
                } else {
                    const item = inventory.find(i => i.id === itemId);
                    if (newQty <= item.stock) {
                        setCart(cart.map(c => c.id === itemId ? {...c, qty: newQty} : c));
                    } else {
                        alert(`Stok ${item.name} hanya ${item.stock} unit`);
                    }
                }
            };

            const handleSaveSale = async () => {
                if (!customerName.trim()) {
                    alert("Nama pelanggan wajib diisi");
                    return;
                }
                if (cart.length === 0) {
                    alert("Keranjang tidak boleh kosong");
                    return;
                }

                try {
                    // 1. Check if customer exists, if not create new customer
                    let existingCustomer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                    
                    if (!existingCustomer && (customerPhone || customerAddress)) {
                        // Create new customer
                        const newCustomerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            name: customerName,
                            phone: customerPhone || '',
                            address: customerAddress || '',
                            createdAt: serverTimestamp()
                        });
                        existingCustomer = {
                            id: newCustomerRef.id,
                            name: customerName,
                            phone: customerPhone,
                            address: customerAddress
                        };
                    }
                    
                    const payload = {
                        customerName,
                        customerId: existingCustomer?.id || null,
                        items: cart.map(c => ({name: c.name, category: c.category, subCategory: c.subCategory || '', qty: c.qty, sellPrice: c.sellPrice, buyPrice: c.buyPrice, id: c.id})),
                        subtotal,
                        discount,
                        discountAmount,
                        total,
                        paymentMethod,
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        createdAt: serverTimestamp(),
                        type: 'sale'
                    };
                    
                    // Calculate modal (cost) and profit
                    let totalModal = 0;
                    let totalProfit = 0;
                    
                    // Calculate costs (tidak update stok dulu)
                    for (const item of cart) {
                        // Calculate modal per item
                        const itemModal = (item.buyPrice || 0) * item.qty;
                        totalModal += itemModal;
                        
                        // Calculate profit per item
                        const itemProfit = ((item.sellPrice || 0) - (item.buyPrice || 0)) * item.qty;
                        totalProfit += itemProfit;
                    }
                    
                    // Use transaction to ensure atomicity
                    const saleRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'));
                    
                    await runTransaction(db, async (transaction) => {
                        // 1. Simpan sale
                        transaction.set(saleRef, payload);
                        
                        // 2. Kurangi stok untuk setiap item di cart (hanya yang bukan manual)
                        for (const item of cart) {
                            // Lewati item manual tidak perlu update stok
                            if (item.isManual) continue;
                            
                            const itemRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            transaction.update(itemRef, {
                                stock: increment(-item.qty)
                            });
                        }
                    });
                    
                    const saleId = saleRef.id;
                    
                    // Create transaction records
                    const batch = writeBatch(db);
                    
                    // 1. PENGELUARAN (Modal/Cost)
                    if (totalModal > 0) {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'expense',
                            category: 'Modal Barang Terjual',
                            description: `Modal penjualan untuk ${customerName}`,
                            amount: totalModal,
                            date: serverTimestamp(),
                            originalSaleId: saleId,
                            cashAccount: cashAccount || 'Kas Tunai'
                        });
                    }
                    
                    // 2. PEMASUKAN (Revenue) - Only if not credit
                    if (paymentMethod !== 'credit') {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'income',
                            category: 'Penjualan Barang',
                            description: `Penjualan ${cart.length} item ke ${customerName}`,
                            amount: payload.total,
                            date: serverTimestamp(),
                            originalSaleId: saleId,
                            cashAccount: cashAccount || 'Kas Tunai'
                        });
                    }
                    
                    // If credit, create receivable (piutang)
                    if (paymentMethod === 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'receivable',
                            customerName: customerName,
                            amount: payload.total,
                            paid: 0,
                            remaining: payload.total,
                            description: `Penjualan ${cart.length} item`,
                            dueDate: null,
                            status: 'unpaid',
                            createdAt: serverTimestamp()
                        });
                    }
                    
                    // 3. KEUNTUNGAN (Profit/Loss)
                    if (totalProfit !== 0) {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: totalProfit > 0 ? 'profit' : 'loss',
                            category: totalProfit > 0 ? 'Keuntungan Penjualan' : 'Rugi Penjualan',
                            description: `${totalProfit > 0 ? 'Profit' : 'Loss'} dari penjualan ke ${customerName}`,
                            amount: Math.abs(totalProfit),
                            date: serverTimestamp(),
                            originalSaleId: saleId,
                            cashAccount: cashAccount || 'Kas Tunai'
                        });
                    }
                    
                    await batch.commit();
                    
                    // Reset form
                    setCart([]);
                    setCustomerName('');
                    setCustomerPhone('');
                    setCustomerAddress('');
                    setDiscount(0);
                    setPaymentMethod('cash');
                    setCashAccount('Kas Tunai');
                    setModal(null);
                    alert('‚úÖ Penjualan berhasil disimpan!');
                } catch (err) {
                    alert("Gagal simpan: " + err.message);
                }
            };

            const handleReturn = async (saleId, returnData) => {
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'), {
                        ...returnData,
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        createdAt: serverTimestamp(),
                        type: 'return',
                        originalSaleId: saleId
                    });
                    alert('‚úÖ Retur berhasil dicatat!');
                } catch (err) {
                    alert("Gagal retur: " + err.message);
                }
            };

            const deleteSale = async (id) => {
                if (confirm("Hapus transaksi penjualan ini? Stok akan dikembalikan dan semua transaksi terkait akan dihapus.")) {
                    try {
                        const saleRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'sales', id);
                        const saleSnap = await getDoc(saleRef);
                        
                        if (!saleSnap.exists()) {
                            alert('Sale tidak ditemukan');
                            return;
                        }
                        
                        const saleData = saleSnap.data();
                        
                        // Get all related transactions first
                        const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                        const q = query(transRef, where('originalSaleId', '==', id));
                        const transSnap = await getDocs(q);
                        
                        // Use transaction to ensure atomicity
                        await runTransaction(db, async (transaction) => {
                            // 1. Kembalikan stok untuk setiap item
                            for (const item of (saleData.items || [])) {
                                if (item.id) {
                                    const itemRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                                    transaction.update(itemRef, {
                                        stock: increment(item.qty)
                                    });
                                }
                            }
                            
                            // 2. Hapus semua transactions terkait
                            transSnap.docs.forEach(doc => {
                                transaction.delete(doc.ref);
                            });
                            
                            // 3. Hapus sale
                            transaction.delete(saleRef);
                        });
                        
                        alert('‚úÖ Transaksi dihapus, stok dikembalikan, dan semua data terkait dihapus');
                    } catch (err) {
                        alert("Gagal hapus: " + err.message);
                    }
                }
            };

            // Date filter logic
            const filterByDate = (sale) => {
                if (!sale.createdAt) return false;
                const saleDate = sale.createdAt.toDate ? sale.createdAt.toDate() : new Date(sale.createdAt);
                const now = new Date();
                
                switch(dateFilter) {
                    case 'today':
                        return saleDate.toDateString() === now.toDateString();
                    case 'month':
                        return saleDate.getMonth() === now.getMonth() && saleDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return saleDate.getFullYear() === now.getFullYear();
                    case 'custom':
                        if (!customDateRange.start || !customDateRange.end) return true;
                        const start = new Date(customDateRange.start);
                        const end = new Date(customDateRange.end);
                        end.setHours(23, 59, 59, 999);
                        return saleDate >= start && saleDate <= end;
                    default: // 'all'
                        return true;
                }
            };
            
            const sales_list = (sales || []).filter(s => 
                s.customerName?.toLowerCase().includes(term) && filterByDate(s)
            );
            
            // Pagination logic
            const totalItems = sales_list.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSales = sales_list.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [term]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200">
                            {[
                                { id: 'cart', label: 'Keranjang' },
                                { id: 'history', label: 'Riwayat' }
                            ].map(t => (
                                <button key={t.id} onClick={() => { setTab(t.id); setTerm(''); }} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>{t.label}</button>
                            ))}
                        </div>
                        <button onClick={() => setTab('cart')} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700"><Plus className="w-5 h-5"/> Penjualan Baru</button>
                    </div>

                    {tab === 'cart' ? (
                        <>
                            {/* Daftar Barang */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="font-bold text-lg mb-4 text-slate-800">Daftar Barang</h3>
                                    
                                    <div className="bg-white p-3 rounded-xl border border-slate-200 mb-3 sticky top-0 z-10">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            {productCategories.length > 0 && (
                                                <div>
                                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Filter Kategori</label>
                                                    <select 
                                                        value={selectedCategory} 
                                                        onChange={e => { setSelectedCategory(e.target.value); setSelectedSubCategory(''); }}
                                                        className="w-full border-2 border-slate-200 p-2.5 rounded-lg text-sm bg-white focus:border-blue-500 focus:outline-none font-bold"
                                                    >
                                                        <option value="">üì¶ Semua Kategori ({displayedProducts.length})</option>
                                                        {productCategories.map(cat => (
                                                            <option key={cat} value={cat}>
                                                                üìÅ {cat} ({(inventory || []).filter(i => i.category === cat && i.stock > 0).length})
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                            <div>
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Sub-Kategori</label>
                                                <select 
                                                    value={selectedSubCategory} 
                                                    onChange={e => setSelectedSubCategory(e.target.value)}
                                                    className="w-full border-2 border-slate-200 p-2.5 rounded-lg text-sm bg-white focus:border-blue-500 focus:outline-none font-bold"
                                                    disabled={!selectedCategory}
                                                >
                                                    <option value="">üìÅ Semua Sub-Kategori</option>
                                                    {selectedCategory && subCategories[selectedCategory] && subCategories[selectedCategory].map(sub => (
                                                        <option key={sub} value={sub}>‚Üí {sub}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="relative">
                                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Cari Barang</label>
                                                <Search className="absolute left-3 bottom-3 w-5 h-5 text-gray-400" />
                                                <input 
                                                    value={searchBarang} 
                                                    onChange={e => setSearchBarang(e.target.value)} 
                                                    placeholder="Ketik nama barang..." 
                                                    className="pl-10 pr-4 py-2.5 w-full border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 bg-gray-50 focus:bg-white transition-all" 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl border border-slate-200">
                                        <div className="space-y-2 p-4 min-h-[450px]">
                                            {paginatedProducts.length > 0 ? (
                                                paginatedProducts.map(item => (
                                                    <button key={item.id} onClick={() => addToCart(item)} className="w-full text-left p-3 rounded-lg border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center justify-between group">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{item.name}</p>
                                                            <div className="flex gap-1 flex-wrap mt-0.5">
                                                                {item.category && (
                                                                    <span className="text-[10px] text-purple-600 font-semibold bg-purple-50 px-1.5 py-0.5 rounded">üì¶ {item.category}</span>
                                                                )}
                                                                {item.subCategory && (
                                                                    <span className="text-[10px] text-blue-600 font-semibold bg-blue-50 px-1.5 py-0.5 rounded">‚Üí {item.subCategory}</span>
                                                                )}
                                                            </div>
                                                            <p className="text-xs text-slate-500">Stok: {item.stock} | Harga: {formatCurrency(item.sellPrice)}</p>
                                                        </div>
                                                        <Plus className="w-4 h-4 text-slate-400 group-hover:text-blue-600" />
                                                    </button>
                                                ))
                                            ) : (
                                                <div className="flex items-center justify-center h-[400px] text-slate-400">
                                                    <div className="text-center">
                                                        <Package className="w-16 h-16 mx-auto mb-3 opacity-30" />
                                                        <p className="font-medium">Tidak ada produk ditemukan</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Pagination Controls untuk Produk */}
                                        {displayedProducts.length > 0 && (
                                            <div className="border-t border-slate-200 p-4 space-y-3">
                                                <div className="flex flex-col sm:flex-row justify-between items-center gap-3 bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-xs text-slate-600 font-medium">Tampilkan:</span>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleProductItemsPerPageChange(12)} className={`px-2.5 py-1 rounded-lg text-xs font-bold transition-all ${productItemsPerPage === 12 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>12</button>
                                                            <button onClick={() => handleProductItemsPerPageChange(24)} className={`px-2.5 py-1 rounded-lg text-xs font-bold transition-all ${productItemsPerPage === 24 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>24</button>
                                                        </div>
                                                    </div>
                                                    <div className="text-xs text-slate-600 font-medium">
                                                        <span className="text-blue-600 font-bold">{productStartIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(productEndIndex, totalProducts)}</span> dari <span className="text-purple-600 font-bold">{totalProducts}</span> produk
                                                    </div>
                                                </div>

                                                {totalProductPages > 1 && (
                                                    <div className="flex justify-between items-center gap-3 bg-white p-3 rounded-lg border border-gray-100">
                                                        <button 
                                                            onClick={() => handleProductPageChange(productCurrentPage - 1)} 
                                                            disabled={productCurrentPage === 1}
                                                            className="px-3 py-1.5 rounded-lg font-bold text-xs transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                                        >
                                                            ‚Üê Sebelumnya
                                                        </button>
                                                        <div className="text-xs text-slate-600 font-medium">
                                                            Hal <span className="text-blue-600 font-bold">{productCurrentPage}</span> dari <span className="text-purple-600 font-bold">{totalProductPages}</span>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleProductPageChange(productCurrentPage + 1)} 
                                                            disabled={productCurrentPage === totalProductPages}
                                                            className="px-3 py-1.5 rounded-lg font-bold text-xs transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                                        >
                                                            Selanjutnya ‚Üí
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Keranjang */}
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg text-slate-800">Keranjang Belanja</h3>
                                        <button 
                                            onClick={() => setShowManualItemForm(!showManualItemForm)}
                                            className="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg hover:bg-purple-200 transition-all flex items-center gap-1"
                                        >
                                            {showManualItemForm ? '‚úï Batal' : '+ Manual'}
                                        </button>
                                    </div>
                                    
                                    {/* Form Input Barang Manual */}
                                    {showManualItemForm && (
                                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4 space-y-2">
                                            <input 
                                                type="text"
                                                placeholder="Nama barang/jasa..."
                                                value={manualItem.name}
                                                onChange={e => setManualItem({...manualItem, name: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500"
                                            />
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                <input 
                                                    type="number"
                                                    placeholder="Harga"
                                                    value={manualItem.price || ''}
                                                    onChange={e => setManualItem({...manualItem, price: parseFloat(e.target.value) || 0})}
                                                    className="border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500 font-bold"
                                                />
                                                <input 
                                                    type="number"
                                                    placeholder="Qty"
                                                    min="1"
                                                    value={manualItem.qty || 1}
                                                    onChange={e => setManualItem({...manualItem, qty: parseInt(e.target.value) || 1})}
                                                    className="border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-purple-500 font-bold"
                                                />
                                                <button 
                                                    onClick={addManualItem}
                                                    className="bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all col-span-2 md:col-span-1 py-2"
                                                >
                                                    Tambah
                                                </button>
                                            </div>
                                            {manualItem.price > 0 && manualItem.qty > 0 && (
                                                <div className="text-xs text-center text-purple-700 font-bold pt-1 border-t border-purple-200">
                                                    Subtotal: {formatCurrency(manualItem.price * manualItem.qty)}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className="bg-white rounded-xl p-4 border border-slate-200 space-y-4">
                                        <div className="space-y-3 max-h-48 overflow-y-auto border-b pb-4">
                                            {cart.length === 0 ? (
                                                <p className="text-center text-slate-400 py-6">Keranjang kosong</p>
                                            ) : (
                                                cart.map(item => (
                                                    <div key={item.id} className="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-sm text-slate-800">{item.name}</p>
                                                            <div className="flex gap-1 flex-wrap">
                                                                {item.category && (
                                                                    <span className="text-[10px] text-purple-600 font-semibold">üì¶ {item.category}</span>
                                                                )}
                                                                {item.subCategory && (
                                                                    <span className="text-[10px] text-blue-600 font-semibold">‚Üí {item.subCategory}</span>
                                                                )}
                                                            </div>
                                                            <p className="text-xs text-slate-500">
                                                                {editingPrice?.itemId === item.id ? (
                                                                    <input 
                                                                        type="number"
                                                                        value={editingPrice.price}
                                                                        onChange={e => setEditingPrice({...editingPrice, price: parseFloat(e.target.value) || 0})}
                                                                        className="w-20 border border-blue-400 p-1 rounded text-xs font-bold"
                                                                        autoFocus
                                                                    />
                                                                ) : (
                                                                    <>{formatCurrency(item.sellPrice)} √ó {item.qty}</>
                                                                )}
                                                            </p>
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            {editingPrice?.itemId === item.id ? (
                                                                <>
                                                                    <button onClick={() => updateCartItemPrice(item.id, editingPrice.price)} className="text-green-600 hover:bg-green-50 p-1 rounded text-xs font-bold">‚úì</button>
                                                                    <button onClick={() => setEditingPrice(null)} className="text-red-600 hover:bg-red-50 p-1 rounded text-xs font-bold">‚úï</button>
                                                                </>
                                                            ) : (
                                                                <button onClick={() => setEditingPrice({itemId: item.id, price: item.sellPrice})} className="text-blue-600 hover:bg-blue-50 p-1 rounded" title="Edit Harga"><Pencil className="w-3 h-3" /></button>
                                                            )}
                                                            <button onClick={() => updateCartQty(item.id, item.qty - 1)} className="text-slate-500 hover:text-red-600 p-1"><Minus className="w-4 h-4" /></button>
                                                            <span className="w-6 text-center text-sm font-bold">{item.qty}</span>
                                                            <button onClick={() => updateCartQty(item.id, item.qty + 1)} className="text-slate-500 hover:text-green-600 p-1"><Plus className="w-4 h-4" /></button>
                                                            <button onClick={() => removeFromCart(item.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><X className="w-4 h-4" /></button>
                                                        </div>
                                                        <p className="text-sm font-bold text-green-600 w-20 text-right">{formatCurrency(item.qty * item.sellPrice)}</p>
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        {/* Ringkasan */}
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between"><span>Subtotal</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                            <div className="flex justify-between"><span>Diskon</span><span className="font-bold text-orange-600">{discount}% ({formatCurrency(discountAmount)})</span></div>
                                            <div className="flex justify-between border-t pt-2"><span className="font-bold">Total</span><span className="font-bold text-lg text-green-600">{formatCurrency(total)}</span></div>
                                        </div>

                                        {cart.length > 0 && (
                                            <button onClick={() => setModal('checkout')} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition-all">Checkout</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10 space-y-3">
                                <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari berdasarkan pelanggan..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                                
                                <div className="flex flex-col gap-3">
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-1 flex flex-wrap gap-1">
                                        {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'},{id:'custom',l:'Custom'}].map(f => (
                                            <button key={f.id} onClick={()=>{setDateFilter(f.id); if(f.id!=='custom') setCustomDateRange({start:'',end:''})}} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${dateFilter === f.id ? 'bg-blue-600 text-white shadow' : 'text-slate-500 hover:bg-slate-200'}`}>{f.l}</button>
                                        ))}
                                    </div>
                                    {dateFilter === 'custom' && (
                                        <div className="flex gap-2 bg-slate-50 border border-slate-200 rounded-lg p-2">
                                            <input type="date" value={customDateRange.start} onChange={(e)=>setCustomDateRange({...customDateRange, start:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Dari"/>
                                            <span className="text-slate-400 self-center">-</span>
                                            <input type="date" value={customDateRange.end} onChange={(e)=>setCustomDateRange({...customDateRange, end:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Ke"/>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 border-b text-slate-600 font-bold uppercase text-xs">
                                            <tr>
                                                <th className="p-4">Tanggal</th>
                                                <th className="p-4 hidden sm:table-cell">Pelanggan</th>
                                                <th className="p-4">Barang</th>
                                                <th className="p-4 text-right hidden md:table-cell">Subtotal</th>
                                                <th className="p-4 text-right hidden lg:table-cell">Diskon</th>
                                                <th className="p-4 text-right">Total</th>
                                                <th className="p-4 hidden md:table-cell">Metode</th>
                                                <th className="p-4 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {paginatedSales.map(s => (
                                                <tr key={s.id} className="hover:bg-slate-50">
                                                    <td className="p-4 text-slate-600 text-xs">{formatDate(s.createdAt)}</td>
                                                    <td className="p-4 font-bold text-slate-800 hidden sm:table-cell">{s.customerName}</td>
                                                    <td className="p-4">
                                                        <div className="space-y-2">
                                                            {(s.items || []).slice(0, 2).map((item, idx) => (
                                                                <div key={idx} className="bg-slate-50 p-2 rounded-lg">
                                                                    <div className="flex items-start justify-between gap-2">
                                                                        <div className="flex-1">
                                                                            <div className="font-medium text-slate-800 text-sm">{item.name}</div>
                                                                            <div className="flex gap-1 flex-wrap mt-1">
                                                                                {item.category && (
                                                                                    <span className="inline-block bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded">
                                                                                        üì¶ {item.category}
                                                                                    </span>
                                                                                )}
                                                                                {item.subCategory && (
                                                                                    <span className="inline-block bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">
                                                                                        ‚Üí {item.subCategory}
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        <span className="text-slate-500 text-xs whitespace-nowrap">x{item.qty}</span>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {s.items?.length > 2 && (
                                                                <div className="text-xs text-blue-600 font-bold text-center py-1">+{s.items.length - 2} item lainnya</div>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-right text-slate-600 hidden md:table-cell">{formatCurrency(s.subtotal || 0)}</td>
                                                    <td className="p-4 text-right text-orange-600 font-bold hidden lg:table-cell">{s.discount || 0}%</td>
                                                    <td className="p-4 text-right font-bold text-green-600">{formatCurrency(s.total || 0)}</td>
                                                    <td className="p-4 text-xs hidden md:table-cell"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">{s.paymentMethod || '-'}</span></td>
                                                    <td className="p-4 text-center">
                                                        <div className="flex gap-1 justify-center">
                                                            <button onClick={() => setEditModal(s)} className="text-blue-500 hover:bg-blue-50 p-2 rounded transition-all" title="Edit"><Pencil className="w-4 h-4" /></button>
                                                            <button onClick={() => deleteSale(s.id)} className="text-red-500 hover:bg-red-50 p-2 rounded transition-all" title="Hapus"><Trash2 className="w-4 h-4" /></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {paginatedSales.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada riwayat penjualan.</div>}
                                </div>
                            </div>
                            
                            {/* Pagination Controls */}
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                                <div className="flex items-center gap-3">
                                    <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                        <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                                    </div>
                                </div>
                                <div className="text-sm text-slate-600 font-medium">
                                    Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                                </div>
                            </div>
                            
                            {/* Pagination Navigation */}
                            {totalPages > 1 && (
                                <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                    <button 
                                        onClick={() => handlePageChange(currentPage - 1)} 
                                        disabled={currentPage === 1}
                                        className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                    >
                                        ‚Üê Sebelumnya
                                    </button>
                                    <div className="text-sm text-slate-600 font-medium">
                                        Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                                    </div>
                                    <button 
                                        onClick={() => handlePageChange(currentPage + 1)} 
                                        disabled={currentPage === totalPages}
                                        className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                    >
                                        Selanjutnya ‚Üí
                                    </button>
                                </div>
                            )}
                        </>
                    )}

                    {/* Modal Checkout */}
                    {modal === 'checkout' && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl space-y-4">
                                <h3 className="font-bold text-xl text-slate-800">Konfirmasi Transaksi</h3>
                                
                                <div className="space-y-3 bg-slate-50 p-4 rounded-lg">
                                    <div className="relative customer-dropdown-container">
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Nama Pelanggan</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={customerName} 
                                                onChange={e => {
                                                    setCustomerName(e.target.value);
                                                    setShowCustomerDropdown(true);
                                                }} 
                                                onFocus={() => setShowCustomerDropdown(true)}
                                                placeholder="Ketik nama atau pilih dari daftar" 
                                                className="flex-1 border border-slate-300 p-2 rounded-lg focus:border-blue-500 focus:outline-none" 
                                            />
                                            <button 
                                                type="button"
                                                onClick={() => setShowCustomerDropdown(!showCustomerDropdown)}
                                                className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all"
                                                title="Lihat daftar pelanggan"
                                            >
                                                <ChevronDown className="w-4 h-4" />
                                            </button>
                                        </div>
                                        
                                        {showCustomerDropdown && customers.length > 0 && (
                                            <div className="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                {customers
                                                    .filter(c => c.name?.toLowerCase().includes(customerName.toLowerCase()))
                                                    .map(customer => (
                                                        <button
                                                            key={customer.id}
                                                            type="button"
                                                            onClick={() => {
                                                                setCustomerName(customer.name);
                                                                setShowCustomerDropdown(false);
                                                            }}
                                                            className="w-full text-left px-3 py-2 hover:bg-blue-50 transition-colors border-b last:border-b-0"
                                                        >
                                                            <div className="font-bold text-slate-800 text-sm">{customer.name}</div>
                                                            {customer.phone && (
                                                                <div className="text-xs text-slate-500 flex items-center gap-1">
                                                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                                                    </svg>
                                                                    {customer.phone}
                                                                </div>
                                                            )}
                                                        </button>
                                                    ))
                                                }
                                                {customers.filter(c => c.name?.toLowerCase().includes(customerName.toLowerCase())).length === 0 && (
                                                    <div className="px-3 py-2 text-xs text-slate-500 text-center">Tidak ada pelanggan yang cocok</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Tombol Tambah Pelanggan Baru */}
                                    {!showNewCustomerForm && (
                                        <button 
                                            type="button"
                                            onClick={() => setShowNewCustomerForm(true)}
                                            className="w-full text-xs font-bold bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg hover:bg-emerald-200 transition-all"
                                        >
                                            + Tambah Pelanggan Baru
                                        </button>
                                    )}
                                    
                                    {/* Form Tambah Pelanggan Baru */}
                                    {showNewCustomerForm && (
                                        <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 space-y-2">
                                            <h4 className="font-bold text-sm text-emerald-900">Tambah Pelanggan Baru</h4>
                                            <input 
                                                type="text"
                                                placeholder="Nama Pelanggan"
                                                value={newCustomerForm.name}
                                                onChange={e => setNewCustomerForm({...newCustomerForm, name: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                            />
                                            <input 
                                                type="tel"
                                                placeholder="Nomor HP"
                                                value={newCustomerForm.phone}
                                                onChange={e => setNewCustomerForm({...newCustomerForm, phone: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                            />
                                            <input 
                                                type="text"
                                                placeholder="Alamat"
                                                value={newCustomerForm.address}
                                                onChange={e => setNewCustomerForm({...newCustomerForm, address: e.target.value})}
                                                className="w-full border border-slate-300 p-2 rounded-lg text-sm focus:outline-none focus:border-emerald-500"
                                            />
                                            <div className="flex gap-2">
                                                <button 
                                                    type="button"
                                                    onClick={addNewCustomer}
                                                    className="flex-1 bg-emerald-600 text-white rounded-lg font-bold py-2 hover:bg-emerald-700 transition-all text-sm"
                                                >
                                                    ‚úì Simpan
                                                </button>
                                                <button 
                                                    type="button"
                                                    onClick={() => {
                                                        setShowNewCustomerForm(false);
                                                        setNewCustomerForm({name: '', phone: '', address: ''});
                                                    }}
                                                    className="flex-1 bg-slate-300 text-slate-700 rounded-lg font-bold py-2 hover:bg-slate-400 transition-all text-sm"
                                                >
                                                    ‚úï Batal
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <select value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)} className="w-full border border-slate-300 p-2 rounded-lg">
                                        <option value="cash">Tunai</option>
                                        <option value="transfer">Transfer</option>
                                        <option value="card">Kartu Kredit</option>
                                        <option value="credit">üí≥ Kredit (Piutang)</option>
                                    </select>
                                    {paymentMethod === 'credit' && (
                                        <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Akan otomatis dicatat sebagai piutang pelanggan</p>
                                    )}

                                    {paymentMethod !== 'credit' && (
                                        <CashAccountSelect value={cashAccount} onChange={setCashAccount} label="Masuk ke Kas" />
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-600">Diskon (%)</label>
                                        <NumberInput value={discount} onChange={val => setDiscount(val || 0)} min="0" max="100" className="w-full border border-slate-300 p-2 rounded-lg mt-1" />
                                    </div>
                                </div>

                                <div className="bg-slate-100 p-3 rounded-lg space-y-1">
                                    <div className="flex justify-between"><span>Subtotal</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                    <div className="flex justify-between"><span>Diskon {discount}%</span><span className="text-orange-600 font-bold">-{formatCurrency(discountAmount)}</span></div>
                                    <div className="flex justify-between border-t pt-1"><span className="font-bold">Total Bayar</span><span className="text-lg font-bold text-green-600">{formatCurrency(total)}</span></div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setModal(null)} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-600">Batal</button>
                                    <button onClick={handleSaveSale} className="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">Selesai</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal Edit Penjualan */}
                    {editModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                                        <Pencil className="w-5 h-5 text-blue-600" />
                                        Edit Transaksi Penjualan
                                    </h3>
                                    <button onClick={() => setEditModal(null)} className="p-1 hover:bg-gray-100 rounded-full">
                                        <X className="w-5 h-5 text-slate-400" />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <p className="text-xs text-blue-700">
                                            <Info className="w-4 h-4 inline mr-1" />
                                            Edit data penjualan. Perubahan akan langsung tersimpan.
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Nama Pelanggan</label>
                                        <input 
                                            type="text" 
                                            value={editModal.customerName || ''} 
                                            onChange={e => setEditModal({...editModal, customerName: e.target.value})}
                                            className="w-full border-2 border-slate-300 p-2.5 rounded-lg focus:border-blue-500 focus:outline-none" 
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Metode Pembayaran</label>
                                            <select 
                                                value={editModal.paymentMethod || 'cash'} 
                                                onChange={e => setEditModal({...editModal, paymentMethod: e.target.value})}
                                                className="w-full border-2 border-slate-300 p-2.5 rounded-lg focus:border-blue-500 focus:outline-none bg-white"
                                            >
                                                <option value="cash">Tunai</option>
                                                <option value="transfer">Transfer</option>
                                                <option value="card">Kartu Kredit</option>
                                                <option value="credit">Kredit (Piutang)</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Diskon (%)</label>
                                            <NumberInput 
                                                value={editModal.discount || 0} 
                                                onChange={val => {
                                                    const newDiscount = val || 0;
                                                    const newDiscountAmount = (editModal.subtotal * newDiscount) / 100;
                                                    const newTotal = editModal.subtotal - newDiscountAmount;
                                                    setEditModal({
                                                        ...editModal, 
                                                        discount: newDiscount,
                                                        total: newTotal
                                                    });
                                                }}
                                                min="0" 
                                                max="100" 
                                                className="w-full border-2 border-slate-300 p-2.5 rounded-lg focus:border-blue-500 focus:outline-none font-bold" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <h4 className="font-bold text-sm text-slate-700 mb-3">Daftar Barang</h4>
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {(editModal.items || []).map((item, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-sm text-slate-800">{item.name}</p>
                                                        <div className="flex gap-1 flex-wrap">
                                                            {item.category && (
                                                                <span className="text-[10px] text-purple-600 font-semibold">üì¶ {item.category}</span>
                                                            )}
                                                            {item.subCategory && (
                                                                <span className="text-[10px] text-blue-600 font-semibold">‚Üí {item.subCategory}</span>
                                                            )}
                                                        </div>
                                                        <p className="text-xs text-slate-500">{formatCurrency(item.sellPrice)} √ó {item.qty}</p>
                                                    </div>
                                                    <p className="font-bold text-green-600">{formatCurrency(item.sellPrice * item.qty)}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border border-blue-200">
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Subtotal</span>
                                                <span className="font-bold text-slate-800">{formatCurrency(editModal.subtotal || 0)}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Diskon {editModal.discount || 0}%</span>
                                                <span className="font-bold text-orange-600">-{formatCurrency((editModal.subtotal * (editModal.discount || 0)) / 100)}</span>
                                            </div>
                                            <div className="flex justify-between border-t border-blue-200 pt-2">
                                                <span className="font-bold text-slate-800">Total</span>
                                                <span className="font-bold text-xl text-green-600">{formatCurrency(editModal.total || 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => setEditModal(null)} 
                                        className="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-all"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'sales', editModal.id), {
                                                    customerName: editModal.customerName,
                                                    paymentMethod: editModal.paymentMethod,
                                                    discount: editModal.discount || 0,
                                                    total: editModal.total,
                                                    updatedAt: serverTimestamp()
                                                });
                                                setEditModal(null);
                                                alert('‚úÖ Data penjualan berhasil diupdate!');
                                            } catch (err) {
                                                alert('Error: ' + err.message);
                                            }
                                        }}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all"
                                    >
                                        üíæ Simpan Perubahan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CustomerManager = ({ setView }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            const { data: sales = [] } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: customers = [] } = useFirestoreCollection('customers', activeOwner?.id, activeStore?.id);
            const [modal, setModal] = useState(null);
            const [historyModal, setHistoryModal] = useState(null);
            const [term, setTerm] = useState('');
            const [addressFilter, setAddressFilter] = useState('');
            const [typeFilter, setTypeFilter] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [customerTab, setCustomerTab] = useState('service');
            const [hiddenCustomers, setHiddenCustomers] = useState([]);
            const [deleteConfirmModal, setDeleteConfirmModal] = useState(null);
            const [deleteAllModal, setDeleteAllModal] = useState(false);
            
            // Cache phone numbers agar tidak pernah hilang setelah ditemukan
            const phoneCacheRef = useRef({});
            const addressCacheRef = useRef({});
            
            const createServiceFromCustomer = (customer) => {
                // Open service manager dengan data pelanggan ter-fill
                const serviceData = {
                    customerName: customer.name,
                    phone: customer.phone,
                    address: customer.address || '',
                    unitType: '',
                    imei: '',
                    complaint: '',
                    serviceFee: 0,
                    dp: 0,
                    status: 'Diterima',
                    warranty: ''
                };
                
                // Store ke session untuk di-pass ke ServiceManager
                sessionStorage.setItem('newServiceData', JSON.stringify(serviceData));
                setView('service');
            };

            const syncFromServices = async () => {
                if (!activeStore || !activeStore.id) {
                    alert('‚ö†Ô∏è Pilih cabang terlebih dahulu!\n\nFitur sinkronisasi pelanggan hanya bisa dilakukan per cabang, tidak bisa di mode "Semua Toko".');
                    return;
                }

                const existingEmails = new Set(customers.map(c => c.phone));
                const newCustomers = services
                    .filter(s => s.phone && !existingEmails.has(s.phone))
                    .map(s => ({
                        name: s.customerName,
                        phone: s.phone,
                        address: s.address || '',
                        createdAt: serverTimestamp(),
                        ownerId: activeOwner.id,
                        storeId: activeStore.id
                    }))
                    .slice(0, 10);

                if (newCustomers.length === 0) {
                    alert('Tidak ada pelanggan baru untuk disinkronkan.');
                    return;
                }

                try {
                    const batch = writeBatch(db);
                    newCustomers.forEach(cust => {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers')), cust);
                    });
                    await batch.commit();
                    alert(`‚úÖ ${newCustomers.length} pelanggan baru berhasil disinkronkan dari data servis.`);
                } catch (err) {
                    alert("Gagal sinkronisasi: " + err.message);
                }
            };

            const handleSaveCustomer = async (data) => {
                try {
                    if (modal.id) {
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', modal.id), data);
                    } else {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                            ...data,
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: serverTimestamp()
                        });
                    }
                    setModal(null);
                    alert(modal.id ? 'Pelanggan diperbarui' : 'Pelanggan ditambahkan');
                } catch (err) {
                    alert("Gagal simpan: " + err.message);
                }
            };

            const confirmDeleteCustomer = (customer) => {
                console.log('Delete customer clicked:', customer);
                setDeleteConfirmModal(customer);
            };

            const executeDeleteCustomer = async () => {
                const customer = deleteConfirmModal;
                console.log('Execute delete:', customer);
                if (!customer) return;
                try {
                    if (customer.dbRecord) {
                        // Customer ada di database ‚Üí tandai deleted (jangan deleteDoc, karena akan muncul lagi dari transaksi)
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', customer.id), {
                            deleted: true,
                            deletedAt: new Date().toISOString()
                        });
                    } else {
                        // Customer dari transaksi ‚Üí buat record baru di DB dengan flag deleted
                        const customerId = customer.id.replace('service_', '').replace('sale_', '');
                        await setDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', customerId), {
                            name: customer.name || '',
                            phone: customer.phone || '',
                            address: customer.address || '',
                            phoneType: customer.phoneType || '',
                            createdAt: customer.createdAt || new Date().toISOString(),
                            deleted: true,
                            deletedAt: new Date().toISOString(),
                            ownerId: activeOwner?.id || '',
                            storeId: activeStore?.id || ''
                        });
                    }
                    alert('‚úÖ Pelanggan berhasil dihapus!');
                    setDeleteConfirmModal(null);
                } catch (err) {
                    console.error('Error deleting customer:', err);
                    alert("Gagal hapus: " + err.message);
                }
            };

            const executeDeleteAllCustomers = async () => {
                console.log('üóëÔ∏è Delete all customers - Starting');
                
                // Ambil semua customer yang aktif (baik dari database maupun transaksi)
                const currentTab = customerTab === 'service' ? mergedServiceCustomers : mergedSalesCustomers;
                const allActiveCustomers = currentTab.filter(c => !c.deleted);
                
                console.log('üìä Total customers in view:', currentTab.length);
                console.log('üìä Active customers to remove:', allActiveCustomers.length);
                
                if (allActiveCustomers.length === 0) {
                    alert('‚ö†Ô∏è Tidak ada pelanggan untuk dihapus.');
                    setDeleteAllModal(false);
                    return;
                }
                
                setDeleteAllModal(false);
                
                try {
                    const batchSize = 500;
                    let totalCount = 0;
                    
                    for (let i = 0; i < allActiveCustomers.length; i += batchSize) {
                        const batch = writeBatch(db);
                        const currentBatch = allActiveCustomers.slice(i, i + batchSize);
                        
                        currentBatch.forEach(customer => {
                            if (customer.dbRecord) {
                                // Customer ada di database ‚Üí tandai deleted (bukan deleteDoc)
                                const docRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', customer.id);
                                batch.update(docRef, {
                                    deleted: true,
                                    deletedAt: new Date().toISOString()
                                });
                            } else {
                                // Customer dari transaksi ‚Üí buat record baru dengan flag deleted + ownerId/storeId
                                const customerId = customer.id.replace('service_', '').replace('sale_', '');
                                const docRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', customerId);
                                batch.set(docRef, {
                                    name: customer.name || '',
                                    phone: customer.phone || '',
                                    address: customer.address || '',
                                    phoneType: customer.phoneType || '',
                                    createdAt: customer.createdAt || new Date().toISOString(),
                                    deleted: true,
                                    deletedAt: new Date().toISOString(),
                                    ownerId: activeOwner?.id || '',
                                    storeId: activeStore?.id || ''
                                });
                            }
                            totalCount++;
                        });
                        
                        await batch.commit();
                        console.log(`‚úÖ Processed batch: ${i + currentBatch.length}/${allActiveCustomers.length}`);
                    }
                    
                    // Clear cache
                    phoneCacheRef.current = {};
                    addressCacheRef.current = {};
                    
                    alert(`‚úÖ Berhasil menghapus ${totalCount} pelanggan!`);
                } catch (err) {
                    console.error('‚ùå Error deleting all customers:', err);
                    alert('‚ùå Gagal hapus semua pelanggan: ' + err.message);
                }
            };

            // Derive unique service customers from services data
            const serviceCustomers = useMemo(() => {
                if (!services || services.length === 0) return [];
                const customerMap = new Map();
                services.forEach(s => {
                    const key = (s.phone || s.customerName || '').toLowerCase();
                    if (!key) return;
                    if (!customerMap.has(key)) {
                        customerMap.set(key, {
                            id: 'svc_' + key,
                            name: s.customerName || '',
                            phone: s.phone || '',
                            address: s.address || '',
                            phoneType: s.unitType || s.deviceType || '',
                            createdAt: s.createdAt,
                            source: 'service',
                            serviceCount: 1
                        });
                    } else {
                        customerMap.get(key).serviceCount += 1;
                    }
                });
                return Array.from(customerMap.values());
            }, [services]);

            // Derive unique sales customers from sales data
            const salesCustomers = useMemo(() => {
                if (!sales || sales.length === 0) return [];
                const customerMap = new Map();
                sales.filter(s => s.type === 'sale').forEach(s => {
                    const key = (s.customerName || '').toLowerCase();
                    if (!key) return;
                    if (!customerMap.has(key)) {
                        customerMap.set(key, {
                            id: 'sale_' + key,
                            name: s.customerName || '',
                            phone: '',
                            address: '',
                            phoneType: '',
                            createdAt: s.createdAt,
                            source: 'sales',
                            salesCount: 1,
                            totalSpent: parseFloat(s.total) || 0
                        });
                    } else {
                        const existing = customerMap.get(key);
                        existing.salesCount += 1;
                        existing.totalSpent += parseFloat(s.total) || 0;
                    }
                });
                return Array.from(customerMap.values());
            }, [sales]);

            // Merge: Mulai dari database customers sebagai basis, lalu tambahkan info dari service/sales
            const mergedServiceCustomers = useMemo(() => {
                const result = new Map();
                customers.forEach(c => {
                    result.set(c.id, {
                        id: c.id,
                        name: c.name || '',
                        phone: c.phone || '',
                        address: c.address || '',
                        phoneType: c.phoneType || '',
                        createdAt: c.createdAt,
                        source: 'database',
                        serviceCount: 0,
                        dbRecord: true,
                        deleted: c.deleted || false
                    });
                });
                
                serviceCustomers.forEach(sc => {
                    const scPhone = (sc.phone || '').trim();
                    const scName = (sc.name || '').trim().toLowerCase();
                    
                    // Pertama, cek apakah ada DB record (termasuk yang deleted) yang cocok
                    const matchedEntry = [...result.values()].find(dbC => {
                        const dbPhone = (dbC.phone || '').trim();
                        const dbName = (dbC.name || '').trim().toLowerCase();
                        if (scPhone && dbPhone && scPhone === dbPhone) return true;
                        if (scName && dbName && scName === dbName) return true;
                        if (scPhone && dbPhone && (scPhone.includes(dbPhone) || dbPhone.includes(scPhone))) return true;
                        return false;
                    });
                    
                    if (matchedEntry) {
                        // Jika matched record sudah deleted, SKIP - jangan tambahkan data apapun
                        if (matchedEntry.deleted) return;
                        
                        matchedEntry.serviceCount = (matchedEntry.serviceCount || 0) + (sc.serviceCount || 1);
                        matchedEntry.phoneType = matchedEntry.phoneType || sc.phoneType || '';
                        matchedEntry.address = matchedEntry.address || sc.address || '';
                        if (!matchedEntry.phone && sc.phone) matchedEntry.phone = sc.phone;
                    } else {
                        // Tidak ada match sama sekali ‚Üí tambahkan sebagai customer baru dari transaksi
                        result.set(sc.id, { ...sc, dbRecord: false, deleted: false });
                    }
                });
                
                // Backfill phone dari raw services data
                if (services && services.length > 0) {
                    [...result.values()].forEach(entry => {
                        if (!entry.phone && entry.name) {
                            const svc = services.find(s => 
                                s.phone && s.customerName && 
                                s.customerName.trim().toLowerCase() === entry.name.trim().toLowerCase()
                            );
                            if (svc) entry.phone = svc.phone;
                        }
                    });
                }
                
                // 4. Restore dari cache: jika phone pernah ditemukan sebelumnya, jangan pernah hilangkan
                const items = Array.from(result.values());
                items.forEach(entry => {
                    const cacheKey = (entry.name || '').trim().toLowerCase();
                    if (!cacheKey) return;
                    
                    // Simpan phone & address ke cache jika ada
                    if (entry.phone) phoneCacheRef.current[cacheKey] = entry.phone;
                    if (entry.address) addressCacheRef.current[cacheKey] = entry.address;
                    
                    // Restore dari cache jika saat ini kosong
                    if (!entry.phone && phoneCacheRef.current[cacheKey]) {
                        entry.phone = phoneCacheRef.current[cacheKey];
                    }
                    if (!entry.address && addressCacheRef.current[cacheKey]) {
                        entry.address = addressCacheRef.current[cacheKey];
                    }
                });
                
                return items;
            }, [serviceCustomers, customers, services]);

            const mergedSalesCustomers = useMemo(() => {
                const result = new Map();
                customers.forEach(c => {
                    result.set(c.id, {
                        id: c.id,
                        name: c.name || '',
                        phone: c.phone || '',
                        address: c.address || '',
                        phoneType: c.phoneType || '',
                        createdAt: c.createdAt,
                        source: 'database',
                        salesCount: 0,
                        totalSpent: 0,
                        dbRecord: true,
                        deleted: c.deleted || false
                    });
                });
                
                salesCustomers.forEach(sc => {
                    const scName = (sc.name || '').trim().toLowerCase();
                    
                    // Cek match dengan semua DB records (termasuk yang deleted)
                    const matchedEntry = [...result.values()].find(dbC => {
                        const dbName = (dbC.name || '').trim().toLowerCase();
                        if (scName && dbName && scName === dbName) return true;
                        return false;
                    });
                    
                    if (matchedEntry) {
                        // Jika matched record sudah deleted, SKIP
                        if (matchedEntry.deleted) return;
                        
                        matchedEntry.salesCount = (matchedEntry.salesCount || 0) + (sc.salesCount || 1);
                        matchedEntry.totalSpent = (matchedEntry.totalSpent || 0) + (sc.totalSpent || 0);
                        if (!matchedEntry.phone && sc.phone) matchedEntry.phone = sc.phone;
                        if (!matchedEntry.address && sc.address) matchedEntry.address = sc.address;
                    } else {
                        // Tidak ada match ‚Üí tambahkan sebagai customer baru dari transaksi
                        result.set(sc.id, { ...sc, dbRecord: false, deleted: false });
                    }
                });
                
                // Backfill phone dari raw services data
                if (services && services.length > 0) {
                    [...result.values()].forEach(entry => {
                        if (!entry.phone && entry.name) {
                            const svc = services.find(s => 
                                s.phone && s.customerName && 
                                s.customerName.trim().toLowerCase() === entry.name.trim().toLowerCase()
                            );
                            if (svc) entry.phone = svc.phone;
                        }
                    });
                }
                
                // 4. Restore dari cache
                const items = Array.from(result.values());
                items.forEach(entry => {
                    const cacheKey = (entry.name || '').trim().toLowerCase();
                    if (!cacheKey) return;
                    
                    if (entry.phone) phoneCacheRef.current[cacheKey] = entry.phone;
                    if (entry.address) addressCacheRef.current[cacheKey] = entry.address;
                    
                    if (!entry.phone && phoneCacheRef.current[cacheKey]) {
                        entry.phone = phoneCacheRef.current[cacheKey];
                    }
                    if (!entry.address && addressCacheRef.current[cacheKey]) {
                        entry.address = addressCacheRef.current[cacheKey];
                    }
                });
                
                return items;
            }, [salesCustomers, customers, services]);

            // Select active customer list based on tab
            const activeCustomerList = customerTab === 'service' ? mergedServiceCustomers : mergedSalesCustomers;

            // Extract unique addresses and phone types for filters (normalize addresses)
            const uniqueAddresses = [...new Set(
                activeCustomerList
                    .map(c => c.address?.trim())
                    .filter(Boolean)
            )].sort();
            const uniqueTypes = [...new Set(activeCustomerList.map(c => c.phoneType).filter(Boolean))].sort();

            const filteredCustomers = activeCustomerList.length > 0 ? activeCustomerList.filter(c => {
                if (c.deleted) return false;
                if (hiddenCustomers.includes(c.id)) return false;
                const matchName = (c.name?.toLowerCase().includes(term.toLowerCase()) || false) || (c.phone?.includes(term) || false);
                const matchAddress = !addressFilter || c.address?.trim() === addressFilter;
                const matchType = !typeFilter || c.phoneType === typeFilter;
                return matchName && matchAddress && matchType;
            }) : [];

            // Count visible (non-deleted, non-hidden) customers for tab badges
            const visibleServiceCount = mergedServiceCustomers.filter(c => !c.deleted && !hiddenCustomers.includes(c.id)).length;
            const visibleSalesCount = mergedSalesCustomers.filter(c => !c.deleted && !hiddenCustomers.includes(c.id)).length;
            
            // Pagination logic
            const totalItems = filteredCustomers.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter or tab changes
            useEffect(() => {
                setCurrentPage(1);
            }, [term, addressFilter, typeFilter, customerTab]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="font-bold text-2xl">Daftar Pelanggan</h2>
                        <div className="flex gap-2">
                            <button onClick={syncFromServices} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 flex items-center gap-2"><RefreshCw className="w-4 h-4" /> Sinkronisasi</button>
                            <button onClick={() => setDeleteAllModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-700 flex items-center gap-2"><Trash2 className="w-4 h-4" /> Hapus Semua</button>
                            <button onClick={() => setModal({})} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700"><Plus className="w-5 h-5" /> Pelanggan Baru</button>
                        </div>
                    </div>

                    {/* Tab Service & Penjualan */}
                    <div className="flex gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                        <button
                            onClick={() => { setCustomerTab('service'); setTerm(''); setAddressFilter(''); setTypeFilter(''); }}
                            className={`flex-1 py-3 px-4 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 ${customerTab === 'service' ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
                        >
                            üì± Pelanggan Service
                            <span className={`px-2 py-0.5 rounded-full text-xs ${customerTab === 'service' ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600'}`}>{visibleServiceCount}</span>
                        </button>
                        <button
                            onClick={() => { setCustomerTab('sales'); setTerm(''); setAddressFilter(''); setTypeFilter(''); }}
                            className={`flex-1 py-3 px-4 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 ${customerTab === 'sales' ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
                        >
                            üõí Pelanggan Penjualan
                            <span className={`px-2 py-0.5 rounded-full text-xs ${customerTab === 'sales' ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-600'}`}>{visibleSalesCount}</span>
                        </button>
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10 space-y-3">
                        <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari nama atau nomor WA..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white" /></div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">Filter Alamat</label>
                                <select value={addressFilter} onChange={e => setAddressFilter(e.target.value)} className="w-full border border-gray-200 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                    <option value="">Semua Alamat</option>
                                    {uniqueAddresses.map(addr => (
                                        <option key={addr} value={addr}>{addr}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">Filter Type HP</label>
                                <select value={typeFilter} onChange={e => setTypeFilter(e.target.value)} className="w-full border border-gray-200 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                    <option value="">Semua Type</option>
                                    {uniqueTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        {(addressFilter || typeFilter || term) && (
                            <div className="text-xs text-slate-600 flex items-center gap-2">
                                <span>Hasil: <strong>{filteredCustomers.length}</strong> pelanggan</span>
                                {(addressFilter || typeFilter || term) && (
                                    <button onClick={() => {setTerm(''); setAddressFilter(''); setTypeFilter('');}} className="text-blue-600 hover:underline text-xs">Bersihkan Filter</button>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mobile-card-wrapper">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b text-slate-600 font-bold uppercase text-xs">
                                    <tr>
                                        <th className="p-4">Nama & Alamat</th>
                                        <th className="p-4">No WA</th>
                                        <th className="p-4">{customerTab === 'service' ? 'Type HP' : 'Jml Transaksi'}</th>
                                        <th className="p-4">{customerTab === 'service' ? 'Jml Service' : 'Total Belanja'}</th>
                                        <th className="p-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {paginatedCustomers.map(c => (
                                        <tr key={c.id} className="hover:bg-slate-50">
                                            <td className="p-4">
                                                <div className="flex flex-col">
                                                    <button 
                                                        onClick={() => createServiceFromCustomer(c)}
                                                        className="font-bold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer transition text-left"
                                                        title="Klik untuk buat service baru"
                                                    >
                                                        {c.name}
                                                    </button>
                                                    {c.address && (
                                                        <span className="text-xs text-slate-500 mt-1">
                                                            üìç {c.address}
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="p-4 text-slate-600">
                                <div className="flex items-center gap-1">
                                    {c.phone ? (
                                        <>
                                            <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                            </svg>
                                            {c.phone}
                                        </>
                                    ) : (
                                        '-'
                                    )}
                                </div>
                            </td>
                                            <td className="p-4 text-slate-500 text-xs">
                                                {customerTab === 'service' 
                                                    ? (c.phoneType || '-')
                                                    : <span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">{c.salesCount || 0}x</span>
                                                }
                                            </td>
                                            <td className="p-4 text-slate-500 text-xs">
                                                {customerTab === 'service'
                                                    ? <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold">{c.serviceCount || 0}x</span>
                                                    : <span className="font-bold text-green-600">{formatCurrency(c.totalSpent || 0)}</span>
                                                }
                                            </td>
                                            <td className="p-4 text-center flex justify-center gap-2">
                                                <button onClick={() => setHistoryModal(c)} className="text-purple-500 hover:bg-purple-50 p-2 rounded" title={customerTab === 'service' ? 'Lihat riwayat service' : 'Lihat riwayat pembelian'}><History className="w-4 h-4" /></button>
                                                {c.dbRecord && <button onClick={() => setModal(c)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil className="w-4 h-4" /></button>}
                                                <button onClick={(e) => { e.stopPropagation(); confirmDeleteCustomer(c); }} className="text-red-500 hover:bg-red-50 p-2 rounded" title="Hapus pelanggan"><Trash2 className="w-4 h-4" /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {paginatedCustomers.length === 0 && <div className="p-8 text-center text-slate-400">{customerTab === 'service' ? 'Tidak ada pelanggan service.' : 'Tidak ada pelanggan penjualan.'}</div>}
                        </div>
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedCustomers.map(c => (
                                <div key={c.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Nama</span>
                                        <span className="mobile-card-value">
                                            <button onClick={() => createServiceFromCustomer(c)} className="font-bold text-blue-600 hover:text-blue-800 hover:underline text-sm">
                                                {c.name}
                                            </button>
                                        </span>
                                    </div>
                                    {c.address && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Alamat</span>
                                            <span className="mobile-card-value text-xs">üìç {c.address}</span>
                                        </div>
                                    )}
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">WhatsApp</span>
                                        <span className="mobile-card-value text-xs flex items-center gap-1">
                                            {c.phone ? (
                                                <>
                                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                                    </svg>
                                                    {c.phone}
                                                </>
                                            ) : '-'}
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">{customerTab === 'service' ? 'Type HP' : 'Transaksi'}</span>
                                        <span className="mobile-card-value">
                                            {customerTab === 'service' 
                                                ? (c.phoneType || '-')
                                                : <span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold">{c.salesCount || 0}x</span>
                                            }
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">{customerTab === 'service' ? 'Service' : 'Total Belanja'}</span>
                                        <span className="mobile-card-value">
                                            {customerTab === 'service'
                                                ? <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold">{c.serviceCount || 0}x</span>
                                                : <span className="font-bold text-green-600 text-sm">{formatCurrency(c.totalSpent || 0)}</span>
                                            }
                                        </span>
                                    </div>
                                    <div className="mobile-card-actions">
                                        <button onClick={() => setHistoryModal(c)} className="flex-1 bg-purple-50 text-purple-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                            <History className="w-3 h-3"/> Riwayat
                                        </button>
                                        {c.dbRecord && (
                                            <button onClick={() => setModal(c)} className="flex-1 bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                                <Pencil className="w-3 h-3"/> Edit
                                            </button>
                                        )}
                                        <button onClick={(e) => { e.stopPropagation(); confirmDeleteCustomer(c); }} className="bg-red-50 text-red-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                            <Trash2 className="w-3 h-3"/> Hapus
                                        </button>
                                    </div>
                                </div>
                            ))}
                            {paginatedCustomers.length === 0 && <div className="p-8 text-center text-slate-400">{customerTab === 'service' ? 'Tidak ada pelanggan service.' : 'Tidak ada pelanggan penjualan.'}</div>}
                        </div>
                    </div>
                    
                    {/* Pagination Controls */}
                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                    </div>
                    
                    {/* Pagination Navigation */}
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <button 
                                onClick={() => handlePageChange(currentPage - 1)} 
                                disabled={currentPage === 1}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                ‚Üê Sebelumnya
                            </button>
                            <div className="text-sm text-slate-600 font-medium">
                                Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                            </div>
                            <button 
                                onClick={() => handlePageChange(currentPage + 1)} 
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                Selanjutnya ‚Üí
                            </button>
                        </div>
                    )}

                    {modal !== null && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <h3 className="font-bold text-xl text-slate-800">{modal.id ? 'Edit Pelanggan' : 'Pelanggan Baru'}</h3>
                                    <button onClick={() => setModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                                </div>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const formData = new FormData(e.target);
                                    handleSaveCustomer({
                                        name: formData.get('name'),
                                        phone: formData.get('phone'),
                                        address: formData.get('address'),
                                        phoneType: formData.get('phoneType')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Pelanggan</label>
                                        <input name="name" defaultValue={modal.name || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">No WhatsApp</label>
                                        <input name="phone" defaultValue={modal.phone || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Type HP</label>
                                        <input name="phoneType" defaultValue={modal.phoneType || ''} placeholder="Contoh: iPhone 12, Samsung A50, dll" className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Alamat</label>
                                        <textarea name="address" defaultValue={modal.address || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500 resize-none" rows="3"></textarea>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button>
                                        <button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {historyModal !== null && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white">
                                    <h3 className="font-bold text-xl text-slate-800">{customerTab === 'service' ? 'Riwayat Service' : 'Riwayat Pembelian'}: {historyModal.name}</h3>
                                    <button onClick={() => setHistoryModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                                </div>
                                
                                {customerTab === 'service' ? (
                                <div className="space-y-3">
                                    {services?.filter(s => s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                            <p>Belum ada riwayat service</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {services?.filter(s => s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(svc => (
                                                <div key={svc.id} className="border rounded-lg p-4 hover:bg-slate-50 transition">
                                                    <div className="flex justify-between items-start gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className="font-bold text-slate-800">{svc.unitType || 'Service'}</span>
                                                                <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                                                                    svc.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                    svc.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                    svc.status === 'Diambil' ? 'bg-purple-100 text-purple-700' :
                                                                    svc.status === 'Dibatalkan' ? 'bg-red-100 text-red-700' :
                                                                    'bg-yellow-100 text-yellow-700'
                                                                }`}>{svc.status || 'Antri'}</span>
                                                            </div>
                                                            <p className="text-sm text-slate-600 mb-1">üîß {svc.complaint || 'Tidak ada keluhan'}</p>
                                                            <p className="text-xs text-slate-500">üì± IMEI: {svc.imei || '-'}</p>
                                                            <p className="text-xs text-slate-500">üìÖ {formatDate(svc.createdAt)}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-slate-800 mb-1">Jasa: {formatCurrency(parseFloat(svc.serviceFee) || 0)}</div>
                                                            <div className={`text-xs font-bold px-2 py-1 rounded ${
                                                                svc.paymentStatus === 'Lunas' ? 'bg-green-100 text-green-700' :
                                                                svc.paymentStatus === 'DP' ? 'bg-orange-100 text-orange-700' :
                                                                'bg-red-100 text-red-700'
                                                            }`}>{svc.paymentStatus || 'Belum Bayar'}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                ) : (
                                <div className="space-y-3">
                                    {sales?.filter(s => s.type === 'sale' && s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                            <p>Belum ada riwayat pembelian</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {sales?.filter(s => s.type === 'sale' && s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(sale => (
                                                <div key={sale.id} className="border rounded-lg p-4 hover:bg-slate-50 transition">
                                                    <div className="flex justify-between items-start gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className="font-bold text-slate-800">üõí Penjualan</span>
                                                                <span className={`text-xs font-bold px-2 py-1 rounded-full ${sale.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : sale.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                    {sale.paymentMethod === 'cash' ? 'Tunai' : sale.paymentMethod === 'credit' ? 'Kredit' : 'Transfer'}
                                                                </span>
                                                            </div>
                                                            <div className="text-xs text-slate-600 space-y-1">
                                                                {sale.items?.map((item, idx) => (
                                                                    <p key={idx}>üì¶ {item.name} x{item.qty} @ {formatCurrency(item.sellPrice)}</p>
                                                                ))}
                                                            </div>
                                                            <p className="text-xs text-slate-500 mt-1">üìÖ {formatDate(sale.createdAt)}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-green-600">{formatCurrency(parseFloat(sale.total) || 0)}</div>
                                                            {sale.discount > 0 && <div className="text-xs text-orange-500">Diskon {sale.discount}%</div>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {deleteConfirmModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[80]">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                                        <Trash2 className="w-8 h-8 text-red-500" />
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-2">Hapus Pelanggan?</h3>
                                    <p className="text-slate-500 text-sm mb-1">Apakah Anda yakin ingin menghapus pelanggan:</p>
                                    <p className="font-bold text-red-600 text-lg mb-1">{deleteConfirmModal.name}</p>
                                    {deleteConfirmModal.phone && <p className="text-slate-400 text-xs mb-4">{deleteConfirmModal.phone}</p>}
                                    <p className="text-xs text-slate-400 mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-2">Data pelanggan akan dihapus dari daftar. Riwayat transaksi tetap tersimpan.</p>
                                    <div className="flex gap-3 w-full">
                                        <button onClick={() => setDeleteConfirmModal(null)} className="flex-1 py-3 border border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Batal</button>
                                        <button onClick={executeDeleteCustomer} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"><Trash2 className="w-4 h-4" /> Hapus</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete All Confirmation Modal */}
                    {deleteAllModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[90]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-4 animate-pulse">
                                        <Trash2 className="w-10 h-10 text-red-600" />
                                    </div>
                                    <h3 className="font-bold text-xl text-slate-800 mb-2">‚ö†Ô∏è Hapus Semua Pelanggan?</h3>
                                    <p className="text-slate-600 text-sm mb-3">Anda akan menghapus <strong className="text-red-600">{(customerTab === 'service' ? mergedServiceCustomers : mergedSalesCustomers).filter(c => !c.deleted).length} pelanggan</strong> dari tampilan!</p>
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-3 mb-3 w-full">
                                        <p className="text-xs text-blue-700">
                                            <strong>Tab aktif:</strong> {customerTab === 'service' ? 'üì± Pelanggan Service' : 'üõí Pelanggan Penjualan'}
                                        </p>
                                    </div>
                                    <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6 w-full">
                                        <p className="text-red-700 font-bold text-sm mb-2">‚ö†Ô∏è PERINGATAN PENTING:</p>
                                        <ul className="text-left text-xs text-red-600 space-y-1">
                                            <li>‚Ä¢ Pelanggan di database akan dihapus permanen</li>
                                            <li>‚Ä¢ Pelanggan dari transaksi akan disembunyikan</li>
                                            <li>‚Ä¢ Riwayat transaksi tetap tersimpan</li>
                                            <li>‚Ä¢ Aksi ini tidak dapat dibatalkan</li>
                                        </ul>
                                    </div>
                                    <div className="flex gap-3 w-full">
                                        <button onClick={() => setDeleteAllModal(false)} className="flex-1 py-3 border-2 border-slate-300 rounded-xl font-bold text-slate-700 hover:bg-slate-50 transition-colors">
                                            Batal
                                        </button>
                                        <button onClick={executeDeleteAllCustomers} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors flex items-center justify-center gap-2 shadow-lg">
                                            <Trash2 className="w-4 h-4" /> Ya, Hapus Semua
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const StockManager = () => {
          const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
          const { data: inv } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
          const [tab, setTab] = useState('barang');
          const [form, setForm] = useState({name:'', category: '', subCategory: '', brand: '', supplier: '', stock:0, buyPrice:0, sellPrice:0, minStock: ''});
          const [adjustModal, setAdjustModal] = useState(null);
          const [adjustAmount, setAdjustAmount] = useState(0);
          const [adjustType, setAdjustType] = useState('add');
          const [newMinStock, setNewMinStock] = useState('');
          const [editModal, setEditModal] = useState(null);
          const [categoryModal, setCategoryModal] = useState(null);
          const [categoryFilter, setCategoryFilter] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [currentPage, setCurrentPage] = useState(1);
          const [itemsPerPage, setItemsPerPage] = useState(10);
          const [customCategories, setCustomCategories] = useState([]);
          const [subCategories, setSubCategories] = useState({});
          const [brands, setBrands] = useState([]);
          const [suppliers, setSuppliers] = useState([]);
          const [inventorySettings, setInventorySettings] = useState({});
          const [settingsModal, setSettingsModal] = useState(false);
          const [tempSettings, setTempSettings] = useState({});
          
          // State untuk Stock Opname
          const [opnameActive, setOpnameActive] = useState(false);
          const [opnameData, setOpnameData] = useState({});
          const [saving, setSaving] = useState(false);
          
          // Filter states untuk tab Opname, Adjustment, Alerts
          const [opnameCategoryFilter, setOpnameCategoryFilter] = useState('');
          const [opnameSubCategoryFilter, setOpnameSubCategoryFilter] = useState('');
          const [opnameSearch, setOpnameSearch] = useState('');
          const [adjustCategoryFilter, setAdjustCategoryFilter] = useState('');
          const [adjustSubCategoryFilter, setAdjustSubCategoryFilter] = useState('');
          const [adjustSearch, setAdjustSearch] = useState('');
          const [alertCategoryFilter, setAlertCategoryFilter] = useState('');
          const [alertSubCategoryFilter, setAlertSubCategoryFilter] = useState('');
          
          // Load custom categories and suppliers from Firestore real-time
          useEffect(() => {
              if (!activeOwner?.id) return;
              let q;
              if (activeStore?.id) {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                      where('ownerId', '==', activeOwner.id), 
                      where('storeId', '==', activeStore.id));
              } else {
                  q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                      where('ownerId', '==', activeOwner.id));
              }
              const unsubsc1 = onSnapshot(q, (snapshot) => {
                  const allCats = new Set();
                  const allSubCats = {};
                  let settings = {};
                  snapshot.docs.forEach(doc => {
                      const data = doc.data();
                      if (data.customCategories && Array.isArray(data.customCategories)) {
                          data.customCategories.forEach(cat => allCats.add(cat));
                      }
                      if (data.subCategories && typeof data.subCategories === 'object') {
                          Object.assign(allSubCats, data.subCategories);
                      }
                      if (data.inventorySettings) {
                          settings = data.inventorySettings;
                      }
                  });
                  setCustomCategories(Array.from(allCats));
                  setSubCategories(allSubCats);
                  setInventorySettings(settings);
                  setTempSettings(settings);
              });
              const suppQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), 
                  where('ownerId', '==', activeOwner.id));
              const unsubsc2 = onSnapshot(suppQ, (snapshot) => {
                  setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
              });
              const brandsQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), 
                  where('ownerId', '==', activeOwner.id));
              const unsubsc3 = onSnapshot(brandsQ, (snapshot) => {
                  setBrands(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
              });
              return () => { unsubsc1(); unsubsc2(); unsubsc3(); };
          }, [activeOwner?.id, activeStore?.id]);
          
          // Save stock settings
          const saveStockSettings = async () => {
              try {
                  let configRef;
                  const configsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs');
                  
                  if (activeStore?.id && activeStore.id !== 'all') {
                      const q = query(configsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                      const snapshot = await getDocs(q);
                      
                      if (!snapshot.empty) {
                          configRef = snapshot.docs[0].ref;
                      } else {
                          configRef = doc(configsRef);
                      }
                  } else {
                      const q = query(configsRef, where('ownerId', '==', activeOwner.id));
                      const snapshot = await getDocs(q);
                      
                      if (!snapshot.empty) {
                          configRef = snapshot.docs[0].ref;
                      } else {
                          configRef = doc(configsRef);
                      }
                  }
                  
                  await setDoc(configRef, {
                      ownerId: activeOwner.id,
                      storeId: activeStore?.id || 'all',
                      inventorySettings: {
                          ...inventorySettings,
                          ...tempSettings
                      }
                  }, { merge: true });
                  
                  setInventorySettings(prev => ({ ...prev, ...tempSettings }));
                  setSettingsModal(false);
                  alert('‚úÖ Pengaturan stok berhasil disimpan!');
              } catch (error) {
                  console.error('Error saving stock settings:', error);
                  alert('‚ùå Gagal menyimpan pengaturan: ' + error.message);
              }
          };
          
          // Get unique categories and brands from inventory
          const categories = [...new Set(inv.map(i => i.category).filter(c => c))];
          const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
          const allCategories = [...new Set([...categories, ...defaultCategories, ...customCategories])];
          
          // Search and filter
          const filteredInv = (categoryFilter ? inv.filter(i => i.category === categoryFilter) : inv)
              .filter(i => !searchTerm || i.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                  (i.brand && i.brand.toLowerCase().includes(searchTerm.toLowerCase())) ||
                  (i.supplier && i.supplier.toLowerCase().includes(searchTerm.toLowerCase())));
          
          const add = async (e) => { 
              e.preventDefault(); 
              try {
                  await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory'), {
                      ...form,
                      ownerId: activeOwner.id,
                      storeId: activeStore.id,
                      createdAt: serverTimestamp()
                  });
                  setForm({name:'', category: '', stock:0, buyPrice:0, sellPrice:0});
                  alert('‚úÖ Barang berhasil ditambahkan');
              } catch(err) {
                  alert("Gagal tambah stok: " + err.message);
              }
          };
          
          const canAddStock = checkPermission('feature_stock_add');
          
          // Low stock and out of stock items with per-item minStock support
          const stockThreshold = inventorySettings?.minStockThreshold || 5;
          const lowStockItems = inv.filter(i => {
              const actualStock = i.stock || 0;
              const minThreshold = i.minStock || stockThreshold;
              return actualStock <= minThreshold && actualStock > 0;
          });
          const outOfStockItems = inv.filter(i => (i.stock || 0) === 0);
          
          // Pagination logic
          const totalItems = filteredInv.length;
          const totalPages = Math.ceil(totalItems / itemsPerPage);
          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const paginatedInv = filteredInv.slice(startIndex, endIndex);
          
          // Calculate total assets
          const totalBuyValue = inv.reduce((sum, item) => sum + ((item.buyPrice || 0) * (item.stock || 0)), 0);
          const totalSellValue = inv.reduce((sum, item) => sum + ((item.sellPrice || 0) * (item.stock || 0)), 0);
          const potentialProfit = totalSellValue - totalBuyValue;
          
          const handlePageChange = (newPage) => {
              if (newPage >= 1 && newPage <= totalPages) {
                  setCurrentPage(newPage);
                  window.scrollTo({ top: 0, behavior: 'smooth' });
              }
          };
          
          const handleItemsPerPageChange = (value) => {
              setItemsPerPage(value);
              setCurrentPage(1);
          };

          const handleAdjust = async () => {
              try {
                  if (!adjustModal || adjustAmount === 0) {
                      alert('Masukkan jumlah penyesuaian!');
                      return;
                  }
                  const item = inv.find(i => i.id === adjustModal.id);
                  const adjustment = adjustType === 'add' ? adjustAmount : -adjustAmount;
                  const newStock = Math.max(0, (item.stock || 0) + adjustment);
                  
                  const updateData = { stock: newStock };
                  if (newMinStock && newMinStock !== '') {
                      updateData.minStock = Number(newMinStock);
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', adjustModal.id), updateData);
                  
                  setAdjustModal(null);
                  setAdjustAmount(0);
                  setNewMinStock('');
                  setAdjustType('add');
                  
                  const minStockText = updateData.minStock ? `, minimal stok: ${updateData.minStock}` : '';
                  alert(`‚úÖ Stok berhasil diperbarui dari ${item.stock || 0} menjadi ${newStock}${minStockText}`);
              } catch (err) {
                  alert("Gagal: " + err.message);
              }
          };
          
          // Fungsi untuk memulai Stock Opname
          const handleStartOpname = () => {
              setOpnameActive(true);
              // Initialize opname data dengan stok sistem saat ini
              const initialData = {};
              inv.forEach(item => {
                  initialData[item.id] = {
                      systemStock: item.stock || 0,
                      physicalStock: item.stock || 0, // Default sama dengan sistem
                      difference: 0
                  };
              });
              setOpnameData(initialData);
          };
          
          // Update stok fisik saat input
          const handleOpnameInput = (itemId, value) => {
              const physicalStock = parseInt(value) || 0;
              const systemStock = opnameData[itemId]?.systemStock || 0;
              setOpnameData(prev => ({
                  ...prev,
                  [itemId]: {
                      ...prev[itemId],
                      physicalStock: physicalStock,
                      difference: physicalStock - systemStock
                  }
              }));
          };
          
          // Simpan hasil opname
          const handleSaveOpname = async () => {
              if (!confirm('Yakin ingin menyimpan hasil stock opname ini? Stok sistem akan diupdate sesuai stok fisik yang diinput.')) {
                  return;
              }
              
              setSaving(true);
              try {
                  // Update stok untuk setiap item yang ada perbedaan
                  const updates = [];
                  const opnameHistory = {
                      ownerId: activeOwner.id,
                      storeId: activeStore.id,
                      items: [],
                      createdAt: serverTimestamp()
                  };
                  
                  for (const [itemId, data] of Object.entries(opnameData)) {
                      if (data.difference !== 0) {
                          const item = inv.find(i => i.id === itemId);
                          // Update stok di inventory
                          updates.push(
                              updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', itemId), {
                                  stock: data.physicalStock
                              })
                          );
                          
                          // Simpan detail untuk history
                          opnameHistory.items.push({
                              itemId: itemId,
                              itemName: item?.name || 'Unknown',
                              systemStock: data.systemStock,
                              physicalStock: data.physicalStock,
                              difference: data.difference
                          });
                      }
                  }
                  
                  // Execute all updates
                  await Promise.all(updates);
                  
                  // Simpan history opname
                  if (opnameHistory.items.length > 0) {
                      await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stock_opname_history'), opnameHistory);
                  }
                  
                  alert(`‚úÖ Stock opname berhasil disimpan!\n\n${opnameHistory.items.length} item diupdate.`);
                  setOpnameActive(false);
                  setOpnameData({});
              } catch (err) {
                  alert('Error: ' + err.message);
              } finally {
                  setSaving(false);
              }
          };
          
          const handleCancelOpname = () => {
              if (confirm('Batalkan stock opname? Data yang sudah diinput akan hilang.')) {
                  setOpnameActive(false);
                  setOpnameData({});
              }
          };
          
          const handleEditProduct = async (e) => {
              e.preventDefault();
              try {
                  const updateData = {
                      name: editModal.name,
                      category: editModal.category,
                      subCategory: editModal.subCategory || '',
                      brand: editModal.brand || '',
                      supplier: editModal.supplier || '',
                      buyPrice: parseFloat(editModal.buyPrice) || 0,
                      sellPrice: parseFloat(editModal.sellPrice) || 0,
                      updatedAt: serverTimestamp()
                  };
                  
                  if (editModal.minStock !== undefined && editModal.minStock !== '') {
                      updateData.minStock = Number(editModal.minStock);
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', editModal.id), updateData);
                  setEditModal(null);
                  alert('‚úÖ Produk berhasil diupdate');
              } catch (err) {
                  alert('Gagal update: ' + err.message);
              }
          };
          
          const deleteProduct = async (id, name) => {
              if (confirm(`Hapus produk "${name}"? Tindakan ini tidak dapat dibatalkan.`)) {
                  try {
                      await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', id));
                      alert('‚úÖ Produk berhasil dihapus');
                  } catch (err) {
                      alert('Gagal hapus: ' + err.message);
                  }
              }
          };

          // Reset page when search or filter changes
          useEffect(() => {
              setCurrentPage(1);
          }, [categoryFilter, searchTerm]);
          
          return (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                  <h2 className="font-bold text-2xl">Manajemen Stok</h2>
                  <button onClick={() => setCategoryModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-700 text-sm">
                      <Filter className="w-4 h-4" /> Kelola Kategori
                  </button>
              </div>

              {/* Total Aset Card */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex items-center gap-3 mb-2">
                          <div className="bg-white/20 p-2 rounded-lg">
                              <Package className="w-6 h-6" />
                          </div>
                          <div className="text-sm font-semibold opacity-90">Total Modal</div>
                      </div>
                      <div className="text-3xl font-bold">{formatCurrency(totalBuyValue)}</div>
                      <div className="text-xs opacity-75 mt-1">{inv.length} item stok</div>
                  </div>
                  <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex items-center gap-3 mb-2">
                          <div className="bg-white/20 p-2 rounded-lg">
                              <TrendingUp className="w-6 h-6" />
                          </div>
                          <div className="text-sm font-semibold opacity-90">Total Harga Jual</div>
                      </div>
                      <div className="text-3xl font-bold">{formatCurrency(totalSellValue)}</div>
                      <div className="text-xs opacity-75 mt-1">Nilai jual seluruh stok</div>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white">
                      <div className="flex items-center gap-3 mb-2">
                          <div className="bg-white/20 p-2 rounded-lg">
                              <DollarSign className="w-6 h-6" />
                          </div>
                          <div className="text-sm font-semibold opacity-90">Potensi Profit</div>
                      </div>
                      <div className="text-3xl font-bold">{formatCurrency(potentialProfit)}</div>
                      <div className="text-xs opacity-75 mt-1">{potentialProfit >= 0 ? '‚Üó' : '‚Üò'} {((potentialProfit / (totalBuyValue || 1)) * 100).toFixed(1)}% margin</div>
                  </div>
              </div>

              <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 w-full overflow-x-auto">
                  {[
                      { id: 'barang', label: 'Daftar Barang' },
                      { id: 'adjustment', label: 'Penyesuaian' },
                      { id: 'opname', label: 'Opname' },
                      { id: 'alerts', label: 'Peringatan Stok' }
                  ].map(t => (
                      <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>
                          {t.label}
                          {t.id === 'alerts' && (lowStockItems.length + outOfStockItems.length) > 0 && (
                              <span className="ml-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">
                                  {lowStockItems.length + outOfStockItems.length}
                              </span>
                          )}
                      </button>
                  ))}
              </div>

              {tab === 'barang' && (
                <>
                  {canAddStock ? (
                      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                          <h3 className="font-bold text-sm mb-4 text-slate-700">Tambah Barang Baru</h3>
                          <form onSubmit={(e) => {
                              e.preventDefault();
                              
                              // Check duplicate validation if enabled
                              if (inventorySettings?.preventDuplicateNames) {
                                  const duplicate = inv.find(item => 
                                      item.name.toLowerCase() === form.name.toLowerCase() &&
                                      item.category === form.category &&
                                      item.brand === form.brand
                                  );
                                  if (duplicate) {
                                      alert('‚ö†Ô∏è Produk dengan nama, kategori, dan brand yang sama sudah ada!\n\nUbah pengaturan di menu Pengaturan > Master Data > Pengaturan Stok jika ingin mengizinkan duplikat.');
                                      return;
                                  }
                              }
                              
                              addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory'), {
                                  ...form,
                                  ownerId: activeOwner.id,
                                  storeId: activeStore.id,
                                  createdAt: serverTimestamp()
                              }).then(() => {
                                  setForm({name:'', category: '', subCategory: '', brand: '', supplier: '', stock:0, buyPrice:0, sellPrice:0, minStock: ''});
                                  alert('‚úÖ Barang berhasil ditambahkan');
                              }).catch(err => {
                                  alert('Error: ' + err.message);
                              });
                          }} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                              <div className="md:col-span-3">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Barang</label>
                                  <input className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.name} onChange={e => setForm({...form, name:e.target.value})} required placeholder="Contoh: LCD Samsung A50"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kategori</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.category} onChange={e => setForm({...form, category:e.target.value, subCategory: ''})} required>
                                      <option value="">-- Pilih Kategori --</option>
                                      {allCategories.map(cat => (
                                          <option key={cat} value={cat}>{cat}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Sub-Kategori</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.subCategory} onChange={e => setForm({...form, subCategory:e.target.value})} disabled={!form.category}>
                                      <option value="">-- Pilih Sub (Opsional) --</option>
                                      {form.category && subCategories[form.category] && subCategories[form.category].map(sub => (
                                          <option key={sub} value={sub}>{sub}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Brand</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.brand} onChange={e => setForm({...form, brand:e.target.value})}>
                                      <option value="">-- Pilih Brand (Opsional) --</option>
                                      {brands.map(brand => (
                                          <option key={brand.id} value={brand.name}>{brand.name}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Supplier</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.supplier} onChange={e => setForm({...form, supplier:e.target.value})}>
                                      <option value="">-- Pilih Supplier (Opsional) --</option>
                                      {suppliers.map(sup => (
                                          <option key={sup.id} value={sup.name}>{sup.name}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-1">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Stok Awal</label>
                                  <NumberInput value={form.stock} onChange={(val) => setForm({...form, stock:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Modal</label>
                                  <NumberInput value={form.buyPrice} onChange={(val) => setForm({...form, buyPrice:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Jual</label>
                                  <NumberInput value={form.sellPrice} onChange={(val) => setForm({...form, sellPrice:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-1">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Min Stok</label>
                                  <NumberInput value={form.minStock} onChange={(val) => setForm({...form, minStock:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder={stockThreshold.toString()}/>
                              </div>
                              <div className="md:col-span-1">
                                  <button className="w-full bg-blue-600 text-white p-2.5 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center"><Plus className="w-5 h-5"/></button>
                              </div>
                          </form>
                      </div>
                  ) : (
                      <div onClick={() => showAccessDenied("Fitur TAMBAH STOK dikunci")} className="bg-red-50 text-red-600 p-4 rounded border border-red-200 flex items-center gap-2 cursor-pointer hover:bg-red-100">
                          <Lock className="w-4 h-4"/> Akses Tambah Stok dikunci.
                      </div>
                  )}
                  
                  <div className="bg-white p-4 rounded-xl border border-slate-200">
                      <div className="flex flex-col md:flex-row gap-3 md:items-end">
                          <div className="flex-1">
                              <label className="text-xs font-bold text-slate-500 uppercase block mb-1">üîç Cari Barang</label>
                              <input value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Cari nama, brand, atau supplier..." className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500"/>
                          </div>
                          <div className="flex-1">
                              <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Filter Kategori</label>
                              <select value={categoryFilter} onChange={e => setCategoryFilter(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm">
                                  <option value="">üìä Semua Kategori ({inv.length})</option>
                                  {allCategories.map(cat => (
                                      <option key={cat} value={cat}>
                                          {cat} ({inv.filter(i => i.category === cat).length})
                                      </option>
                                  ))}
                              </select>
                          </div>
                      </div>
                  </div>
                  
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                      <div className="overflow-x-auto">
                          <table className="w-full text-sm text-left">
                              <thead className="bg-slate-50 border-b text-slate-500 font-bold uppercase text-xs">
                                  <tr>
                                      <th className="p-4 w-10 text-center">No</th>
                                      <th className="p-4">Barang</th>
                                      <th className="p-4 text-center hidden md:table-cell">Brand</th>
                                      <th className="p-4 text-center hidden lg:table-cell">Supplier</th>
                                      <th className="p-4 text-center">Stok</th>
                                      <th className="p-4 text-center hidden md:table-cell">Min Stok</th>
                                      <th className="p-4 text-right hidden sm:table-cell">Harga Modal</th>
                                      <th className="p-4 text-right">Harga Jual</th>
                                      <th className="p-4 text-right hidden lg:table-cell">Margin</th>
                                      <th className="p-4 text-center">Aksi</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-slate-100">
                                  {paginatedInv.map((i, idx) => {
                                      const margin = i.buyPrice > 0 ? ((i.sellPrice - i.buyPrice) / i.buyPrice * 100).toFixed(0) : '‚Äî';
                                      const marginColor = margin !== '‚Äî' && margin >= 30 ? 'text-green-600' : margin !== '‚Äî' && margin >= 15 ? 'text-yellow-600' : 'text-red-600';
                                      return (
                                      <tr key={i.id} className="hover:bg-slate-50 transition-colors">
                                          <td className="p-4 text-center text-slate-400 font-bold">{startIndex + idx + 1}</td>
                                          <td className="p-4">
                                              <div className="font-bold text-slate-800">{i.name}</div>
                                              {i.category && (
                                                  <div className="mt-1 flex gap-1 flex-wrap">
                                                      <span className="inline-block bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded">
                                                          üì¶ {i.category}
                                                      </span>
                                                      {i.subCategory && (
                                                          <span className="inline-block bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">
                                                              ‚Üí {i.subCategory}
                                                          </span>
                                                      )}
                                                  </div>
                                              )}
                                          </td>
                                          <td className="p-4 text-center text-sm font-medium text-slate-700 hidden md:table-cell">{i.brand || '‚Äî'}</td>
                                          <td className="p-4 text-center text-sm font-medium text-slate-700 hidden lg:table-cell">{i.supplier || '‚Äî'}</td>
                                          <td className="p-4 text-center font-bold rounded-lg bg-blue-50 text-blue-600">{i.stock || 0}</td>
                                          <td className="p-4 text-center hidden md:table-cell">
                                              <div className="flex items-center justify-center">
                                                  <span className={`font-bold px-2 py-1 rounded text-xs ${(i.stock || 0) <= (i.minStock || stockThreshold) ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                      {i.minStock || stockThreshold}
                                                  </span>
                                              </div>
                                          </td>
                                          <td className="p-4 text-right font-medium text-slate-600 hidden sm:table-cell">{formatCurrency(i.buyPrice || 0)}</td>
                                          <td className="p-4 text-right font-medium text-slate-600">{formatCurrency(i.sellPrice)}</td>
                                          <td className={`p-4 text-right font-bold hidden lg:table-cell ${marginColor}`}>{margin}%</td>
                                          <td className="p-4 text-center">
                                              <div className="flex items-center justify-center gap-2">
                                                  <button onClick={() => setEditModal(i)} className="text-blue-500 hover:bg-blue-50 p-2 rounded" title="Edit Produk"><Pencil className="w-4 h-4" /></button>
                                                  <button onClick={() => { setAdjustModal(i); setAdjustAmount(0); setAdjustType('add'); }} className="text-orange-500 hover:bg-orange-50 p-2 rounded" title="Sesuaikan Stok"><PenTool className="w-4 h-4" /></button>
                                                  <button onClick={() => deleteProduct(i.id, i.name)} className="text-red-500 hover:bg-red-50 p-2 rounded" title="Hapus Produk"><Trash2 className="w-4 h-4" /></button>
                                              </div>
                                          </td>
                                      </tr>
                                      );
                                  })}
                              </tbody>
                          </table>
                          {paginatedInv.length === 0 && (
                              <div className="p-6 text-center text-slate-500">
                                  üì¶ Tidak ada barang{categoryFilter ? ` dalam kategori "${categoryFilter}"` : ''}
                              </div>
                          )}
                      </div>
                  </div>
                  
                  {/* Pagination Controls */}
                  <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                      <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                          <div className="flex gap-2">
                              <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                              <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                          </div>
                      </div>
                      <div className="text-sm text-slate-600 font-medium">
                          Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                      </div>
                  </div>
                  
                  {/* Pagination Navigation */}
                  {totalPages > 1 && (
                      <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <button 
                              onClick={() => handlePageChange(currentPage - 1)} 
                              disabled={currentPage === 1}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              ‚Üê Sebelumnya
                          </button>
                          <div className="text-sm text-slate-600 font-medium">
                              Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                          </div>
                          <button 
                              onClick={() => handlePageChange(currentPage + 1)} 
                              disabled={currentPage === totalPages}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              Selanjutnya ‚Üí
                          </button>
                      </div>
                  )}
                </>
              )}

              {tab === 'adjustment' && (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b bg-slate-50">
                        <h3 className="font-bold text-slate-800 mb-2">Penyesuaian Stok</h3>
                        <p className="text-sm text-slate-600">Sesuaikan stok untuk koreksi atau pindah lokasi.</p>
                    </div>
                    {/* Filter Kategori & Sub-Kategori */}
                    <div className="p-4 bg-blue-50 border-b border-blue-100">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üîç Cari Barang</label>
                                <input value={adjustSearch} onChange={e => setAdjustSearch(e.target.value)} placeholder="Cari nama barang..." className="w-full border border-blue-200 p-2.5 rounded-lg text-sm focus:outline-blue-500 bg-white" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Kategori</label>
                                <select value={adjustCategoryFilter} onChange={e => { setAdjustCategoryFilter(e.target.value); setAdjustSubCategoryFilter(''); }} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white">
                                    <option value="">Semua Kategori</option>
                                    {allCategories.map(cat => <option key={cat} value={cat}>{cat} ({inv.filter(i => i.category === cat).length})</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÅ Sub-Kategori</label>
                                <select value={adjustSubCategoryFilter} onChange={e => setAdjustSubCategoryFilter(e.target.value)} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white" disabled={!adjustCategoryFilter}>
                                    <option value="">Semua Sub-Kategori</option>
                                    {adjustCategoryFilter && subCategories[adjustCategoryFilter] && subCategories[adjustCategoryFilter].map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div className="divide-y max-h-96 overflow-y-auto">
                        {inv.filter(i => {
                            const matchCategory = !adjustCategoryFilter || i.category === adjustCategoryFilter;
                            const matchSubCategory = !adjustSubCategoryFilter || i.subCategory === adjustSubCategoryFilter;
                            const matchSearch = !adjustSearch || i.name.toLowerCase().includes(adjustSearch.toLowerCase());
                            return matchCategory && matchSubCategory && matchSearch;
                        }).map(i => (
                            <div key={i.id} className="p-4 flex justify-between items-center hover:bg-slate-50">
                                <div>
                                    <p className="font-bold text-slate-800">{i.name}</p>
                                    <div className="flex gap-1 mt-1 flex-wrap">
                                        {i.category && <span className="inline-block bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded">üì¶ {i.category}</span>}
                                        {i.subCategory && <span className="inline-block bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">‚Üí {i.subCategory}</span>}
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">Stok saat ini: {i.stock}</p>
                                </div>
                                <button onClick={() => setAdjustModal(i)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Sesuaikan</button>
                            </div>
                        ))}
                        {inv.filter(i => {
                            const matchCategory = !adjustCategoryFilter || i.category === adjustCategoryFilter;
                            const matchSubCategory = !adjustSubCategoryFilter || i.subCategory === adjustSubCategoryFilter;
                            const matchSearch = !adjustSearch || i.name.toLowerCase().includes(adjustSearch.toLowerCase());
                            return matchCategory && matchSubCategory && matchSearch;
                        }).length === 0 && (
                            <div className="p-6 text-center text-slate-500">üì¶ Tidak ada barang ditemukan</div>
                        )}
                    </div>
                </div>
              )}

              {tab === 'opname' && (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                        <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
                            <Upload className="w-6 h-6" /> Stock Opname
                        </h3>
                        <p className="text-sm text-blue-700">Periksa dan verifikasi seluruh stok fisik dengan hitungan aktual di gudang</p>
                    </div>
                    
                    {/* Filter Kategori & Sub-Kategori untuk Opname */}
                    {opnameActive && (
                        <div className="p-4 bg-blue-50 border-b border-blue-100">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">üîç Cari Barang</label>
                                    <input value={opnameSearch} onChange={e => setOpnameSearch(e.target.value)} placeholder="Cari nama barang..." className="w-full border border-blue-200 p-2.5 rounded-lg text-sm focus:outline-blue-500 bg-white" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Kategori</label>
                                    <select value={opnameCategoryFilter} onChange={e => { setOpnameCategoryFilter(e.target.value); setOpnameSubCategoryFilter(''); }} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white">
                                        <option value="">Semua Kategori</option>
                                        {allCategories.map(cat => <option key={cat} value={cat}>{cat} ({inv.filter(i => i.category === cat).length})</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-blue-600 mb-1 block">üìÅ Sub-Kategori</label>
                                    <select value={opnameSubCategoryFilter} onChange={e => setOpnameSubCategoryFilter(e.target.value)} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white" disabled={!opnameCategoryFilter}>
                                        <option value="">Semua Sub-Kategori</option>
                                        {opnameCategoryFilter && subCategories[opnameCategoryFilter] && subCategories[opnameCategoryFilter].map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {!opnameActive ? (
                        <div className="p-8 text-center">
                            <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Upload className="w-10 h-10 text-blue-600" />
                            </div>
                            <h4 className="font-bold text-lg text-slate-800 mb-2">Belum Ada Opname Aktif</h4>
                            <p className="text-sm text-slate-600 mb-6 max-w-md mx-auto">
                                Mulai stock opname untuk menghitung dan membandingkan stok fisik dengan stok sistem. 
                                Semua perbedaan akan tercatat otomatis.
                            </p>
                            <button 
                                onClick={handleStartOpname}
                                className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:from-blue-700 hover:to-purple-700 flex items-center justify-center gap-2 mx-auto shadow-lg"
                            >
                                <Upload className="w-5 h-5" /> Mulai Stock Opname
                            </button>
                        </div>
                    ) : (
                        <div>
                            <div className="p-4 bg-yellow-50 border-b border-yellow-200 flex items-center justify-between">
                                <div className="flex items-center gap-2 text-yellow-800">
                                    <AlertTriangle className="w-5 h-5" />
                                    <span className="font-bold text-sm">Stock Opname Sedang Berlangsung</span>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleCancelOpname}
                                        disabled={saving}
                                        className="px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-100 disabled:opacity-50"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={handleSaveOpname}
                                        disabled={saving}
                                        className="px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2 disabled:opacity-50"
                                    >
                                        {saving ? (
                                            <>
                                                <Loader2 className="w-4 h-4 animate-spin" /> Menyimpan...
                                            </>
                                        ) : (
                                            <>
                                                <Save className="w-4 h-4" /> Simpan Opname
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-100 border-b-2 border-slate-200">
                                        <tr>
                                            <th className="p-3 text-left font-bold text-slate-700">No</th>
                                            <th className="p-3 text-left font-bold text-slate-700">Nama Barang</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Kategori</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Sub-Kategori</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Stok Sistem</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Stok Fisik</th>
                                            <th className="p-3 text-center font-bold text-slate-700">Selisih</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {inv.filter(item => {
                                            const matchCategory = !opnameCategoryFilter || item.category === opnameCategoryFilter;
                                            const matchSubCategory = !opnameSubCategoryFilter || item.subCategory === opnameSubCategoryFilter;
                                            const matchSearch = !opnameSearch || item.name.toLowerCase().includes(opnameSearch.toLowerCase());
                                            return matchCategory && matchSubCategory && matchSearch;
                                        }).map((item, idx) => {
                                            const data = opnameData[item.id] || { systemStock: item.stock || 0, physicalStock: item.stock || 0, difference: 0 };
                                            const diffColor = data.difference > 0 ? 'text-green-600 bg-green-50' : data.difference < 0 ? 'text-red-600 bg-red-50' : 'text-slate-600 bg-slate-50';
                                            
                                            return (
                                                <tr key={item.id} className="hover:bg-slate-50">
                                                    <td className="p-3 text-slate-500 font-medium">{idx + 1}</td>
                                                    <td className="p-3 font-bold text-slate-800">{item.name}</td>
                                                    <td className="p-3 text-center">
                                                        <span className="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">
                                                            {item.category || '‚Äî'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        {item.subCategory ? (
                                                            <span className="inline-block bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded">
                                                                {item.subCategory}
                                                            </span>
                                                        ) : (
                                                            <span className="text-slate-400 text-xs">‚Äî</span>
                                                        )}
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <span className="inline-block bg-slate-100 text-slate-700 font-bold px-3 py-1 rounded">
                                                            {data.systemStock}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <input 
                                                            type="number"
                                                            min="0"
                                                            value={data.physicalStock}
                                                            onChange={(e) => handleOpnameInput(item.id, e.target.value)}
                                                            className="w-24 px-3 py-2 border border-slate-300 rounded-lg text-center font-bold focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        />
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <span className={`inline-block font-bold px-3 py-1 rounded ${diffColor}`}>
                                                            {data.difference > 0 ? '+' : ''}{data.difference}
                                                        </span>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                                
                                {inv.length === 0 && (
                                    <div className="p-8 text-center text-slate-500">
                                        üì¶ Tidak ada barang untuk di-opname
                                    </div>
                                )}
                            </div>
                            
                            {/* Summary */}
                            <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <div className="flex flex-wrap gap-4 justify-center text-sm">
                                    <div className="bg-white px-4 py-2 rounded-lg border border-slate-200">
                                        <span className="text-slate-600">Total Item: </span>
                                        <span className="font-bold text-slate-800">{inv.length}</span>
                                    </div>
                                    <div className="bg-white px-4 py-2 rounded-lg border border-slate-200">
                                        <span className="text-slate-600">Item Berubah: </span>
                                        <span className="font-bold text-blue-600">
                                            {Object.values(opnameData).filter(d => d.difference !== 0).length}
                                        </span>
                                    </div>
                                    <div className="bg-green-50 px-4 py-2 rounded-lg border border-green-200">
                                        <span className="text-green-700">Surplus: </span>
                                        <span className="font-bold text-green-600">
                                            {Object.values(opnameData).filter(d => d.difference > 0).length}
                                        </span>
                                    </div>
                                    <div className="bg-red-50 px-4 py-2 rounded-lg border border-red-200">
                                        <span className="text-red-700">Kekurangan: </span>
                                        <span className="font-bold text-red-600">
                                            {Object.values(opnameData).filter(d => d.difference < 0).length}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
              )}

              {tab === 'alerts' && (
                <div className="space-y-4">
                    {/* Settings Header */}
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200">
                        <div>
                            <h3 className="font-bold text-slate-800">Pengaturan Peringatan Stok</h3>
                            <p className="text-sm text-slate-500">Threshold saat ini: <span className="font-bold text-blue-600">{stockThreshold} unit</span></p>
                        </div>
                        <button 
                            onClick={() => {
                                setTempSettings({ minStockThreshold: stockThreshold });
                                setSettingsModal(true);
                            }} 
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2"
                        >
                            <Settings className="w-4 h-4" /> Settings
                        </button>
                    </div>
                    
                    {/* Filter Kategori & Sub-Kategori */}
                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Filter Kategori</label>
                                <select value={alertCategoryFilter} onChange={e => { setAlertCategoryFilter(e.target.value); setAlertSubCategoryFilter(''); }} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white">
                                    <option value="">Semua Kategori</option>
                                    {allCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-blue-600 mb-1 block">üìÅ Sub-Kategori</label>
                                <select value={alertSubCategoryFilter} onChange={e => setAlertSubCategoryFilter(e.target.value)} className="w-full border border-blue-200 p-2.5 rounded-lg text-sm bg-white" disabled={!alertCategoryFilter}>
                                    <option value="">Semua Sub-Kategori</option>
                                    {alertCategoryFilter && subCategories[alertCategoryFilter] && subCategories[alertCategoryFilter].map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                        <h3 className="font-bold text-red-900 mb-3 flex items-center gap-2"><AlertTriangle className="w-5 h-5" /> ‚õî Stok KOSONG</h3>
                        {outOfStockItems.filter(item => {
                            const matchCategory = !alertCategoryFilter || item.category === alertCategoryFilter;
                            const matchSubCategory = !alertSubCategoryFilter || item.subCategory === alertSubCategoryFilter;
                            return matchCategory && matchSubCategory;
                        }).length === 0 ? (
                            <p className="text-red-700 text-sm">‚úì Tidak ada barang yang kosong{alertCategoryFilter ? ` di kategori "${alertCategoryFilter}"` : ''}</p>
                        ) : (
                            <div className="space-y-2">
                                {outOfStockItems.filter(item => {
                                    const matchCategory = !alertCategoryFilter || item.category === alertCategoryFilter;
                                    const matchSubCategory = !alertSubCategoryFilter || item.subCategory === alertSubCategoryFilter;
                                    return matchCategory && matchSubCategory;
                                }).map(item => (
                                    <div key={item.id} className="bg-white p-3 rounded-lg border border-red-200 flex justify-between items-center">
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800">{item.name}</p>
                                            <div className="flex gap-2 mt-1 text-xs flex-wrap">
                                                <span className="bg-red-100 text-red-700 px-2 py-1 rounded font-bold">Stok: 0</span>
                                                {item.category && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold">üì¶ {item.category}</span>}
                                                {item.subCategory && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">‚Üí {item.subCategory}</span>}
                                                {item.supplier && <span className="bg-slate-100 text-slate-700 px-2 py-1 rounded">{item.supplier}</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => { setAdjustModal(item); setAdjustAmount(0); setAdjustType('add'); }} className="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-blue-700">‚ûï Tambah</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <h3 className="font-bold text-yellow-900 mb-3 flex items-center gap-2"><AlertTriangle className="w-5 h-5" /> ‚ö†Ô∏è Stok Rendah (‚â§{stockThreshold} unit)</h3>
                        {lowStockItems.filter(i => {
                            const matchCategory = !alertCategoryFilter || i.category === alertCategoryFilter;
                            const matchSubCategory = !alertSubCategoryFilter || i.subCategory === alertSubCategoryFilter;
                            return i.stock > 0 && matchCategory && matchSubCategory;
                        }).length === 0 ? (
                            <p className="text-yellow-700 text-sm">‚úì Tidak ada barang stok rendah{alertCategoryFilter ? ` di kategori "${alertCategoryFilter}"` : ''}</p>
                        ) : (
                            <div className="space-y-2">
                                {lowStockItems.filter(i => {
                                    const matchCategory = !alertCategoryFilter || i.category === alertCategoryFilter;
                                    const matchSubCategory = !alertSubCategoryFilter || i.subCategory === alertSubCategoryFilter;
                                    return matchCategory && matchSubCategory;
                                }).map(item => (
                                    <div key={item.id} className="bg-white p-3 rounded-lg border border-yellow-200 flex justify-between items-center">
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800">{item.name}</p>
                                            <div className="flex gap-2 mt-1 text-xs flex-wrap">
                                                <span className={`px-2 py-1 rounded font-bold ${item.stock <= Math.floor(stockThreshold / 2) ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                    Stok: {item.stock} unit {item.stock <= Math.floor(stockThreshold / 2) ? '(SANGAT RENDAH!)' : ''}
                                                </span>
                                                {item.category && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold">üì¶ {item.category}</span>}
                                                {item.subCategory && <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">‚Üí {item.subCategory}</span>}
                                                {item.supplier && <span className="bg-slate-100 text-slate-700 px-2 py-1 rounded">{item.supplier}</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => { setAdjustModal(item); setAdjustAmount(0); setAdjustType('add'); }} className="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700">‚ûï Tambah</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
              )}

              {adjustModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                        <h3 className="font-bold text-xl text-slate-800 mb-2 flex items-center gap-2">
                            <PenTool className="w-5 h-5 text-orange-600" />
                            {adjustModal.name}
                        </h3>
                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-4">
                            <p className="text-sm text-slate-600">Stok Saat Ini:</p>
                            <p className="text-2xl font-bold text-blue-600">{adjustModal.stock || 0} unit</p>
                            <p className="text-xs text-slate-500 mt-1">Min Stok: <span className="font-bold">{adjustModal.minStock || stockThreshold} unit</span></p>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Jenis Penyesuaian</label>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setAdjustType('add')}
                                        className={`flex-1 py-2.5 rounded-lg font-bold transition-all ${adjustType === 'add' ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        ‚ûï Tambah Stok
                                    </button>
                                    <button 
                                        onClick={() => setAdjustType('reduce')}
                                        className={`flex-1 py-2.5 rounded-lg font-bold transition-all ${adjustType === 'reduce' ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        ‚ûñ Kurangi Stok
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Jumlah ({adjustType === 'add' ? 'Tambahan' : 'Pengurangan'})</label>
                                <NumberInput value={adjustAmount} onChange={setAdjustAmount} placeholder="Masukkan jumlah" className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" min="0" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Minimal Stok Baru (Opsional)</label>
                                <NumberInput value={newMinStock} onChange={setNewMinStock} placeholder={`Default: ${adjustModal.minStock || stockThreshold}`} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" min="1" />
                                <p className="text-[10px] text-slate-500 mt-1">Kosongkan untuk tidak mengubah. Default: {adjustModal.minStock || stockThreshold} unit</p>
                            </div>
                            <div className="bg-slate-50 p-3 rounded-lg">
                                <p className="text-xs text-slate-600 mb-1">Stok Baru:</p>
                                <p className="text-lg font-bold text-slate-800">
                                    {adjustType === 'add' ? (adjustModal.stock || 0) + adjustAmount : Math.max(0, (adjustModal.stock || 0) - adjustAmount)} unit
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setAdjustModal(null)} className="flex-1 border border-slate-300 py-2.5 rounded-lg font-bold text-slate-600 hover:bg-slate-50">Batal</button>
                                <button onClick={handleAdjust} className="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700">Simpan</button>
                            </div>
                        </div>
                    </div>
                </div>
              )}
              
              {editModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">Edit Produk</h3>
                            <button onClick={() => setEditModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <form onSubmit={handleEditProduct} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-2">Nama Produk *</label>
                                <input className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500" value={editModal.name} onChange={e => setEditModal({...editModal, name: e.target.value})} required />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Kategori *</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.category || ''} onChange={e => setEditModal({...editModal, category: e.target.value, subCategory: ''})} required>
                                        <option value="">-- Pilih Kategori --</option>
                                        {allCategories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Sub-Kategori</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.subCategory || ''} onChange={e => setEditModal({...editModal, subCategory: e.target.value})} disabled={!editModal.category}>
                                        <option value="">-- Pilih Sub (Opsional) --</option>
                                        {editModal.category && subCategories[editModal.category] && subCategories[editModal.category].map(sub => (
                                            <option key={sub} value={sub}>{sub}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Brand</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.brand || ''} onChange={e => setEditModal({...editModal, brand: e.target.value})}>
                                        <option value="">-- Pilih Brand (Opsional) --</option>
                                        {brands.map(brand => (
                                            <option key={brand.id} value={brand.name}>{brand.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Supplier</label>
                                    <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.supplier || ''} onChange={e => setEditModal({...editModal, supplier: e.target.value})}>
                                        <option value="">-- Pilih Supplier (Opsional) --</option>
                                        {suppliers.map(sup => (
                                            <option key={sup.id} value={sup.name}>{sup.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Harga Modal *</label>
                                    <NumberInput value={editModal.buyPrice} onChange={(val) => setEditModal({...editModal, buyPrice: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Harga Jual *</label>
                                    <NumberInput value={editModal.sellPrice} onChange={(val) => setEditModal({...editModal, sellPrice: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-2">Minimal Stok</label>
                                <NumberInput value={editModal.minStock || ''} onChange={(val) => setEditModal({...editModal, minStock: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder={stockThreshold.toString()}/>
                                <p className="text-xs text-slate-500 mt-1">Kosongkan untuk menggunakan default ({stockThreshold} unit)</p>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                <p className="text-xs text-slate-600 mb-1">Margin Keuntungan:</p>
                                <p className="text-lg font-bold text-blue-600">{editModal.buyPrice > 0 ? ((editModal.sellPrice - editModal.buyPrice) / editModal.buyPrice * 100).toFixed(1) : '0'}%</p>
                            </div>
                            <div className="flex gap-2 pt-2">
                                <button type="button" onClick={() => setEditModal(null)} className="flex-1 border py-3 rounded-lg font-bold hover:bg-slate-50">Batal</button>
                                <button type="submit" className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">üíæ Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
              )}
              
              {categoryModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">Kelola Kategori</h3>
                            <button onClick={() => setCategoryModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="space-y-3 max-h-96 overflow-y-auto">
                            {allCategories.map(cat => (
                                <div key={cat} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <p className="font-bold text-slate-700">{cat}</p>
                                        <p className="text-xs text-slate-500">{inv.filter(i => i.category === cat).length} produk</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => setCategoryModal(null)} className="w-full mt-4 py-3 border rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                    </div>
                </div>
              )}
              
              {/* Stock Settings Modal */}
              {settingsModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">‚öôÔ∏è Pengaturan Stok</h3>
                            <button onClick={() => setSettingsModal(false)} className="p-1 hover:bg-gray-100 rounded-full">
                                <X className="w-5 h-5 text-slate-400"/>
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <h4 className="font-bold text-blue-800 mb-2">üìä Info Stok Saat Ini</h4>
                                <div className="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <p className="text-slate-600">Total Barang:</p>
                                        <p className="font-bold text-blue-600">{inv.length} item</p>
                                    </div>
                                    <div>
                                        <p className="text-slate-600">Stok Kosong:</p>
                                        <p className="font-bold text-red-600">{outOfStockItems.length} item</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label className="text-sm font-bold text-slate-700 block mb-2">
                                    üö® Batas Minimum Stok Peringatan
                                </label>
                                <div className="relative flex items-center gap-3">
                                    <NumberInput 
                                        value={tempSettings.minStockThreshold || stockThreshold} 
                                        onChange={(val) => setTempSettings(prev => ({ ...prev, minStockThreshold: val }))}
                                        placeholder="Minimal stok" 
                                        className="flex-1 border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" 
                                        min="1" 
                                        max="1000"
                                    />
                                    <span className="text-slate-500 font-medium">unit</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">
                                    Stok di bawah atau sama dengan angka ini akan muncul peringatan
                                </p>
                            </div>
                            
                            <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                                <h5 className="font-bold text-yellow-800 text-sm mb-1">Preview Peringatan:</h5>
                                <p className="text-xs text-yellow-700">
                                    Dengan threshold <span className="font-bold">{tempSettings.minStockThreshold || stockThreshold} unit</span>, 
                                    akan ada <span className="font-bold">{inv.filter(i => (i.stock || 0) <= (tempSettings.minStockThreshold || stockThreshold) && (i.stock || 0) > 0).length} item</span> yang muncul peringatan stok rendah.
                                </p>
                            </div>
                        </div>
                        
                        <div className="flex gap-3 mt-6">
                            <button 
                                onClick={() => setSettingsModal(false)} 
                                className="flex-1 border border-slate-300 py-2.5 rounded-lg font-bold text-slate-600 hover:bg-slate-50"
                            >
                                Batal
                            </button>
                            <button 
                                onClick={saveStockSettings}
                                className="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700"
                            >
                                üíæ Simpan
                            </button>
                        </div>
                    </div>
                </div>
              )}
            </div>
          );
        };

        const PaymentModal = ({ service, close, pay }) => {
           const { activeOwner, activeStore } = useContext(SessionContext);
           const sisa = (service.costEstimate || 0) - (service.dp || 0);
           const [paymentType, setPaymentType] = useState('full'); // 'full', 'partial', 'credit'
           const [amount, setAmount] = useState(sisa);
           const [method, setMethod] = useState('Cash');
           const [cashAccount, setCashAccount] = useState('Kas Tunai');
           const [saving, setSaving] = useState(false);
           
           const handlePayment = async () => {
               setSaving(true);
               try {
                   if (paymentType === 'credit') {
                       // Create receivable (piutang) and close service
                       await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                           ownerId: activeOwner.id,
                           storeId: activeStore.id,
                           serviceId: service.id,
                           type: 'receivable',
                           customerName: service.customerName,
                           amount: sisa,
                           paid: 0,
                           remaining: sisa,
                           description: `Service ${service.unitType || 'HP'} - ${service.complaint || ''}`,
                           dueDate: null,
                           status: 'unpaid',
                           createdAt: serverTimestamp()
                       });
                       
                       // Update service to show it's now a receivable
                       await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id), { 
                           paymentStatus: 'Piutang',
                           updatedAt: serverTimestamp()
                       });
                       
                       alert(`‚úÖ Piutang ${formatCurrency(sisa)} berhasil dicatat untuk ${service.customerName}\n\nüí∞ Pelanggan dapat membayar nanti melalui menu Piutang`);
                       close();
                   } else {
                       // Normal payment flow
                       await pay(service, amount, method, cashAccount);
                   }
               } catch (err) {
                   alert('Error: ' + err.message);
               } finally {
                   setSaving(false);
               }
           };
           
           return (
             <div className="fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
                   <div className="flex justify-between items-center mb-4 border-b pb-3">
                       <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                           <DollarSign className="w-6 h-6 text-green-600" />
                           Pembayaran Service
                       </h3>
                       <button onClick={close} className="p-1 hover:bg-gray-100 rounded-full">
                           <X className="w-5 h-5 text-slate-400" />
                       </button>
                   </div>
                   
                   <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl mb-4 border border-blue-100">
                      <p className="text-sm text-slate-600 mb-1">Pelanggan: <span className="font-bold text-slate-800">{service.customerName}</span></p>
                      <p className="text-sm text-slate-600 mb-1">Unit: <span className="font-bold text-slate-800">{service.unitType}</span></p>
                      <div className="flex justify-between items-center mt-3 pt-3 border-t border-blue-200">
                          <span className="text-sm text-slate-600">Sisa Tagihan:</span>
                          <span className="font-bold text-2xl text-red-600">{formatCurrency(sisa)}</span>
                      </div>
                   </div>
                   
                   <div className="space-y-4">
                       <div>
                           <label className="text-xs font-bold text-slate-600 uppercase mb-2 block">Pilih Jenis Pembayaran</label>
                           <div className="grid grid-cols-3 gap-2">
                               <button
                                   onClick={() => {
                                       setPaymentType('full');
                                       setAmount(sisa);
                                   }}
                                   className={`p-3 rounded-lg border-2 transition-all text-center ${
                                       paymentType === 'full'
                                           ? 'border-green-500 bg-green-50 shadow-lg'
                                           : 'border-slate-200 hover:border-green-300'
                                   }`}
                               >
                                   <CheckCircle className={`w-6 h-6 mx-auto mb-1 ${paymentType === 'full' ? 'text-green-600' : 'text-slate-400'}`} />
                                   <p className="text-xs font-bold text-slate-700">Lunas</p>
                                   <p className="text-[10px] text-slate-500">Bayar Semua</p>
                               </button>
                               
                               <button
                                   onClick={() => {
                                       setPaymentType('partial');
                                       setAmount(0);
                                   }}
                                   className={`p-3 rounded-lg border-2 transition-all text-center ${
                                       paymentType === 'partial'
                                           ? 'border-orange-500 bg-orange-50 shadow-lg'
                                           : 'border-slate-200 hover:border-orange-300'
                                   }`}
                               >
                                   <div className={`w-6 h-6 mx-auto mb-1 rounded-full border-2 flex items-center justify-center ${
                                       paymentType === 'partial' ? 'border-orange-600 text-orange-600' : 'border-slate-400 text-slate-400'
                                   }`}>
                                       <span className="text-xs font-bold">%</span>
                                   </div>
                                   <p className="text-xs font-bold text-slate-700">Sebagian</p>
                                   <p className="text-[10px] text-slate-500">Bayar DP</p>
                               </button>
                               
                               <button
                                   onClick={() => {
                                       setPaymentType('credit');
                                       setAmount(0);
                                   }}
                                   className={`p-3 rounded-lg border-2 transition-all text-center ${
                                       paymentType === 'credit'
                                           ? 'border-blue-500 bg-blue-50 shadow-lg'
                                           : 'border-slate-200 hover:border-blue-300'
                                   }`}
                               >
                                   <div className={`w-6 h-6 mx-auto mb-1 text-2xl leading-6 ${paymentType === 'credit' ? 'text-blue-600' : 'text-slate-400'}`}>
                                       ‚è∞
                                   </div>
                                   <p className="text-xs font-bold text-slate-700">Piutang</p>
                                   <p className="text-[10px] text-slate-500">Bayar Nanti</p>
                               </button>
                           </div>
                       </div>
                       
                       {paymentType !== 'credit' && (
                           <>
                               <div>
                                   <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">
                                       Jumlah Bayar {paymentType === 'partial' && '(Minimal DP)'}
                                   </label>
                                   <NumberInput 
                                       className="w-full border-2 p-3 rounded-lg font-bold text-xl text-slate-800 focus:border-green-500 focus:outline-none" 
                                       value={amount} 
                                       onChange={val=>setAmount(val)}
                                       placeholder="0"
                                   />
                                   {paymentType === 'full' && amount !== sisa && (
                                       <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Jumlah tidak sesuai untuk pelunasan</p>
                                   )}
                               </div>
                               
                               <div>
                                   <label className="text-xs font-bold text-slate-600 uppercase mb-1 block">Metode Pembayaran</label>
                                   <select className="w-full border-2 p-3 rounded-lg bg-white focus:border-blue-500 focus:outline-none" value={method} onChange={e=>setMethod(e.target.value)}>
                                       <option>Cash</option>
                                       <option>Transfer</option>
                                       <option>Debit Card</option>
                                       <option>Credit Card</option>
                                       <option>E-Wallet</option>
                                   </select>
                               </div>
                               <CashAccountSelect value={cashAccount} onChange={setCashAccount} label="Masuk ke Kas" />
                           </>
                       )}
                       
                       {paymentType === 'credit' && (
                           <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg">
                               <h4 className="font-bold text-sm text-blue-900 mb-2 flex items-center gap-2">
                                   <Info className="w-4 h-4" />
                                   Informasi Piutang
                               </h4>
                               <ul className="text-xs text-blue-800 space-y-1">
                                   <li>‚Ä¢ Sisa tagihan <b>{formatCurrency(sisa)}</b> akan dicatat sebagai piutang</li>
                                   <li>‚Ä¢ Pelanggan dapat membayar kapan saja melalui menu <b>Piutang</b></li>
                                   <li>‚Ä¢ Status service akan berubah menjadi <b>"Piutang"</b></li>
                                   <li>‚Ä¢ Anda akan mendapat notifikasi saat pelanggan melakukan pembayaran</li>
                               </ul>
                           </div>
                       )}
                   </div>
                   
                   <div className="mt-6 flex gap-3">
                      <button onClick={close} className="flex-1 py-3 border-2 border-slate-200 rounded-xl hover:bg-slate-50 font-bold text-slate-600 transition-all">Batal</button>
                      <button 
                          onClick={handlePayment} 
                          disabled={saving || (paymentType !== 'credit' && (!amount || amount <= 0))}
                          className={`flex-1 py-3 rounded-xl font-bold shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed ${
                              paymentType === 'credit'
                                  ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-blue-200'
                                  : 'bg-green-600 text-white hover:bg-green-700 shadow-green-200'
                          }`}
                      >
                          {saving ? 'Memproses...' : paymentType === 'credit' ? 'üìù Catat Piutang' : 'üíµ Proses Pembayaran'}
                      </button>
                   </div>
                </div>
             </div>
           );
        };

        const Invoice = ({ s, store, allKelengkapanItems = [], allQCItems = [] }) => {
          const sisa = (s.costEstimate || 0) - (s.dp || 0);
          
          const getSelectedItems = (obj, allItems = []) => {
            if (!obj) return [];
            return Object.entries(obj).filter(([k, v]) => v === true).map(([k]) => {
              const found = allItems.find(item => item.name.toLowerCase().replace(/\s+/g, '_') === k);
              return found ? found.name : k.replace(/_/g, ' ');
            });
          };
          
          const kelengkapanList = getSelectedItems(s.kelengkapan, allKelengkapanItems);
          const qcFunctionalList = getSelectedItems(s.qcFunctional, allQCItems);
          
          return (
            <div className="w-[80mm] mx-auto bg-white p-6 text-slate-800 shadow-lg" style={{ fontFamily: 'Inter, sans-serif' }}>
                {/* Header */}
                <div className="flex flex-col items-center border-b-2 border-slate-100 pb-4 mb-4">
                    {store?.logo ? <img src={store.logo} alt="Logo" className="w-20 h-20 object-contain mb-2 rounded-lg" /> : <div className="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-2xl mb-2">{store?.name?.[0] || 'i'}</div>}
                    <h2 className="font-bold text-lg uppercase tracking-wider text-slate-900">{store?.name || 'iFix Pro'}</h2>
                    <p className="text-[10px] text-slate-500 text-center mt-1 px-4 leading-tight">{store?.address}</p>
                    {store?.phone && (
                        <div className="text-[10px] text-slate-500 mt-0.5 flex items-center justify-center gap-1">
                            <svg className="w-2 h-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                            </svg>
                            {store.phone}
                        </div>
                    )}
                </div>
                
                {/* Customer & Invoice Info */}
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Kepada</p>
                        <h3 className="font-bold text-sm text-slate-800">{s.customerName}</h3>
                        {s.phone && (
                            <div className="text-xs text-slate-500 flex items-center gap-1">
                                <svg className="w-2 h-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                </svg>
                                {s.phone}
                            </div>
                        )}
                    </div>
                    <div className="text-right">
                        <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Invoice</p>
                        <h3 className="font-bold text-sm text-blue-600">#{s.token}</h3>
                        <p className="text-[10px] text-slate-500">{formatDate(s.createdAt)}</p>
                    </div>
                </div>
                
                {/* Unit & Status Info */}
                <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 mb-6">
                    <div className="flex justify-between text-xs mb-1">
                        <span className="text-slate-500 font-medium">Unit</span>
                        <span className="font-bold text-slate-700">{s.unitType}</span>
                    </div>
                    <div className="flex justify-between text-xs mb-1">
                        <span className="text-slate-500 font-medium">Status</span>
                        <span className="font-bold text-slate-700">{s.status}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                        <span className="text-slate-500 font-medium">Keluhan</span>
                        <span className="font-medium text-slate-700 text-right max-w-[55%] text-[9px]">{s.complaint}</span>
                    </div>
                </div>
                
                {/* Sparepart List */}
                <div className="mb-4">
                    <h3 className="font-bold text-xs text-slate-800 uppercase tracking-wider mb-2 border-b border-slate-200 pb-1">Sparepart</h3>
                    {s.usedParts && s.usedParts.length > 0 ? (
                        <table className="w-full text-xs">
                            <tbody className="divide-y divide-slate-50">
                                {s.usedParts.map((p, i) => (
                                    <tr key={i}>
                                        <td className="py-1 text-slate-700">{p.name}</td>
                                        <td className="py-1 text-right text-slate-500 text-[9px]">x{p.qty}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <p className="text-xs text-slate-400 italic">-</p>
                    )}
                </div>
                
                {/* Kelengkapan Section */}
                {allKelengkapanItems.length > 0 && (
                    <div className="mb-3 border-b border-slate-200 pb-2">
                        <h3 className="font-bold text-xs text-slate-800 mb-1 uppercase">‚òë Kelengkapan</h3>
                        <div className="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[8px]">
                            {allKelengkapanItems.map((item, i) => {
                              const isSelected = kelengkapanList.includes(item.name);
                              return (
                                <div key={i} className="flex items-center">
                                    <span className={`font-bold mr-1 ${isSelected ? 'text-cyan-600' : 'text-slate-300'}`}>{isSelected ? '‚òë' : '‚òê'}</span>
                                    <span className={isSelected ? 'text-slate-700 font-medium' : 'text-slate-400'}>{item.name}</span>
                                </div>
                              );
                            })}
                        </div>
                    </div>
                )}
                
                {/* QC Cek Fungsional Section */}
                {allQCItems.length > 0 && (
                    <div className="mb-4 border-b border-slate-200 pb-2">
                        <h3 className="font-bold text-xs text-slate-800 mb-1 uppercase">‚òë QC Cek</h3>
                        <div className="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[8px]">
                            {allQCItems.map((item, i) => {
                              const isSelected = qcFunctionalList.includes(item.name);
                              return (
                                <div key={i} className="flex items-center">
                                    <span className={`font-bold mr-1 ${isSelected ? 'text-green-600' : 'text-slate-300'}`}>{isSelected ? '‚òë' : '‚òê'}</span>
                                    <span className={isSelected ? 'text-slate-700 font-medium' : 'text-slate-400'}>{item.name}</span>
                                </div>
                              );
                            })}
                        </div>
                    </div>
                )}
                
                {/* Billing Summary */}
                <div className="space-y-2 border-t border-slate-200 pt-4 mb-4">
                    <div className="flex justify-between text-xs">
                        <span className="text-slate-500 font-medium">Subtotal</span>
                        <span className="font-bold text-slate-700">{formatCurrency(s.costEstimate)}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                        <span className="text-slate-500 font-medium">Pembayaran (DP/Lunas)</span>
                        <span className="font-bold text-green-600">-{formatCurrency(s.dp)}</span>
                    </div>
                    <div className="flex justify-between items-center pt-2 border-t border-slate-100 mt-2">
                        <span className="text-sm font-bold text-slate-800">Sisa Tagihan</span>
                        <span className="text-lg font-black text-red-600">{formatCurrency(sisa < 0 ? 0 : sisa)}</span>
                    </div>
                </div>
                
                {/* Footer */}
                <div className="text-center border-t-2 border-slate-100 pt-3">
                    {s.warranty && <div className="inline-block bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-wider mb-2 border border-blue-100">Garansi: {s.warranty}</div>}
                    <p className="text-[10px] text-slate-400">Terima kasih telah mempercayakan servis kepada kami.</p>
                </div>
            </div>
          );
        };
        
        const FinanceManager = () => { 
            const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            
            // State untuk filter bulan (default: bulan saat ini)
            const now = new Date();
            const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const [selectedMonth, setSelectedMonth] = useState(defaultMonth);
            
            // ‚úÖ FIXED: Load transactions hanya untuk cabang aktif (bukan semua cabang)
            const { data: allTransactions } = useFirestoreCollection('transactions', activeOwner?.id, activeStore?.id);
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            
            // Filter transactions by selectedMonth di client-side
            const transactions = useMemo(() => {
                if (!selectedMonth) return allTransactions;
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                
                return allTransactions.filter(t => {
                    const tDate = t.createdAt?.seconds 
                        ? new Date(t.createdAt.seconds * 1000) 
                        : (t.date?.seconds ? new Date(t.date.seconds * 1000) : null);
                    
                    if (!tDate) return false;
                    return tDate >= startDate && tDate <= endDate;
                });
            }, [allTransactions, selectedMonth]);
            
            const [editModal, setEditModal] = useState(null);
            const [expenseModal, setExpenseModal] = useState(false);
            const [expenseCashAccount, setExpenseCashAccount] = useState('Kas Tunai');
            const [detailModal, setDetailModal] = useState(null);
            const [filter, setFilter] = useState('today');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            
            const canEdit = checkPermission('feature_finance_edit');

            if (!checkPermission('menu_finance')) return <div className="p-20 text-center text-slate-400 flex flex-col items-center"><Lock className="w-12 h-12 mb-4 text-slate-300"/>Akses Menu Keuangan Dikunci oleh Superadmin</div>;

            // Filter transactions by date
            const getFilteredTrans = (trans, f) => {
                if (f === 'all') return trans;
                const now = new Date();
                return trans.filter(t => {
                    if (!t.date && !t.createdAt) return true; // Jika tidak ada tanggal, tetap tampilkan
                    const tDate = t.date?.toDate?.() || (t.date ? new Date(t.date) : null) || (t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : null);
                    if (!tDate) return true;
                    if (f === 'today') return tDate.toDateString() === now.toDateString();
                    if (f === 'month') return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                    if (f === 'year') return tDate.getFullYear() === now.getFullYear();
                    return true;
                });
            };
            
            const filteredTrans = getFilteredTrans(transactions, filter);
            
            // Pagination logic
            const totalItems = filteredTrans.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTrans = filteredTrans.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [filter]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            // Calculate summary by type
            const totalExpense = filteredTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalIncome = filteredTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalProfit = filteredTrans.filter(t => t.type === 'profit').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalLoss = filteredTrans.filter(t => t.type === 'loss').reduce((sum, t) => sum + (t.amount || 0), 0);
            const netProfit = totalIncome - totalExpense;
            
            // Debug log untuk troubleshooting - lebih detail
            useEffect(() => {
                console.log('üí∞ Finance Data Debug:', {
                    rawTransactions: transactions.length,
                    filteredCount: filteredTrans.length,
                    expense: { count: filteredTrans.filter(t => t.type === 'expense').length, total: totalExpense },
                    income: { count: filteredTrans.filter(t => t.type === 'income').length, total: totalIncome },
                    profit: { count: filteredTrans.filter(t => t.type === 'profit').length, total: totalProfit },
                    loss: { count: filteredTrans.filter(t => t.type === 'loss').length, total: totalLoss },
                    filter: filter,
                    activeOwner: activeOwner?.id,
                    transactions: transactions.slice(0, 3) // Sample 3 transactions
                });
            }, [transactions, filter]);

            const deleteTransaction = async (t) => {
                if(!confirm(`Hapus transaksi ${t.description}? \nJika ini pembayaran servis, data servis akan disinkronkan.`)) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', t.id));
                    if(t.serviceId) {
                        await recalculateServicePayment(t.serviceId, activeOwner.id);
                    }
                    alert("Transaksi dihapus.");
                } catch(e) {
                    alert("Gagal hapus: " + e.message);
                }
            };

            const updateTransaction = async (e) => {
                e.preventDefault();
                const amount = parseFloat(e.target.amount.value);
                const desc = e.target.description.value;
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', editModal.id), {
                        amount: amount,
                        description: desc
                    });
                    if(editModal.serviceId) {
                        await recalculateServicePayment(editModal.serviceId, activeOwner.id);
                    }
                    setEditModal(null);
                    alert("Transaksi diperbarui.");
                } catch(e) {
                    alert("Gagal update: " + e.message);
                }
            };
            
            const addExpense = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Pengeluaran Operasional',
                        description: formData.get('description'),
                        amount: parseFloat(formData.get('amount')),
                        date: serverTimestamp(),
                        cashAccount: formData.get('cashAccount') || expenseCashAccount || 'Kas Tunai'
                    });
                    setExpenseModal(false);
                    setExpenseCashAccount('Kas Tunai');
                    e.target.reset();
                } catch(e) { alert("Error: " + e.message); }
            };

            return (
                <div className="space-y-6">
                  <div className="flex justify-between items-center gap-4 flex-wrap">
                    <h2 className="font-bold text-2xl">Keuangan</h2>
                    <div className="flex gap-2 items-center">
                        {/* Month Picker untuk hemat quota */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 flex items-center gap-2">
                            <Calendar className="w-4 h-4 text-blue-600"/>
                            <input 
                                type="month" 
                                value={selectedMonth} 
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="text-sm font-bold text-blue-700 bg-transparent border-none outline-none cursor-pointer"
                                max={defaultMonth}
                            />
                        </div>
                        <div className="bg-white border border-slate-200 rounded-lg p-1 flex">
                            {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'}].map(f => (
                                <button key={f.id} onClick={()=>setFilter(f.id)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filter === f.id ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}>{f.l}</button>
                            ))}
                        </div>
                    </div>
                    <button onClick={()=>setExpenseModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700 flex items-center gap-2 shadow-lg"><MinusCircle className="w-4 h-4"/> Catat Pengeluaran</button>
                  </div>

                  {/* Summary Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onClick={() => setDetailModal({type: 'expense', title: 'Pengeluaran (Modal)', data: filteredTrans.filter(t => t.type === 'expense')})} className="bg-red-50 border border-red-200 rounded-xl p-6 text-left hover:bg-red-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-red-600 text-sm font-bold uppercase mb-2">Pengeluaran (Modal)</div>
                        <div className="text-3xl font-bold text-red-600">{formatCurrency(totalExpense)}</div>
                        <div className="text-xs text-red-500 mt-2">{filteredTrans.filter(t => t.type === 'expense').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'income', title: 'Pemasukan (Penjualan)', data: filteredTrans.filter(t => t.type === 'income')})} className="bg-green-50 border border-green-200 rounded-xl p-6 text-left hover:bg-green-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-green-600 text-sm font-bold uppercase mb-2">Pemasukan (Penjualan)</div>
                        <div className="text-3xl font-bold text-green-600">{formatCurrency(totalIncome)}</div>
                        <div className="text-xs text-green-500 mt-2">{filteredTrans.filter(t => t.type === 'income').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'profit', title: 'Keuntungan', data: filteredTrans.filter(t => t.type === 'profit')})} className="bg-blue-50 border border-blue-200 rounded-xl p-6 text-left hover:bg-blue-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-blue-600 text-sm font-bold uppercase mb-2">Keuntungan</div>
                        <div className="text-3xl font-bold text-blue-600">{formatCurrency(totalProfit)}</div>
                        <div className="text-xs text-blue-500 mt-2">{filteredTrans.filter(t => t.type === 'profit').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'net', title: 'Bersih (Pemasukan - Pengeluaran)', data: [...filteredTrans.filter(t => t.type === 'income'), ...filteredTrans.filter(t => t.type === 'expense')]})} className={`border rounded-xl p-6 text-left hover:shadow-lg transition-all cursor-pointer ${netProfit >= 0 ? 'bg-emerald-50 border-emerald-200 hover:bg-emerald-100' : 'bg-amber-50 border-amber-200 hover:bg-amber-100'}`}>
                        <div className={`text-sm font-bold uppercase mb-2 ${netProfit >= 0 ? 'text-emerald-600' : 'text-amber-600'}`}>Bersih (Pemasukan - Pengeluaran)</div>
                        <div className={`text-3xl font-bold ${netProfit >= 0 ? 'text-emerald-600' : 'text-amber-600'}`}>{formatCurrency(Math.abs(netProfit))}</div>
                        <div className={`text-xs mt-2 ${netProfit >= 0 ? 'text-emerald-500' : 'text-amber-500'}`}>{netProfit >= 0 ? '‚úÖ Untung' : '‚ö†Ô∏è Rugi'} ‚Ä¢ Klik untuk detail</div>
                    </button>
                  </div>

                  {/* Transactions Table */}
                  <div className="bg-white rounded shadow overflow-hidden overflow-x-auto">
                      <table className="w-full text-sm text-left"><thead className="bg-gray-50"><tr><th className="p-3">Tgl</th><th className="p-3">Jenis</th><th className="p-3">Ket</th><th className="p-3 text-right">Jml</th><th className="p-3 text-center">Aksi</th></tr></thead>
                      <tbody className="divide-y">{paginatedTrans.map((t,i) => {
                          let typeColor = 'text-slate-600';
                          let typeLabel = t.type;
                          if(t.type === 'expense') { typeColor = 'text-red-600'; typeLabel = '‚ùå Pengeluaran'; }
                          else if(t.type === 'income') { typeColor = 'text-green-600'; typeLabel = '‚úÖ Pemasukan'; }
                          else if(t.type === 'profit') { typeColor = 'text-blue-600'; typeLabel = 'üìà Keuntungan'; }
                          else if(t.type === 'loss') { typeColor = 'text-amber-600'; typeLabel = 'üìâ Rugi'; }
                          return (
                          <tr key={i}>
                              <td className="p-3 text-gray-500">{formatDate(t.date)}</td>
                              <td className={`p-3 font-bold text-sm ${typeColor}`}>{typeLabel}</td>
                              <td className="p-3">
                                  <div className="font-medium">{t.category}</div>
                                  <div className="text-xs text-gray-400">{t.description}</div>
                                  {t.serviceId && <span className="text-[9px] bg-blue-50 text-blue-600 px-1 rounded border border-blue-100">Linked Service</span>}
                              </td>
                              <td className={`p-3 text-right font-bold text-sm`}>{formatCurrency(t.amount)}</td>
                              <td className="p-3 text-center">
                                  {canEdit ? (
                                      <div className="flex justify-center gap-2">
                                          <button onClick={()=>setEditModal(t)} className="text-blue-500 hover:bg-blue-50 p-1 rounded"><Pencil className="w-4 h-4"/></button>
                                          <button onClick={()=>deleteTransaction(t)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 className="w-4 h-4"/></button>
                                      </div>
                                  ) : (
                                      <span className="text-xs text-slate-300 italic">Locked</span>
                                  )}
                              </td>
                          </tr>
                          );
                      })}</tbody></table>
                      {paginatedTrans.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada transaksi.</div>}
                  </div>
                  
                  {/* Pagination Controls */}
                  <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                      <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                          <div className="flex gap-2">
                              <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                              <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                          </div>
                      </div>
                      <div className="text-sm text-slate-600 font-medium">
                          Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                      </div>
                  </div>
                  
                  {/* Pagination Navigation */}
                  {totalPages > 1 && (
                      <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <button 
                              onClick={() => handlePageChange(currentPage - 1)} 
                              disabled={currentPage === 1}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              ‚Üê Sebelumnya
                          </button>
                          <div className="text-sm text-slate-600 font-medium">
                              Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                          </div>
                          <button 
                              onClick={() => handlePageChange(currentPage + 1)} 
                              disabled={currentPage === totalPages}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              Selanjutnya ‚Üí
                          </button>
                      </div>
                  )}

                  {expenseModal && (
                      <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                          <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                              <h3 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2"><ArrowDownRight className="w-5 h-5"/> Catat Pengeluaran</h3>
                              <form onSubmit={addExpense} className="space-y-4">
                                  <div><label className="text-xs font-bold text-slate-500">Keterangan</label><input name="description" placeholder="Contoh: Bayar Listrik, Beli Kopi" className="w-full border p-2 rounded" required/></div>
                                  <div><label className="text-xs font-bold text-slate-500">Jumlah (Rp)</label><NumberInput name="amount" className="w-full border p-2 rounded font-bold" required/></div>
                                  <CashAccountSelect value={expenseCashAccount} onChange={setExpenseCashAccount} label="Keluar dari Kas" />
                                  <div className="flex gap-2 pt-2">
                                      <button type="button" onClick={()=>setExpenseModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                      <button className="flex-1 bg-red-600 text-white p-2 rounded font-bold">Simpan</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  )}

                  {editModal && (
                      <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                          <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                              <h3 className="font-bold text-lg mb-4">Edit Transaksi</h3>
                              <form onSubmit={updateTransaction} className="space-y-4">
                                  <div><label className="text-xs font-bold text-slate-500">Keterangan</label><input name="description" defaultValue={editModal.description} className="w-full border p-2 rounded" required/></div>
                                  <div><label className="text-xs font-bold text-slate-500">Jumlah (Rp)</label><NumberInput name="amount" defaultValue={editModal.amount} className="w-full border p-2 rounded font-bold" required/></div>
                                  <div className="flex gap-2 pt-2">
                                      <button type="button" onClick={()=>setEditModal(null)} className="flex-1 border p-2 rounded">Batal</button>
                                      <button className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  )}
                  
                  {detailModal && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                          <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                              <div className="flex justify-between items-center border-b border-slate-200 p-6 bg-gradient-to-r from-slate-50 to-slate-100">
                                  <div>
                                      <h3 className="font-bold text-2xl text-slate-800">{detailModal.title}</h3>
                                      <p className="text-xs text-slate-500 mt-1">
                                          {detailModal.type === 'expense' && 'üí∏ Semua transaksi pengeluaran & modal'}
                                          {detailModal.type === 'income' && 'üí∞ Semua transaksi pemasukan'}
                                          {detailModal.type === 'profit' && 'üìà Semua transaksi keuntungan'}
                                          {detailModal.type === 'net' && 'üìä Perhitungan pemasukan dikurangi pengeluaran'}
                                      </p>
                                  </div>
                                  <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-lg transition-all"><X className="w-6 h-6 text-slate-600" /></button>
                              </div>
                              
                              <div className="overflow-y-auto flex-1 p-6">
                                  {detailModal.data.length === 0 ? (
                                      <div className="text-center py-12 text-slate-400">
                                          <FileText className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                                          <p>Tidak ada transaksi</p>
                                      </div>
                                  ) : (
                                      <div className="space-y-3">
                                          {detailModal.data.map((t, idx) => {
                                              const isExpense = t.type === 'expense';
                                              const isIncome = t.type === 'income';
                                              const isProfit = t.type === 'profit';
                                              const bgColor = isExpense ? 'bg-red-50 border-red-200' : isIncome ? 'bg-green-50 border-green-200' : isProfit ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200';
                                              const textColor = isExpense ? 'text-red-700' : isIncome ? 'text-green-700' : isProfit ? 'text-blue-700' : 'text-slate-700';
                                              const relatedService = services.find(s => s.id === t.serviceId);
                                              
                                              return (
                                                  <div key={idx} className={`border rounded-xl p-4 ${bgColor} hover:shadow-md transition-all`}>
                                                      <div className="flex justify-between items-start mb-2">
                                                          <div className="flex-1">
                                                              <div className="flex items-center gap-2 mb-1">
                                                                  {isExpense && <span className="text-red-600 font-bold text-xs bg-red-100 px-2 py-0.5 rounded">‚ùå KELUAR</span>}
                                                                  {isIncome && <span className="text-green-600 font-bold text-xs bg-green-100 px-2 py-0.5 rounded">‚úÖ MASUK</span>}
                                                                  {isProfit && <span className="text-blue-600 font-bold text-xs bg-blue-100 px-2 py-0.5 rounded">üìà PROFIT</span>}
                                                                  {t.type === 'loss' && <span className="text-amber-600 font-bold text-xs bg-amber-100 px-2 py-0.5 rounded">üìâ LOSS</span>}
                                                                  <span className="text-[10px] text-slate-400">{formatDate(t.date || t.createdAt)}</span>
                                                              </div>
                                                              <h4 className={`font-bold text-sm ${textColor} mb-1`}>{t.category}</h4>
                                                              <p className="text-xs text-slate-600">{t.description}</p>
                                                              {t.serviceId && <span className="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100 inline-block mt-1">üîó Linked Service</span>}
                                                              
                                                              {/* Sparepart Info */}
                                                              {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                                  <div className="bg-white/80 p-3 rounded-lg mt-3 border border-purple-100">
                                                                      <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Digunakan:</p>
                                                                      <div className="flex flex-wrap gap-2">
                                                                          {relatedService.usedParts.map((part, pidx) => {
                                                                              const profit = (part.sellPrice - part.buyPrice) * part.qty;
                                                                              return (
                                                                              <div key={pidx} className="bg-purple-50 border border-purple-200 rounded-md px-2 py-1.5 text-[10px]">
                                                                                  <div className="font-bold text-purple-700">{part.name} x{part.qty}</div>
                                                                                  {isExpense && <div className="text-red-600">Modal: {formatCurrency(part.buyPrice * part.qty)}</div>}
                                                                                  {isIncome && <div className="text-green-600">Jual: {formatCurrency(part.sellPrice * part.qty)}</div>}
                                                                                  {isProfit && <div className="text-blue-600">Profit: {formatCurrency(profit)}</div>}
                                                                              </div>
                                                                              );
                                                                          })}
                                                                      </div>
                                                                  </div>
                                                              )}
                                                          </div>
                                                          <div className={`text-right font-bold text-lg ${textColor}`}>
                                                              {formatCurrency(t.amount)}
                                                          </div>
                                                      </div>
                                                  </div>
                                              );
                                          })}
                                          
                                          <div className="mt-6 pt-4 border-t-2 border-slate-200">
                                              <div className="flex justify-between items-center bg-gradient-to-r from-slate-100 to-slate-50 p-4 rounded-xl">
                                                  <span className="font-bold text-slate-700">TOTAL {detailModal.title.toUpperCase()}</span>
                                                  <span className="font-bold text-2xl text-slate-800">
                                                      {formatCurrency(detailModal.data.reduce((sum, t) => {
                                                          if (detailModal.type === 'net') {
                                                              return sum + (t.type === 'income' ? t.amount : -t.amount);
                                                          }
                                                          return sum + (t.amount || 0);
                                                      }, 0))}
                                                  </span>
                                              </div>
                                          </div>
                                      </div>
                                  )}
                              </div>
                              
                              <div className="border-t border-slate-200 p-4 bg-slate-50">
                                  <button onClick={() => setDetailModal(null)} className="w-full py-3 bg-slate-600 text-white rounded-xl font-bold hover:bg-slate-700 transition-all">
                                      Tutup
                                  </button>
                              </div>
                          </div>
                      </div>
                  )}
                </div>
            ); 
        };
        
        const Sidebar = ({ setView, view, isOpen, close }) => {
            const { user, activeOwner, activeStore, availableStores, switchStore, logout, checkPermission } = useContext(SessionContext);
            const [storeMenuOpen, setStoreMenuOpen] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({ operations: true, finance: false, inventory: false });
            const [showInstallButton, setShowInstallButton] = useState(true); // Default true
            const [isInstalled, setIsInstalled] = useState(false);
            const effectiveRole = user.role === 'superadmin' ? 'owner' : user.role;
            
            useEffect(() => {
                // Check if app is already installed
                const installed = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
                console.log('PWA: Installation check -', installed ? 'INSTALLED' : 'NOT INSTALLED');
                setIsInstalled(installed);
                setShowInstallButton(!installed);
                
                const handleInstallable = () => {
                    console.log('PWA: Install prompt available');
                    setShowInstallButton(true);
                };
                const handleInstalled = () => {
                    console.log('PWA: App installed successfully');
                    setIsInstalled(true);
                    setShowInstallButton(false);
                };
                
                window.addEventListener('pwa-installable', handleInstallable);
                window.addEventListener('pwa-installed', handleInstalled);
                
                return () => {
                    window.removeEventListener('pwa-installable', handleInstallable);
                    window.removeEventListener('pwa-installed', handleInstalled);
                };
            }, []);
            
            const handleInstallClick = async () => {
                if (window.deferredPrompt) {
                    // Native PWA prompt available
                    window.deferredPrompt.prompt();
                    const { outcome } = await window.deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        setShowInstallButton(false);
                        setIsInstalled(true);
                        alert('Aplikasi berhasil diinstall!');
                    }
                    window.deferredPrompt = null;
                } else {
                    // Show manual instructions
                    const ua = navigator.userAgent;
                    const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor);
                    const isEdge = /Edg/.test(ua);
                    const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
                    
                    let instructions = 'Cara Install Aplikasi:\n\n';
                    
                    if (isChrome || isEdge) {
                        instructions += '1. Klik icon install di address bar (pojok kanan)\n';
                        instructions += '   ATAU\n';
                        instructions += '2. Klik menu (titik tiga) di pojok kanan atas\n';
                        instructions += '3. Pilih "Install iFix Pro"\n';
                        instructions += '4. Klik "Install"\n\n';
                        instructions += 'Aplikasi akan muncul seperti app native!';
                    } else if (isSafari) {
                        instructions += '1. Tap tombol Share (kotak dengan panah)\n';
                        instructions += '2. Scroll dan pilih "Add to Home Screen"\n';
                        instructions += '3. Tap "Add"\n\n';
                        instructions += 'Icon akan muncul di home screen!';
                    } else {
                        instructions += 'Gunakan browser Chrome, Edge, atau Safari\n';
                        instructions += 'untuk menginstall aplikasi ini.';
                    }
                    
                    alert(instructions);
                }
            };
            
            const toggleGroup = (group) => {
                setExpandedGroups(prev => ({ ...prev, [group]: !prev[group] }));
            };
            
            const menuGroups = [
                {
                    id: 'main',
                    items: [
                        { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard, permission: 'menu_dashboard' }
                    ]
                },
                {
                    id: 'operations',
                    label: 'üìã Transaksi',
                    expandable: true,
                    items: [
                        { id: 'service', label: 'Servis HP', icon: Smartphone, permission: 'menu_service' },
                        { id: 'sales', label: 'Penjualan', icon: Store, permission: 'menu_sales' },
                        { id: 'purchase', label: 'Pembelian', icon: ShoppingCart, permission: 'menu_purchase' },
                        { id: 'return-sales', label: 'Retur Penjualan', icon: RotateCcw, permission: 'menu_return_sales' },
                        { id: 'return-purchase', label: 'Retur Pembelian', icon: RotateCw, permission: 'menu_return_purchase' }
                    ]
                },
                {
                    id: 'finance',
                    label: 'üí∞ Keuangan',
                    expandable: true,
                    items: [
                        { id: 'payable', label: 'Utang', icon: ArrowUpRight, permission: 'menu_payable' },
                        { id: 'receivable', label: 'Piutang', icon: ArrowDownRight, permission: 'menu_receivable' },
                        { id: 'cash', label: 'Kas', icon: Banknote, permission: 'menu_cash' },
                        { id: 'finance', label: 'Laporan Keuangan', icon: Wallet, permission: 'menu_finance' }
                    ]
                },
                {
                    id: 'inventory',
                    label: 'üì¶ Inventory',
                    expandable: true,
                    items: [
                        { id: 'inventory', label: 'Stok', icon: Box, permission: 'menu_inventory' },
                        { id: 'supplier', label: 'Supplier', icon: Truck, permission: 'menu_supplier' }
                    ]
                },
                {
                    id: 'other',
                    items: [
                        { id: 'customers', label: 'Pelanggan', icon: Users, permission: 'menu_customers' },
                        { id: 'report', label: 'Laporan', icon: FileText, permission: 'menu_report' },
                        { id: 'hr', label: 'HR & Payroll', icon: Calendar, permission: 'menu_hr' }
                    ]
                }
            ];
            
            if(effectiveRole === 'owner') {
                menuGroups.push({
                    id: 'admin',
                    items: [
                        { id: 'users', label: 'Pegawai', icon: Users, permission: 'menu_users' },
                        { id: 'settings', label: 'Pengaturan', icon: Settings, permission: 'menu_settings' }
                    ]
                });
            }
            
            return (
                <aside className={`bg-slate-900 text-slate-300 flex flex-col fixed left-0 top-0 bottom-0 z-50 shadow-2xl transition-transform duration-300 mobile-sidebar ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 w-64`}>
                    <div className="md:hidden absolute top-4 right-4 z-10"><button onClick={close} className="text-slate-400 hover:text-white"><X className="w-6 h-6"/></button></div>
                    {user.role === 'superadmin' && activeOwner && <div className="bg-purple-900 px-4 py-2 text-xs text-purple-200 font-bold flex justify-between items-center border-b border-purple-800 flex-shrink-0"><span>üëÅÔ∏è View: {activeOwner.name}</span><button onClick={()=>window.location.reload()} className="underline hover:text-white">Exit</button></div>}
                    <div className="p-6 flex-1 overflow-y-auto sidebar-scroll bg-slate-900">
                        <div className="flex items-center gap-3 text-white mb-6"><div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-xl">iF</div><div><h1 className="font-bold text-lg leading-tight">iFix Pro</h1><p className="text-[10px] text-blue-400 uppercase tracking-widest">{activeOwner?.plan || 'Cloud'} Edition</p></div></div>
                        <div className="relative mb-6">
                            <button onClick={() => effectiveRole === 'owner' && setStoreMenuOpen(!storeMenuOpen)} className={`w-full bg-slate-800 p-3 rounded-xl flex items-center gap-3 border border-slate-700 ${effectiveRole === 'owner' ? 'hover:border-blue-500 cursor-pointer' : ''}`}>
                                <div className="bg-blue-900 p-2 rounded-lg text-blue-400"><Store className="w-4 h-4"/></div><div className="flex-1 min-w-0 text-left"><p className="text-[10px] text-slate-500 uppercase font-bold">Lokasi Aktif</p><p className="text-sm font-bold text-white truncate">{!activeStore ? 'üìä Semua Toko' : (activeStore.name || 'Loading...')}</p></div>{effectiveRole === 'owner' ? <ChevronDown className="w-4 h-4"/> : <Lock className="w-3 h-3"/>}
                            </button>
                            {storeMenuOpen && <div className="absolute top-full left-0 w-full mt-2 bg-slate-800 rounded-xl border border-slate-700 shadow-xl overflow-hidden z-50">
                                <button onClick={()=>{switchStore(null); setStoreMenuOpen(false);}} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 flex justify-between border-b border-slate-700 text-slate-300 font-bold text-blue-400 bg-slate-700/50">
                                    <span className="truncate">üìä Semua Toko (Full Database)</span>
                                    {!activeStore?.id && <Check className="w-4 h-4 text-blue-500"/>}
                                </button>
                                {availableStores.map(s => <button key={s.id} onClick={()=>{switchStore(s.id); setStoreMenuOpen(false);}} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 flex justify-between border-b border-slate-700 last:border-0 text-slate-300"><span className="truncate">{s.name}</span>{s.id === activeStore?.id && <Check className="w-4 h-4 text-blue-500"/>}</button>)}</div>}
                        </div>
                        <nav className="space-y-1">
                            {menuGroups.map(group => (
                                <div key={group.id}>
                                    {group.label && (
                                        <button
                                            onClick={() => group.expandable && toggleGroup(group.id)}
                                            className="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider hover:text-slate-200 transition-colors"
                                        >
                                            <span>{group.label}</span>
                                            {group.expandable && (
                                                <ChevronDown className={`w-3 h-3 transition-transform ${expandedGroups[group.id] ? 'rotate-180' : ''}`} />
                                            )}
                                        </button>
                                    )}
                                    <div className={`space-y-1 ${group.expandable && !expandedGroups[group.id] ? 'hidden' : ''}`}>
                                        {group.items.map(m => {
                                            const isLocked = m.permission && !checkPermission(m.permission);
                                            return (
                                                <button 
                                                    key={m.id} 
                                                    onClick={()=>{ 
                                                        if(isLocked) { 
                                                            alert("‚ùå Menu ini dikunci oleh Superadmin/Owner"); 
                                                        } else { 
                                                            setView(m.id); 
                                                            if(window.innerWidth < 768) close(); 
                                                        } 
                                                    }} 
                                                    className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${view === m.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 hover:text-white'} ${isLocked ? 'text-slate-500 cursor-not-allowed hover:bg-transparent' : ''} ${group.label ? 'ml-2' : ''}`}
                                                > 
                                                    {isLocked ? <Lock className="w-4 h-4"/> : <m.icon className="w-4 h-4"/>} 
                                                    <span className="text-xs">{m.label}</span>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </nav>
                    </div>
                    {!isInstalled && showInstallButton && (
                        <div className="p-4 flex-shrink-0 bg-slate-900 border-t border-slate-800">
                            <button
                                onClick={handleInstallClick}
                                className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-3 rounded-xl font-bold text-sm hover:from-purple-700 hover:to-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 animate-pulse"
                                style={{ animationDuration: '2s' }}
                            >
                                <Download className="w-5 h-5" />
                                <span>Install Aplikasi</span>
                            </button>
                            <p className="text-xs text-center text-slate-500 mt-2">Install untuk akses lebih cepat</p>
                        </div>
                    )}
                    <div className="p-4 border-t border-slate-800 flex-shrink-0 bg-slate-900"><div className="flex items-center gap-3 px-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold text-xs">{user.name.charAt(0)}</div><div className="flex-1 min-w-0"><p className="text-sm font-bold text-white truncate">{user.name}</p><p className="text-[10px] text-slate-500 uppercase font-bold">{user.role}</p></div></div></div>
                </aside>
            );
        };
        
        const SettingsManager = () => {
             const { user, activeOwner, activeStore, checkPermission, ownerAccess, storeConfig, availableStores } = useContext(SessionContext);
             const { data: users } = useFirestoreCollection('users', activeOwner?.id);
             const [storeData, setStoreData] = useState(activeStore || {});
             const [config, setConfig] = useState(storeConfig || {});
             const [saving, setSaving] = useState(false);
             const [restoring, setRestoring] = useState(false);
             const [isBranchModalOpen, setBranchModalOpen] = useState(false);
             const [modal, setModal] = useState(null);

             useEffect(() => { 
                 setStoreData(activeStore || {}); 
                 setConfig(storeConfig || {}); 
                 console.log('üîÑ Real-time sync: Config updated', storeConfig);
             }, [activeStore, storeConfig]);
             const effectiveRole = user.role === 'superadmin' ? 'owner' : user.role;
             if (effectiveRole !== 'owner') return <div className="p-10 text-center text-red-500 font-bold"><Lock className="w-10 h-10 mx-auto mb-2"/>Akses Ditolak: Hanya Owner</div>;
             
             // NEW: Image Processor (Optimized for Spark Plan)
             const processImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            // Resize logic: Max width 300px (Sangat cukup untuk logo thermal)
                            const MAX_WIDTH = 300;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            // Compress to WEBP quality 0.5 (Sangat hemat size)
                            resolve(canvas.toDataURL('image/webp', 0.5));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
             };

             const handleLogo = async (e) => { 
                 const file = e.target.files[0]; 
                 if(file) { 
                     // Check max size 2MB for input
                     if (file.size > 2 * 1024 * 1024) {
                         alert("File terlalu besar! Maksimal 2MB.");
                         return;
                     }
                     try {
                        const compressed = await processImage(file);
                        setStoreData(prev => ({...prev, logo: compressed}));
                     } catch (err) {
                        alert("Gagal memproses gambar: " + err.message);
                     }
                 } 
             };

             const saveProfile = async (e) => { 
                e.preventDefault(); 
                setSaving(true); 
                try { 
                    if(!activeStore?.id) throw new Error("Data toko tidak ditemukan.");
                    
                    // Explicitly update only relevant fields
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', activeStore.id), {
                        name: storeData.name || '',
                        address: storeData.address || '',
                        phone: storeData.phone || '',
                        logo: storeData.logo || null
                    }); 
                    alert("Profil Toko Disimpan!"); 
                } catch(err) { 
                    alert("Gagal: " + err.message); 
                } finally { 
                    setSaving(false); 
                } 
             };
             
             const handleCreateBranch = async (e) => {
                 e.preventDefault();
                 
                 // LIMITATION CHECK: BASIC PLAN MAX 1 STORE
                 if (activeOwner.plan === 'basic' && availableStores.length >= 1) {
                     alert("üö´ AKSES DITOLAK: Basic Plan hanya diizinkan memiliki 1 cabang (Toko Pusat).\n\nSilakan hubungi Superadmin untuk upgrade ke PRO Plan agar bisa membuka cabang tak terbatas.");
                     return;
                 }

                 setSaving(true);
                 const formData = new FormData(e.target);
                 try {
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), {
                         ownerId: activeOwner.id,
                         name: formData.get('name'),
                         address: formData.get('address'),
                         phone: formData.get('phone'),
                         createdAt: serverTimestamp()
                     });
                     alert("Cabang baru berhasil dibuka!");
                     setBranchModalOpen(false);
                 } catch(e) {
                     alert("Error: " + e.message);
                 } finally {
                     setSaving(false);
                 }
             };

             const saveStorePermissions = async (e) => {
                 e.preventDefault();
                 setSaving(true);
                 try {
                     const formData = new FormData(e.target);
                     const permissions = {
                         menu_dashboard: formData.get('menu_dashboard') === 'on',
                         menu_report: formData.get('menu_report') === 'on',
                         menu_service: formData.get('menu_service') === 'on',
                         menu_sales: formData.get('menu_sales') === 'on',
                         menu_purchase: formData.get('menu_purchase') === 'on',
                         menu_return_sales: formData.get('menu_return_sales') === 'on',
                         menu_return_purchase: formData.get('menu_return_purchase') === 'on',
                         menu_payable: formData.get('menu_payable') === 'on',
                         menu_receivable: formData.get('menu_receivable') === 'on',
                         menu_cash: formData.get('menu_cash') === 'on',
                         menu_finance: formData.get('menu_finance') === 'on',
                         menu_inventory: formData.get('menu_inventory') === 'on',
                         menu_supplier: formData.get('menu_supplier') === 'on',
                         menu_customers: formData.get('menu_customers') === 'on',
                         menu_hr: formData.get('menu_hr') === 'on',
                         feature_service_edit: formData.get('feature_service_edit') === 'on',
                         feature_sales_edit: formData.get('feature_sales_edit') === 'on',
                         feature_inventory_edit: formData.get('feature_inventory_edit') === 'on',
                         feature_customer_edit: formData.get('feature_customer_edit') === 'on',
                         feature_employee_edit: formData.get('feature_employee_edit') === 'on',
                         feature_finance_edit: formData.get('feature_finance_edit') === 'on',
                         feature_print: formData.get('feature_print') === 'on',
                         feature_share: formData.get('feature_share') === 'on',
                         feature_delete: formData.get('feature_delete') === 'on',
                         feature_stock_add: formData.get('feature_stock_add') === 'on',
                         feature_backup: formData.get('feature_backup') === 'on',
                         feature_import_export: formData.get('feature_import_export') === 'on',
                         feature_multi_branch: formData.get('feature_multi_branch') === 'on',
                         feature_qc_checklist: formData.get('feature_qc_checklist') === 'on',
                         feature_kelengkapan: formData.get('feature_kelengkapan') === 'on',
                         feature_accounting: formData.get('feature_accounting') === 'on'
                     };
                     
                     const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('storeId', '==', activeStore.id));
                     const snap = await getDocs(q);
                     if (snap.empty) {
                         await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), { 
                             storeId: activeStore.id, 
                             ...permissions 
                         });
                     } else {
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'store_configs', snap.docs[0].id), permissions);
                     }
                     
                     // Config akan otomatis update via real-time listener di SessionProvider
                     alert("‚úÖ Hak akses karyawan berhasil disimpan!\n\nüîÑ Perubahan telah tersinkronisasi real-time ke semua perangkat karyawan.");
                     setModal(null);
                 } catch (err) {
                     alert("‚ùå Gagal menyimpan: " + err.message);
                 } finally {
                     setSaving(false);
                 }
             };

             const handleBackup = async () => {
                 if (!checkPermission('feature_backup')) { showAccessDenied('Fitur Backup hanya tersedia untuk PRO Plan.'); return; }
                 const backupData = { version: '1.0', timestamp: new Date().toISOString(), services: [], inventory: [], transactions: [], customers: [] };
                 const fetchCol = async (name) => { const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', name), where('ownerId', '==', activeOwner.id)); const snap = await getDocs(q); return snap.docs.map(d => ({id: d.id, ...d.data()})); }
                 try { setSaving(true); backupData.services = await fetchCol('services'); backupData.inventory = await fetchCol('inventory'); backupData.transactions = await fetchCol('transactions'); backupData.customers = await fetchCol('customers'); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `ifix_backup_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); } catch(e) { alert("Gagal backup: " + e.message); } finally { setSaving(false); }
             };

             const handleRestore = async (e) => {
                 const file = e.target.files[0]; if (!file) return;
                 if (!checkPermission('feature_backup')) { showAccessDenied('Fitur Restore hanya tersedia untuk PRO Plan.'); return; }
                 if (!confirm("PERINGATAN: Restore akan menimpa/menambah data yang ada. Apakah Anda yakin ingin melanjutkannya?")) return;
                 const reader = new FileReader();
                 reader.onload = async (event) => {
                     try {
                         setRestoring(true);
                         const json = JSON.parse(event.target.result);
                         const collectionsToRestore = ['services', 'inventory', 'transactions', 'customers'];
                         let totalItems = 0;
                         for (const key of collectionsToRestore) {
                             if (json[key] && Array.isArray(json[key])) {
                                 const batchArray = []; let currentBatch = writeBatch(db); let count = 0;
                                 for (const item of json[key]) {
                                     const cleanItem = normalizeFirestoreData(item);
                                     cleanItem.ownerId = activeOwner.id; cleanItem.storeId = activeStore.id; 
                                     const docRef = cleanItem.id ? doc(db, APP_COLLECTION_PREFIX, 'public', key, cleanItem.id) : doc(collection(db, APP_COLLECTION_PREFIX, 'public', key));
                                     currentBatch.set(docRef, cleanItem, { merge: true });
                                     count++; totalItems++;
                                     if (count >= 400) { batchArray.push(currentBatch); currentBatch = writeBatch(db); count = 0; }
                                 }
                                 if (count > 0) batchArray.push(currentBatch);
                                 for (const batch of batchArray) { await batch.commit(); }
                             }
                         }
                         alert(`Restore Berhasil! Total ${totalItems} data dipulihkan.`); window.location.reload();
                     } catch (err) { alert("Gagal restore: " + err.message); console.error(err); } finally { setRestoring(false); }
                 };
                 reader.readAsText(file);
             };

             // NEW: Reset All Data Function
             const resetAllData = async () => {
                 const confirmText = prompt(
                     "‚ö†Ô∏è BAHAYA: Ini akan menghapus SEMUA DATA TOKO!\n\nData yang akan dihapus:\n- Semua servis\n- Semua transaksi\n- Semua pelanggan\n- Semua stok barang\n\nKetik 'RESET SEMUA DATA' untuk konfirmasi:"
                 );
                 
                 if (confirmText !== 'RESET SEMUA DATA') {
                     alert('‚ùå Konfirmasi dibatalkan');
                     return;
                 }
                 
                 if (!confirm(`üö® KONFIRMASI TERAKHIR\n\nüìã SEMUA DATA AKAN TERHAPUS PERMANEN!\n\nüö´ TIDAK BISA DIKEMBALIKAN!\n\nAnda yakin ingin melanjutkan?`)) {
                     return;
                 }
                 
                 try {
                     setRestoring(true);
                     console.log('üóëÔ∏è Starting complete data reset...');
                     
                     const collectionsToReset = ['services', 'inventory', 'transactions', 'customers'];
                     let totalDeleted = 0;
                     
                     // Delete each collection
                     for (const collectionName of collectionsToReset) {
                         console.log(`Deleting ${collectionName}...`);
                         
                         const collectionRef = collection(db, APP_COLLECTION_PREFIX, 'public', collectionName);
                         const q = query(collectionRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                         const snapshot = await getDocs(q);
                         
                         if (snapshot.docs.length > 0) {
                             // Delete in batches
                             const batchArray = [];
                             let currentBatch = writeBatch(db);
                             let count = 0;
                             
                             snapshot.docs.forEach(doc => {
                                 currentBatch.delete(doc.ref);
                                 count++;
                                 totalDeleted++;
                                 
                                 if (count >= 450) {
                                     batchArray.push(currentBatch);
                                     currentBatch = writeBatch(db);
                                     count = 0;
                                 }
                             });
                             
                             if (count > 0) {
                                 batchArray.push(currentBatch);
                             }
                             
                             // Commit all batches for this collection
                             for (const batch of batchArray) {
                                 await batch.commit();
                             }
                             
                             console.log(`‚úÖ Deleted ${snapshot.docs.length} ${collectionName}`);
                         }
                     }
                     
                     console.log('‚úÖ Complete data reset finished');
                     alert(`‚úÖ RESET BERHASIL!\n\nüìã Total ${totalDeleted} data terhapus\nüéÜ Toko kembali seperti baru!\n\nüîÑ Halaman akan dimuat ulang...`);
                     
                     // Reload page to refresh all data
                     setTimeout(() => {
                         window.location.reload();
                     }, 1500);
                     
                 } catch (err) {
                     console.error('‚ùå Error in data reset:', err);
                     alert(`‚ùå Gagal reset data: ${err.message}`);
                 } finally {
                     setRestoring(false);
                 }
             };

             return (
                 <div className="space-y-8 max-w-4xl">
                     <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                         <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl flex items-center gap-2 text-slate-800"><Store className="w-6 h-6 text-blue-600"/> Profil Toko</h3><button onClick={()=>setBranchModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2"><Plus className="w-4 h-4"/> Buka Cabang Baru</button></div>
                         <form onSubmit={saveProfile} className="space-y-6"><div className="flex items-center gap-6">
                            
                            {/* FIX: LOGO UPLOADER */}
                            <div className="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center bg-slate-50 overflow-hidden relative group cursor-pointer hover:border-blue-500 transition-colors">
                                {storeData.logo ? <img src={storeData.logo} className="w-full h-full object-contain pointer-events-none"/> : <ImageIcon className="w-8 h-8 text-slate-300 pointer-events-none"/>}
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs font-bold pointer-events-none">Ganti Logo</div>
                                <input type="file" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" accept="image/*" onChange={handleLogo} title="Ganti Logo Toko"/>
                            </div>

                            <div><h4 className="font-bold text-slate-700">Logo Struk</h4><p className="text-xs text-slate-500 mb-2">Format: JPG/PNG, Max 2MB</p></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Toko</label><input className="w-full border border-slate-300 p-3 rounded-lg font-bold text-slate-800" value={storeData.name||''} onChange={e=>setStoreData({...storeData, name:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">No Telepon</label><input className="w-full border border-slate-300 p-3 rounded-lg" value={storeData.phone||''} onChange={e=>setStoreData({...storeData, phone:e.target.value})}/></div><div className="md:col-span-2"><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Alamat</label><input className="w-full border border-slate-300 p-3 rounded-lg" value={storeData.address||''} onChange={e=>setStoreData({...storeData, address:e.target.value})}/></div></div><div className="flex justify-end"><button disabled={saving} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition-all">{saving?'Saving...':'Simpan Perubahan'}</button></div></form>
                     </div>
                     {isBranchModalOpen && (
                         <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                 <h3 className="font-bold text-xl mb-6 text-slate-800">Buka Cabang Baru</h3>
                                 <form onSubmit={handleCreateBranch} className="space-y-4">
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama Cabang</label>
                                         <input name="name" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="Contoh: iFix Jakarta Selatan" required/>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Alamat Cabang</label>
                                         <input name="address" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="Alamat lengkap..." required/>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">No Telepon</label>
                                         <input name="phone" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="08..." required/>
                                     </div>
                                     <div className="flex gap-3 mt-6">
                                         <button type="button" onClick={()=>setBranchModalOpen(false)} className="flex-1 py-3 border rounded-xl font-bold hover:bg-slate-50">Batal</button>
                                         <button disabled={saving} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                                             {saving && <Loader2 className="w-4 h-4 animate-spin"/>} Buat Cabang
                                         </button>
                                     </div>
                                 </form>
                             </div>
                         </div>
                     )}

                     {/* MASTER DATA MANAGEMENT */}
                     <div className="bg-gradient-to-br from-purple-50 to-blue-50 p-8 rounded-2xl border border-purple-200 shadow-sm">
                         <h3 className="font-bold text-xl mb-6 flex items-center gap-2 text-slate-800"><Settings className="w-6 h-6 text-purple-600"/> Master Data</h3>
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                             {[
                                 {
                                     title: '‚úì Cek Fungsional',
                                     desc: 'Kelola item QC fungsional',
                                     icon: <CheckCircle className="w-6 h-6 text-green-600"/>,
                                     onClick: () => setModal('qcItems'),
                                     color: 'from-green-50 to-green-100'
                                 },
                                 {
                                     title: 'üì¶ Kelengkapan',
                                     desc: 'Kelola item kelengkapan',
                                     icon: <Box className="w-6 h-6 text-blue-600"/>,
                                     onClick: () => setModal('kelengkapanItems'),
                                     color: 'from-blue-50 to-blue-100'
                                 },
                                 {
                                     title: 'üè∑Ô∏è Kategori Stok',
                                     desc: 'Kelola kategori & sub-kategori',
                                     icon: <Tag className="w-6 h-6 text-orange-600"/>,
                                     onClick: () => setModal('categoryItems'),
                                     color: 'from-orange-50 to-orange-100'
                                 },
                                 {
                                     title: 'üîñ Brand',
                                     desc: 'Kelola daftar brand produk',
                                     icon: <Tag className="w-6 h-6 text-purple-600"/>,
                                     onClick: () => setModal('brandItems'),
                                     color: 'from-purple-50 to-purple-100'
                                 },
                                 {
                                     title: '‚öôÔ∏è Pengaturan Stok',
                                     desc: 'Atur duplikasi & validasi',
                                     icon: <Settings className="w-6 h-6 text-slate-600"/>,
                                     onClick: () => setModal('inventorySettings'),
                                     color: 'from-slate-50 to-slate-100'
                                 }
                             ].map((item, idx) => (
                                 <button
                                     key={idx}
                                     onClick={item.onClick}
                                     className={`bg-gradient-to-br ${item.color} p-4 rounded-xl border border-slate-200 hover:shadow-md transition-all text-left group`}
                                 >
                                     <div className="flex items-center gap-3 mb-2">
                                         {item.icon}
                                         <h4 className="font-bold text-slate-800 group-hover:text-slate-900">{item.title}</h4>
                                     </div>
                                     <p className="text-xs text-slate-600">{item.desc}</p>
                                 </button>
                             ))}
                         </div>
                     </div>

                     {/* EMPLOYEE PERMISSIONS */}
                     <div className="bg-gradient-to-br from-cyan-50 to-blue-50 p-8 rounded-2xl border border-cyan-200 shadow-sm">
                         <h3 className="font-bold text-xl mb-6 flex items-center gap-2 text-slate-800"><ShieldCheck className="w-6 h-6 text-cyan-600"/> Hak Akses Karyawan</h3>
                         <p className="text-sm text-slate-600 mb-6">Kontrol fitur dan menu yang dapat diakses oleh Admin dan Teknisi di toko ini. <strong className="text-orange-600">Owner selalu punya akses penuh</strong> kecuali yang dikunci oleh Superadmin.</p>
                         <button 
                             onClick={() => setModal('storePermissions')}
                             className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white p-4 rounded-xl font-bold hover:from-cyan-700 hover:to-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg"
                         >
                             <Settings className="w-5 h-5"/>
                             Kelola Hak Akses Karyawan
                         </button>
                     </div>

                     <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-orange-500">
                         <div className="flex justify-between items-start">
                             <div>
                                 <h3 className="font-bold text-xl mb-2 flex items-center gap-2 text-slate-800"><Database className="w-6 h-6 text-orange-600"/> Backup & Restore Data</h3>
                                 <p className="text-sm text-slate-500 mb-6">Simpan data toko Anda secara berkala atau pindahkan data dari perangkat lain. File backup berformat .json.</p>
                             </div>
                             {activeOwner.plan === 'basic' && <span className="bg-slate-100 text-slate-500 px-3 py-1 rounded text-xs font-bold border border-slate-200">BASIC PLAN: LOCKED</span>}
                             {activeOwner.plan === 'pro' && <span className="bg-purple-100 text-purple-600 px-3 py-1 rounded text-xs font-bold border border-purple-200 flex items-center gap-1"><Crown className="w-3 h-3"/> PRO PLAN</span>}
                         </div>
                         
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div className={`bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center ${activeOwner.plan === 'basic' ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                 <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4"><HardDriveDownload className="w-6 h-6"/></div>
                                 <h4 className="font-bold text-slate-800">Download Backup</h4>
                                 <p className="text-xs text-slate-500 mt-2 mb-4">Simpan seluruh data servis, pelanggan, dan stok ke komputer Anda.</p>
                                 <button onClick={handleBackup} disabled={saving} className="mt-auto w-full py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">{saving ? 'Memproses...' : 'Download JSON'}</button>
                             </div>
                             <div className={`bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center ${activeOwner.plan === 'basic' ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                 <div className="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4"><HardDriveUpload className="w-6 h-6"/></div>
                                 <h4 className="font-bold text-slate-800">Restore Database</h4>
                                 <p className="text-xs text-slate-500 mt-2 mb-4">Upload file backup (.json) untuk mengembalikan data.</p>
                                 <label className={`mt-auto w-full py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 cursor-pointer flex items-center justify-center gap-2 ${restoring ? 'opacity-50 cursor-wait' : ''}`}>{restoring ? <Loader2 className="w-4 h-4 animate-spin"/> : <Upload className="w-4 h-4"/>} {restoring ? 'Merestore...' : 'Pilih File JSON'} <input type="file" accept=".json" onChange={handleRestore} disabled={restoring} className="hidden"/></label>
                             </div>
                         </div>
                     </div>

                     {/* DANGER ZONE - RESET DATA */}
                     <div className="bg-gradient-to-br from-red-50 to-orange-50 p-8 rounded-2xl border-2 border-red-200 shadow-sm">
                         <div className="flex justify-between items-start">
                             <div>
                                 <h3 className="font-bold text-xl mb-2 flex items-center gap-2 text-red-800"><AlertTriangle className="w-6 h-6 text-red-600"/> Danger Zone</h3>
                                 <p className="text-sm text-red-600 mb-6">
                                     ‚ö†Ô∏è <strong>PERINGATAN KERAS:</strong> Fitur ini akan menghapus SEMUA data toko secara permanen.
                                     <br/>Pastikan Anda sudah backup data sebelum menggunakan fitur ini.
                                 </p>
                             </div>
                         </div>
                         
                         <div className="bg-white p-6 rounded-xl border-2 border-red-200">
                             <div className="text-center">
                                 <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                     <Trash2 className="w-8 h-8"/>
                                 </div>
                                 <h4 className="font-bold text-red-800 text-lg mb-2">Reset Semua Data Toko</h4>
                                 <p className="text-sm text-red-600 mb-4">
                                     Menghapus <strong>SEMUA</strong> data:
                                 </p>
                                 <div className="bg-red-50 p-4 rounded-lg mb-6 text-left">
                                     <ul className="text-sm text-red-700 space-y-1">
                                         <li>‚Ä¢ üìã Semua data servis</li>
                                         <li>‚Ä¢ üí∞ Semua transaksi keuangan</li>
                                         <li>‚Ä¢ üë• Semua data pelanggan</li>
                                         <li>‚Ä¢ üì¶ Semua stok barang</li>
                                         <li className="text-red-800 font-bold mt-2">‚ö†Ô∏è Data TIDAK BISA dikembalikan!</li>
                                     </ul>
                                 </div>
                                 <button 
                                     onClick={resetAllData}
                                     disabled={restoring}
                                     className="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-all flex items-center justify-center gap-2 shadow-lg"
                                 >
                                     {restoring ? (
                                         <>
                                             <Loader2 className="w-5 h-5 animate-spin"/>
                                             Menghapus Data...
                                         </>
                                     ) : (
                                         <>
                                             <Trash2 className="w-5 h-5"/>
                                             Reset Semua Data
                                         </>
                                     )}
                                 </button>
                                 <p className="text-xs text-red-500 mt-3">
                                     üîí Konfirmasi ganda akan diminta sebelum eksekusi
                                 </p>
                             </div>
                         </div>
                     </div>

                     {/* USER GUIDE PDF */}
                     <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-8 rounded-2xl border border-blue-200 shadow-sm">
                         <div className="flex justify-between items-start mb-6">
                             <div>
                                 <h3 className="font-bold text-xl mb-2 flex items-center gap-2 text-slate-800"><FileText className="w-6 h-6 text-blue-600"/> Panduan Penggunaan Aplikasi</h3>
                                 <p className="text-sm text-slate-600">Download buku panduan lengkap dengan tutorial dan screenshot untuk setiap fitur</p>
                             </div>
                         </div>
                         
                         <div className="bg-white p-6 rounded-xl border border-blue-100">
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                 <div className="flex items-center gap-3">
                                     <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                         <FileText className="w-5 h-5 text-blue-600"/>
                                     </div>
                                     <div>
                                         <p className="font-bold text-sm">Format PDF</p>
                                         <p className="text-xs text-slate-500">Dokumen profesional</p>
                                     </div>
                                 </div>
                                 <div className="flex items-center gap-3">
                                     <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                         <ImageIcon className="w-5 h-5 text-green-600"/>
                                     </div>
                                     <div>
                                         <p className="font-bold text-sm">Dengan Screenshot</p>
                                         <p className="text-xs text-slate-500">Panduan visual lengkap</p>
                                     </div>
                                 </div>
                                 <div className="flex items-center gap-3">
                                     <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                         <Zap className="w-5 h-5 text-purple-600"/>
                                     </div>
                                     <div>
                                         <p className="font-bold text-sm">Auto-Update</p>
                                         <p className="text-xs text-slate-500">Fitur baru otomatis masuk</p>
                                     </div>
                                 </div>
                                 <div className="flex items-center gap-3">
                                     <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                         <Download className="w-5 h-5 text-orange-600"/>
                                     </div>
                                     <div>
                                         <p className="font-bold text-sm">Bisa Didownload</p>
                                         <p className="text-xs text-slate-500">Simpan offline</p>
                                     </div>
                                 </div>
                             </div>
                             
                             <div className="bg-slate-50 p-4 rounded-lg mb-4">
                                 <p className="text-sm font-bold text-slate-700 mb-2">üìö Isi Panduan:</p>
                                 <ul className="text-xs text-slate-600 space-y-1 ml-4">
                                     <li>‚úì Dashboard & Laporan</li>
                                     <li>‚úì Manajemen Servis HP</li>
                                     <li>‚úì Stok & Inventory</li>
                                     <li>‚úì Keuangan & Transaksi</li>
                                     <li>‚úì Customer & WhatsApp</li>
                                     <li>‚úì HR & Payroll (Absensi, Gaji, Cuti)</li>
                                     <li>‚úì User Management</li>
                                     <li>‚úì Multi-Branch</li>
                                     <li>‚úì Backup & Restore</li>
                                     <li>‚úì Tips & Trik</li>
                                 </ul>
                             </div>
                             
                             <button
                                 onClick={async () => {
                                     setSaving(true);
                                     try {
                                         const doc = new jsPDF('p', 'mm', 'a4');
                                         const pageWidth = doc.internal.pageSize.getWidth();
                                         const pageHeight = doc.internal.pageSize.getHeight();
                                         const margin = 15;
                                         let yPos = margin;

                                         // Helper function to add new page
                                         const checkPage = (neededSpace = 20) => {
                                             if (yPos + neededSpace > pageHeight - margin) {
                                                 doc.addPage();
                                                 yPos = margin;
                                                 return true;
                                             }
                                             return false;
                                         };

                                         // Cover Page
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(0, 0, pageWidth, pageHeight, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(32);
                                         doc.text('iFix POS', pageWidth / 2, 80, { align: 'center' });
                                         doc.setFontSize(18);
                                         doc.text('Panduan Penggunaan Aplikasi', pageWidth / 2, 100, { align: 'center' });
                                         doc.setFontSize(12);
                                         doc.text('Sistem Manajemen Service HP Profesional', pageWidth / 2, 120, { align: 'center' });
                                         doc.setFontSize(10);
                                         doc.text(`Versi ${new Date().getFullYear()}.${new Date().getMonth() + 1}`, pageWidth / 2, 140, { align: 'center' });
                                         doc.text(`Generated: ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`, pageWidth / 2, 150, { align: 'center' });
                                         doc.setFontSize(8);
                                         doc.text('(c) ' + (storeData.name || 'iFix POS'), pageWidth / 2, pageHeight - 20, { align: 'center' });

                                         // Table of Contents
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(20);
                                         doc.text('Daftar Isi', margin, yPos);
                                         yPos += 15;
                                         
                                         const chapters = [
                                             '1. Dashboard & Laporan',
                                             '2. Manajemen Servis HP',
                                             '3. Stok & Inventory',
                                             '4. Keuangan & Transaksi',
                                             '5. Customer Management',
                                             '6. HR & Payroll',
                                             '7. User Management',
                                             '8. Multi-Branch',
                                             '9. Settings & Backup'
                                         ];

                                         doc.setFontSize(11);
                                         chapters.forEach((chapter) => {
                                             doc.text(chapter, margin + 5, yPos);
                                             yPos += 8;
                                         });

                                         // Chapter 1: Dashboard
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('1. Dashboard & Laporan', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(10);
                                         doc.text('Dashboard adalah halaman utama yang menampilkan ringkasan bisnis Anda:', margin, yPos);
                                         yPos += 10;

                                         const dashboardFeatures = [
                                             '- Total Pendapatan: Jumlah keseluruhan uang masuk',
                                             '- Servis Aktif: Jumlah HP yang sedang dikerjakan',
                                             '- Stok Value: Total nilai inventory',
                                             '- Grafik Penjualan: Trend penjualan 7 hari terakhir',
                                             '- Status Servis: Breakdown servis per status',
                                             '- Top Services: Layanan paling laris'
                                         ];

                                         doc.setFontSize(9);
                                         dashboardFeatures.forEach(feature => {
                                             checkPage();
                                             doc.text(feature, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Dashboard
                                         yPos += 5;
                                         checkPage(80);
                                         const dashboardY = yPos;
                                         
                                         // Title ilustrasi
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Tampilan Dashboard', margin + 3, yPos + 5);
                                         yPos += 10;
                                         
                                         // Dashboard cards mockup
                                         const cardWidth = 40;
                                         const cardHeight = 25;
                                         const cardGap = 5;
                                         
                                         // Card 1: Total Pendapatan
                                         doc.setFillColor(239, 246, 255);
                                         doc.rect(margin, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(191, 219, 254);
                                         doc.rect(margin, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(59, 130, 246);
                                         doc.text('Total Pendapatan', margin + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(30, 64, 175);
                                         doc.text('Rp 15.000.000', margin + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('+12% dari bulan lalu', margin + 2, yPos + 18);
                                         
                                         // Card 2: Servis Aktif
                                         doc.setFillColor(254, 243, 199);
                                         doc.rect(margin + cardWidth + cardGap, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(253, 224, 71);
                                         doc.rect(margin + cardWidth + cardGap, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(202, 138, 4);
                                         doc.text('Servis Aktif', margin + cardWidth + cardGap + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(161, 98, 7);
                                         doc.text('24 Unit', margin + cardWidth + cardGap + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('Dalam proses', margin + cardWidth + cardGap + 2, yPos + 18);
                                         
                                         // Card 3: Stok Value
                                         doc.setFillColor(243, 232, 255);
                                         doc.rect(margin + (cardWidth + cardGap) * 2, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(216, 180, 254);
                                         doc.rect(margin + (cardWidth + cardGap) * 2, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(126, 34, 206);
                                         doc.text('Stok Value', margin + (cardWidth + cardGap) * 2 + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(91, 33, 182);
                                         doc.text('Rp 8.500.000', margin + (cardWidth + cardGap) * 2 + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('142 item', margin + (cardWidth + cardGap) * 2 + 2, yPos + 18);
                                         
                                         // Card 4: Customer
                                         doc.setFillColor(240, 253, 244);
                                         doc.rect(margin + (cardWidth + cardGap) * 3, yPos, cardWidth, cardHeight, 'F');
                                         doc.setDrawColor(134, 239, 172);
                                         doc.rect(margin + (cardWidth + cardGap) * 3, yPos, cardWidth, cardHeight, 'S');
                                         doc.setFontSize(7);
                                         doc.setTextColor(22, 163, 74);
                                         doc.text('Total Customer', margin + (cardWidth + cardGap) * 3 + 2, yPos + 5);
                                         doc.setFontSize(11);
                                         doc.setTextColor(21, 128, 61);
                                         doc.text('387 Orang', margin + (cardWidth + cardGap) * 3 + 2, yPos + 13);
                                         doc.setFontSize(6);
                                         doc.setTextColor(107, 114, 128);
                                         doc.text('Database lengkap', margin + (cardWidth + cardGap) * 3 + 2, yPos + 18);
                                         
                                         yPos += cardHeight + 10;
                                         
                                         // Chart mockup
                                         doc.setFillColor(248, 250, 252);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'F');
                                         doc.setDrawColor(226, 232, 240);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 35, 'S');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Grafik Penjualan 7 Hari Terakhir', margin + 3, yPos + 5);
                                         
                                         // Simple bar chart
                                         const barY = yPos + 10;
                                         const barWidth = 8;
                                         const barGap = 4;
                                         const heights = [15, 20, 18, 25, 22, 28, 24];
                                         const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
                                         
                                         heights.forEach((h, i) => {
                                             const x = margin + 10 + i * (barWidth + barGap);
                                             doc.setFillColor(59, 130, 246);
                                             doc.rect(x, barY + (25 - h), barWidth, h, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(days[i], x + 1, yPos + 33);
                                         });
                                         
                                         yPos += 40;

                                         // Chapter 2: Servis HP
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('2. Manajemen Servis HP', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Membuat Servis Baru', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const servisSteps = [
                                             '1. Klik tombol "+ Servis Baru"',
                                             '2. Pilih pelanggan (atau buat baru)',
                                             '3. Input detail HP:',
                                             '   - Merk & Tipe HP',
                                             '   - IMEI (opsional)',
                                             '   - Keluhan pelanggan',
                                             '   - Password HP (jika ada)',
                                             '4. Centang Cek Fungsional (kamera, mic, speaker, dll)',
                                             '5. Centang Kelengkapan (charger, case, dll)',
                                             '6. Input estimasi biaya dan tanggal selesai',
                                             '7. Klik "Simpan"'
                                         ];

                                         servisSteps.forEach(step => {
                                             checkPage();
                                             doc.text(step, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Form Servis
                                         yPos += 8;
                                         checkPage(90);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Form Input Servis Baru', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Form container
                                         doc.setFillColor(255, 255, 255);
                                         doc.setDrawColor(226, 232, 240);
                                         doc.setLineWidth(0.5);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 75, 'FD');
                                         
                                         // Form title
                                         doc.setFillColor(59, 130, 246);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
                                         doc.setFontSize(10);
                                         doc.setTextColor(255, 255, 255);
                                         doc.text('+ Servis Baru', margin + 3, yPos + 7);
                                         
                                         yPos += 15;
                                         
                                         // Form fields
                                         const formX = margin + 5;
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         
                                         // Customer
                                         doc.text('Customer:', formX, yPos);
                                         doc.setDrawColor(203, 213, 225);
                                         doc.rect(formX + 25, yPos - 3, 80, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Budi Santoso - 0812345678', formX + 27, yPos);
                                         yPos += 8;
                                         
                                         // HP Details
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Merk HP:', formX, yPos);
                                         doc.rect(formX + 25, yPos - 3, 35, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Samsung', formX + 27, yPos);
                                         
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Tipe:', formX + 70, yPos);
                                         doc.rect(formX + 80, yPos - 3, 35, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Galaxy S21', formX + 82, yPos);
                                         yPos += 8;
                                         
                                         // Keluhan
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Keluhan:', formX, yPos);
                                         doc.rect(formX + 25, yPos - 3, 80, 10, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Layar pecah, tidak bisa touch', formX + 27, yPos);
                                         yPos += 13;
                                         
                                         // Checkboxes - Cek Fungsional
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Cek Fungsional:', formX, yPos);
                                         yPos += 5;
                                         
                                         const checks = ['Kamera', 'Mic', 'Speaker', 'Touch'];
                                         checks.forEach((item, i) => {
                                             const x = formX + 5 + (i * 25);
                                             // Checkbox
                                             doc.setFillColor(34, 197, 94);
                                             doc.rect(x, yPos - 3, 3, 3, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(item, x + 5, yPos);
                                         });
                                         yPos += 7;
                                         
                                         // Estimasi
                                         doc.setFontSize(7);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Estimasi Biaya:', formX, yPos);
                                         doc.rect(formX + 30, yPos - 3, 30, 5, 'S');
                                         doc.setFontSize(6);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('Rp 500.000', formX + 32, yPos);
                                         yPos += 8;
                                         
                                         // Button
                                         doc.setFillColor(59, 130, 246);
                                         doc.rect(formX + 60, yPos - 3, 20, 6, 'F');
                                         doc.setFontSize(7);
                                         doc.setTextColor(255, 255, 255);
                                         doc.text('Simpan', formX + 65, yPos + 1);
                                         
                                         yPos += 15;

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Status Servis', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const statusFlow = [
                                             '- Diterima: HP baru masuk, sedang diperiksa',
                                             '- Diagnosa: Teknisi sedang menganalisa kerusakan',
                                             '- Menunggu Sparepart: Menunggu part datang',
                                             '- Selesai: HP sudah diperbaiki, siap diambil',
                                             '- Dibatalkan: Servis dibatalkan pelanggan'
                                         ];

                                         statusFlow.forEach(status => {
                                             checkPage();
                                             doc.text(status, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('C. Fitur Lanjutan', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const advancedFeatures = [
                                             '- Cetak Invoice: Print struk dengan logo toko',
                                             '- Share WhatsApp: Kirim update progress ke customer',
                                             '- Edit Servis: Ubah detail atau status',
                                             '- Hapus Servis: Hapus data (dengan permission)',
                                             '- Filter: Cari berdasarkan token, nama, atau HP',
                                             '- QR Code: Scan untuk cek status servis'
                                         ];

                                         advancedFeatures.forEach(feature => {
                                             checkPage();
                                             doc.text(feature, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Chapter 3: Stok & Inventory
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('3. Stok & Inventory', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Tambah Barang', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const stockSteps = [
                                             '1. Klik "+ Tambah Stok"',
                                             '2. Pilih kategori (Sparepart, Aksesoris, dll)',
                                             '3. Input nama barang',
                                             '4. Input harga beli (modal)',
                                             '5. Input harga jual',
                                             '6. Input jumlah stok',
                                             '7. Klik "Simpan"'
                                         ];

                                         stockSteps.forEach(step => {
                                             checkPage();
                                             doc.text(step, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Stock Opname', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const opnameSteps = [
                                             '1. Klik tab "Stock Opname"',
                                             '2. Input jumlah fisik di kolom "Input Fisik"',
                                             '3. Sistem otomatis hitung selisih',
                                             '4. Klik "Simpan Stock Opname"',
                                             '5. Data tersimpan di history'
                                         ];

                                         opnameSteps.forEach(step => {
                                             checkPage();
                                             doc.text(step, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Tabel Stok
                                         yPos += 8;
                                         checkPage(60);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Tabel Inventory Barang', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Table header
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
                                         doc.setDrawColor(226, 232, 240);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'S');
                                         
                                         doc.setFontSize(7);
                                         doc.setTextColor(51, 65, 85);
                                         doc.text('Nama Barang', margin + 2, yPos + 5);
                                         doc.text('Kategori', margin + 60, yPos + 5);
                                         doc.text('Stok', margin + 95, yPos + 5);
                                         doc.text('Harga Beli', margin + 115, yPos + 5);
                                         doc.text('Harga Jual', margin + 145, yPos + 5);
                                         yPos += 7;
                                         
                                         // Table rows
                                         const stockItems = [
                                             {name: 'LCD Samsung A52', cat: 'Sparepart', stock: '15', buy: '450.000', sell: '650.000'},
                                             {name: 'Baterai iPhone 12', cat: 'Sparepart', stock: '8', buy: '320.000', sell: '500.000'},
                                             {name: 'Casing Xiaomi Note', cat: 'Aksesoris', stock: '25', buy: '25.000', sell: '45.000'},
                                             {name: 'Charger Type-C', cat: 'Aksesoris', stock: '40', buy: '15.000', sell: '30.000'},
                                             {name: 'Tempered Glass', cat: 'Aksesoris', stock: '60', buy: '8.000', sell: '20.000'}
                                         ];
                                         
                                         doc.setFontSize(6);
                                         stockItems.forEach((item, i) => {
                                             const rowY = yPos;
                                             const bgColor = i % 2 === 0 ? [255, 255, 255] : [249, 250, 251];
                                             doc.setFillColor(...bgColor);
                                             doc.rect(margin, rowY, pageWidth - 2 * margin, 6, 'F');
                                             doc.setDrawColor(226, 232, 240);
                                             doc.rect(margin, rowY, pageWidth - 2 * margin, 6, 'S');
                                             
                                             doc.setTextColor(51, 65, 85);
                                             doc.text(item.name, margin + 2, rowY + 4);
                                             
                                             // Category badge
                                             const catColor = item.cat === 'Sparepart' ? [219, 234, 254] : [254, 240, 138];
                                             const catText = item.cat === 'Sparepart' ? [29, 78, 216] : [161, 98, 7];
                                             doc.setFillColor(...catColor);
                                             doc.rect(margin + 60, rowY + 1, 25, 4, 'F');
                                             doc.setFontSize(5);
                                             doc.setTextColor(...catText);
                                             doc.text(item.cat, margin + 62, rowY + 3.5);
                                             
                                             doc.setFontSize(6);
                                             doc.setTextColor(51, 65, 85);
                                             doc.text(item.stock, margin + 98, rowY + 4);
                                             doc.text('Rp ' + item.buy, margin + 115, rowY + 4);
                                             doc.setTextColor(22, 163, 74);
                                             doc.text('Rp ' + item.sell, margin + 145, rowY + 4);
                                             
                                             yPos += 6;
                                         });
                                         
                                         yPos += 5;

                                         // Chapter 4: Keuangan
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('4. Keuangan & Transaksi', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Jenis Transaksi', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const transactions = [
                                             '- Service: Pembayaran dari servis HP',
                                             '- Penjualan Barang: Jual sparepart/aksesoris',
                                             '- Pengeluaran: Biaya operasional (restok, dll)',
                                             '- Lain-lain: Transaksi diluar kategori utama'
                                         ];

                                         transactions.forEach(trx => {
                                             checkPage();
                                             doc.text(trx, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Laporan Keuangan', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const financeReports = [
                                             '- Total Pemasukan: Semua uang masuk',
                                             '- Total Pengeluaran: Semua biaya operasional',
                                             '- Profit Bersih: Pemasukan - Pengeluaran',
                                             '- Grafik Trend: Visualisasi keuangan',
                                             '- Export Excel: Download laporan'
                                         ];

                                         financeReports.forEach(report => {
                                             checkPage();
                                             doc.text(report, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Laporan Keuangan
                                         yPos += 8;
                                         checkPage(50);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Summary Laporan Keuangan', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Finance summary cards
                                         const financeCards = [
                                             {label: 'Total Pemasukan', value: 'Rp 25.500.000', icon: '', color: [34, 197, 94], bgColor: [240, 253, 244]},
                                             {label: 'Total Pengeluaran', value: 'Rp 12.000.000', icon: '', color: [239, 68, 68], bgColor: [254, 242, 242]},
                                             {label: 'Profit Bersih', value: 'Rp 13.500.000', icon: '', color: [59, 130, 246], bgColor: [239, 246, 255]}
                                         ];
                                         
                                         const cardW = 58;
                                         const cardH = 22;
                                         
                                         financeCards.forEach((card, i) => {
                                             const x = margin + (i * (cardW + 3));
                                             
                                             // Card background
                                             doc.setFillColor(...card.bgColor);
                                             doc.rect(x, yPos, cardW, cardH, 'F');
                                             doc.setDrawColor(...card.color);
                                             doc.setLineWidth(0.5);
                                             doc.rect(x, yPos, cardW, cardH, 'S');
                                             
                                             // Icon/Badge
                                             doc.setFillColor(...card.color);
                                             doc.circle(x + 5, yPos + 5, 3, 'F');
                                             
                                             // Label
                                             doc.setFontSize(7);
                                             doc.setTextColor(71, 85, 105);
                                             doc.text(card.label, x + 3, yPos + 12);
                                             
                                             // Value
                                             doc.setFontSize(10);
                                             doc.setTextColor(...card.color);
                                             doc.text(card.value, x + 3, yPos + 19);
                                         });
                                         
                                         yPos += cardH + 10;
                                         
                                         // Transaction list preview
                                         doc.setFillColor(255, 255, 255);
                                         doc.setDrawColor(226, 232, 240);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 25, 'FD');
                                         
                                         doc.setFontSize(8);
                                         doc.setTextColor(51, 65, 85);
                                         doc.text('Transaksi Terbaru', margin + 3, yPos + 5);
                                         yPos += 8;
                                         
                                         const recentTransactions = [
                                             {type: 'Service', desc: 'Ganti LCD Samsung A52', amount: '+650.000'},
                                             {type: 'Penjualan', desc: 'Charger Type-C x2', amount: '+60.000'},
                                             {type: 'Pengeluaran', desc: 'Restok Sparepart', amount: '-2.300.000'}
                                         ];
                                         
                                         doc.setFontSize(6);
                                         recentTransactions.forEach((trx, i) => {
                                             const typeColor = trx.type === 'Pengeluaran' ? [239, 68, 68] : [34, 197, 94];
                                             const bgColor = trx.type === 'Pengeluaran' ? [254, 226, 226] : [220, 252, 231];
                                             
                                             // Type badge
                                             doc.setFillColor(...bgColor);
                                             doc.rect(margin + 3, yPos - 2, 18, 4, 'F');
                                             doc.setFontSize(5);
                                             doc.setTextColor(...typeColor);
                                             doc.text(trx.type, margin + 5, yPos);
                                             
                                             // Description
                                             doc.setFontSize(6);
                                             doc.setTextColor(71, 85, 105);
                                             doc.text(trx.desc, margin + 25, yPos);
                                             
                                             // Amount
                                             doc.setTextColor(...typeColor);
                                             doc.text('Rp ' + trx.amount, margin + 140, yPos);
                                             
                                             yPos += 6;
                                         });
                                         
                                         yPos += 5;

                                         // Chapter 5: Customer
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('5. Customer Management', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const customerFeatures = [
                                             '- Database Pelanggan: Simpan semua data customer',
                                             '- Riwayat Servis: Lihat semua servis customer',
                                             '- Auto WhatsApp: Link langsung ke chat WA',
                                             '- Sync dari Servis: Otomatis tambah saat buat servis',
                                             '- Edit & Hapus: Kelola data customer',
                                             '- Search: Cari berdasarkan nama atau nomor'
                                         ];

                                         customerFeatures.forEach(feature => {
                                             checkPage();
                                             doc.text(feature, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Customer Cards
                                         yPos += 8;
                                         checkPage(70);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Daftar Customer', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         const customers = [
                                             {name: 'Ahmad Fadli', phone: '0812-3456-7890', count: 5, lastService: '15 Des 2024'},
                                             {name: 'Dewi Kartika', phone: '0856-7890-1234', count: 3, lastService: '10 Des 2024'},
                                             {name: 'Budi Setiawan', phone: '0821-5678-9012', count: 8, lastService: '18 Des 2024'}
                                         ];
                                         
                                         customers.forEach((customer, i) => {
                                             // Card container
                                             doc.setFillColor(255, 255, 255);
                                             doc.setDrawColor(226, 232, 240);
                                             doc.setLineWidth(0.3);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 18, 'FD');
                                             
                                             // Avatar circle
                                             doc.setFillColor(59, 130, 246);
                                             doc.circle(margin + 8, yPos + 8, 4, 'F');
                                             doc.setFontSize(7);
                                             doc.setTextColor(255, 255, 255);
                                             doc.text(customer.name.charAt(0), margin + 6.5, yPos + 9.5);
                                             
                                             // Customer name
                                             doc.setFontSize(8);
                                             doc.setTextColor(15, 23, 42);
                                             doc.text(customer.name, margin + 15, yPos + 6);
                                             
                                             // Phone number
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(customer.phone, margin + 15, yPos + 11);
                                             
                                             // Service count badge
                                             doc.setFillColor(240, 253, 244);
                                             doc.rect(margin + 15, yPos + 13, 18, 4, 'F');
                                             doc.setFontSize(5);
                                             doc.setTextColor(34, 197, 94);
                                             doc.text(customer.count + ' servis', margin + 16, yPos + 15.8);
                                             
                                             // Last service date
                                             doc.setFontSize(6);
                                             doc.setTextColor(148, 163, 184);
                                             doc.text('Terakhir: ' + customer.lastService, margin + 15, yPos + 18);
                                             
                                             // WhatsApp button
                                             doc.setFillColor(34, 197, 94);
                                             doc.roundedRect(margin + 150, yPos + 6, 20, 6, 1, 1, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(255, 255, 255);
                                             doc.text('WhatsApp', margin + 153, yPos + 10);
                                             
                                             // History button
                                             doc.setDrawColor(148, 163, 184);
                                             doc.setLineWidth(0.3);
                                             doc.roundedRect(margin + 125, yPos + 6, 20, 6, 1, 1, 'S');
                                             doc.setTextColor(71, 85, 105);
                                             doc.text('Riwayat', margin + 130, yPos + 10);
                                             
                                             yPos += 20;
                                         });

                                         // Chapter 6: HR & Payroll
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('6. HR & Payroll Management', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Absensi', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const absensi = [
                                             '- Karyawan: Check-in/out sendiri',
                                             '- Owner: Monitor real-time semua karyawan',
                                             '- Auto Hitung: Jam kerja otomatis terhitung',
                                             '- Riwayat: Database absensi lengkap'
                                         ];

                                         absensi.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Absensi Karyawan
                                         yPos += 8;
                                         checkPage(70);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Dashboard Absensi Karyawan', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Employee attendance cards
                                         const employees = [
                                             {name: 'Ahmad Rizki', role: 'Teknisi', status: 'active', checkIn: '08:15', checkOut: '-'},
                                             {name: 'Siti Nurhaliza', role: 'Admin', status: 'done', checkIn: '08:00', checkOut: '17:00'},
                                             {name: 'Budi Santoso', role: 'Teknisi', status: 'notyet', checkIn: '-', checkOut: '-'}
                                         ];
                                         
                                         employees.forEach((emp, i) => {
                                             const cardY = yPos;
                                             
                                             // Card container
                                             doc.setFillColor(255, 255, 255);
                                             doc.setDrawColor(226, 232, 240);
                                             doc.rect(margin, cardY, pageWidth - 2 * margin, 18, 'FD');
                                             
                                             // Employee info
                                             doc.setFontSize(8);
                                             doc.setTextColor(30, 41, 59);
                                             doc.text(emp.name, margin + 3, cardY + 5);
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(emp.role, margin + 3, cardY + 9);
                                             
                                             // Status badge
                                             const statusColors = {
                                                 active: {bg: [254, 243, 199], text: [161, 98, 7], label: 'Aktif'},
                                                 done: {bg: [220, 252, 231], text: [21, 128, 61], label: 'Selesai'},
                                                 notyet: {bg: [241, 245, 249], text: [100, 116, 139], label: 'Belum'}
                                             };
                                             const status = statusColors[emp.status];
                                             doc.setFillColor(...status.bg);
                                             doc.rect(margin + 130, cardY + 2, 18, 5, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(...status.text);
                                             doc.text(status.label, margin + 134, cardY + 5.5);
                                             
                                             // Time info
                                             doc.setFontSize(6);
                                             doc.setTextColor(71, 85, 105);
                                             doc.text('Check In:', margin + 3, cardY + 13);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(emp.checkIn, margin + 18, cardY + 13);
                                             
                                             doc.setTextColor(71, 85, 105);
                                             doc.text('Check Out:', margin + 35, cardY + 13);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(emp.checkOut, margin + 52, cardY + 13);
                                             
                                             // Buttons
                                             if (emp.status === 'notyet') {
                                                 doc.setFillColor(34, 197, 94);
                                                 doc.rect(margin + 75, cardY + 10, 15, 5, 'F');
                                                 doc.setFontSize(6);
                                                 doc.setTextColor(255, 255, 255);
                                                 doc.text('Check In', margin + 77, cardY + 13.5);
                                             } else if (emp.status === 'active') {
                                                 doc.setFillColor(239, 68, 68);
                                                 doc.rect(margin + 75, cardY + 10, 16, 5, 'F');
                                                 doc.setFontSize(6);
                                                 doc.setTextColor(255, 255, 255);
                                                 doc.text('Check Out', margin + 77, cardY + 13.5);
                                             }
                                             
                                             yPos += 19;
                                         });
                                         
                                         yPos += 3;

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Gaji Tetap', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const salary = [
                                             '- Set Sekali Pakai: Input gaji pokok per karyawan',
                                             '- Rate Komisi: Tentukan % komisi',
                                             '- Auto-Generate: Generate payroll semua karyawan',
                                             '- Update Mudah: Edit kapan saja'
                                         ];

                                         salary.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('C. Payroll', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const payroll = [
                                             '- Generate Manual: Input per karyawan',
                                             '- Auto-Generate: Dari gaji tetap',
                                             '- Komponen: Gaji + Komisi + Bonus - Potongan',
                                             '- Edit & Hapus: Kelola payroll',
                                             '- Status: Pending atau Paid'
                                         ];

                                         payroll.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('D. Cuti', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const cuti = [
                                             '- Karyawan: Ajukan cuti sendiri',
                                             '- Owner: Approve/Reject pengajuan',
                                             '- Tipe: Tahunan, Sakit, Izin, Lainnya',
                                             '- Status: Pending, Disetujui, Ditolak'
                                         ];

                                         cuti.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('E. Anggaran Bulanan', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const budget = [
                                             '- Catat Pengeluaran Rutin: Sewa, listrik, dll',
                                             '- Kategori: Terorganisir per jenis',
                                             '- Jatuh Tempo: Reminder pembayaran',
                                             '- Dashboard: Total & rata-rata anggaran'
                                         ];

                                         budget.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Chapter 7: User Management
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('7. User Management', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const userMgmt = [
                                             '- Role: Owner, Admin, Teknisi',
                                             '- Tambah Karyawan: Buat akun dengan email & password',
                                             '- Edit: Ubah nama, role, atau status',
                                             '- Hapus: Remove user dari sistem',
                                             '- Password: Set saat membuat akun'
                                         ];

                                         userMgmt.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi User Management Table
                                         yPos += 8;
                                         checkPage(50);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Daftar User', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Table header
                                         doc.setFillColor(248, 250, 252);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
                                         doc.setFontSize(7);
                                         doc.setTextColor(51, 65, 85);
                                         doc.text('Nama', margin + 3, yPos + 4.5);
                                         doc.text('Email', margin + 50, yPos + 4.5);
                                         doc.text('Role', margin + 110, yPos + 4.5);
                                         doc.text('Status', margin + 140, yPos + 4.5);
                                         doc.text('Aksi', margin + 165, yPos + 4.5);
                                         yPos += 7;
                                         
                                         const users = [
                                             {name: 'Anda (Owner)', email: 'owner@ifix.com', role: 'Owner', status: 'Aktif', roleColor: [139, 92, 246], bgColor: [237, 233, 254]},
                                             {name: 'Ahmad Admin', email: 'admin@ifix.com', role: 'Admin', status: 'Aktif', roleColor: [59, 130, 246], bgColor: [239, 246, 255]},
                                             {name: 'Budi Teknisi', email: 'teknisi1@ifix.com', role: 'Teknisi', status: 'Aktif', roleColor: [34, 197, 94], bgColor: [240, 253, 244]},
                                             {name: 'Siti Kasir', email: 'kasir@ifix.com', role: 'Teknisi', status: 'Nonaktif', roleColor: [34, 197, 94], bgColor: [240, 253, 244]}
                                         ];
                                         
                                         users.forEach((user, i) => {
                                             const rowColor = i % 2 === 0 ? [255, 255, 255] : [249, 250, 251];
                                             doc.setFillColor(...rowColor);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
                                             
                                             doc.setFontSize(7);
                                             doc.setTextColor(15, 23, 42);
                                             doc.text(user.name, margin + 3, yPos + 6);
                                             
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(user.email, margin + 50, yPos + 6);
                                             
                                             // Role badge
                                             doc.setFillColor(...user.bgColor);
                                             doc.rect(margin + 110, yPos + 2.5, 20, 5, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(...user.roleColor);
                                             doc.text(user.role, margin + 113, yPos + 5.5);
                                             
                                             // Status badge
                                             const isActive = user.status === 'Aktif';
                                             doc.setFillColor(isActive ? 220 : 254, isActive ? 252 : 226, isActive ? 231 : 226);
                                             doc.rect(margin + 140, yPos + 2.5, 18, 5, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(isActive ? 34 : 239, isActive ? 197 : 68, isActive ? 94 : 68);
                                             doc.text(user.status, margin + 142, yPos + 5.5);
                                             
                                             // Action buttons
                                             doc.setFontSize(5);
                                             doc.setTextColor(59, 130, 246);
                                             doc.text('Edit', margin + 165, yPos + 4);
                                             doc.setTextColor(239, 68, 68);
                                             doc.text('Hapus', margin + 165, yPos + 8);
                                             
                                             yPos += 10;
                                         });

                                         // Chapter 8: Multi-Branch
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('8. Multi-Branch System', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const multiBranch = [
                                             '- Buka Cabang Baru: Unlimited untuk PRO Plan',
                                             '- Data Terpisah: Setiap cabang punya data sendiri',
                                             '- Switch Branch: Pindah cabang dengan mudah',
                                             '- All Stores: Lihat gabungan semua cabang',
                                             '- Sentralisasi: Owner kontrol semua cabang'
                                         ];

                                         multiBranch.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 6;
                                         });

                                         // Ilustrasi Branch Selector
                                         yPos += 8;
                                         checkPage(55);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Pilih Cabang', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         const branches = [
                                             {name: 'All Stores', desc: 'Gabungan semua cabang', count: 150, isActive: true},
                                             {name: 'iFix Surabaya Pusat', desc: 'Jl. Raya Darmo No. 123', count: 85, isActive: false},
                                             {name: 'iFix Surabaya Timur', desc: 'Jl. Ahmad Yani No. 45', count: 42, isActive: false},
                                             {name: 'iFix Sidoarjo', desc: 'Jl. Pahlawan No. 67', count: 23, isActive: false}
                                         ];
                                         
                                         branches.forEach((branch, i) => {
                                             // Card container
                                             const borderColor = branch.isActive ? [37, 99, 235] : [226, 232, 240];
                                             const bgColor = branch.isActive ? [239, 246, 255] : [255, 255, 255];
                                             
                                             doc.setFillColor(...bgColor);
                                             doc.setDrawColor(...borderColor);
                                             doc.setLineWidth(branch.isActive ? 0.8 : 0.3);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 12, 'FD');
                                             
                                             // Branch icon
                                             doc.setFillColor(37, 99, 235);
                                             doc.circle(margin + 6, yPos + 6, 3, 'F');
                                             doc.setFontSize(6);
                                             doc.setTextColor(255, 255, 255);
                                             doc.text('', margin + 5, yPos + 7);
                                             
                                             // Branch name
                                             doc.setFontSize(8);
                                             doc.setTextColor(15, 23, 42);
                                             doc.text(branch.name, margin + 12, yPos + 5);
                                             
                                             // Description
                                             doc.setFontSize(6);
                                             doc.setTextColor(100, 116, 139);
                                             doc.text(branch.desc, margin + 12, yPos + 9);
                                             
                                             // Transaction count badge
                                             doc.setFillColor(240, 253, 244);
                                             doc.rect(margin + 130, yPos + 3, 25, 6, 'F');
                                             doc.setFontSize(7);
                                             doc.setTextColor(34, 197, 94);
                                             doc.text(branch.count + ' transaksi', margin + 132, yPos + 7);
                                             
                                             // Active indicator
                                             if (branch.isActive) {
                                                 doc.setFillColor(34, 197, 94);
                                                 doc.circle(margin + 165, yPos + 6, 2, 'F');
                                                 doc.setFontSize(6);
                                                 doc.setTextColor(34, 197, 94);
                                                 doc.text('Aktif', margin + 168, yPos + 7);
                                             }
                                             
                                             yPos += 13;
                                         });

                                         // Chapter 9: Settings
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(37, 99, 235);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('9. Settings & Backup', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(11);
                                         doc.text('A. Profil Toko', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const settings = [
                                             '- Upload Logo: Muncul di struk/invoice',
                                             '- Nama Toko: Identitas bisnis',
                                             '- Alamat & Telepon: Info kontak'
                                         ];

                                         settings.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('B. Backup & Restore', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const backup = [
                                             '- Download Backup: Export semua data ke JSON',
                                             '- Restore: Import data dari file backup',
                                             '- Hanya PRO Plan: Fitur premium',
                                             '- Backup Berkala: Disarankan mingguan'
                                         ];

                                         backup.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         yPos += 10;
                                         doc.setFontSize(11);
                                         doc.text('C. Hak Akses', margin, yPos);
                                         yPos += 8;

                                         doc.setFontSize(9);
                                         const permissions = [
                                             '- Hapus Data: Izinkan admin hapus servis',
                                             '- Cetak Invoice: Akses printer',
                                             '- Share WhatsApp: Kirim ke customer',
                                             '- Tambah Stok: Input barang baru'
                                         ];

                                         permissions.forEach(item => {
                                             checkPage();
                                             doc.text(item, margin + 5, yPos);
                                             yPos += 5;
                                         });

                                         // Ilustrasi Settings Panel
                                         yPos += 10;
                                         checkPage(65);
                                         
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
                                         doc.setFontSize(8);
                                         doc.setTextColor(71, 85, 105);
                                         doc.text('Screenshot: Halaman Settings', margin + 3, yPos + 5);
                                         yPos += 12;
                                         
                                         // Settings sections
                                         const settingsSections = [
                                             {
                                                 title: 'Profil Toko',
                                                 items: [
                                                     {label: 'Nama Toko', value: 'iFix Phone Repair', type: 'input'},
                                                     {label: 'Alamat', value: 'Jl. Raya Darmo No. 123, Surabaya', type: 'input'},
                                                     {label: 'Telepon', value: '031-5678901', type: 'input'}
                                                 ]
                                             },
                                             {
                                                 title: 'Hak Akses',
                                                 items: [
                                                     {label: 'Admin boleh hapus data', value: true, type: 'toggle'},
                                                     {label: 'Teknisi bisa cetak invoice', value: true, type: 'toggle'},
                                                     {label: 'Auto-backup harian', value: false, type: 'toggle'}
                                                 ]
                                             }
                                         ];
                                         
                                         settingsSections.forEach((section, idx) => {
                                             // Section header
                                             doc.setFillColor(248, 250, 252);
                                             doc.rect(margin, yPos, pageWidth - 2 * margin, 7, 'F');
                                             doc.setFontSize(8);
                                             doc.setTextColor(51, 65, 85);
                                             doc.text(section.title, margin + 3, yPos + 4.5);
                                             yPos += 7;
                                             
                                             // Section items
                                             section.items.forEach((item, i) => {
                                                 doc.setFillColor(255, 255, 255);
                                                 doc.setDrawColor(226, 232, 240);
                                                 doc.setLineWidth(0.2);
                                                 doc.rect(margin, yPos, pageWidth - 2 * margin, 9, 'FD');
                                                 
                                                 doc.setFontSize(7);
                                                 doc.setTextColor(71, 85, 105);
                                                 doc.text(item.label, margin + 3, yPos + 5);
                                                 
                                                 if (item.type === 'input') {
                                                     // Input field
                                                     doc.setFillColor(249, 250, 251);
                                                     doc.setDrawColor(203, 213, 225);
                                                     doc.rect(margin + 90, yPos + 2, 80, 5, 'FD');
                                                     doc.setFontSize(6);
                                                     doc.setTextColor(15, 23, 42);
                                                     doc.text(item.value, margin + 92, yPos + 5.5);
                                                 } else if (item.type === 'toggle') {
                                                     // Toggle switch
                                                     const toggleOn = item.value;
                                                     doc.setFillColor(toggleOn ? 34 : 203, toggleOn ? 197 : 213, toggleOn ? 94 : 225);
                                                     doc.roundedRect(margin + 155, yPos + 2.5, 12, 4, 2, 2, 'F');
                                                     doc.setFillColor(255, 255, 255);
                                                     doc.circle(margin + (toggleOn ? 163 : 159), yPos + 4.5, 1.5, 'F');
                                                 }
                                                 
                                                 yPos += 9;
                                             });
                                             
                                             yPos += 3;
                                         });
                                         
                                         // Save button
                                         doc.setFillColor(37, 99, 235);
                                         doc.roundedRect(margin + 135, yPos, 35, 7, 1, 1, 'F');
                                         doc.setFontSize(7);
                                         doc.setTextColor(255, 255, 255);
                                         doc.text('Simpan Perubahan', margin + 140, yPos + 4.5);

                                         // Tips & Tricks
                                         doc.addPage();
                                         yPos = margin;
                                         doc.setFillColor(16, 185, 129);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 15, 'F');
                                         doc.setTextColor(255, 255, 255);
                                         doc.setFontSize(16);
                                         doc.text('Tips & Trik Penggunaan', margin + 5, yPos + 10);
                                         yPos += 20;

                                         doc.setTextColor(0, 0, 0);
                                         doc.setFontSize(9);
                                         const tips = [
                                             '1. Backup rutin setiap minggu untuk keamanan data',
                                             '2. Gunakan fitur filter untuk pencarian cepat',
                                             '3. Set gaji tetap untuk efisiensi generate payroll',
                                             '4. Manfaatkan WhatsApp untuk komunikasi customer',
                                             '5. Cek dashboard setiap pagi untuk monitoring',
                                             '6. Stock opname minimal sebulan sekali',
                                             '7. Update status servis real-time untuk akurasi',
                                             '8. Gunakan kategori untuk organisasi stok',
                                             '9. Aktifkan hak akses sesuai posisi karyawan',
                                             '10. Download laporan keuangan untuk analisa bulanan'
                                         ];

                                         tips.forEach(tip => {
                                             checkPage();
                                             doc.text(tip, margin + 5, yPos);
                                             yPos += 7;
                                         });

                                         // Footer
                                         doc.addPage();
                                         yPos = pageHeight / 2 - 20;
                                         doc.setFillColor(241, 245, 249);
                                         doc.rect(margin, yPos, pageWidth - 2 * margin, 60, 'F');
                                         doc.setTextColor(51, 65, 85);
                                         doc.setFontSize(14);
                                         doc.text('Terima Kasih!', pageWidth / 2, yPos + 15, { align: 'center' });
                                         doc.setFontSize(10);
                                         doc.text('Untuk pertanyaan atau bantuan lebih lanjut,', pageWidth / 2, yPos + 25, { align: 'center' });
                                         doc.text('hubungi admin atau superadmin Anda.', pageWidth / 2, yPos + 32, { align: 'center' });
                                         doc.setFontSize(8);
                                         doc.setTextColor(100, 116, 139);
                                         doc.text('iFix POS - Professional Service Management System', pageWidth / 2, yPos + 45, { align: 'center' });

                                         // Save PDF
                                         doc.save(`Panduan_iFix_POS_${new Date().toISOString().slice(0,10)}.pdf`);
                                         alert('‚úÖ Panduan berhasil didownload!');
                                     } catch (err) {
                                         alert('Error: ' + err.message);
                                         console.error(err);
                                     } finally {
                                         setSaving(false);
                                     }
                                 }}
                                 disabled={saving}
                                 className="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition-all flex items-center justify-center gap-2"
                             >
                                 {saving ? (
                                     <>
                                         <Loader2 className="w-5 h-5 animate-spin"/>
                                         Generating PDF...
                                     </>
                                 ) : (
                                     <>
                                         <Download className="w-5 h-5"/>
                                         Download Panduan PDF
                                     </>
                                 )}
                             </button>
                         </div>
                     </div>
                     
                     {/* MODAL RENDERING */}
                     {modal === 'qcItems' && <QCFunctionalItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'kelengkapanItems' && <KelengkapanItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'categoryItems' && <CategoryItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} storeId={activeStore?.id} />}
                     {modal === 'brandItems' && <BrandItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'inventorySettings' && <InventorySettingsModal close={()=>setModal(null)} ownerId={activeOwner?.id} storeId={activeStore?.id} />}
                     
                     {modal === 'storePermissions' && (
                         <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-2">
                             <div className="bg-slate-800 border border-slate-700 w-full max-w-[98vw] rounded-2xl shadow-2xl h-[96vh] overflow-hidden flex flex-col">
                                 <div className="flex items-center justify-between gap-3 p-6 border-b border-slate-700 bg-slate-750">
                                     <div className="flex items-center gap-3">
                                         <div className="w-10 h-10 rounded-full bg-cyan-600 flex items-center justify-center font-bold text-white text-lg">
                                             <ShieldCheck className="w-6 h-6"/>
                                         </div>
                                         <div className="flex-1">
                                             <div className="flex items-center gap-2">
                                                 <h3 className="font-bold text-lg text-white">{activeStore?.name || 'Pengaturan Toko'}</h3>
                                                 <span className="bg-green-500/20 text-green-300 text-[10px] font-bold px-2 py-0.5 rounded-full border border-green-500/30 flex items-center gap-1">
                                                     <span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                                                     REAL-TIME SYNC
                                                 </span>
                                             </div>
                                             <p className="text-xs text-cyan-300">Hak Akses Karyawan (Admin & Teknisi) - Owner Selalu Punya Akses Penuh</p>
                                         </div>
                                     </div>
                                     <button 
                                         type="button" 
                                         onClick={()=>setModal(null)} 
                                         className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700 rounded-lg"
                                     >
                                         <X className="w-5 h-5"/>
                                     </button>
                                 </div>
                                 <div className="px-6 pt-4">
                                     <p className="text-slate-400 text-sm bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                                         <span className="text-cyan-400 font-bold">‚ÑπÔ∏è INFO:</span> Fitur yang dinonaktifkan akan <strong>tersembunyi</strong> dari Admin dan Teknisi di toko ini. Owner tetap bisa akses semua fitur (kecuali yang dikunci Superadmin). <span className="text-green-400 font-bold">‚úì Perubahan langsung tersinkronisasi real-time</span> ke semua perangkat karyawan.
                                     </p>
                                 </div>
                                 <form onSubmit={saveStorePermissions} className="flex-1 overflow-y-auto p-6 space-y-6">
                                     <div className="space-y-4">
                                         <div className="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-blue-300 mb-3 flex items-center gap-2">
                                                 <LayoutDashboard className="w-4 h-4"/> MENU UTAMA
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_dashboard', label: 'üìä Dashboard', locked: ownerAccess?.menu_dashboard === false},
                                                     {id: 'menu_report', label: 'üìà Laporan', locked: ownerAccess?.menu_report === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={config?.[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-green-300 mb-3 flex items-center gap-2">
                                                 <Smartphone className="w-4 h-4"/> MENU TRANSAKSI
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_service', label: 'üì± Servis HP', locked: ownerAccess?.menu_service === false},
                                                     {id: 'menu_sales', label: 'üõí Penjualan', locked: ownerAccess?.menu_sales === false},
                                                     {id: 'menu_purchase', label: 'üõçÔ∏è Pembelian', locked: ownerAccess?.menu_purchase === false},
                                                     {id: 'menu_return_sales', label: '‚Ü©Ô∏è Retur Penjualan', locked: ownerAccess?.menu_return_sales === false},
                                                     {id: 'menu_return_purchase', label: '‚Ü™Ô∏è Retur Pembelian', locked: ownerAccess?.menu_return_purchase === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={config?.[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-yellow-300 mb-3 flex items-center gap-2">
                                                 <Wallet className="w-4 h-4"/> MENU KEUANGAN
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_payable', label: 'üì§ Utang', locked: ownerAccess?.menu_payable === false},
                                                     {id: 'menu_receivable', label: 'üì• Piutang', locked: ownerAccess?.menu_receivable === false},
                                                     {id: 'menu_cash', label: 'üíµ Kas', locked: ownerAccess?.menu_cash === false},
                                                     {id: 'menu_finance', label: 'üí≥ Laporan Keuangan', locked: ownerAccess?.menu_finance === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={config?.[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-purple-300 mb-3 flex items-center gap-2">
                                                 <Box className="w-4 h-4"/> MENU INVENTORY & DATA
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'menu_inventory', label: 'üì¶ Stok Barang', locked: ownerAccess?.menu_inventory === false},
                                                     {id: 'menu_supplier', label: 'üöö Supplier', locked: ownerAccess?.menu_supplier === false},
                                                     {id: 'menu_customers', label: 'üë• Pelanggan', locked: ownerAccess?.menu_customers === false},
                                                     {id: 'menu_hr', label: 'üëî HR & Payroll', locked: ownerAccess?.menu_hr === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={config?.[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>

                                         <div className="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-4">
                                             <h4 className="font-bold text-cyan-300 mb-3 flex items-center gap-2">
                                                 <ShieldCheck className="w-4 h-4"/> FITUR & AKSI
                                             </h4>
                                             <div className="grid grid-cols-1 gap-3">
                                                 {[
                                                     {id: 'feature_service_edit', label: '‚úèÔ∏è Edit Servis', locked: ownerAccess?.feature_service_edit === false},
                                                     {id: 'feature_sales_edit', label: '‚úèÔ∏è Edit Penjualan', locked: ownerAccess?.feature_sales_edit === false},
                                                     {id: 'feature_inventory_edit', label: '‚úèÔ∏è Edit Inventory', locked: ownerAccess?.feature_inventory_edit === false},
                                                     {id: 'feature_customer_edit', label: '‚úèÔ∏è Edit Pelanggan', locked: ownerAccess?.feature_customer_edit === false},
                                                     {id: 'feature_employee_edit', label: '‚úèÔ∏è Edit Pegawai', locked: ownerAccess?.feature_employee_edit === false},
                                                     {id: 'feature_finance_edit', label: '‚úèÔ∏è Edit Keuangan', locked: ownerAccess?.feature_finance_edit === false},
                                                     {id: 'feature_print', label: 'üñ®Ô∏è Cetak Invoice', locked: ownerAccess?.feature_print === false},
                                                     {id: 'feature_share', label: 'üí¨ Share WhatsApp', locked: ownerAccess?.feature_share === false},
                                                     {id: 'feature_delete', label: 'üóëÔ∏è Hapus Data', locked: ownerAccess?.feature_delete === false},
                                                     {id: 'feature_stock_add', label: '‚ûï Tambah Stok', locked: ownerAccess?.feature_stock_add === false},
                                                     {id: 'feature_backup', label: 'üíæ Backup Data', locked: ownerAccess?.feature_backup === false},
                                                     {id: 'feature_import_export', label: 'üì§ Import/Export', locked: ownerAccess?.feature_import_export === false},
                                                     {id: 'feature_multi_branch', label: 'üè¢ Multi Cabang', locked: ownerAccess?.feature_multi_branch === false},
                                                     {id: 'feature_qc_checklist', label: '‚úÖ QC Checklist', locked: ownerAccess?.feature_qc_checklist === false},
                                                     {id: 'feature_kelengkapan', label: 'üìã Kelengkapan Item', locked: ownerAccess?.feature_kelengkapan === false},
                                                     {id: 'feature_accounting', label: 'üìä Akuntansi', locked: ownerAccess?.feature_accounting === false}
                                                 ].map(item => (
                                                     <label key={item.id} className={`flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 ${item.locked ? 'opacity-50 cursor-not-allowed' : 'hover:border-slate-500 cursor-pointer'} group`}>
                                                         <span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm flex items-center gap-2">
                                                             {item.locked && <Lock className="w-3 h-3 text-red-500"/>}
                                                             {item.label}
                                                         </span>
                                                         <div className="relative flex items-center">
                                                             <input 
                                                                 type="checkbox" 
                                                                 name={item.id} 
                                                                 defaultChecked={config?.[item.id] !== false}
                                                                 disabled={item.locked}
                                                                 className="peer sr-only"
                                                             />
                                                             <div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600 peer-disabled:opacity-30"></div>
                                                         </div>
                                                     </label>
                                                 ))}
                                             </div>
                                         </div>
                                     </div>
                                     <div className="flex gap-3 pt-4 border-t border-slate-700">
                                         <button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700 text-sm">Batal</button>
                                         <button disabled={saving} className="flex-1 py-3 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-700 text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                             {saving ? (
                                                 <>
                                                     <Loader2 className="w-4 h-4 animate-spin"/>
                                                     Menyimpan & Sync...
                                                 </>
                                             ) : (
                                                 <>
                                                     <Save className="w-4 h-4"/>
                                                     Simpan Pengaturan
                                                 </>
                                             )}
                                         </button>
                                     </div>
                                 </form>
                             </div>
                         </div>
                     )}
                 </div>
             );
        };
        const UserManager = () => {
             const { user, activeOwner, activeStore, checkPermission } = useContext(SessionContext);
             const { data: users } = useFirestoreCollection('users', activeOwner?.id);
             const { data: stores } = useFirestoreCollection('stores', activeOwner?.id);
             const [modal, setModal] = useState(null);
             const [editUserModal, setEditUserModal] = useState(null);
             const [userCurrentPage, setUserCurrentPage] = useState(1);
             const [userItemsPerPage, setUserItemsPerPage] = useState(10);
             
             const effectiveRole = user.role === 'superadmin' ? 'owner' : user.role;
             if (effectiveRole !== 'owner') return null;
             
             // Check permission for editing employee
             const canEditEmployee = checkPermission('feature_employee_edit');

             const addUser = async (userData) => { 
                 try { 
                     // Create Firebase Auth user with secondary app (to avoid logout current user)
                     let newUid = null; 
                     const secondaryApp = initializeApp(firebaseConfig, "SecondaryEmployee"); 
                     const secondaryAuth = getAuth(secondaryApp); 
                     
                     try { 
                         const userCred = await createUserWithEmailAndPassword(secondaryAuth, userData.email, userData.password); 
                         newUid = userCred.user.uid; 
                         await signOut(secondaryAuth); 
                     } catch(authErr) { 
                         if(authErr.code === 'auth/email-already-in-use') { 
                             throw new Error("Email ini sudah terdaftar."); 
                         } 
                         if(authErr.code === 'auth/weak-password') { 
                             throw new Error("Password terlalu lemah. Minimal 6 karakter."); 
                         } 
                         throw authErr; 
                     } finally { 
                         await deleteApp(secondaryApp); 
                     } 
                     
                     // Remove password from userData before saving to Firestore
                     const { password, ...userDataWithoutPassword } = userData;
                     
                     // Save user data to Firestore
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), { 
                         ...userDataWithoutPassword, 
                         uid: newUid,
                         ownerId: activeOwner.id, 
                         createdAt: serverTimestamp() 
                     }); 
                     
                     setModal(null); 
                     alert(`‚úÖ Pegawai berhasil ditambahkan!\n\nEmail: ${userData.email}\nPassword: ${userData.password}\n\nPegawai dapat langsung login menggunakan kredensial di atas.`); 
                 } catch(e) { 
                     alert("Error: " + e.message); 
                 } 
             };
             const deleteUser = async (id) => { if(confirm("Hapus akses user ini?")) { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', id)); } };
             
             const handleEditUser = async (e) => {
                 e.preventDefault();
                 const newName = e.target.name.value;
                 const newRole = e.target.role.value;
                 const newStore = e.target.storeId.value;
                 try {
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', editUserModal.id), {
                         name: newName,
                         role: newRole,
                         storeId: newStore
                     });
                     setEditUserModal(null);
                     alert("Data Pegawai Diperbarui");
                 } catch(err) {
                     alert("Gagal update: " + err.message);
                 }
             };

             return (
                 <div className="space-y-6">
                    <div className="flex justify-between items-center"><h2 className="text-xl md:text-2xl font-bold text-slate-800">Pegawai & Akses</h2><button onClick={()=>setModal({})} className="bg-blue-600 text-white px-3 md:px-5 py-2 md:py-2.5 rounded-xl font-bold flex items-center gap-2 text-xs md:text-sm shadow-lg hover:bg-blue-700"><Plus className="w-4 h-4"/> <span className="hidden sm:inline">Tambah Pegawai</span><span className="sm:hidden">Tambah</span></button></div>
                    
                    {/* Desktop Table View */}
                    <div className="mobile-card-wrapper">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase text-xs tracking-wider">
                                    <tr><th className="p-4">Nama</th><th className="p-4">Email</th><th className="p-4">Role</th><th className="p-4">Penempatan Toko</th><th className="p-4">Aksi</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {users.slice((userCurrentPage - 1) * userItemsPerPage, userCurrentPage * userItemsPerPage).map(u => { 
                                        const storeName = stores.find(s => s.id === u.storeId)?.name || 'Semua (Owner)'; 
                                        return (
                                            <tr key={u.id} className="hover:bg-slate-50">
                                                <td className="p-4 font-bold text-slate-700">
                                                    {u.name} {u.role === 'owner' && <span className="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded ml-2">OWNER</span>}
                                                </td>
                                                <td className="p-4 text-slate-500">{u.email}</td>
                                                <td className="p-4"><span className="uppercase text-xs font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">{u.role}</span></td>
                                                <td className="p-4 text-slate-500 font-medium">{storeName}</td>
                                                <td className="p-4">
                                                    <div className="flex gap-2">
                                                        {u.role !== 'owner' && canEditEmployee && (
                                                            <button onClick={()=>setEditUserModal(u)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil className="w-4 h-4"/></button>
                                                        )}
                                                        {u.role !== 'owner' && (
                                                            <button onClick={()=>deleteUser(u.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4"/></button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ); 
                                    })}
                                </tbody>
                            </table>
                        </div>
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {users.slice((userCurrentPage - 1) * userItemsPerPage, userCurrentPage * userItemsPerPage).map(u => {
                                const storeName = stores.find(s => s.id === u.storeId)?.name || 'Semua (Owner)';
                                return (
                                    <div key={u.id} className="mobile-card">
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Nama</span>
                                            <span className="mobile-card-value">
                                                {u.name} {u.role === 'owner' && <span className="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded ml-1">OWNER</span>}
                                            </span>
                                        </div>
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Email</span>
                                            <span className="mobile-card-value text-xs">{u.email}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Role</span>
                                            <span className="mobile-card-value"><span className="uppercase text-[10px] font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">{u.role}</span></span>
                                        </div>
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Toko</span>
                                            <span className="mobile-card-value text-xs">{storeName}</span>
                                        </div>
                                        {u.role !== 'owner' && (
                                            <div className="mobile-card-actions">
                                                {canEditEmployee && (
                                                    <button onClick={()=>setEditUserModal(u)} className="flex-1 bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                                        <Pencil className="w-3 h-3"/> Edit
                                                    </button>
                                                )}
                                                <button onClick={()=>deleteUser(u.id)} className="flex-1 bg-red-50 text-red-600 px-3 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1">
                                                    <Trash2 className="w-3 h-3"/> Hapus
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {users.length > userItemsPerPage && (
                        <div className="p-4 border-t border-slate-200">
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                    <select value={userItemsPerPage} onChange={(e) => { setUserItemsPerPage(parseInt(e.target.value)); setUserCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                    </select>
                                    <span className="text-sm text-slate-600">per halaman</span>
                                </div>
                                <div className="text-sm text-slate-600">
                                    Menampilkan {Math.min((userCurrentPage - 1) * userItemsPerPage + 1, users.length)} - {Math.min(userCurrentPage * userItemsPerPage, users.length)} dari {users.length}
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => { if (userCurrentPage > 1) setUserCurrentPage(userCurrentPage - 1); }} disabled={userCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                    <div className="flex space-x-1">
                                        {Array.from({ length: Math.ceil(users.length / userItemsPerPage) }, (_, i) => {
                                            const p = i + 1;
                                            if (p === 1 || p === Math.ceil(users.length / userItemsPerPage) || (p >= userCurrentPage - 2 && p <= userCurrentPage + 2)) {
                                                return <button key={p} onClick={() => setUserCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === userCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                            } else if (p === userCurrentPage - 3 || p === userCurrentPage + 3) {
                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    <button onClick={() => { const tp = Math.ceil(users.length / userItemsPerPage); if (userCurrentPage < tp) setUserCurrentPage(userCurrentPage + 1); }} disabled={userCurrentPage === Math.ceil(users.length / userItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl"><h3 className="font-bold text-xl mb-6">Tambah Karyawan Baru</h3><form onSubmit={(e) => { e.preventDefault(); const formData = new FormData(e.target); addUser(Object.fromEntries(formData)); }} className="space-y-4"><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama</label><input name="name" className="w-full border p-2.5 rounded-lg" required/></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Email</label><input name="email" type="email" className="w-full border p-2.5 rounded-lg" required/></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Password</label><input name="password" type="password" className="w-full border p-2.5 rounded-lg" required minLength="6" placeholder="Min. 6 karakter"/><p className="text-xs text-slate-500 mt-1">Password ini akan digunakan pegawai untuk login</p></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Role</label><select name="role" className="w-full border p-2.5 rounded-lg"><option value="admin">Admin</option><option value="kasir">Kasir</option><option value="teknisi">Teknisi</option></select></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Penempatan Toko</label><select name="storeId" className="w-full border p-2.5 rounded-lg">{stores.map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div><div className="flex gap-3 mt-8"><button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Simpan</button></div></form></div></div>)}

                    {editUserModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold text-xl mb-6">Edit Data Pegawai</h3>
                                <form onSubmit={handleEditUser} className="space-y-4">
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama</label><input name="name" defaultValue={editUserModal.name} className="w-full border p-2.5 rounded-lg" required/></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Email (Tidak bisa diubah)</label><input value={editUserModal.email} disabled className="w-full border p-2.5 rounded-lg bg-gray-100 text-gray-500"/></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Role</label><select name="role" defaultValue={editUserModal.role} className="w-full border p-2.5 rounded-lg"><option value="admin">Admin</option><option value="kasir">Kasir</option><option value="teknisi">Teknisi</option></select></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Penempatan Toko</label><select name="storeId" defaultValue={editUserModal.storeId} className="w-full border p-2.5 rounded-lg">{stores.map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div>
                                    <div className="flex gap-3 mt-8"><button type="button" onClick={()=>setEditUserModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Update</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                 </div>
             );
        };

        // ==========================================
        // üí∞ PURCHASE MANAGER (Pembelian)
        // ==========================================
        const PurchaseManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [purchases, setPurchases] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ supplierId: '', items: [], paymentMethod: 'cash', notes: '' });
            const [items, setItems] = useState([{ productId: '', productName: '', qty: 0, price: 0, subcategory: '' }]);
            const [purchaseCashAccount, setPurchaseCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [brands, setBrands] = useState([]);
            const [customCategories, setCustomCategories] = useState([]);
            const [subCategories, setSubCategories] = useState({});
            const [filterBrand, setFilterBrand] = useState('');
            const [filterCategory, setFilterCategory] = useState('');
            const [searchTerms, setSearchTerms] = useState({}); // Search terms for each item index
            const [dropdownOpen, setDropdownOpen] = useState({}); // Track which dropdown is open

            // Auto-clear search terms when filter changes to show filtered products
            useEffect(() => {
                if (filterBrand || filterCategory) {
                    setSearchTerms({});
                }
            }, [filterBrand, filterCategory]);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const purchasesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases');
                let q = query(purchasesRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(purchasesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const suppliersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers');
                const qSupplier = query(suppliersRef, where('ownerId', '==', activeOwner.id));
                const unsubSupplier = onSnapshot(qSupplier, (snapshot) => {
                    setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const inventoryRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory');
                const qInv = activeStore?.id && activeStore.id !== 'all' 
                    ? query(inventoryRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id))
                    : query(inventoryRef, where('ownerId', '==', activeOwner.id));
                const unsubInv = onSnapshot(qInv, (snapshot) => {
                    setInventory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                // Load brands
                const brandsQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'brands'), where('ownerId', '==', activeOwner.id));
                const unsubBrands = onSnapshot(brandsQ, (snapshot) => {
                    setBrands(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                // Load categories and subcategories from store_configs
                let qConfig;
                if (activeStore?.id && activeStore.id !== 'all') {
                    qConfig = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id), 
                        where('storeId', '==', activeStore.id));
                } else {
                    qConfig = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), 
                        where('ownerId', '==', activeOwner.id));
                }
                const unsubConfig = onSnapshot(qConfig, (snapshot) => {
                    const allCats = new Set();
                    const allSubCats = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.customCategories && Array.isArray(data.customCategories)) {
                            data.customCategories.forEach(cat => allCats.add(cat));
                        }
                        if (data.subCategories && typeof data.subCategories === 'object') {
                            Object.assign(allSubCats, data.subCategories);
                        }
                    });
                    setCustomCategories(Array.from(allCats));
                    setSubCategories(allSubCats);
                    console.log('üì¶ Purchase Manager - Loaded Categories:', Array.from(allCats));
                    console.log('üì¶ Purchase Manager - Loaded SubCategories:', allSubCats);
                });

                return () => { unsubscribe(); unsubSupplier(); unsubInv(); unsubBrands(); unsubConfig(); };
            }, [activeOwner?.id, activeStore?.id]);

            // Build category list
            const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
            const allCategories = [...new Set([...defaultCategories, ...customCategories])];

            // Filter inventory by brand & category for item selection
            const filteredInventory = inventory.filter(i => {
                const matchBrand = !filterBrand || (i.brand && i.brand === filterBrand);
                const matchCategory = !filterCategory || (i.category && i.category === filterCategory);
                return matchBrand && matchCategory;
            });

            // Log filtered results when filters change
            useEffect(() => {
                if (filterBrand || filterCategory) {
                    console.log('üîç Active Filters:', { filterBrand, filterCategory });
                    console.log('üîç Filtered Inventory Count:', filteredInventory.length);
                    console.log('üîç Total Inventory Count:', inventory.length);
                }
            }, [filterBrand, filterCategory, filteredInventory.length, inventory.length]);

            const addItem = () => setItems([...items, { productId: '', productName: '', qty: 0, price: 0, subcategory: '' }]);
            
            const removeItem = (idx) => {
                setItems(items.filter((_, i) => i !== idx));
                // Clean up search terms and dropdown state for removed item
                setSearchTerms(prev => {
                    const newState = { ...prev };
                    delete newState[idx];
                    // Re-index remaining items
                    const reindexed = {};
                    Object.keys(newState).forEach(key => {
                        const keyNum = parseInt(key);
                        if (keyNum > idx) {
                            reindexed[keyNum - 1] = newState[key];
                        } else {
                            reindexed[key] = newState[key];
                        }
                    });
                    return reindexed;
                });
                setDropdownOpen(prev => {
                    const newState = { ...prev };
                    delete newState[idx];
                    // Re-index remaining items
                    const reindexed = {};
                    Object.keys(newState).forEach(key => {
                        const keyNum = parseInt(key);
                        if (keyNum > idx) {
                            reindexed[keyNum - 1] = newState[key];
                        } else {
                            reindexed[key] = newState[key];
                        }
                    });
                    return reindexed;
                });
            };
            const updateItem = (idx, field, value) => {
                const newItems = [...items];
                newItems[idx][field] = value;
                if (field === 'productId') {
                    const product = inventory.find(p => p.id === value);
                    if (product) {
                        newItems[idx].productName = product.name;
                        newItems[idx].price = product.buyPrice || 0;
                    }
                    // Clear search term and close dropdown when product is selected
                    setSearchTerms(prev => ({ ...prev, [idx]: '' }));
                    setDropdownOpen(prev => ({ ...prev, [idx]: false }));
                }
                setItems(newItems);
            };

            const handleSearchChange = (idx, value) => {
                setSearchTerms(prev => ({ ...prev, [idx]: value }));
                setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                
                // Clear selected product if search term is cleared
                if (!value.trim()) {
                    updateItem(idx, 'productId', '');
                }
            };

            const selectProduct = (idx, product) => {
                updateItem(idx, 'productId', product.id);
            };

            const getFilteredProducts = (idx) => {
                const searchTerm = searchTerms[idx]?.toLowerCase() || '';
                if (!searchTerm) return filteredInventory;
                
                return filteredInventory.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.brand && product.brand.toLowerCase().includes(searchTerm)) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                    (product.subCategory && product.subCategory.toLowerCase().includes(searchTerm))
                );
            };

            const submitPurchase = async (e) => {
                e.preventDefault();
                if (items.length === 0 || items.some(i => !i.productId || i.qty <= 0)) {
                    alert('Isi semua item dengan benar!');
                    return;
                }

                try {
                    const total = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
                    const purchaseData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        supplierId: form.supplierId,
                        supplierName: suppliers.find(s => s.id === form.supplierId)?.name || 'Unknown',
                        items: items,
                        total: total,
                        paymentMethod: form.paymentMethod,
                        notes: form.notes,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases'), purchaseData);

                    // Update stock for each item
                    for (const item of items) {
                        const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                        await runTransaction(db, async (transaction) => {
                            const productSnap = await transaction.get(productRef);
                            if (productSnap.exists()) {
                                transaction.update(productRef, {
                                    stock: increment(item.qty)
                                });
                            }
                        });
                    }

                    // Add to expense transactions (only if not kredit)
                    if (form.paymentMethod !== 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'expense',
                            category: 'Pembelian Barang',
                            description: `Pembelian dari ${purchaseData.supplierName}`,
                            amount: total,
                            cashAccount: purchaseCashAccount,
                            date: serverTimestamp()
                        });
                    }

                    // If credit, create payable (debt)
                    if (form.paymentMethod === 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'payable',
                            customerName: purchaseData.supplierName,
                            amount: total,
                            paid: 0,
                            remaining: total,
                            description: `Pembelian barang - ${items.map(i => i.productName).join(', ')}`,
                            dueDate: null,
                            status: 'unpaid',
                            createdAt: serverTimestamp()
                        });
                    }

                    alert('‚úÖ Pembelian berhasil dicatat!');
                    closeModal();
                    setPurchaseCashAccount('Kas Tunai');
                    setFilterBrand('');
                    setFilterCategory('');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = purchases.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedPurchases = purchases.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };
            
            const resetForm = () => {
                setForm({ supplierId: '', items: [], paymentMethod: 'cash', notes: '' });
                setItems([{ productId: '', productName: '', qty: 0, price: 0, subcategory: '' }]);
                setSearchTerms({});
                setDropdownOpen({});
            };
            
            const openModal = () => {
                resetForm();
                setModal(true);
            };
            
            const closeModal = () => {
                resetForm();
                setModal(false);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üì¶ Pembelian</h2>
                        <button onClick={openModal} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Pembelian
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto mobile-card-wrapper">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-left">Pembayaran</th>
                                    <th className="p-3 text-left">Catatan</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedPurchases.map(p => (
                                    <tr key={p.id}>
                                        <td className="p-3 text-gray-500">{formatDate(p.createdAt)}</td>
                                        <td className="p-3 font-medium">{p.supplierName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {p.items.map((item, idx) => (
                                                    <div key={idx}>
                                                        {item.productName} x{item.qty}
                                                        {item.subcategory && <span className="ml-1 text-[10px] bg-purple-100 text-purple-700 px-1 rounded">{item.subcategory}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(p.total)}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${p.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : p.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {p.paymentMethod === 'cash' ? 'Tunai' : p.paymentMethod === 'credit' ? 'üí≥ Kredit' : 'Transfer'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-xs text-gray-500">{p.notes || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {purchases.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data pembelian</div>}
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedPurchases.map(p => (
                                <div key={p.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Tanggal</span>
                                        <span className="mobile-card-value text-xs">{formatDate(p.createdAt)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Supplier</span>
                                        <span className="mobile-card-value">{p.supplierName}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Item</span>
                                        <span className="mobile-card-value">
                                            <div className="text-xs space-y-1">
                                                {p.items.map((item, idx) => (
                                                    <div key={idx}>
                                                        {item.productName} x{item.qty}
                                                        {item.subcategory && <span className="ml-1 text-[10px] bg-purple-100 text-purple-700 px-1 rounded">{item.subcategory}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Total</span>
                                        <span className="mobile-card-value font-bold text-blue-600">{formatCurrency(p.total)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Pembayaran</span>
                                        <span className="mobile-card-value">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${p.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : p.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {p.paymentMethod === 'cash' ? 'Tunai' : p.paymentMethod === 'credit' ? 'üí≥ Kredit' : 'Transfer'}
                                            </span>
                                        </span>
                                    </div>
                                    {p.notes && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Catatan</span>
                                            <span className="mobile-card-value text-xs">{p.notes}</span>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {purchases.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data pembelian</div>}
                        </div>
                    </div>

                    {purchases.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Pembelian</h3>
                                <form onSubmit={submitPurchase} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Supplier</label>
                                        <select value={form.supplierId} onChange={e => setForm({ ...form, supplierId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Supplier --</option>
                                            {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                    </div>

                                    {/* Filter Brand & Kategori */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <div>
                                            <label className="text-xs font-bold text-blue-600 mb-1 block">üè∑Ô∏è Filter Brand</label>
                                            <select value={filterBrand} onChange={e => setFilterBrand(e.target.value)} className="w-full border border-blue-300 p-2 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                                <option value="">-- Semua Brand --</option>
                                                {brands.map(b => <option key={b.id} value={b.name}>{b.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-blue-600 mb-1 block">üìÇ Filter Kategori</label>
                                            <select value={filterCategory} onChange={e => setFilterCategory(e.target.value)} className="w-full border border-blue-300 p-2 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                                <option value="">-- Semua Kategori --</option>
                                                {allCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        {(filterBrand || filterCategory) && (
                                            <div className="col-span-2 flex items-center justify-between">
                                                <span className="text-xs text-blue-600">Menampilkan {filteredInventory.length} dari {inventory.length} produk</span>
                                                <button type="button" onClick={() => { setFilterBrand(''); setFilterCategory(''); }} className="text-xs text-blue-700 hover:underline font-bold">Reset Filter</button>
                                            </div>
                                        )}
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-bold text-slate-500">Item Pembelian</label>
                                            <button type="button" onClick={addItem} className="text-xs bg-green-600 text-white px-3 py-1 rounded">+ Item</button>
                                        </div>
                                        {items.map((item, idx) => {
                                            const selectedProduct = inventory.find(p => p.id === item.productId);
                                            const filteredProducts = getFilteredProducts(idx);
                                            const isOpen = dropdownOpen[idx] || false;
                                            // Get subcategories for selected product's category
                                            const availableSubCategories = selectedProduct?.category && subCategories[selectedProduct.category] 
                                                ? subCategories[selectedProduct.category] 
                                                : [];
                                            
                                            // Debug log when product is selected
                                            if (selectedProduct && idx === 0) {
                                                console.log('üîç Selected Product:', selectedProduct.name);
                                                console.log('üîç Product Category:', selectedProduct.category);
                                                console.log('üîç Available SubCategories:', availableSubCategories);
                                            }
                                            
                                            return (
                                                <div key={idx} className="flex gap-2 mb-2">
                                                    {/* Custom Searchable Product Dropdown */}
                                                    <div className="flex-1 relative">
                                                        <input
                                                            type="text"
                                                            value={selectedProduct ? `${selectedProduct.name}${selectedProduct.brand ? ` (${selectedProduct.brand})` : ''}${selectedProduct.subCategory ? ` [${selectedProduct.subCategory}]` : ''}` : (searchTerms[idx] || '')}
                                                            onChange={(e) => {
                                                                // If a product is selected, clear it first to allow re-searching
                                                                if (selectedProduct) {
                                                                    const newItems = [...items];
                                                                    newItems[idx].productId = '';
                                                                    newItems[idx].productName = '';
                                                                    newItems[idx].price = 0;
                                                                    setItems(newItems);
                                                                    setSearchTerms(prev => ({ ...prev, [idx]: '' }));
                                                                    setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                                                                    return;
                                                                }
                                                                handleSearchChange(idx, e.target.value);
                                                            }}
                                                            onFocus={() => {
                                                                // If no product selected, show dropdown immediately
                                                                if (!selectedProduct) {
                                                                    setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                                                                }
                                                            }}
                                                            onClick={() => {
                                                                // If product is selected, clear it and show dropdown for re-search
                                                                if (selectedProduct) {
                                                                    const newItems = [...items];
                                                                    newItems[idx].productId = '';
                                                                    newItems[idx].productName = '';
                                                                    newItems[idx].price = 0;
                                                                    setItems(newItems);
                                                                    setSearchTerms(prev => ({ ...prev, [idx]: '' }));
                                                                    setDropdownOpen(prev => ({ ...prev, [idx]: true }));
                                                                }
                                                            }}
                                                            placeholder="Ketik untuk cari produk..."
                                                            className="w-full border p-2 rounded text-sm"
                                                            required
                                                        />
                                                        
                                                        {/* Dropdown Options */}
                                                        {isOpen && (
                                                            <div className="absolute z-20 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto mt-1">
                                                                {filteredProducts.length > 0 ? (
                                                                    filteredProducts.slice(0, 10).map(product => (
                                                                        <button
                                                                            key={product.id}
                                                                            type="button"
                                                                            onClick={() => selectProduct(idx, product)}
                                                                            className="w-full text-left px-3 py-2 hover:bg-blue-50 text-sm border-b border-gray-100 last:border-b-0"
                                                                        >
                                                                            <div className="font-medium text-slate-800">{product.name}</div>
                                                                            <div className="text-xs text-slate-500 flex items-center gap-1 mt-1">
                                                                                {product.brand && <span className="bg-blue-100 text-blue-700 px-1 rounded">{product.brand}</span>}
                                                                                {product.category && <span className="bg-green-100 text-green-700 px-1 rounded">{product.category}</span>}
                                                                {product.subCategory && <span className="bg-purple-100 text-purple-700 px-1 rounded">{product.subCategory}</span>}
                                                                                <span className="text-slate-400">Stok: {product.stock || 0}</span>
                                                                                <span className="text-slate-400">|</span>
                                                                                <span className="text-slate-600 font-medium">Beli: {formatCurrency(product.buyPrice || 0)}</span>
                                                                            </div>
                                                                        </button>
                                                                    ))
                                                                ) : (
                                                                    <div className="px-3 py-2 text-sm text-gray-500">
                                                                        {(filterBrand || filterSubCategory) ? (
                                                                            <div>
                                                                                <div className="font-medium text-orange-600">Tidak ada produk ditemukan</div>
                                                                                <div className="text-xs mt-1">
                                                                                    {filterBrand && <div>‚Ä¢ Brand: {filterBrand}</div>}
                                                                                    {filterCategory && <div>‚Ä¢ Kategori: {filterCategory}</div>}
                                                                                    {searchTerms[idx] && <div>‚Ä¢ Pencarian: "{searchTerms[idx]}"</div>}
                                                                                </div>
                                                                            </div>
                                                                        ) : (
                                                                            searchTerms[idx] ? `Tidak ada produk "${searchTerms[idx]}" ditemukan` : 'Ketik untuk mencari produk...'
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {filteredProducts.length > 10 && (
                                                                    <div className="px-3 py-2 text-xs text-gray-400 bg-gray-50 font-medium">
                                                                        {filteredProducts.length - 10} produk lainnya... (ketik lebih spesifik)
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Click outside to close */}
                                                        {isOpen && (
                                                            <div 
                                                                className="fixed inset-0 z-5"
                                                                onClick={() => setDropdownOpen(prev => ({ ...prev, [idx]: false }))}
                                                            ></div>
                                                        )}
                                                    </div>
                                                    
                                                    <select 
                                                        value={item.subcategory} 
                                                        onChange={e => updateItem(idx, 'subcategory', e.target.value)} 
                                                        className="w-36 border p-2 rounded text-sm" 
                                                        disabled={!selectedProduct}
                                                        required={availableSubCategories.length > 0}
                                                    >
                                                        <option value="">{selectedProduct ? (availableSubCategories.length > 0 ? 'Pilih Sub Kategori' : 'Tidak Ada Sub') : 'Pilih Produk Dulu'}</option>
                                                        {availableSubCategories.map(sub => <option key={sub} value={sub}>{sub}</option>)}
                                                    </select>
                                                    <NumberInput value={item.qty} onChange={val => updateItem(idx, 'qty', val)} placeholder="Qty" className="w-20 border p-2 rounded text-sm" required />
                                                    <NumberInput value={item.price} onChange={val => updateItem(idx, 'price', val)} placeholder="Harga" className="w-32 border p-2 rounded text-sm" required />
                                                    {items.length > 1 && <button type="button" onClick={() => removeItem(idx)} className="text-red-600 px-2"><Trash2 className="w-4 h-4" /></button>}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Total</label>
                                        <div className="text-2xl font-bold text-blue-600">{formatCurrency(items.reduce((sum, i) => sum + (i.qty * i.price), 0))}</div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Metode Pembayaran</label>
                                        <select value={form.paymentMethod} onChange={e => setForm({ ...form, paymentMethod: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="cash">Tunai</option>
                                            <option value="transfer">Transfer</option>
                                            <option value="credit">üí≥ Kredit (Hutang)</option>
                                        </select>
                                        {form.paymentMethod === 'credit' && (
                                            <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Akan otomatis dicatat sebagai utang ke supplier</p>
                                        )}
                                    </div>

                                    {form.paymentMethod !== 'credit' && (
                                        <CashAccountSelect value={purchaseCashAccount} onChange={setPurchaseCashAccount} />
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Catatan</label>
                                        <textarea value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Catatan tambahan..."></textarea>
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={closeModal} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üöö SUPPLIER MANAGER
        // ==========================================
        const SupplierManager = () => {
            const { activeOwner } = useContext(SessionContext);
            const [suppliers, setSuppliers] = useState([]);
            const [modal, setModal] = useState(false);
            const [editModal, setEditModal] = useState(null);
            const [form, setForm] = useState({ name: '', phone: '', address: '', email: '' });
            const [supplierCurrentPage, setSupplierCurrentPage] = useState(1);
            const [supplierItemsPerPage, setSupplierItemsPerPage] = useState(9);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), where('ownerId', '==', activeOwner.id));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id]);

            const addSupplier = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), {
                        ownerId: activeOwner.id,
                        name: form.name,
                        phone: form.phone,
                        address: form.address,
                        email: form.email,
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Supplier berhasil ditambahkan!');
                    setModal(false);
                    setForm({ name: '', phone: '', address: '', email: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const updateSupplier = async (e) => {
                e.preventDefault();
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'suppliers', editModal.id), {
                        name: form.name,
                        phone: form.phone,
                        address: form.address,
                        email: form.email
                    });
                    alert('‚úÖ Supplier berhasil diperbarui!');
                    setEditModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteSupplier = async (supplier) => {
                if (!confirm(`Hapus supplier "${supplier.name}"?`)) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'suppliers', supplier.id));
                    alert('‚úÖ Supplier berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üöö Supplier</h2>
                        <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Supplier
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {(() => {
                            const supStart = (supplierCurrentPage - 1) * supplierItemsPerPage;
                            const supEnd = supStart + supplierItemsPerPage;
                            return suppliers.slice(supStart, supEnd).map(s => (
                            <div key={s.id} className="bg-white border rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start mb-3">
                                    <h3 className="font-bold text-lg">{s.name}</h3>
                                    <div className="flex gap-1">
                                        <button onClick={() => { setForm(s); setEditModal(s); }} className="text-blue-600 p-1 hover:bg-blue-50 rounded"><Pencil className="w-4 h-4" /></button>
                                        <button onClick={() => deleteSupplier(s)} className="text-red-600 p-1 hover:bg-red-50 rounded"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                </div>
                                <div className="space-y-2 text-sm text-gray-600">
                                    <div className="flex items-center gap-2">
                                        <svg className="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652a11.952 11.952 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.905 3.686" fill="#25D366"/>
                                        </svg>
                                        {s.phone || '-'}
                                    </div>
                                    <div className="flex items-center gap-2"><Mail className="w-3 h-3" /> {s.email || '-'}</div>
                                    <div className="flex items-start gap-2"><MapPin className="w-3 h-3 mt-1" /> <span className="flex-1">{s.address || '-'}</span></div>
                                </div>
                            </div>
                        ));
                        })()}
                    </div>
                    {suppliers.length === 0 && <div className="bg-white rounded-lg p-8 text-center text-gray-400">Belum ada data supplier</div>}
                    
                    {/* Pagination Controls for Suppliers */}
                    {suppliers.length > supplierItemsPerPage && (
                        <div className="pt-4 border-t border-slate-200">
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                    <select value={supplierItemsPerPage} onChange={(e) => { setSupplierItemsPerPage(parseInt(e.target.value)); setSupplierCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                        <option value="6">6</option><option value="9">9</option><option value="12">12</option><option value="24">24</option>
                                    </select>
                                    <span className="text-sm text-slate-600">per halaman</span>
                                </div>
                                <div className="text-sm text-slate-600">
                                    Menampilkan {Math.min((supplierCurrentPage - 1) * supplierItemsPerPage + 1, suppliers.length)} - {Math.min(supplierCurrentPage * supplierItemsPerPage, suppliers.length)} dari {suppliers.length}
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => { if (supplierCurrentPage > 1) setSupplierCurrentPage(supplierCurrentPage - 1); }} disabled={supplierCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                    <div className="flex space-x-1">
                                        {Array.from({ length: Math.ceil(suppliers.length / supplierItemsPerPage) }, (_, i) => {
                                            const p = i + 1;
                                            if (p === 1 || p === Math.ceil(suppliers.length / supplierItemsPerPage) || (p >= supplierCurrentPage - 2 && p <= supplierCurrentPage + 2)) {
                                                return <button key={p} onClick={() => setSupplierCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === supplierCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                            } else if (p === supplierCurrentPage - 3 || p === supplierCurrentPage + 3) {
                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    <button onClick={() => { const tp = Math.ceil(suppliers.length / supplierItemsPerPage); if (supplierCurrentPage < tp) setSupplierCurrentPage(supplierCurrentPage + 1); }} disabled={supplierCurrentPage === Math.ceil(suppliers.length / supplierItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {(modal || editModal) && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">{editModal ? 'Edit Supplier' : 'Tambah Supplier'}</h3>
                                <form onSubmit={editModal ? updateSupplier : addSupplier} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Supplier</label>
                                        <input value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">No. Telepon</label>
                                        <input value={form.phone} onChange={e => setForm({ ...form, phone: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Email</label>
                                        <input type="email" value={form.email} onChange={e => setForm({ ...form, email: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alamat</label>
                                        <textarea value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => { setModal(false); setEditModal(null); setForm({ name: '', phone: '', address: '', email: '' }); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîÑ RETURN SALES MANAGER (Retur Penjualan)
        // ==========================================
        const ReturnSalesManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [returns, setReturns] = useState([]);
            const [sales, setSales] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ saleId: '', reason: '', compensation: 0 });
            const [returnSalesCashAccount, setReturnSalesCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const returnsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'return_sales');
                let qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubReturns = onSnapshot(qReturns, (snapshot) => {
                    setReturns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const salesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'sales');
                let qSales = query(salesRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'sale'), orderBy('createdAt', 'desc'), limit(50));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qSales = query(salesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'sale'), orderBy('createdAt', 'desc'), limit(50));
                }
                const unsubSales = onSnapshot(qSales, (snapshot) => {
                    setSales(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubReturns(); unsubSales(); };
            }, [activeOwner?.id, activeStore?.id]);

            const submitReturn = async (e) => {
                e.preventDefault();
                if (!form.saleId) {
                    alert('Pilih transaksi penjualan!');
                    return;
                }

                try {
                    const sale = sales.find(s => s.id === form.saleId);
                    if (!sale) {
                        alert('Transaksi tidak ditemukan');
                        return;
                    }

                    const returnData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        saleId: form.saleId,
                        customerName: sale.customerName,
                        items: sale.items || [],
                        total: sale.total,
                        reason: form.reason,
                        compensation: form.compensation || 0,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'return_sales'), returnData);

                    // Kembalikan stok
                    for (const item of (sale.items || [])) {
                        if (item.id) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(item.qty)
                                    });
                                }
                            });
                        }
                    }

                    // Catat refund sebagai pengeluaran
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Retur Penjualan',
                        description: `Retur dari ${sale.customerName} - ${form.reason}`,
                        amount: sale.total,
                        cashAccount: returnSalesCashAccount,
                        date: serverTimestamp()
                    });

                    // Jika ada kompensasi, catat sebagai income dengan kategori khusus
                    if (form.compensation > 0) {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'income',
                            category: 'Kompensasi Retur Penjualan',
                            description: `Kompensasi retur dari ${sale.customerName} - ${form.reason}`,
                            amount: form.compensation,
                            cashAccount: returnSalesCashAccount,
                            date: serverTimestamp()
                        });
                    }

                    alert('‚úÖ Retur berhasil diproses!');
                    setModal(false);
                    setForm({ saleId: '', reason: '', compensation: 0 });
                    setReturnSalesCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = returns.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReturns = returns.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üîÑ Retur Penjualan</h2>
                        <button onClick={() => setModal(true)} className="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Proses Retur
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto mobile-card-wrapper">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Pelanggan</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-left">Alasan</th>
                                    <th className="p-3 text-right">Total Refund</th>
                                    <th className="p-3 text-right">Kompensasi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReturns.map(r => (
                                    <tr key={r.id}>
                                        <td className="p-3 text-gray-500">{formatDate(r.createdAt)}</td>
                                        <td className="p-3 font-medium">{r.customerName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.name} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-xs text-gray-600">{r.reason}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{formatCurrency(r.total)}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{r.compensation ? formatCurrency(r.compensation) : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur penjualan</div>}
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedReturns.map(r => (
                                <div key={r.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Tanggal</span>
                                        <span className="mobile-card-value text-xs">{formatDate(r.createdAt)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Pelanggan</span>
                                        <span className="mobile-card-value">{r.customerName}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Item</span>
                                        <span className="mobile-card-value">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.name} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Alasan</span>
                                        <span className="mobile-card-value text-xs">{r.reason}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Total Refund</span>
                                        <span className="mobile-card-value font-bold text-red-600">{formatCurrency(r.total)}</span>
                                    </div>
                                    {r.compensation && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Kompensasi</span>
                                            <span className="mobile-card-value font-bold text-green-600">{formatCurrency(r.compensation)}</span>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur penjualan</div>}
                        </div>
                    </div>

                    {returns.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-2xl p-6">
                                <h3 className="font-bold text-xl mb-4">Proses Retur Penjualan</h3>
                                <form onSubmit={submitReturn} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Pilih Transaksi Penjualan</label>
                                        <select value={form.saleId} onChange={e => setForm({ ...form, saleId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Penjualan --</option>
                                            {sales.map(s => (
                                                <option key={s.id} value={s.id}>
                                                    {formatDate(s.createdAt)} - {s.customerName} - {formatCurrency(s.total)}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {form.saleId && (() => {
                                        const sale = sales.find(s => s.id === form.saleId);
                                        return sale ? (
                                            <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                                <div className="text-xs font-bold text-blue-700 mb-2">Detail Penjualan:</div>
                                                <div className="space-y-1 text-xs">
                                                    {(sale.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between">
                                                            <span>{item.name} x{item.qty}</span>
                                                            <span className="font-bold">{formatCurrency(item.sellPrice * item.qty)}</span>
                                                        </div>
                                                    ))}
                                                    <div className="border-t border-blue-300 pt-1 flex justify-between font-bold">
                                                        <span>Total:</span>
                                                        <span>{formatCurrency(sale.total)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })()}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alasan Retur</label>
                                        <textarea value={form.reason} onChange={e => setForm({ ...form, reason: e.target.value })} className="w-full border p-2 rounded" rows="3" placeholder="Contoh: Barang rusak, salah item, dll" required></textarea>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Biaya Kompensasi dari Pelanggan (Opsional)</label>
                                        <input type="number" value={form.compensation || 0} onChange={e => setForm({ ...form, compensation: parseFloat(e.target.value) || 0 })} className="w-full border p-2 rounded" placeholder="0" min="0" />
                                        <p className="text-xs text-slate-500 mt-1">Contoh: Biaya restocking, handling fee, dll</p>
                                        {form.compensation > 0 && (
                                            <div className="mt-1 text-xs text-green-600 font-bold">
                                                ‚úì Kompensasi {formatCurrency(form.compensation)} akan masuk ke Pemasukan (Kompensasi Retur Penjualan)
                                            </div>
                                        )}
                                    </div>

                                    <CashAccountSelect value={returnSalesCashAccount} onChange={setReturnSalesCashAccount} />

                                    <div className="bg-orange-50 border border-orange-200 p-3 rounded text-xs text-orange-700">
                                        ‚ö†Ô∏è <strong>Perhatian:</strong> Refund dicatat sebagai pengeluaran, kompensasi dari pelanggan masuk ke pemasukan
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-orange-600 text-white p-2 rounded font-bold">Proses Retur</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîô RETURN PURCHASE MANAGER (Retur Pembelian)
        // ==========================================
        const ReturnPurchaseManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [returns, setReturns] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ purchaseId: '', reason: '', compensation: 0 });
            const [returnPurchaseCashAccount, setReturnPurchaseCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const returnsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'return_purchases');
                let qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubReturns = onSnapshot(qReturns, (snapshot) => {
                    setReturns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const purchasesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases');
                let qPurchases = query(purchasesRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'), limit(50));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qPurchases = query(purchasesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'), limit(50));
                }
                const unsubPurchases = onSnapshot(qPurchases, (snapshot) => {
                    setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubReturns(); unsubPurchases(); };
            }, [activeOwner?.id, activeStore?.id]);

            const submitReturn = async (e) => {
                e.preventDefault();
                if (!form.purchaseId) {
                    alert('Pilih transaksi pembelian!');
                    return;
                }

                try {
                    const purchase = purchases.find(p => p.id === form.purchaseId);
                    if (!purchase) {
                        alert('Transaksi tidak ditemukan');
                        return;
                    }

                    const returnData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        purchaseId: form.purchaseId,
                        supplierName: purchase.supplierName,
                        items: purchase.items || [],
                        total: purchase.total,
                        reason: form.reason,
                        compensation: form.compensation || 0,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'return_purchases'), returnData);

                    for (const item of (purchase.items || [])) {
                        if (item.productId) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(-item.qty)
                                    });
                                }
                            });
                        }
                    }

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'income',
                        category: 'Retur Pembelian',
                        description: `Retur ke ${purchase.supplierName} - ${form.reason}`,
                        amount: purchase.total,
                        cashAccount: returnPurchaseCashAccount,
                        date: serverTimestamp()
                    });

                    // Jika ada kompensasi ke supplier, catat sebagai expense
                    if (form.compensation > 0) {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'expense',
                            category: 'Kompensasi Retur Pembelian',
                            description: `Kompensasi retur ke ${purchase.supplierName} - ${form.reason}`,
                            amount: form.compensation,
                            cashAccount: returnPurchaseCashAccount,
                            date: serverTimestamp()
                        });
                    }

                    alert('‚úÖ Retur berhasil diproses!');
                    setModal(false);
                    setForm({ purchaseId: '', reason: '', compensation: 0 });
                    setReturnPurchaseCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = returns.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReturns = returns.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üîô Retur Pembelian</h2>
                        <button onClick={() => setModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Proses Retur
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto mobile-card-wrapper">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-left">Alasan</th>
                                    <th className="p-3 text-right">Total Refund</th>
                                    <th className="p-3 text-right">Kompensasi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReturns.map(r => (
                                    <tr key={r.id}>
                                        <td className="p-3 text-gray-500">{formatDate(r.createdAt)}</td>
                                        <td className="p-3 font-medium">{r.supplierName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.productName} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-xs text-gray-600">{r.reason}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{formatCurrency(r.total)}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{r.compensation ? formatCurrency(r.compensation) : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur pembelian</div>}
                        
                        {/* Mobile Card View */}
                        <div className="mobile-card-stack" style={{display: 'none'}}>
                            {paginatedReturns.map(r => (
                                <div key={r.id} className="mobile-card">
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Tanggal</span>
                                        <span className="mobile-card-value text-xs">{formatDate(r.createdAt)}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Supplier</span>
                                        <span className="mobile-card-value">{r.supplierName}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Item</span>
                                        <span className="mobile-card-value">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.productName} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Alasan</span>
                                        <span className="mobile-card-value text-xs">{r.reason}</span>
                                    </div>
                                    <div className="mobile-card-row">
                                        <span className="mobile-card-label">Total Refund</span>
                                        <span className="mobile-card-value font-bold text-green-600">{formatCurrency(r.total)}</span>
                                    </div>
                                    {r.compensation > 0 && (
                                        <div className="mobile-card-row">
                                            <span className="mobile-card-label">Kompensasi</span>
                                            <span className="mobile-card-value font-bold text-orange-600">{formatCurrency(r.compensation)}</span>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur pembelian</div>}
                        </div>
                    </div>

                    {returns.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-2xl p-6">
                                <h3 className="font-bold text-xl mb-4">Proses Retur Pembelian</h3>
                                <form onSubmit={submitReturn} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Pilih Transaksi Pembelian</label>
                                        <select value={form.purchaseId} onChange={e => setForm({ ...form, purchaseId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Pembelian --</option>
                                            {purchases.map(p => (
                                                <option key={p.id} value={p.id}>
                                                    {formatDate(p.createdAt)} - {p.supplierName} - {formatCurrency(p.total)}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {form.purchaseId && (() => {
                                        const purchase = purchases.find(p => p.id === form.purchaseId);
                                        return purchase ? (
                                            <div className="bg-purple-50 p-3 rounded border border-purple-200">
                                                <div className="text-xs font-bold text-purple-700 mb-2">Detail Pembelian:</div>
                                                <div className="space-y-1 text-xs">
                                                    {(purchase.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between">
                                                            <span>{item.productName} x{item.qty}</span>
                                                            <span className="font-bold">{formatCurrency(item.price * item.qty)}</span>
                                                        </div>
                                                    ))}
                                                    <div className="border-t border-purple-300 pt-1 flex justify-between font-bold">
                                                        <span>Total:</span>
                                                        <span>{formatCurrency(purchase.total)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })()}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alasan Retur</label>
                                        <textarea value={form.reason} onChange={e => setForm({ ...form, reason: e.target.value })} className="w-full border p-2 rounded" rows="3" placeholder="Contoh: Barang cacat, salah kirim, dll" required></textarea>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Biaya Kompensasi ke Supplier (Opsional)</label>
                                        <input type="number" value={form.compensation || 0} onChange={e => setForm({ ...form, compensation: parseFloat(e.target.value) || 0 })} className="w-full border p-2 rounded" placeholder="0" min="0" />
                                        <p className="text-xs text-slate-500 mt-1">Contoh: Ongkir retur, restocking fee, dll</p>
                                        {form.compensation > 0 && (
                                            <div className="mt-1 text-xs text-red-600 font-bold">
                                                ‚úì Kompensasi {formatCurrency(form.compensation)} akan masuk ke Pengeluaran (Kompensasi Retur Pembelian)
                                            </div>
                                        )}
                                    </div>

                                    <CashAccountSelect value={returnPurchaseCashAccount} onChange={setReturnPurchaseCashAccount} />

                                    <div className="bg-purple-50 border border-purple-200 p-3 rounded text-xs text-purple-700">
                                        ‚ö†Ô∏è <strong>Perhatian:</strong> Stok dikurangi, refund masuk pemasukan, kompensasi (jika ada) masuk pengeluaran
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-purple-600 text-white p-2 rounded font-bold">Proses Retur</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩ PAYABLE MANAGER (Utang - Yang Harus Kita Bayar)
        // ==========================================
        const PayableManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [payables, setPayables] = useState([]);
            const [modal, setModal] = useState(false);
            const [paymentModal, setPaymentModal] = useState(null);
            const [form, setForm] = useState({ customerName: '', amount: 0, description: '', dueDate: '' });
            const [paymentAmount, setPaymentAmount] = useState(0);
            const [payableCashAccount, setPayableCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                let q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'payable'), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'payable'), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPayables(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addPayable = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'payable',
                        customerName: form.customerName,
                        amount: parseNumberFromInput(form.amount.toString()),
                        paid: 0,
                        remaining: parseNumberFromInput(form.amount.toString()),
                        description: form.description,
                        dueDate: form.dueDate ? new Date(form.dueDate) : null,
                        status: 'unpaid',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Data utang berhasil ditambahkan!');
                    setModal(false);
                    setForm({ customerName: '', amount: 0, description: '', dueDate: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const recordPayment = async (debt) => {
                if (paymentAmount <= 0 || paymentAmount > debt.remaining) {
                    alert('Jumlah pembayaran tidak valid!');
                    return;
                }
                try {
                    const newPaid = debt.paid + paymentAmount;
                    const newRemaining = debt.amount - newPaid;
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'debts', debt.id), {
                        paid: newPaid,
                        remaining: newRemaining,
                        status: newRemaining === 0 ? 'paid' : 'partial'
                    });

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Pembayaran Utang',
                        description: `${debt.customerName} - ${debt.description}`,
                        amount: paymentAmount,
                        cashAccount: payableCashAccount,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Pembayaran berhasil dicatat!');
                    setPaymentModal(null);
                    setPaymentAmount(0);
                    setPayableCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = payables.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedPayables = payables.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">ÔøΩ Utang (Yang Harus Kita Bayar)</h2>
                        <button onClick={() => setModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Utang
                        </button>
                    </div>

                    <div className="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h3 className="text-red-700 font-bold mb-2">Total Utang</h3>
                        <div className="text-4xl font-bold text-red-600 mb-2">
                            {formatCurrency(payables.reduce((sum, d) => sum + d.remaining, 0))}
                        </div>
                        <div className="text-sm text-red-600">{payables.filter(d => d.status !== 'paid').length} transaksi belum lunas</div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier/Vendor</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-right">Dibayar</th>
                                    <th className="p-3 text-right">Sisa</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedPayables.map(d => (
                                    <tr key={d.id}>
                                        <td className="p-3 text-gray-500">{formatDate(d.createdAt)}</td>
                                        <td className="p-3 font-medium">{d.customerName}</td>
                                        <td className="p-3 text-xs text-gray-500">{d.description}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{formatCurrency(d.amount)}</td>
                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid)}</td>
                                        <td className="p-3 text-right font-bold text-orange-600">{formatCurrency(d.remaining)}</td>
                                        <td className="p-3 text-center">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${d.status === 'paid' ? 'bg-green-100 text-green-700' : d.status === 'partial' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}`}>
                                                {d.status === 'paid' ? '‚úÖ Lunas' : d.status === 'partial' ? '‚è≥ Dicicil' : '‚ùå Belum Bayar'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-center">
                                            {d.status !== 'paid' && (
                                                <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold">
                                                    üí∞ Bayar
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {payables.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data utang</div>}
                    </div>

                    {payables.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4 text-red-600">üì§ Tambah Data Utang</h3>
                                <form onSubmit={addPayable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Supplier/Vendor</label>
                                        <input value={form.customerName} onChange={e => setForm({ ...form, customerName: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <input type="date" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {paymentModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Catat Pembayaran</h3>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-xs text-gray-500">Nama</div>
                                        <div className="font-bold">{paymentModal.customerName}</div>
                                        <div className="text-xs text-gray-500 mt-2">Sisa</div>
                                        <div className="text-2xl font-bold text-orange-600">{formatCurrency(paymentModal.remaining)}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah Bayar</label>
                                        <NumberInput value={paymentAmount} onChange={val => setPaymentAmount(val)} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <CashAccountSelect value={payableCashAccount} onChange={setPayableCashAccount} />
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { setPaymentModal(null); setPaymentAmount(0); setPayableCashAccount('Kas Tunai'); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button onClick={() => recordPayment(paymentModal)} className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Bayar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩ RECEIVABLE MANAGER (Piutang - Yang Harus Dibayar ke Kita)
        // ==========================================
        const ReceivableManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [receivables, setReceivables] = useState([]);
            const [modal, setModal] = useState(false);
            const [paymentModal, setPaymentModal] = useState(null);
            const [form, setForm] = useState({ customerName: '', amount: 0, description: '', dueDate: '' });
            const [paymentAmount, setPaymentAmount] = useState(0);
            const [receivableCashAccount, setReceivableCashAccount] = useState('Kas Tunai');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                let q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'receivable'), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'receivable'), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setReceivables(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addReceivable = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'receivable',
                        customerName: form.customerName,
                        amount: parseNumberFromInput(form.amount.toString()),
                        paid: 0,
                        remaining: parseNumberFromInput(form.amount.toString()),
                        description: form.description,
                        dueDate: form.dueDate ? new Date(form.dueDate) : null,
                        status: 'unpaid',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Data piutang berhasil ditambahkan!');
                    setModal(false);
                    setForm({ customerName: '', amount: 0, description: '', dueDate: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const recordPayment = async (debt) => {
                if (paymentAmount <= 0 || paymentAmount > debt.remaining) {
                    alert('Jumlah pembayaran tidak valid!');
                    return;
                }
                try {
                    const newPaid = debt.paid + paymentAmount;
                    const newRemaining = debt.amount - newPaid;
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'debts', debt.id), {
                        paid: newPaid,
                        remaining: newRemaining,
                        status: newRemaining === 0 ? 'paid' : 'partial'
                    });

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'income',
                        category: 'Pembayaran Piutang',
                        description: `${debt.customerName} - ${debt.description}`,
                        amount: paymentAmount,
                        cashAccount: receivableCashAccount,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Pembayaran berhasil dicatat!');
                    setPaymentModal(null);
                    setPaymentAmount(0);
                    setReceivableCashAccount('Kas Tunai');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = receivables.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReceivables = receivables.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üì• Piutang (Yang Harus Dibayar ke Kita)</h2>
                        <button onClick={() => setModal(true)} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Piutang
                        </button>
                    </div>

                    <div className="bg-green-50 border border-green-200 rounded-xl p-6">
                        <h3 className="text-green-700 font-bold mb-2">Total Piutang</h3>
                        <div className="text-4xl font-bold text-green-600 mb-2">
                            {formatCurrency(receivables.reduce((sum, d) => sum + d.remaining, 0))}
                        </div>
                        <div className="text-sm text-green-600">{receivables.filter(d => d.status !== 'paid').length} transaksi belum lunas</div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Nama Pelanggan</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-right">Dibayar</th>
                                    <th className="p-3 text-right">Sisa</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReceivables.map(d => (
                                    <tr key={d.id}>
                                        <td className="p-3 text-gray-500">{formatDate(d.createdAt)}</td>
                                        <td className="p-3 font-medium">{d.customerName}</td>
                                        <td className="p-3 text-xs text-gray-500">{d.description}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{formatCurrency(d.amount)}</td>
                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid)}</td>
                                        <td className="p-3 text-right font-bold text-orange-600">{formatCurrency(d.remaining)}</td>
                                        <td className="p-3 text-center">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${d.status === 'paid' ? 'bg-green-100 text-green-700' : d.status === 'partial' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}`}>
                                                {d.status === 'paid' ? '‚úÖ Lunas' : d.status === 'partial' ? '‚è≥ Dicicil' : '‚ùå Belum Bayar'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-center">
                                            {d.status !== 'paid' && (
                                                <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold">
                                                    üí∞ Terima Bayar
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {receivables.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data piutang</div>}
                    </div>

                    {receivables.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4 text-green-600">üì• Tambah Data Piutang</h3>
                                <form onSubmit={addReceivable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Pelanggan</label>
                                        <input value={form.customerName} onChange={e => setForm({ ...form, customerName: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <input type="date" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-green-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {paymentModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Catat Pembayaran</h3>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-xs text-gray-500">Nama</div>
                                        <div className="font-bold">{paymentModal.customerName}</div>
                                        <div className="text-xs text-gray-500 mt-2">Sisa</div>
                                        <div className="text-2xl font-bold text-orange-600">{formatCurrency(paymentModal.remaining)}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah Diterima</label>
                                        <NumberInput value={paymentAmount} onChange={val => setPaymentAmount(val)} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <CashAccountSelect value={receivableCashAccount} onChange={setReceivableCashAccount} />
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { setPaymentModal(null); setPaymentAmount(0); setReceivableCashAccount('Kas Tunai'); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button onClick={() => recordPayment(paymentModal)} className="flex-1 bg-green-600 text-white p-2 rounded font-bold">Terima</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩüíµ CASH MANAGER (Uang Kas)
        // ==========================================
        const CashManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [cashFlow, setCashFlow] = useState([]);
            const [cashAccounts, setCashAccounts] = useState([]);
            const [modal, setModal] = useState(false);
            const [accountModal, setAccountModal] = useState(false);
            const [form, setForm] = useState({ type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
            const [newAccount, setNewAccount] = useState({ name: '', type: 'bank', color: '#3B82F6', initialBalance: 0 });
            const [filterAccount, setFilterAccount] = useState('all');
            
            // Pagination states
            const [cashCurrentPage, setCashCurrentPage] = useState(1);
            const [cashItemsPerPage, setCashItemsPerPage] = useState(10);

            // Load cash accounts
            useEffect(() => {
                if (!activeOwner?.id) return;
                const accountsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts');
                let q = query(accountsRef, where('ownerId', '==', activeOwner.id));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(accountsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setCashAccounts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            // Load cash flow
            useEffect(() => {
                if (!activeOwner?.id) return;
                const cashRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow');
                let q = query(cashRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'), limit(100));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(cashRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'), limit(100));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setCashFlow(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addAccount = async (e) => {
                e.preventDefault();
                try {
                    const accountRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        name: newAccount.name,
                        type: newAccount.type,
                        color: newAccount.color,
                        createdAt: serverTimestamp()
                    });
                    
                    // Add initial balance if provided
                    if (newAccount.initialBalance && newAccount.initialBalance > 0) {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'in',
                            amount: parseNumberFromInput(newAccount.initialBalance.toString()),
                            category: 'Saldo Awal',
                            description: `Saldo awal akun ${newAccount.name}`,
                            account: newAccount.name,
                            createdAt: serverTimestamp()
                        });
                    }
                    
                    alert('‚úÖ Akun berhasil ditambahkan!');
                    setAccountModal(false);
                    setNewAccount({ name: '', type: 'bank', color: '#3B82F6', initialBalance: 0 });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteAccount = async (id) => {
                if (!confirm('Hapus akun ini? Transaksi tetap tersimpan.')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts', id));
                    alert('‚úÖ Akun dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const addCashFlow = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: form.type,
                        amount: parseNumberFromInput(form.amount.toString()),
                        category: form.category,
                        description: form.description,
                        account: form.account || 'Kas Tunai',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Kas berhasil dicatat!');
                    setModal(false);
                    setForm({ type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            // Filter by account
            const filteredCashFlow = filterAccount === 'all' 
                ? cashFlow 
                : cashFlow.filter(c => (c.account || 'Kas Tunai') === filterAccount);

            // Get all unique accounts (from cash_accounts + default)
            const allAccountNames = ['Kas Tunai', ...cashAccounts.map(a => a.name)];
            
            // Calculate balance per account
            const accountBalances = allAccountNames.map(accName => {
                const flows = cashFlow.filter(c => (c.account || 'Kas Tunai') === accName);
                const totalIn = flows.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
                const totalOut = flows.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
                const accountInfo = cashAccounts.find(a => a.name === accName);
                return { 
                    account: accName, 
                    balance: totalIn - totalOut, 
                    totalIn, 
                    totalOut,
                    type: accountInfo?.type || 'cash',
                    color: accountInfo?.color || '#10B981'
                };
            });

            const totalIn = filteredCashFlow.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
            const totalOut = filteredCashFlow.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
            const balance = totalIn - totalOut;
            const grandTotal = accountBalances.reduce((sum, a) => sum + a.balance, 0);

            // Pagination calculations for cash flow
            const cashTotalPages = Math.ceil(filteredCashFlow.length / cashItemsPerPage);
            const cashStartIndex = (cashCurrentPage - 1) * cashItemsPerPage;
            const cashEndIndex = cashStartIndex + cashItemsPerPage;
            const paginatedCashFlow = filteredCashFlow.slice(cashStartIndex, cashEndIndex);
            
            // Calculate running balance before the current page
            const balanceBeforePage = filteredCashFlow.slice(0, cashStartIndex).reduce((acc, c) => {
                return acc + (c.type === 'in' ? c.amount : -c.amount);
            }, 0);

            const handleCashPageChange = (newPage) => {
                if (newPage >= 1 && newPage <= cashTotalPages) {
                    setCashCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleCashItemsPerPageChange = (value) => {
                setCashItemsPerPage(value);
                setCashCurrentPage(1);
            };

            const getAccountIcon = (type) => {
                switch(type) {
                    case 'bank': return 'üè¶';
                    case 'ewallet': return 'üì±';
                    case 'cash': return 'üíµ';
                    default: return 'üí∞';
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üíµ Uang Kas & Bank</h2>
                        <div className="flex gap-2">
                            <button onClick={() => setAccountModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2">
                                <Plus className="w-4 h-4" /> Tambah Akun
                            </button>
                            <button 
                                onClick={() => {
                                    setForm({ type: 'in', amount: 0, category: 'Saldo Awal', description: '', account: form.account || 'Kas Tunai' });
                                    setModal(true);
                                }} 
                                className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2"
                            >
                                <Plus className="w-4 h-4" /> üí∞ Tambah Saldo
                            </button>
                            <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                                <Plus className="w-4 h-4" /> Catat Transaksi
                            </button>
                        </div>
                    </div>

                    {/* Saldo Per Akun */}
                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-purple-800 flex items-center gap-2">
                                <Banknote className="w-5 h-5" />
                                Saldo Per Akun ({accountBalances.length} Akun)
                            </h3>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {accountBalances.map(acc => {
                                const accountData = cashAccounts.find(a => a.name === acc.account);
                                return (
                                    <div key={acc.account} className="bg-white rounded-lg p-3 border border-gray-200 relative group">
                                        {accountData && (
                                            <button 
                                                onClick={() => deleteAccount(accountData.id)}
                                                className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-red-100 hover:bg-red-200 text-red-600 rounded p-1"
                                                title="Hapus akun"
                                            >
                                                <Trash2 className="w-3 h-3" />
                                            </button>
                                        )}
                                        <div className="text-xs text-gray-600 mb-1 flex items-center gap-1">
                                            <span>{getAccountIcon(acc.type)}</span>
                                            <span className="truncate">{acc.account}</span>
                                        </div>
                                        <div className={`text-lg font-bold ${acc.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(acc.balance)}
                                        </div>
                                        <button
                                            onClick={() => {
                                                setForm({ type: 'in', amount: 0, category: 'Saldo Awal', description: '', account: acc.account });
                                                setModal(true);
                                            }}
                                            className="mt-2 w-full bg-green-50 hover:bg-green-100 text-green-700 text-xs py-1 px-2 rounded font-medium transition-colors"
                                        >
                                            + Tambah Saldo
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="mt-3 pt-3 border-t border-purple-200 flex justify-between items-center">
                            <span className="text-sm font-bold text-purple-800">Total Semua Akun:</span>
                            <span className="text-2xl font-bold text-purple-600">{formatCurrency(grandTotal)}</span>
                        </div>
                    </div>

                    {/* Filter Akun */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Filter Akun:</label>
                        <select 
                            value={filterAccount} 
                            onChange={e => setFilterAccount(e.target.value)} 
                            className="w-full md:w-64 border border-gray-300 p-2 rounded-lg text-sm font-medium focus:outline-blue-500"
                        >
                            <option value="all">üìä Semua Akun</option>
                            {allAccountNames.map(acc => {
                                const accountInfo = cashAccounts.find(a => a.name === acc);
                                const icon = getAccountIcon(accountInfo?.type || 'cash');
                                return <option key={acc} value={acc}>{icon} {acc}</option>;
                            })}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <h3 className="text-blue-700 font-bold mb-2 text-sm">üí∞ Saldo {filterAccount === 'all' ? 'Total' : filterAccount}</h3>
                            <div className="text-3xl font-bold text-blue-600">{formatCurrency(balance)}</div>
                        </div>
                        <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                            <h3 className="text-green-700 font-bold mb-2 text-sm">üì• Kas Masuk</h3>
                            <div className="text-2xl font-bold text-green-600">{formatCurrency(totalIn)}</div>
                        </div>
                        <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                            <h3 className="text-red-700 font-bold mb-2 text-sm">üì§ Kas Keluar</h3>
                            <div className="text-2xl font-bold text-red-600">{formatCurrency(totalOut)}</div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal & Waktu</th>
                                    <th className="p-3 text-left">Akun</th>
                                    <th className="p-3 text-left">Jenis</th>
                                    <th className="p-3 text-left">Kategori</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Jumlah</th>
                                    <th className="p-3 text-right">Saldo</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedCashFlow.reduce((acc, c, idx) => {
                                    const runningBalance = acc.balance + (c.type === 'in' ? c.amount : -c.amount);
                                    const accountInfo = cashAccounts.find(a => a.name === c.account);
                                    acc.rows.push(
                                        <tr key={c.id}>
                                            <td className="p-3 text-gray-500 text-xs">{formatDate(c.createdAt)}</td>
                                            <td className="p-3">
                                                <span className="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded flex items-center gap-1 w-fit">
                                                    <span>{getAccountIcon(accountInfo?.type || 'cash')}</span>
                                                    <span>{c.account || 'Kas Tunai'}</span>
                                                </span>
                                            </td>
                                            <td className="p-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${c.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {c.type === 'in' ? 'üì• Masuk' : 'üì§ Keluar'}
                                                </span>
                                            </td>
                                            <td className="p-3 font-medium">{c.category || '-'}</td>
                                            <td className="p-3 text-xs text-gray-500">{c.description}</td>
                                            <td className={`p-3 text-right font-bold ${c.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>
                                                {c.type === 'in' ? '+' : '-'}{formatCurrency(c.amount)}
                                            </td>
                                            <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(runningBalance)}</td>
                                        </tr>
                                    );
                                    acc.balance = runningBalance;
                                    return acc;
                                }, { rows: [], balance: balanceBeforePage }).rows}
                            </tbody>
                        </table>
                        {filteredCashFlow.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada transaksi kas</div>}
                    </div>

                    {/* Pagination Controls for Cash Flow */}
                    {filteredCashFlow.length > 0 && (
                        <div className="pt-4 border-t border-slate-200">
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex items-center space-x-2">
                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                    <select 
                                        value={cashItemsPerPage} 
                                        onChange={(e) => handleCashItemsPerPageChange(parseInt(e.target.value))}
                                        className="border border-slate-300 rounded px-2 py-1 text-sm bg-white"
                                    >
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span className="text-sm text-slate-600">transaksi per halaman</span>
                                </div>
                                <div className="text-sm text-slate-600">
                                    Menampilkan {Math.min(cashStartIndex + 1, filteredCashFlow.length)} - {Math.min(cashEndIndex, filteredCashFlow.length)} dari {filteredCashFlow.length} transaksi
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => handleCashPageChange(cashCurrentPage - 1)} disabled={cashCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                    <div className="flex space-x-1">
                                        {Array.from({ length: cashTotalPages }, (_, i) => {
                                            const p = i + 1;
                                            if (p === 1 || p === cashTotalPages || (p >= cashCurrentPage - 2 && p <= cashCurrentPage + 2)) {
                                                return <button key={p} onClick={() => handleCashPageChange(p)} className={`px-3 py-1 text-sm rounded ${p === cashCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                            } else if (p === cashCurrentPage - 3 || p === cashCurrentPage + 3) {
                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                            }
                                            return null;
                                        })}
                                    </div>
                                    <button onClick={() => handleCashPageChange(cashCurrentPage + 1)} disabled={cashCurrentPage === cashTotalPages} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal Tambah Akun */}
                    {accountModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Akun Kas/Bank</h3>
                                <form onSubmit={addAccount} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Akun</label>
                                        <input 
                                            value={newAccount.name} 
                                            onChange={e => setNewAccount({ ...newAccount, name: e.target.value })} 
                                            placeholder="Contoh: Bank BRI Cabang Jakarta, Kas Toko 1" 
                                            className="w-full border p-2 rounded" 
                                            required 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Tipe Akun</label>
                                        <select 
                                            value={newAccount.type} 
                                            onChange={e => setNewAccount({ ...newAccount, type: e.target.value })} 
                                            className="w-full border p-2 rounded"
                                        >
                                            <option value="cash">üíµ Kas Tunai</option>
                                            <option value="bank">üè¶ Bank</option>
                                            <option value="ewallet">üì± E-Wallet</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Saldo Awal (Opsional)</label>
                                        <NumberInput 
                                            value={newAccount.initialBalance} 
                                            onChange={val => setNewAccount({ ...newAccount, initialBalance: val })} 
                                            className="w-full border p-2 rounded font-bold text-lg" 
                                            placeholder="0"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">üí° Isi jika ingin menambahkan saldo awal untuk akun ini</p>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setAccountModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-purple-600 text-white p-2 rounded font-bold">Tambah Akun</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal Transaksi */}
                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">
                                    {form.type === 'in' && form.category === 'Saldo Awal' 
                                        ? 'üí∞ Tambah Saldo Kas/Bank' 
                                        : 'Catat Transaksi Kas/Bank'
                                    }
                                </h3>
                                <form onSubmit={addCashFlow} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Akun</label>
                                        <select 
                                            value={form.account} 
                                            onChange={e => setForm({ ...form, account: e.target.value })} 
                                            className="w-full border p-2 rounded"
                                        >
                                            {allAccountNames.map(acc => {
                                                const accountInfo = cashAccounts.find(a => a.name === acc);
                                                const icon = getAccountIcon(accountInfo?.type || 'cash');
                                                return <option key={acc} value={acc}>{icon} {acc}</option>;
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jenis Transaksi</label>
                                        <select value={form.type} onChange={e => setForm({ ...form, type: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="in">üì• Kas Masuk</option>
                                            <option value="out">üì§ Kas Keluar</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Kategori</label>
                                        <input 
                                            value={form.category} 
                                            onChange={e => setForm({ ...form, category: e.target.value })} 
                                            placeholder={form.type === 'in' ? 'Contoh: Saldo Awal, Penjualan, Pendapatan Lain' : 'Contoh: Pembelian, Gaji, Operasional'} 
                                            className="w-full border p-2 rounded" 
                                            required 
                                            list="categoryOptions"
                                        />
                                        <datalist id="categoryOptions">
                                            {form.type === 'in' ? (
                                                <>
                                                    <option value="Saldo Awal" />
                                                    <option value="Penjualan" />
                                                    <option value="Pendapatan Jasa" />
                                                    <option value="Pendapatan Lain" />
                                                </>
                                            ) : (
                                                <>
                                                    <option value="Pembelian Barang" />
                                                    <option value="Gaji Karyawan" />
                                                    <option value="Biaya Operasional" />
                                                    <option value="Biaya Lain" />
                                                </>
                                            )}
                                        </datalist>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Detail transaksi..."></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîó PUBLIC SERVICE TRACKER (Tracking Progress via Link)
        // ==========================================
        const PublicServiceTracker = ({ serviceId, onBack }) => {
            const [service, setService] = useState(null);
            const [store, setStore] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchService = async () => {
                    try {
                        setLoading(true);
                        const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                        const serviceSnap = await getDoc(serviceRef);
                        
                        if (!serviceSnap.exists()) {
                            setError('Service tidak ditemukan');
                            setLoading(false);
                            return;
                        }

                        const serviceData = { id: serviceSnap.id, ...serviceSnap.data() };
                        setService(serviceData);

                        // Get store data
                        if (serviceData.storeId) {
                            const storeRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', serviceData.storeId);
                            const storeSnap = await getDoc(storeRef);
                            if (storeSnap.exists()) {
                                setStore({ id: storeSnap.id, ...storeSnap.data() });
                            }
                        }

                        setLoading(false);
                    } catch (err) {
                        console.error('Error fetching service:', err);
                        setError('Gagal memuat data: ' + err.message);
                        setLoading(false);
                    }
                };

                fetchService();

                // Setup realtime listener
                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                const unsubscribe = onSnapshot(serviceRef, (doc) => {
                    if (doc.exists()) {
                        setService({ id: doc.id, ...doc.data() });
                    }
                }, (err) => {
                    console.error('Realtime listener error:', err);
                    setError('Error realtime: ' + err.message);
                });

                return () => unsubscribe();
            }, [serviceId]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                        <div className="text-center">
                            <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" />
                            <p className="text-slate-600 font-medium">Memuat data servis...</p>
                        </div>
                    </div>
                );
            }

            if (error || !service) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <AlertTriangle className="w-8 h-8 text-red-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2">Data Tidak Ditemukan</h2>
                            <p className="text-slate-600 mb-6">{error || 'Service tidak ditemukan'}</p>
                        </div>
                    </div>
                );
            }

            const statusColors = {
                'Diterima': 'bg-blue-100 text-blue-700 border-blue-300',
                'Diagnosa': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                'Menunggu Sparepart': 'bg-orange-100 text-orange-700 border-orange-300',
                'Selesai': 'bg-green-100 text-green-700 border-green-300',
                'Dibatalkan': 'bg-red-100 text-red-700 border-red-300'
            };

            const paid = parseFloat(service.dp) || 0;
            const total = parseFloat(service.costEstimate) || 0;
            const remaining = total - paid;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
                    <div className="max-w-2xl mx-auto p-4 py-8">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="flex items-center gap-4 mb-4">
                                <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                                    <Smartphone className="w-6 h-6 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800">Tracking Servis</h1>
                                    {store && <p className="text-sm text-slate-500">{store.name}</p>}
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <Activity className="w-4 h-4" />
                                <span>Update Realtime</span>
                            </div>
                        </div>

                        {/* Service Info */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="space-y-4">
                                <div className="flex justify-between items-start border-b pb-4">
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">Token Servis</p>
                                        <p className="text-2xl font-bold text-blue-600">{service.token}</p>
                                    </div>
                                    <div className={`px-4 py-2 rounded-xl border-2 font-bold text-sm ${statusColors[service.status] || 'bg-gray-100 text-gray-700'}`}>
                                        {service.status}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">Pelanggan</p>
                                        <p className="font-bold text-slate-800">{service.customerName}</p>
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">No. HP</p>
                                        <p className="font-bold text-slate-800">{service.phone}</p>
                                    </div>
                                </div>

                                <div>
                                    <p className="text-xs text-slate-500 mb-1">Perangkat</p>
                                    <p className="font-bold text-slate-800">{service.unitType || service.deviceType}</p>
                                </div>

                                <div>
                                    <p className="text-xs text-slate-500 mb-1">Keluhan</p>
                                    <p className="text-slate-700 bg-slate-50 p-3 rounded-lg">{service.complaint || service.problem}</p>
                                </div>

                                <div className="border-t pt-4">
                                    <p className="text-xs text-slate-500 mb-1">Tanggal Masuk</p>
                                    <p className="font-bold text-slate-800">{formatDate(service.createdAt)}</p>
                                </div>
                            </div>
                        </div>

                        {/* Payment Info */}
                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                                <Wallet className="w-5 h-5 text-green-600" />
                                Informasi Pembayaran
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-600">Total Biaya</span>
                                    <span className="font-bold text-xl text-slate-800">{formatCurrency(total)}</span>
                                </div>
                                {service.paymentStatus === 'Lunas' ? (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-3">
                                        <CheckCircle className="w-6 h-6 text-green-600" />
                                        <div>
                                            <p className="font-bold text-green-700">Lunas</p>
                                            <p className="text-xs text-green-600">Pembayaran sudah diselesaikan</p>
                                        </div>
                                    </div>
                                ) : service.paymentStatus === 'DP' ? (
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-600">DP Dibayar</span>
                                            <span className="font-bold text-green-600">{formatCurrency(paid)}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-600">Sisa Pembayaran</span>
                                            <span className="font-bold text-orange-600">{formatCurrency(remaining)}</span>
                                        </div>
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 text-xs text-orange-700">
                                            ‚è≥ Pembayaran DP telah diterima. Sisa pembayaran dapat dilunasi saat pengambilan.
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <p className="text-sm text-slate-600">Belum ada pembayaran</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-8 text-xs text-slate-500">
                            <p>Halaman ini update secara realtime</p>
                            <p className="mt-1">Powered by iFix Pro Enterprise</p>
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== HR MANAGER ====================
        const HRManager = () => {
            const { user, activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            const [tab, setTab] = useState('attendance');
            const { data: users } = useFirestoreCollection('users', activeOwner?.id, activeStore?.id);
            const [attendances, setAttendances] = useState([]);
            const [payrolls, setPayrolls] = useState([]);
            const [leaves, setLeaves] = useState([]);
            const [shifts, setShifts] = useState([]);
            const [salarySettings, setSalarySettings] = useState([]);
            const [monthlyBudgets, setMonthlyBudgets] = useState([]);
            const [modal, setModal] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // Pagination states
            const [attCurrentPage, setAttCurrentPage] = useState(1);
            const [attItemsPerPage, setAttItemsPerPage] = useState(10);
            const [payrollCurrentPage, setPayrollCurrentPage] = useState(1);
            const [payrollItemsPerPage, setPayrollItemsPerPage] = useState(10);
            const [leaveCurrentPage, setLeaveCurrentPage] = useState(1);
            const [leaveItemsPerPage, setLeaveItemsPerPage] = useState(10);
            const [budgetCurrentPage, setBudgetCurrentPage] = useState(1);
            const [budgetItemsPerPage, setBudgetItemsPerPage] = useState(10);

            // Check if current user is owner
            const isOwner = user?.role === 'owner' || user?.role === 'superadmin';
            
            // Get current user data from users collection
            const currentUserData = users.find(u => u.email === user?.email);

            // Load Attendance Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'attendance'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setAttendances(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Payroll Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'payroll'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setPayrolls(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Leave Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'leaves'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setLeaves(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Shift Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'shifts'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setShifts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Salary Settings Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'salarySettings'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setSalarySettings(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Load Monthly Budget Data
            useEffect(() => {
                if (!activeOwner?.id || !activeStore?.id) return;
                const q = query(
                    collection(db, APP_COLLECTION_PREFIX, 'public', 'monthlyBudgets'),
                    where('ownerId', '==', activeOwner.id),
                    where('storeId', '==', activeStore.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    setMonthlyBudgets(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [activeOwner?.id, activeStore?.id]);

            // Check In/Out Handler
            const handleCheckInOut = async (userId, type) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === userId);
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];

                    // Check if already checked in today
                    const todayAttendance = attendances.find(a => 
                        a.userId === userId && 
                        a.date === today && 
                        a.checkOut === null
                    );

                    if (type === 'in') {
                        if (todayAttendance) {
                            alert('Sudah check-in hari ini!');
                            return;
                        }
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'attendance'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            userId: userId,
                            userName: user?.name || 'Unknown',
                            date: today,
                            checkIn: serverTimestamp(),
                            checkOut: null,
                            workHours: 0,
                            createdAt: serverTimestamp()
                        });
                        alert('‚úÖ Check-in berhasil!');
                    } else {
                        if (!todayAttendance) {
                            alert('Belum check-in hari ini!');
                            return;
                        }
                        const checkInTime = todayAttendance.checkIn?.seconds ? new Date(todayAttendance.checkIn.seconds * 1000) : new Date();
                        const workHours = ((now - checkInTime) / (1000 * 60 * 60)).toFixed(2);

                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'attendance', todayAttendance.id), {
                            checkOut: serverTimestamp(),
                            workHours: parseFloat(workHours)
                        });
                        alert(`‚úÖ Check-out berhasil! Jam kerja: ${workHours} jam`);
                    }
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Generate Payroll
            const handleGeneratePayroll = async (formData) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === formData.userId);
                    
                    // Calculate total work hours for the month
                    const monthAttendances = attendances.filter(a => 
                        a.userId === formData.userId && 
                        a.date?.startsWith(formData.month)
                    );
                    const totalHours = monthAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                    const totalDays = monthAttendances.length;

                    const baseSalary = parseFloat(formData.baseSalary) || 0;
                    const commission = parseFloat(formData.commission) || 0;
                    const bonus = parseFloat(formData.bonus) || 0;
                    const deduction = parseFloat(formData.deduction) || 0;
                    const totalSalary = baseSalary + commission + bonus - deduction;

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'payroll'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        userId: formData.userId,
                        userName: user?.name || 'Unknown',
                        month: formData.month,
                        baseSalary,
                        commission,
                        bonus,
                        deduction,
                        totalSalary,
                        totalHours,
                        totalDays,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });

                    alert('‚úÖ Payroll berhasil digenerate!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Request Leave
            const handleRequestLeave = async (formData) => {
                setLoading(true);
                try {
                    // For employee, use their own userId. For owner, use selected userId
                    const targetUserId = isOwner ? formData.userId : currentUserData?.id;
                    const targetUser = users.find(u => u.id === targetUserId);
                    
                    if (!targetUserId || !targetUser) {
                        alert('User tidak ditemukan!');
                        return;
                    }
                    
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'leaves'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        userId: targetUserId,
                        userName: targetUser.name || 'Unknown',
                        type: formData.type,
                        startDate: formData.startDate,
                        endDate: formData.endDate,
                        reason: formData.reason,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Pengajuan cuti berhasil!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Approve/Reject Leave
            const handleLeaveAction = async (leaveId, status) => {
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'leaves', leaveId), {
                        status: status,
                        updatedAt: serverTimestamp()
                    });
                    alert(`‚úÖ Cuti ${status === 'approved' ? 'disetujui' : 'ditolak'}!`);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            // Create Shift
            const handleCreateShift = async (formData) => {
                setLoading(true);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'shifts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        name: formData.name,
                        startTime: formData.startTime,
                        endTime: formData.endTime,
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Shift berhasil dibuat!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Save/Update Salary Setting
            const handleSaveSalarySetting = async (formData) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === formData.userId);
                    const existing = salarySettings.find(s => s.userId === formData.userId);
                    
                    const salaryData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        userId: formData.userId,
                        userName: user?.name || 'Unknown',
                        baseSalary: parseFloat(formData.baseSalary) || 0,
                        commissionRate: parseFloat(formData.commissionRate) || 0,
                        updatedAt: serverTimestamp()
                    };

                    if (existing) {
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'salarySettings', existing.id), salaryData);
                        alert('‚úÖ Gaji tetap berhasil diupdate!');
                    } else {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'salarySettings'), {
                            ...salaryData,
                            createdAt: serverTimestamp()
                        });
                        alert('‚úÖ Gaji tetap berhasil disimpan!');
                    }
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Auto Generate Payroll for All Employees
            const handleAutoGeneratePayroll = async (month) => {
                if (!month) {
                    alert('Pilih bulan terlebih dahulu!');
                    return;
                }
                
                if (!confirm(`Generate payroll untuk semua karyawan untuk bulan ${month}?`)) {
                    return;
                }
                
                setLoading(true);
                try {
                    let generated = 0;
                    for (const setting of salarySettings) {
                        // Check if payroll already exists for this user and month
                        const existingPayroll = payrolls.find(p => 
                            p.userId === setting.userId && p.month === month
                        );
                        
                        if (existingPayroll) {
                            console.log(`Payroll untuk ${setting.userName} bulan ${month} sudah ada, skip.`);
                            continue;
                        }

                        // Calculate total work hours for the month
                        const monthAttendances = attendances.filter(a => 
                            a.userId === setting.userId && 
                            a.date?.startsWith(month)
                        );
                        const totalHours = monthAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                        const totalDays = monthAttendances.length;

                        const baseSalary = setting.baseSalary || 0;
                        const commission = 0; // Will be added manually if needed
                        const bonus = 0;
                        const deduction = 0;
                        const totalSalary = baseSalary + commission + bonus - deduction;

                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'payroll'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            userId: setting.userId,
                            userName: setting.userName,
                            month: month,
                            baseSalary,
                            commission,
                            bonus,
                            deduction,
                            totalSalary,
                            totalHours,
                            totalDays,
                            status: 'pending',
                            createdAt: serverTimestamp()
                        });
                        
                        generated++;
                    }
                    
                    if (generated > 0) {
                        alert(`‚úÖ Payroll berhasil digenerate untuk ${generated} karyawan!`);
                    } else {
                        alert('‚ÑπÔ∏è Tidak ada payroll baru yang digenerate. Mungkin sudah ada untuk bulan tersebut.');
                    }
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Add Monthly Budget
            const handleAddMonthlyBudget = async (formData) => {
                setLoading(true);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'monthlyBudgets'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        name: formData.name,
                        amount: parseFloat(formData.amount) || 0,
                        category: formData.category,
                        dueDate: formData.dueDate || null,
                        notes: formData.notes || '',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Anggaran bulanan berhasil ditambahkan!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Delete Monthly Budget
            const handleDeleteBudget = async (budgetId) => {
                if (!confirm('Hapus anggaran bulanan ini?')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'monthlyBudgets', budgetId));
                    alert('‚úÖ Anggaran bulanan berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            // Update Payroll
            const handleUpdatePayroll = async (payrollId, formData) => {
                setLoading(true);
                try {
                    const user = users.find(u => u.id === formData.userId);
                    
                    // Calculate total work hours for the month
                    const monthAttendances = attendances.filter(a => 
                        a.userId === formData.userId && 
                        a.date?.startsWith(formData.month)
                    );
                    const totalHours = monthAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                    const totalDays = monthAttendances.length;

                    const baseSalary = parseFloat(formData.baseSalary) || 0;
                    const commission = parseFloat(formData.commission) || 0;
                    const bonus = parseFloat(formData.bonus) || 0;
                    const deduction = parseFloat(formData.deduction) || 0;
                    const totalSalary = baseSalary + commission + bonus - deduction;

                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'payroll', payrollId), {
                        userId: formData.userId,
                        userName: user?.name || 'Unknown',
                        month: formData.month,
                        baseSalary,
                        commission,
                        bonus,
                        deduction,
                        totalSalary,
                        totalHours,
                        totalDays,
                        updatedAt: serverTimestamp()
                    });

                    alert('‚úÖ Payroll berhasil diupdate!');
                    setModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Delete Payroll
            const handleDeletePayroll = async (payrollId) => {
                if (!confirm('Hapus data payroll ini?')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'payroll', payrollId));
                    alert('‚úÖ Payroll berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl flex items-center gap-2">
                            <Users className="w-7 h-7 text-blue-600" />
                            HR & Payroll Management
                        </h2>
                    </div>

                    {!isOwner && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p className="text-sm text-blue-800"><strong>[i] Info:</strong> Anda dapat mengakses Absensi dan Cuti. Fitur Gaji, Payroll, Shift, dan Anggaran hanya untuk Owner.</p>
                        </div>
                    )}

                    {/* Tabs */}
                    <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 overflow-x-auto">
                        {[
                            { id: 'attendance', label: 'üìã Absensi', icon: CheckCircle, forAll: true },
                            { id: 'salary', label: 'üíµ Gaji Tetap', icon: DollarSign, ownerOnly: true },
                            { id: 'payroll', label: 'üí∞ Payroll', icon: Wallet, ownerOnly: true },
                            { id: 'leave', label: 'üèñÔ∏è Cuti', icon: Calendar, forAll: true },
                            { id: 'shift', label: 'üïê Shift', icon: RotateCw, ownerOnly: true },
                            { id: 'budget', label: 'üìä Anggaran Bulanan', icon: TrendingDown, ownerOnly: true }
                        ].filter(t => t.forAll || (t.ownerOnly && isOwner)).map(t => (
                            <button 
                                key={t.id} 
                                onClick={() => setTab(t.id)} 
                                className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap flex items-center gap-2 ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}
                            >
                                {t.label}
                            </button>
                        ))}
                    </div>

                    {/* ATTENDANCE TAB */}
                    {tab === 'attendance' && (
                        <div className="space-y-4">
                            {/* Employee Self-Service View */}
                            {!isOwner && currentUserData && (
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white">
                                    <h3 className="font-bold text-xl mb-4">Absensi Saya</h3>
                                    {(() => {
                                        const today = new Date().toISOString().split('T')[0];
                                        const todayAttendance = attendances.find(a => 
                                            a.userId === currentUserData.id && a.date === today
                                        );
                                        const isCheckedIn = todayAttendance && !todayAttendance.checkOut;
                                        const isCheckedOut = todayAttendance && todayAttendance.checkOut;

                                        return (
                                            <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                                                <div className="mb-4">
                                                    <p className="text-2xl font-bold mb-1">{currentUserData.name}</p>
                                                    <p className="opacity-75">{currentUserData.role}</p>
                                                </div>
                                                <div className="mb-4">
                                                    <div className={`inline-block px-4 py-2 rounded-full text-sm font-bold ${
                                                        isCheckedOut ? 'bg-green-500' : isCheckedIn ? 'bg-yellow-500' : 'bg-slate-500'
                                                    }`}>
                                                        {isCheckedOut ? '‚úì Sudah Check Out' : isCheckedIn ? '‚è∞ Sedang Bekerja' : '‚óã Belum Check In'}
                                                    </div>
                                                </div>
                                                {todayAttendance && (
                                                    <div className="mb-4 space-y-2 text-sm">
                                                        <p>Check In: {todayAttendance.checkIn?.seconds ? new Date(todayAttendance.checkIn.seconds * 1000).toLocaleTimeString('id-ID') : '-'}</p>
                                                        <p>Check Out: {todayAttendance.checkOut?.seconds ? new Date(todayAttendance.checkOut.seconds * 1000).toLocaleTimeString('id-ID') : '-'}</p>
                                                        {todayAttendance.workHours && <p className="font-bold">Total: {todayAttendance.workHours} jam</p>}
                                                    </div>
                                                )}
                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={() => handleCheckInOut(currentUserData.id, 'in')}
                                                        disabled={isCheckedIn || isCheckedOut || loading}
                                                        className="flex-1 bg-green-500 text-white py-3 rounded-lg text-base font-bold hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        ‚úì Check In
                                                    </button>
                                                    <button
                                                        onClick={() => handleCheckInOut(currentUserData.id, 'out')}
                                                        disabled={!isCheckedIn || isCheckedOut || loading}
                                                        className="flex-1 bg-red-500 text-white py-3 rounded-lg text-base font-bold hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        ‚úì Check Out
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}

                            {/* Owner View - All Employees */}
                            {isOwner && (
                                <>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <p className="text-sm text-blue-800"><strong>[i] Info:</strong> Owner hanya dapat melihat absensi karyawan. Karyawan melakukan check-in dan check-out sendiri.</p>
                                    </div>
                                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white">
                                        <h3 className="font-bold text-xl mb-4">Absensi Semua Karyawan Hari Ini</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {users.filter(u => u.role !== 'owner').map(user => {
                                            const today = new Date().toISOString().split('T')[0];
                                            const todayAttendance = attendances.find(a => 
                                                a.userId === user.id && a.date === today
                                            );
                                            const isCheckedIn = todayAttendance && !todayAttendance.checkOut;
                                            const isCheckedOut = todayAttendance && todayAttendance.checkOut;

                                            return (
                                                <div key={user.id} className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <div>
                                                            <p className="font-bold">{user.name}</p>
                                                            <p className="text-xs opacity-75">{user.role}</p>
                                                        </div>
                                                        <div className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            isCheckedOut ? 'bg-green-500' : isCheckedIn ? 'bg-yellow-500' : 'bg-slate-500'
                                                        }`}>
                                                            {isCheckedOut ? '‚úì Selesai' : isCheckedIn ? '‚è∞ Aktif' : '‚óã Belum'}
                                                        </div>
                                                    </div>
                                                    {todayAttendance && (
                                                        <div className="text-xs space-y-1 mb-2 opacity-90">
                                                            <p>In: {todayAttendance.checkIn?.seconds ? new Date(todayAttendance.checkIn.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}</p>
                                                            <p>Out: {todayAttendance.checkOut?.seconds ? new Date(todayAttendance.checkOut.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}</p>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                </>
                            )}

                            {/* Attendance History */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50">
                                    <h3 className="font-bold text-slate-800">
                                        {isOwner ? 'Riwayat Absensi Semua Karyawan' : 'Riwayat Absensi Saya'}
                                    </h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Tanggal</th>
                                                {isOwner && <th className="p-3 text-left">Nama</th>}
                                                <th className="p-3 text-center">Check In</th>
                                                <th className="p-3 text-center">Check Out</th>
                                                <th className="p-3 text-center">Jam Kerja</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const filteredAtt = attendances
                                                    .filter(att => isOwner || att.userId === currentUserData?.id)
                                                    .sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                                                const attTotalPages = Math.ceil(filteredAtt.length / attItemsPerPage);
                                                const attStart = (attCurrentPage - 1) * attItemsPerPage;
                                                const attEnd = attStart + attItemsPerPage;
                                                const paginatedAtt = filteredAtt.slice(attStart, attEnd);
                                                return paginatedAtt.map(att => (
                                                <tr key={att.id} className="hover:bg-slate-50">
                                                    <td className="p-3">{att.date}</td>
                                                    {isOwner && <td className="p-3 font-bold">{att.userName}</td>}
                                                    <td className="p-3 text-center">
                                                        {att.checkIn?.seconds ? new Date(att.checkIn.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        {att.checkOut?.seconds ? new Date(att.checkOut.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-'}
                                                    </td>
                                                    <td className="p-3 text-center font-bold text-blue-600">
                                                        {att.workHours ? `${att.workHours} jam` : '-'}
                                                    </td>
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls for Attendance */}
                                {(() => {
                                    const filteredAtt = attendances
                                        .filter(att => isOwner || att.userId === currentUserData?.id);
                                    const attTotal = filteredAtt.length;
                                    const attTotalPages = Math.ceil(attTotal / attItemsPerPage);
                                    if (attTotal === 0) return null;
                                    return (
                                        <div className="p-4 border-t border-slate-200">
                                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                                    <select value={attItemsPerPage} onChange={(e) => { setAttItemsPerPage(parseInt(e.target.value)); setAttCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                    </select>
                                                    <span className="text-sm text-slate-600">per halaman</span>
                                                </div>
                                                <div className="text-sm text-slate-600">
                                                    Menampilkan {Math.min((attCurrentPage - 1) * attItemsPerPage + 1, attTotal)} - {Math.min(attCurrentPage * attItemsPerPage, attTotal)} dari {attTotal}
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button onClick={() => { if (attCurrentPage > 1) setAttCurrentPage(attCurrentPage - 1); }} disabled={attCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                    <div className="flex space-x-1">
                                                        {Array.from({ length: attTotalPages }, (_, i) => {
                                                            const p = i + 1;
                                                            if (p === 1 || p === attTotalPages || (p >= attCurrentPage - 2 && p <= attCurrentPage + 2)) {
                                                                return <button key={p} onClick={() => setAttCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === attCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                            } else if (p === attCurrentPage - 3 || p === attCurrentPage + 3) {
                                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                    <button onClick={() => { if (attCurrentPage < attTotalPages) setAttCurrentPage(attCurrentPage + 1); }} disabled={attCurrentPage === attTotalPages} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    {/* SALARY SETTINGS TAB */}
                    {tab === 'salary' && isOwner && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white">
                                <h3 className="font-bold text-xl mb-2">Pengaturan Gaji Tetap</h3>
                                <p className="text-sm opacity-90">Set gaji pokok sekali, payroll akan auto-generate tiap bulan</p>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800">Daftar Gaji Karyawan</h3>
                                    <button
                                        onClick={() => setModal('salary')}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <Plus className="w-4 h-4" /> Set Gaji
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Nama</th>
                                                <th className="p-3 text-right">Gaji Pokok</th>
                                                <th className="p-3 text-right">Rate Komisi (%)</th>
                                                <th className="p-3 text-center">Terakhir Update</th>
                                                <th className="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {users.filter(u => u.role !== 'owner').map(user => {
                                                const setting = salarySettings.find(s => s.userId === user.id);
                                                return (
                                                    <tr key={user.id} className="hover:bg-slate-50">
                                                        <td className="p-3 font-bold">{user.name}</td>
                                                        <td className="p-3 text-right text-green-600 font-bold">
                                                            {setting ? `Rp ${formatNumberWithSeparator(setting.baseSalary)}` : '-'}
                                                        </td>
                                                        <td className="p-3 text-right">
                                                            {setting ? `${setting.commissionRate}%` : '-'}
                                                        </td>
                                                        <td className="p-3 text-center text-xs text-slate-500">
                                                            {setting?.updatedAt?.seconds ? new Date(setting.updatedAt.seconds * 1000).toLocaleDateString('id-ID') : '-'}
                                                        </td>
                                                        <td className="p-3 text-center">
                                                            <button
                                                                onClick={() => setModal({ type: 'salary', userId: user.id, data: setting })}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-600"
                                                            >
                                                                {setting ? 'Edit' : 'Set Gaji'}
                                                            </button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {salarySettings.length > 0 && (
                                <div className="bg-blue-50 border border-blue-200 rounded-xl p-6">
                                    <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                        <Zap className="w-5 h-5 text-blue-600" />
                                        Auto-Generate Payroll
                                    </h3>
                                    <p className="text-sm text-slate-600 mb-4">
                                        Generate payroll untuk semua karyawan berdasarkan gaji tetap yang sudah di-set
                                    </p>
                                    <button
                                        onClick={() => setModal('autoPayroll')}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                    >
                                        <Zap className="w-5 h-5" /> Auto Generate Payroll
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* PAYROLL TAB */}
                    {tab === 'payroll' && (
                        <div className="space-y-4">
                            <div className="flex justify-end">
                                <button
                                    onClick={() => setModal('payroll')}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                >
                                    <Plus className="w-5 h-5" /> Generate Payroll
                                </button>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Bulan</th>
                                                <th className="p-3 text-left">Nama</th>
                                                <th className="p-3 text-right">Gaji Pokok</th>
                                                <th className="p-3 text-right">Komisi</th>
                                                <th className="p-3 text-right">Bonus</th>
                                                <th className="p-3 text-right">Potongan</th>
                                                <th className="p-3 text-right">Total</th>
                                                <th className="p-3 text-center">Status</th>
                                                <th className="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const sortedPayrolls = payrolls.sort((a, b) => (b.month || '').localeCompare(a.month || ''));
                                                const prTotalPages = Math.ceil(sortedPayrolls.length / payrollItemsPerPage);
                                                const prStart = (payrollCurrentPage - 1) * payrollItemsPerPage;
                                                const prEnd = prStart + payrollItemsPerPage;
                                                return sortedPayrolls.slice(prStart, prEnd).map(pr => (
                                                <tr key={pr.id} className="hover:bg-slate-50">
                                                    <td className="p-3">{pr.month}</td>
                                                    <td className="p-3 font-bold">{pr.userName}</td>
                                                    <td className="p-3 text-right">{formatCurrency(pr.baseSalary)}</td>
                                                    <td className="p-3 text-right text-green-600">{formatCurrency(pr.commission)}</td>
                                                    <td className="p-3 text-right text-blue-600">{formatCurrency(pr.bonus)}</td>
                                                    <td className="p-3 text-right text-red-600">{formatCurrency(pr.deduction)}</td>
                                                    <td className="p-3 text-right font-bold text-lg">{formatCurrency(pr.totalSalary)}</td>
                                                    <td className="p-3 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            pr.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                            {pr.status === 'paid' ? 'Dibayar' : 'Pending'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <div className="flex gap-2 justify-center">
                                                            <button
                                                                onClick={() => setModal({ type: 'payroll', mode: 'edit', data: pr })}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-600"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeletePayroll(pr.id)}
                                                                className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600"
                                                            >
                                                                Hapus
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls for Payroll */}
                                {payrolls.length > 0 && (
                                    <div className="p-4 border-t border-slate-200">
                                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                            <div className="flex items-center space-x-2">
                                                <span className="text-sm text-slate-600">Tampilkan:</span>
                                                <select value={payrollItemsPerPage} onChange={(e) => { setPayrollItemsPerPage(parseInt(e.target.value)); setPayrollCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                    <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                </select>
                                                <span className="text-sm text-slate-600">per halaman</span>
                                            </div>
                                            <div className="text-sm text-slate-600">
                                                Menampilkan {Math.min((payrollCurrentPage - 1) * payrollItemsPerPage + 1, payrolls.length)} - {Math.min(payrollCurrentPage * payrollItemsPerPage, payrolls.length)} dari {payrolls.length}
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => { if (payrollCurrentPage > 1) setPayrollCurrentPage(payrollCurrentPage - 1); }} disabled={payrollCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                <div className="flex space-x-1">
                                                    {Array.from({ length: Math.ceil(payrolls.length / payrollItemsPerPage) }, (_, i) => {
                                                        const p = i + 1;
                                                        if (p === 1 || p === Math.ceil(payrolls.length / payrollItemsPerPage) || (p >= payrollCurrentPage - 2 && p <= payrollCurrentPage + 2)) {
                                                            return <button key={p} onClick={() => setPayrollCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === payrollCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                        } else if (p === payrollCurrentPage - 3 || p === payrollCurrentPage + 3) {
                                                            return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                        }
                                                        return null;
                                                    })}
                                                </div>
                                                <button onClick={() => { const tp = Math.ceil(payrolls.length / payrollItemsPerPage); if (payrollCurrentPage < tp) setPayrollCurrentPage(payrollCurrentPage + 1); }} disabled={payrollCurrentPage === Math.ceil(payrolls.length / payrollItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* LEAVE TAB */}
                    {tab === 'leave' && (
                        <div className="space-y-4">
                            {isOwner && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-sm text-blue-800"><strong>[i] Info:</strong> Owner hanya dapat melihat dan menyetujui/menolak pengajuan cuti karyawan. Karyawan mengajukan cuti sendiri.</p>
                                </div>
                            )}
                            {!isOwner && (
                                <div className="flex justify-end">
                                    <button
                                        onClick={() => setModal('leave')}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                    >
                                        <Plus className="w-5 h-5" /> Ajukan Cuti
                                    </button>
                                </div>
                            )}

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50">
                                    <h3 className="font-bold text-slate-800">
                                        {isOwner ? 'Daftar Cuti Semua Karyawan' : 'Daftar Cuti Saya'}
                                    </h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                {isOwner && <th className="p-3 text-left">Nama</th>}
                                                <th className="p-3 text-left">Tipe</th>
                                                <th className="p-3 text-center">Tanggal Mulai</th>
                                                <th className="p-3 text-center">Tanggal Selesai</th>
                                                <th className="p-3 text-left">Alasan</th>
                                                <th className="p-3 text-center">Status</th>
                                                {isOwner && <th className="p-3 text-center">Aksi</th>}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const filteredLeaves = leaves
                                                    .filter(leave => isOwner || leave.userId === currentUserData?.id)
                                                    .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                                                const leaveStart = (leaveCurrentPage - 1) * leaveItemsPerPage;
                                                const leaveEnd = leaveStart + leaveItemsPerPage;
                                                return filteredLeaves.slice(leaveStart, leaveEnd).map(leave => (
                                                <tr key={leave.id} className="hover:bg-slate-50">
                                                    {isOwner && <td className="p-3 font-bold">{leave.userName}</td>}
                                                    <td className="p-3">
                                                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">
                                                            {leave.type}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">{leave.startDate}</td>
                                                    <td className="p-3 text-center">{leave.endDate}</td>
                                                    <td className="p-3 text-sm">{leave.reason}</td>
                                                    <td className="p-3 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                                                            leave.status === 'approved' ? 'bg-green-100 text-green-700' :
                                                            leave.status === 'rejected' ? 'bg-red-100 text-red-700' :
                                                            'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                            {leave.status === 'approved' ? 'Disetujui' : leave.status === 'rejected' ? 'Ditolak' : 'Pending'}
                                                        </span>
                                                    </td>
                                                    {isOwner && (
                                                        <td className="p-3 text-center">
                                                            {leave.status === 'pending' && (
                                                                <div className="flex gap-2 justify-center">
                                                                    <button
                                                                        onClick={() => handleLeaveAction(leave.id, 'approved')}
                                                                        className="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-600"
                                                                    >
                                                                        Setujui
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleLeaveAction(leave.id, 'rejected')}
                                                                        className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600"
                                                                    >
                                                                        Tolak
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </td>
                                                    )}
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                                {/* Pagination Controls for Leave */}
                                {(() => {
                                    const filteredLeaves = leaves.filter(leave => isOwner || leave.userId === currentUserData?.id);
                                    const leaveTotal = filteredLeaves.length;
                                    const leaveTotalPages = Math.ceil(leaveTotal / leaveItemsPerPage);
                                    if (leaveTotal === 0) return null;
                                    return (
                                        <div className="p-4 border-t border-slate-200">
                                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                                    <select value={leaveItemsPerPage} onChange={(e) => { setLeaveItemsPerPage(parseInt(e.target.value)); setLeaveCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                    </select>
                                                    <span className="text-sm text-slate-600">per halaman</span>
                                                </div>
                                                <div className="text-sm text-slate-600">
                                                    Menampilkan {Math.min((leaveCurrentPage - 1) * leaveItemsPerPage + 1, leaveTotal)} - {Math.min(leaveCurrentPage * leaveItemsPerPage, leaveTotal)} dari {leaveTotal}
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button onClick={() => { if (leaveCurrentPage > 1) setLeaveCurrentPage(leaveCurrentPage - 1); }} disabled={leaveCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                    <div className="flex space-x-1">
                                                        {Array.from({ length: leaveTotalPages }, (_, i) => {
                                                            const p = i + 1;
                                                            if (p === 1 || p === leaveTotalPages || (p >= leaveCurrentPage - 2 && p <= leaveCurrentPage + 2)) {
                                                                return <button key={p} onClick={() => setLeaveCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === leaveCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                            } else if (p === leaveCurrentPage - 3 || p === leaveCurrentPage + 3) {
                                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                    <button onClick={() => { if (leaveCurrentPage < leaveTotalPages) setLeaveCurrentPage(leaveCurrentPage + 1); }} disabled={leaveCurrentPage === leaveTotalPages} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    {/* SHIFT TAB */}
                    {tab === 'shift' && (
                        <div className="space-y-4">
                            <div className="flex justify-end">
                                <button
                                    onClick={() => setModal('shift')}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center gap-2"
                                >
                                    <Plus className="w-5 h-5" /> Buat Shift
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {shifts.map(shift => (
                                    <div key={shift.id} className="bg-white rounded-xl border border-slate-200 p-6 hover:shadow-lg transition-shadow">
                                        <h3 className="font-bold text-lg text-slate-800 mb-3">{shift.name}</h3>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex items-center gap-2 text-slate-600">
                                                <span className="text-lg">‚è∞</span>
                                                <span>Mulai: <strong>{shift.startTime}</strong></span>
                                            </div>
                                            <div className="flex items-center gap-2 text-slate-600">
                                                <span className="text-lg">‚è∞</span>
                                                <span>Selesai: <strong>{shift.endTime}</strong></span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* PERFORMANCE TAB */}
                    {tab === 'performance' && (
                        <div className="space-y-4">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 className="font-bold text-xl mb-6 text-slate-800">Performance Review</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {users.filter(u => u.role !== 'owner').map(user => {
                                        const userAttendances = attendances.filter(a => a.userId === user.id);
                                        const totalHours = userAttendances.reduce((sum, a) => sum + (a.workHours || 0), 0);
                                        const avgHours = userAttendances.length > 0 ? (totalHours / userAttendances.length).toFixed(1) : 0;

                                        return (
                                            <div key={user.id} className="border border-slate-200 rounded-xl p-6 hover:shadow-md transition-shadow">
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <Users className="w-6 h-6 text-blue-600" />
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-lg">{user.name}</h4>
                                                        <p className="text-sm text-slate-500">{user.role}</p>
                                                    </div>
                                                </div>
                                                <div className="space-y-3">
                                                    <div className="flex justify-between items-center py-2 border-b">
                                                        <span className="text-slate-600">Total Hadir</span>
                                                        <span className="font-bold text-blue-600">{userAttendances.length} hari</span>
                                                    </div>
                                                    <div className="flex justify-between items-center py-2 border-b">
                                                        <span className="text-slate-600">Total Jam Kerja</span>
                                                        <span className="font-bold text-green-600">{totalHours.toFixed(1)} jam</span>
                                                    </div>
                                                    <div className="flex justify-between items-center py-2">
                                                        <span className="text-slate-600">Rata-rata/Hari</span>
                                                        <span className="font-bold text-purple-600">{avgHours} jam</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MONTHLY BUDGET TAB */}
                    {tab === 'budget' && isOwner && (
                        <div className="space-y-4">
                            <div className="bg-gradient-to-r from-orange-600 to-red-600 rounded-2xl p-6 text-white">
                                <h3 className="font-bold text-xl mb-2">Anggaran Bulanan</h3>
                                <p className="text-sm opacity-90">Catat pengeluaran rutin bulanan seperti sewa, listrik, dll</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <p className="text-slate-600 text-sm mb-2">Total Anggaran</p>
                                    <p className="font-bold text-2xl text-blue-600">
                                        Rp {formatNumberWithSeparator(monthlyBudgets.reduce((sum, b) => sum + (b.amount || 0), 0))}
                                    </p>
                                </div>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <p className="text-slate-600 text-sm mb-2">Jumlah Item</p>
                                    <p className="font-bold text-2xl text-green-600">{monthlyBudgets.length}</p>
                                </div>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                                    <p className="text-slate-600 text-sm mb-2">Rata-rata per Item</p>
                                    <p className="font-bold text-2xl text-purple-600">
                                        Rp {monthlyBudgets.length > 0 ? formatNumberWithSeparator(Math.round(monthlyBudgets.reduce((sum, b) => sum + (b.amount || 0), 0) / monthlyBudgets.length)) : '0'}
                                    </p>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800">Daftar Pengeluaran Bulanan</h3>
                                    <button
                                        onClick={() => setModal('budget')}
                                        className="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2"
                                    >
                                        <Plus className="w-4 h-4" /> Tambah Anggaran
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                <th className="p-3 text-left">Nama</th>
                                                <th className="p-3 text-left">Kategori</th>
                                                <th className="p-3 text-right">Jumlah</th>
                                                <th className="p-3 text-center">Jatuh Tempo</th>
                                                <th className="p-3 text-left">Catatan</th>
                                                <th className="p-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {(() => {
                                                const budgetStart = (budgetCurrentPage - 1) * budgetItemsPerPage;
                                                const budgetEnd = budgetStart + budgetItemsPerPage;
                                                return monthlyBudgets.slice(budgetStart, budgetEnd).map(budget => (
                                                <tr key={budget.id} className="hover:bg-slate-50">
                                                    <td className="p-3 font-bold">{budget.name}</td>
                                                    <td className="p-3">
                                                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">
                                                            {budget.category}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-right font-bold text-red-600">
                                                        Rp {formatNumberWithSeparator(budget.amount)}
                                                    </td>
                                                    <td className="p-3 text-center">{budget.dueDate || '-'}</td>
                                                    <td className="p-3 text-sm text-slate-600">{budget.notes || '-'}</td>
                                                    <td className="p-3 text-center">
                                                        <button
                                                            onClick={() => handleDeleteBudget(budget.id)}
                                                            className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600"
                                                        >
                                                            Hapus
                                                        </button>
                                                    </td>
                                                </tr>
                                            ));
                                            })()}
                                        </tbody>
                                    </table>
                                    {monthlyBudgets.length === 0 && (
                                        <div className="p-8 text-center text-slate-400">
                                            <TrendingDown className="w-12 h-12 mx-auto mb-2 opacity-50" />
                                            <p>Belum ada anggaran bulanan</p>
                                        </div>
                                    )}
                                    {/* Pagination Controls for Budget */}
                                    {monthlyBudgets.length > 0 && (
                                        <div className="p-4 border-t border-slate-200">
                                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                                                <div className="flex items-center space-x-2">
                                                    <span className="text-sm text-slate-600">Tampilkan:</span>
                                                    <select value={budgetItemsPerPage} onChange={(e) => { setBudgetItemsPerPage(parseInt(e.target.value)); setBudgetCurrentPage(1); }} className="border border-slate-300 rounded px-2 py-1 text-sm bg-white">
                                                        <option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="50">50</option>
                                                    </select>
                                                    <span className="text-sm text-slate-600">per halaman</span>
                                                </div>
                                                <div className="text-sm text-slate-600">
                                                    Menampilkan {Math.min((budgetCurrentPage - 1) * budgetItemsPerPage + 1, monthlyBudgets.length)} - {Math.min(budgetCurrentPage * budgetItemsPerPage, monthlyBudgets.length)} dari {monthlyBudgets.length}
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button onClick={() => { if (budgetCurrentPage > 1) setBudgetCurrentPage(budgetCurrentPage - 1); }} disabled={budgetCurrentPage === 1} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">‚Üê Sebelumnya</button>
                                                    <div className="flex space-x-1">
                                                        {Array.from({ length: Math.ceil(monthlyBudgets.length / budgetItemsPerPage) }, (_, i) => {
                                                            const p = i + 1;
                                                            if (p === 1 || p === Math.ceil(monthlyBudgets.length / budgetItemsPerPage) || (p >= budgetCurrentPage - 2 && p <= budgetCurrentPage + 2)) {
                                                                return <button key={p} onClick={() => setBudgetCurrentPage(p)} className={`px-3 py-1 text-sm rounded ${p === budgetCurrentPage ? 'bg-blue-600 text-white' : 'border border-slate-300 hover:bg-slate-50'}`}>{p}</button>;
                                                            } else if (p === budgetCurrentPage - 3 || p === budgetCurrentPage + 3) {
                                                                return <span key={p} className="px-2 py-1 text-slate-400">...</span>;
                                                            }
                                                            return null;
                                                        })}
                                                    </div>
                                                    <button onClick={() => { const tp = Math.ceil(monthlyBudgets.length / budgetItemsPerPage); if (budgetCurrentPage < tp) setBudgetCurrentPage(budgetCurrentPage + 1); }} disabled={budgetCurrentPage === Math.ceil(monthlyBudgets.length / budgetItemsPerPage)} className="px-3 py-1 border border-slate-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">Selanjutnya ‚Üí</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODALS */}
                    {modal?.type === 'salary' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">
                                    {modal.data ? 'Edit Gaji Tetap' : 'Set Gaji Tetap'}
                                </h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleSaveSalarySetting({
                                        userId: modal.userId,
                                        baseSalary: fd.get('baseSalary'),
                                        commissionRate: fd.get('commissionRate')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Pegawai</label>
                                        <input 
                                            type="text" 
                                            value={users.find(u => u.id === modal.userId)?.name || ''} 
                                            disabled 
                                            className="w-full border p-3 rounded-lg bg-slate-100"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Gaji Pokok (Rp)</label>
                                        <NumberInput 
                                            name="baseSalary" 
                                            required 
                                            value={modal.data?.baseSalary || 0}
                                            className="w-full border p-3 rounded-lg" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Rate Komisi (%)</label>
                                        <input 
                                            type="number" 
                                            name="commissionRate" 
                                            step="0.1" 
                                            defaultValue={modal.data?.commissionRate || 0}
                                            className="w-full border p-3 rounded-lg" 
                                        />
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-slate-600">
                                        üí° Gaji pokok akan digunakan untuk auto-generate payroll tiap bulan
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">
                                            {loading ? 'Proses...' : 'Simpan'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'autoPayroll' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4 flex items-center gap-2">
                                    <Zap className="w-6 h-6 text-blue-600" />
                                    Auto Generate Payroll
                                </h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleAutoGeneratePayroll(fd.get('month'));
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Pilih Bulan</label>
                                        <input 
                                            type="month" 
                                            name="month" 
                                            required 
                                            className="w-full border p-3 rounded-lg"
                                        />
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-2 text-sm">
                                        <p className="font-bold text-blue-900">‚ÑπÔ∏è Informasi:</p>
                                        <ul className="list-disc list-inside text-slate-700 space-y-1">
                                            <li>Payroll akan digenerate untuk {salarySettings.length} karyawan</li>
                                            <li>Menggunakan gaji pokok yang sudah di-set</li>
                                            <li>Komisi dan bonus bisa ditambahkan manual setelah generate</li>
                                            <li>Jika payroll untuk bulan tersebut sudah ada, akan di-skip</li>
                                        </ul>
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Processing...' : 'Generate Payroll'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'budget' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Anggaran Bulanan</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleAddMonthlyBudget({
                                        name: fd.get('name'),
                                        amount: fd.get('amount'),
                                        category: fd.get('category'),
                                        dueDate: fd.get('dueDate'),
                                        notes: fd.get('notes')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Nama Pengeluaran</label>
                                        <input 
                                            type="text" 
                                            name="name" 
                                            required 
                                            placeholder="e.g. Sewa Toko" 
                                            className="w-full border p-3 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Kategori</label>
                                        <select name="category" required className="w-full border p-3 rounded-lg">
                                            <option value="Sewa">Sewa/Kontrak</option>
                                            <option value="Utilitas">Utilitas (Listrik, Air, Internet)</option>
                                            <option value="Transportasi">Transportasi</option>
                                            <option value="Maintenance">Maintenance/Pemeliharaan</option>
                                            <option value="Asuransi">Asuransi</option>
                                            <option value="Lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Jumlah (Rp)</label>
                                        <NumberInput 
                                            name="amount" 
                                            required 
                                            className="w-full border p-3 rounded-lg" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tanggal Jatuh Tempo (Opsional)</label>
                                        <input 
                                            type="number" 
                                            name="dueDate" 
                                            min="1" 
                                            max="31" 
                                            placeholder="Tanggal 1-31" 
                                            className="w-full border p-3 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Catatan (Opsional)</label>
                                        <textarea 
                                            name="notes" 
                                            placeholder="Catatan tambahan..." 
                                            className="w-full border p-3 rounded-lg" 
                                            rows="3"
                                        ></textarea>
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700">
                                            {loading ? 'Proses...' : 'Tambah'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {(modal === 'payroll' || modal?.type === 'payroll') && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">
                                    {modal?.mode === 'edit' ? 'Edit Payroll' : 'Generate Payroll'}
                                </h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    if (modal?.mode === 'edit') {
                                        handleUpdatePayroll(modal.data.id, {
                                            userId: fd.get('userId'),
                                            month: fd.get('month'),
                                            baseSalary: fd.get('baseSalary'),
                                            commission: fd.get('commission'),
                                            bonus: fd.get('bonus'),
                                            deduction: fd.get('deduction')
                                        });
                                    } else {
                                        handleGeneratePayroll({
                                            userId: fd.get('userId'),
                                            month: fd.get('month'),
                                            baseSalary: fd.get('baseSalary'),
                                            commission: fd.get('commission'),
                                            bonus: fd.get('bonus'),
                                            deduction: fd.get('deduction')
                                        });
                                    }
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Pegawai</label>
                                        <select name="userId" required defaultValue={modal?.data?.userId || ''} className="w-full border p-3 rounded-lg">
                                            <option value="">Pilih Pegawai</option>
                                            {users.filter(u => u.role !== 'owner').map(u => (
                                                <option key={u.id} value={u.id}>{u.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Bulan</label>
                                        <input type="month" name="month" required defaultValue={modal?.data?.month || ''} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Gaji Pokok</label>
                                        <NumberInput name="baseSalary" required value={modal?.data?.baseSalary || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Komisi</label>
                                        <NumberInput name="commission" value={modal?.data?.commission || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Bonus</label>
                                        <NumberInput name="bonus" value={modal?.data?.bonus || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Potongan</label>
                                        <NumberInput name="deduction" value={modal?.data?.deduction || 0} className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Proses...' : (modal?.mode === 'edit' ? 'Update' : 'Generate')}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'leave' && !isOwner && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">Ajukan Cuti</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleRequestLeave({
                                        userId: currentUserData?.id,
                                        type: fd.get('type'),
                                        startDate: fd.get('startDate'),
                                        endDate: fd.get('endDate'),
                                        reason: fd.get('reason')
                                    });
                                }} className="space-y-4">
                                    {currentUserData && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p className="text-sm text-slate-600 mb-1">Mengajukan cuti untuk:</p>
                                            <p className="font-bold text-lg">{currentUserData.name}</p>
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tipe Cuti</label>
                                        <select name="type" required className="w-full border p-3 rounded-lg">
                                            <option value="Cuti Tahunan">Cuti Tahunan</option>
                                            <option value="Sakit">Sakit</option>
                                            <option value="Izin">Izin</option>
                                            <option value="Lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tanggal Mulai</label>
                                        <input type="date" name="startDate" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Tanggal Selesai</label>
                                        <input type="date" name="endDate" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Alasan</label>
                                        <textarea name="reason" required className="w-full border p-3 rounded-lg" rows="3"></textarea>
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Proses...' : 'Ajukan'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {modal === 'shift' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                                <h3 className="font-bold text-xl mb-4">Buat Shift Baru</h3>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    handleCreateShift({
                                        name: fd.get('name'),
                                        startTime: fd.get('startTime'),
                                        endTime: fd.get('endTime')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Nama Shift</label>
                                        <input type="text" name="name" required placeholder="e.g. Shift Pagi" className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Jam Mulai</label>
                                        <input type="time" name="startTime" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Jam Selesai</label>
                                        <input type="time" name="endTime" required className="w-full border p-3 rounded-lg" />
                                    </div>
                                    <div className="flex gap-3">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-lg font-bold">Batal</button>
                                        <button type="submit" disabled={loading} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                                            {loading ? 'Proses...' : 'Buat Shift'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // ==================== END HR MANAGER ====================

        const App = () => {
            const { user, activeOwner, loading, logout, subscriptionStatus, adminWhatsApp } = useContext(SessionContext);
            const [view, setView] = useState('dashboard');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [initialServiceData, setInitialServiceData] = useState(null);
            const [showAdminMessagePopup, setShowAdminMessagePopup] = useState(false);
            const [lastDismissedMessageTime, setLastDismissedMessageTime] = useState(() => {
                return localStorage.getItem('lastDismissedMessageTime') || null;
            });
            
            // Monitor access notifications
            useAccessNotification(user);
            
            // Monitor admin message and show popup for active subscribers
            useEffect(() => {
                if (!activeOwner?.adminMessage || !subscriptionStatus) return;
                
                // Only show popup if subscription is active (not expired)
                if (subscriptionStatus.expired) return;
                
                // Check if there's a new admin message
                const messageTime = activeOwner.adminMessageAt?.seconds 
                    ? new Date(activeOwner.adminMessageAt.seconds * 1000).getTime().toString()
                    : null;
                
                // Don't show if user already dismissed this exact message
                if (messageTime && lastDismissedMessageTime === messageTime) return;
                
                // Show popup for new message
                setShowAdminMessagePopup(true);
            }, [activeOwner?.adminMessage, activeOwner?.adminMessageAt, subscriptionStatus, lastDismissedMessageTime]);
            
            const dismissAdminMessagePopup = () => {
                const messageTime = activeOwner.adminMessageAt?.seconds 
                    ? new Date(activeOwner.adminMessageAt.seconds * 1000).getTime().toString()
                    : Date.now().toString();
                
                setLastDismissedMessageTime(messageTime);
                localStorage.setItem('lastDismissedMessageTime', messageTime);
                setShowAdminMessagePopup(false);
            };
            
            // Check for Tracking Token or Track ID
            const [urlToken, setUrlToken] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('token');
            });
            
            const [trackId, setTrackId] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('track');
            });

            if (urlToken) {
                return <PublicTrackingView token={urlToken} onBack={() => { setUrlToken(null); window.history.pushState({}, '', window.location.pathname); }} />;
            }
            
            if (trackId) {
                return <PublicServiceTracker serviceId={trackId} onBack={() => { setTrackId(null); window.history.pushState({}, '', window.location.pathname); }} />;
            }

            if (loading) return <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center text-white gap-4"><Loader2 className="w-10 h-10 animate-spin text-blue-500"/><p className="text-sm font-medium animate-pulse">Menghubungkan ke Cloud Database...</p></div>;
            
            if (!user) return <LoginScreen />;
            if (user.role === 'guest') return <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4"><div className="bg-white max-w-md w-full p-8 rounded-2xl shadow-xl text-center"><div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldAlert className="w-8 h-8"/></div><h2 className="text-xl font-bold text-slate-800 mb-2">Akun Belum Aktif</h2><p className="text-slate-500 mb-6">Halo <strong>{user.email}</strong>. Akun Anda berhasil dibuat, namun belum memiliki hak akses (Role). Silakan hubungi Superadmin atau Owner toko Anda untuk menambahkan email ini ke daftar pegawai.</p><button onClick={()=>getAuth().signOut().then(()=>window.location.reload())} className="text-blue-600 font-bold hover:underline">Keluar / Ganti Akun</button></div></div>;
            if (user.role === 'superadmin' && !activeOwner) return <SuperAdminDashboard />;
            
            // Subscription Lock Screen - block access if subscription expired
            if (subscriptionStatus && subscriptionStatus.expired && user.role !== 'superadmin') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-red-900/20 to-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white max-w-lg w-full rounded-2xl shadow-2xl overflow-hidden">
                            <div className="bg-red-600 p-8 text-center">
                                <div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Lock className="w-10 h-10 text-white"/>
                                </div>
                                <h2 className="text-2xl font-black text-white">Aplikasi Terkunci</h2>
                                <p className="text-red-100 mt-2 text-sm">Langganan Anda telah berakhir</p>
                            </div>
                            <div className="p-8 text-center">
                                <div className="bg-red-50 border-2 border-red-200 rounded-xl p-5 mb-6">
                                    <p className="text-red-800 font-bold text-sm mb-2">Masa aktif aplikasi Anda telah habis.</p>
                                    <p className="text-red-600 text-xs">Untuk melanjutkan menggunakan aplikasi iFix Enterprise, silakan hubungi Administrator untuk melakukan perpanjangan langganan.</p>
                                    {subscriptionStatus.expiresAt && (
                                        <p className="text-red-500 text-xs mt-3 font-mono">Kedaluwarsa: {subscriptionStatus.expiresAt.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                    )}
                                </div>
                                <div className="bg-slate-50 rounded-xl p-4 mb-6 text-left">
                                    <p className="text-xs font-bold text-slate-700 uppercase mb-2">Informasi Akun</p>
                                    <div className="space-y-1 text-sm">
                                        <div className="flex justify-between"><span className="text-slate-500">Bisnis:</span><span className="font-bold text-slate-800">{activeOwner?.name}</span></div>
                                        <div className="flex justify-between"><span className="text-slate-500">Email:</span><span className="font-bold text-slate-800">{user.email}</span></div>
                                        <div className="flex justify-between"><span className="text-slate-500">Paket:</span><span className="font-bold text-slate-800 uppercase">{activeOwner?.plan}</span></div>
                                    </div>
                                </div>
                                {activeOwner?.adminMessage && (
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-5 mb-6">
                                        <div className="flex items-start gap-2 mb-2">
                                            <MessageCircle className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"/>
                                            <p className="text-xs font-bold text-blue-800 uppercase">Pesan dari Admin:</p>
                                        </div>
                                        <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{activeOwner.adminMessage}</p>
                                        {activeOwner.adminMessageAt && activeOwner.adminMessageAt.seconds && (
                                            <p className="text-[10px] text-blue-500 mt-2 opacity-70">
                                                {new Date(activeOwner.adminMessageAt.seconds * 1000).toLocaleString('id-ID', {
                                                    day: 'numeric',
                                                    month: 'long',
                                                    year: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </p>
                                        )}
                                    </div>
                                )}
                                <div className="space-y-3">
                                    <a href={`https://wa.me/${adminWhatsApp || '6281234567890'}?text=Halo%20Admin%2C%20saya%20ingin%20memperpanjang%20langganan%20iFix%20Enterprise.%20Bisnis%3A%20${encodeURIComponent(activeOwner?.name || '')}`} target="_blank" className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all" onClick={() => console.log('üì± Opening WhatsApp:', adminWhatsApp || '6281234567890 (default)')}>
                                        <MessageCircle className="w-5 h-5"/> Hubungi Admin via WhatsApp
                                    </a>
                                    {adminWhatsApp && <p className="text-xs text-slate-500 text-center mt-2">WA: +{adminWhatsApp}</p>}
                                    <button onClick={logout} className="w-full py-3 border-2 border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 flex items-center justify-center gap-2 transition-all">
                                        <LogOut className="w-4 h-4"/> Keluar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="flex bg-slate-50 min-h-screen relative overflow-x-hidden">
                    {mobileMenuOpen && ( <div className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm transition-opacity" onClick={() => setMobileMenuOpen(false)}></div> )}
                    <Sidebar setView={setView} view={view} isOpen={mobileMenuOpen} close={() => setMobileMenuOpen(false)} />
                    <main className="flex-1 md:ml-64 transition-all duration-300" style={{minWidth: 0}}>
                        {/* Desktop Header - hidden di mobile */}
                        <header className="hidden md:flex bg-white border-b border-slate-200 px-6 py-4 justify-between items-center sticky top-0 z-30 shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <p className="text-sm font-bold text-slate-800">{user.name}</p>
                                    <p className="text-xs text-slate-500 uppercase">{user.role}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                {subscriptionStatus && subscriptionStatus.status === 'active' && (
                                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold ${
                                        subscriptionStatus.remainingDays <= 30 
                                            ? 'bg-red-100 text-red-700 border border-red-200 animate-pulse' 
                                            : subscriptionStatus.remainingDays <= 90 
                                                ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' 
                                                : 'bg-green-100 text-green-700 border border-green-200'
                                    }`}>
                                        <Calendar className="w-3 h-3"/>
                                        {subscriptionStatus.remainingDays <= 30 ? '‚ö†Ô∏è ' : ''}{subscriptionStatus.remainingDays} hari tersisa
                                    </div>
                                )}
                                <button onClick={()=>{setView('settings');}} className="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-white text-sm"><Crown className="w-4 h-4"/> Paket</button>
                                <button onClick={logout} className="bg-red-600 hover:bg-red-700 p-2 rounded-lg transition-colors flex items-center gap-2 text-white"><LogOut className="w-5 h-5"/></button>
                            </div>
                        </header>
                        {/* Mobile Header - hanya 1 header, clean */}
                        <div className="md:hidden bg-slate-900 text-white px-4 py-3 flex justify-between items-center sticky top-0 z-30 shadow-md">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setMobileMenuOpen(true)} className="p-2 rounded-lg bg-slate-800 border border-slate-700 active:scale-95 transition-transform"><Menu className="w-5 h-5 text-white"/></button>
                                <div><h1 className="font-bold text-sm leading-tight">iFix Pro</h1><p className="text-[10px] text-blue-400 uppercase">{activeOwner?.plan || 'Mobile'}</p></div>
                            </div>
                            <div className="flex items-center gap-2">
                                {subscriptionStatus && subscriptionStatus.status === 'active' && (
                                    <span className={`text-[10px] px-2 py-1 rounded font-bold ${
                                        subscriptionStatus.remainingDays <= 30 
                                            ? 'bg-red-600 text-white animate-pulse' 
                                            : subscriptionStatus.remainingDays <= 90 
                                                ? 'bg-yellow-600 text-white' 
                                                : 'bg-green-600 text-white'
                                    }`}>{subscriptionStatus.remainingDays}hr</span>
                                )}
                                <button onClick={logout} className="p-2 rounded-lg bg-red-600/20 border border-red-500/30 active:scale-95 transition-transform"><LogOut className="w-4 h-4 text-red-400"/></button>
                            </div>
                        </div>
                        <div className="p-3 md:p-8 mobile-bottom-padding">
                            {view === 'dashboard' && <Dashboard setView={setView}/>}
                            {view === 'service' && <ServiceManager />}
                            {view === 'sales' && <SalesManager />}
                            {view === 'purchase' && <PurchaseManager />}
                            {view === 'return-sales' && <ReturnSalesManager />}
                            {view === 'return-purchase' && <ReturnPurchaseManager />}
                            {view === 'supplier' && <SupplierManager />}
                            {view === 'payable' && <PayableManager />}
                            {view === 'receivable' && <ReceivableManager />}
                            {view === 'cash' && <CashManager />}
                            {view === 'report' && <ReportManager />}
                            {view === 'customers' && <CustomerManager setView={setView} />}
                            {view === 'users' && <UserManager />}
                            {view === 'hr' && <HRManager />}
                            {view === 'settings' && <SettingsManager />}
                            {view === 'inventory' && <StockManager />}
                            {view === 'finance' && <FinanceManager />}
                        </div>
                        {/* Bottom Navigation Mobile */}
                        <div className="bottom-nav">
                            {[
                                { id: 'dashboard', label: 'Home', icon: LayoutDashboard },
                                { id: 'service', label: 'Servis', icon: Smartphone },
                                { id: 'sales', label: 'Jual', icon: Store },
                                { id: 'inventory', label: 'Stok', icon: Box },
                                { id: 'finance', label: 'Keuangan', icon: Wallet }
                            ].map(nav => (
                                <button key={nav.id} onClick={() => setView(nav.id)} className={`bottom-nav-item ${view === nav.id ? 'active' : ''}`}>
                                    <nav.icon />
                                    <span>{nav.label}</span>
                                </button>
                            ))}
                        </div>
                    </main>

                    {/* Admin Message Popup - hanya muncul saat subscription aktif */}
                    {showAdminMessagePopup && activeOwner?.adminMessage && !subscriptionStatus?.expired && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100] animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-scale-up">
                                {/* Header dengan gradien */}
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-center relative">
                                    <div className="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
                                        <MessageCircle className="w-8 h-8 text-white"/>
                                    </div>
                                    <h2 className="text-xl font-black text-white">Pesan dari Admin</h2>
                                    <p className="text-blue-100 text-xs mt-1">iFix Pro Enterprise</p>
                                </div>

                                {/* Konten pesan */}
                                <div className="p-6">
                                    <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                                        <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap font-medium">
                                            {activeOwner.adminMessage}
                                        </p>
                                    </div>

                                    {/* Timestamp */}
                                    {activeOwner.adminMessageAt && activeOwner.adminMessageAt.seconds && (
                                        <div className="flex items-center gap-2 text-xs text-slate-500 mb-6 justify-center">
                                            <Clock className="w-3 h-3"/>
                                            <span>
                                                {new Date(activeOwner.adminMessageAt.seconds * 1000).toLocaleString('id-ID', {
                                                    day: 'numeric',
                                                    month: 'long',
                                                    year: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </span>
                                        </div>
                                    )}

                                    {/* Tombol tutup */}
                                    <button 
                                        onClick={dismissAdminMessagePopup}
                                        className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl"
                                    >
                                        <CheckCircle className="w-5 h-5"/> Mengerti
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(auth, persistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/invalid-credential') msg = "Email atau password salah.";
                    if (err.code === 'auth/user-not-found') msg = "Akun tidak ditemukan.";
                    if (err.code === 'auth/wrong-password') msg = "Password salah.";
                    if (err.code === 'auth/too-many-requests') msg = "Terlalu banyak percobaan. Coba lagi nanti.";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center"></div>
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10">
                        <div className="p-8 text-center bg-blue-600">
                            <h1 className="text-2xl font-black text-white tracking-tight">iFix Enterprise</h1>
                            <p className="text-blue-100 text-sm mt-1">Cloud Management Platform</p>
                        </div>
                        <div className="p-8">
                            <h2 className="text-xl font-bold text-slate-800 mb-6 text-center">Login</h2>

                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs font-bold mb-4 flex items-center gap-2 border border-red-100"><ShieldAlert className="w-4 h-4"/> {error}</div>}

                            <form onSubmit={handleAuth} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Email</label>
                                    <div className="relative">
                                        <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="nama@email.com" required/>
                                        <UserPlus className="w-5 h-5 text-slate-400 absolute left-3 top-3.5"/>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Password</label>
                                    <div className="relative">
                                        <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="******" required/>
                                        <Key className="w-5 h-5 text-slate-400 absolute left-3 top-3.5"/>
                                    </div>
                                </div>
                                
                                <div className="flex items-center">
                                    <input 
                                        id="remember-me" 
                                        type="checkbox" 
                                        checked={rememberMe}
                                        onChange={(e) => setRememberMe(e.target.checked)}
                                        className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                    />
                                    <label htmlFor="remember-me" className="ml-2 text-sm font-medium text-slate-600 cursor-pointer">Ingat Saya</label>
                                </div>

                                <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-600/30 transition-all flex items-center justify-center gap-2">
                                    {loading ? <Loader2 className="w-5 h-5 animate-spin"/> : 'Masuk Aplikasi'}
                                </button>
                            </form>
                            
                            <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                                <p className="text-xs text-slate-400">Pastikan email Anda telah didaftarkan oleh Admin/Owner toko Anda.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üõ°Ô∏è ERROR BOUNDARY COMPONENT
        // ==========================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('üî¥ React Error Boundary caught:', error, errorInfo);
                this.setState({
                    error,
                    errorInfo
                });
                
                // Tampilkan error di UI
                window.showError(
                    'React Component Error',
                    'Terjadi error saat merender komponen React.\n\nComponent Stack: ' + (errorInfo?.componentStack || 'N/A'),
                    error
                );
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full">
                                <div className="flex items-center gap-3 mb-6">
                                    <AlertTriangle className="w-10 h-10 text-red-600" />
                                    <h1 className="text-2xl font-bold text-red-600">Aplikasi Mengalami Error</h1>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded p-4 mb-6">
                                    <p className="text-sm font-mono text-red-800 whitespace-pre-wrap break-words">
                                        {this.state.error && this.state.error.toString()}
                                    </p>
                                </div>
                                <div className="space-y-3">
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <RefreshCw className="w-5 h-5" />
                                        Reload Halaman
                                    </button>
                                    <button
                                        onClick={() => {
                                            localStorage.clear();
                                            window.location.reload();
                                        }}
                                        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Trash2 className="w-5 h-5" />
                                        Clear Cache & Reload
                                    </button>
                                </div>
                                <p className="text-xs text-slate-500 mt-6 text-center">
                                    Jika masalah berlanjut, hubungi support atau screenshot error ini.
                                </p>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        const Root = () => (
            <ErrorBoundary>
                <QuotaTrackingProvider>
                    <ToastProvider>
                        <SessionProvider>
                            <App />
                        </SessionProvider>
                    </ToastProvider>
                </QuotaTrackingProvider>
            </ErrorBoundary>
        );
        
        // Render dengan error handling
        try {
            console.log('üîÑ Rendering React app...');
            const root = createRoot(document.getElementById('root'));
            root.render(<Root />);
            console.log('‚úÖ React app rendered successfully');
            
            // ==========================================
            // üîí VERSION COMPATIBILITY CHECK
            // ==========================================
            console.log('üîí ===== VERSION LOCK STATUS =====');
            console.log('üì¶ Dependencies Status: LOCKED');
            console.log('‚úÖ React: 18.2.0 (Stable)');
            console.log('‚úÖ Firebase: 10.7.1 (Tested)');
            console.log('‚úÖ Protection Layer: Active');
            console.log('üìÖ Last Verified: Feb 3, 2026');
            console.log('‚ö†Ô∏è  DO NOT auto-update without testing!');
            console.log('üîí ================================');
            
        } catch (error) {
            console.error('‚ùå Failed to render React app:', error);
            window.showError(
                'React Render Error',
                'Gagal merender aplikasi React.\nPeriksa kompabilitas browser atau koneksi internet.',
                error
            );
        }
    </script>
</body>
</html>